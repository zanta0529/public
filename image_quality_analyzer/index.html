<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>åœ–ç‰‡å£“ç¸®å“è³ªåˆ†æå·¥å…·</title>
        <style>
            /* åŸºç¤æ¨£å¼é‡ç½®èˆ‡è®Šæ•¸ */
            :root {
                --primary: #2563eb;
                --primary-hover: #1d4ed8;
                --success: #16a34a;
                --success-bg: #f0fdf4;
                --success-border: #bbf7d0;
                --warning: #ca8a04;
                --warning-bg: #fefce8;
                --warning-border: #fef08a;
                --danger: #dc2626;
                --danger-bg: #fef2f2;
                --danger-border: #fecaca;
                --text-main: #1f2937;
                --text-sub: #4b5563;
                --bg-gradient-start: #eff6ff;
                --bg-gradient-end: #e0e7ff;
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
                min-height: 100vh;
                padding: 20px;
                color: var(--text-main);
                display: flex;
                justify-content: center;
                align-items: flex-start;
            }

            .container {
                width: 100%;
                max-width: 900px;
                background: white;
                border-radius: 12px;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                padding: 2rem;
                margin-top: 2rem;
            }

            header {
                margin-bottom: 2rem;
            }
            h1 {
                font-size: 1.875rem;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-bottom: 0.5rem;
            }
            .subtitle {
                color: var(--text-sub);
            }

            .upload-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }
            @media (min-width: 768px) {
                .upload-grid {
                    grid-template-columns: 1fr 1fr;
                }
            }

            .upload-box {
                border: 2px dashed #d1d5db;
                border-radius: 0.5rem;
                padding: 1.5rem;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s;
                position: relative;
                background-color: #fff;
            }

            /* æ–°å¢ï¼šæ‹–æ›³æ™‚çš„æ¨£å¼ */
            .upload-box.drag-over {
                border-color: var(--primary);
                background-color: #eff6ff;
                transform: scale(1.02);
            }

            .upload-box:hover {
                border-color: var(--primary);
                background-color: #f8fafc;
            }
            .upload-box input {
                display: none;
            }
            .upload-icon {
                color: #9ca3af;
                width: 48px;
                height: 48px;
                margin-bottom: 0.75rem;
            }
            .upload-text {
                color: var(--primary);
                font-weight: 600;
                display: block;
                margin-bottom: 0.5rem;
            }
            .file-name {
                font-size: 0.875rem;
                color: var(--success);
                margin-top: 0.5rem;
                word-break: break-all;
                font-weight: 600;
            }

            .btn-analyze {
                width: 100%;
                background-color: var(--primary);
                color: white;
                padding: 0.75rem;
                border: none;
                border-radius: 0.5rem;
                font-weight: 600;
                font-size: 1rem;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            .btn-analyze:hover {
                background-color: var(--primary-hover);
            }
            .btn-analyze:disabled {
                background-color: #d1d5db;
                cursor: not-allowed;
            }

            #resultsSection {
                display: none;
                margin-top: 2rem;
                animation: fadeIn 0.5s ease-out;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .rating-card {
                padding: 1.5rem;
                border-radius: 0.5rem;
                border-width: 2px;
                border-style: solid;
                margin-bottom: 1.5rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .rating-title {
                font-weight: 600;
                color: var(--text-sub);
                margin-bottom: 0.25rem;
            }
            .rating-value {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 1.5rem;
                font-weight: 700;
            }
            .size-stat {
                text-align: right;
            }
            .size-percent {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--primary);
            }

            .metrics-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }
            @media (min-width: 768px) {
                .metrics-grid {
                    grid-template-columns: 1fr 1fr 1fr;
                }
            }

            .metric-card {
                background: white;
                border: 2px solid;
                border-radius: 0.5rem;
                padding: 1.25rem;
            }
            .metric-card.psnr {
                border-color: #e9d5ff;
            }
            .metric-card.ssim {
                border-color: #c7d2fe;
            }
            .metric-card.mse {
                border-color: #fbcfe8;
            }

            .metric-label {
                font-size: 0.875rem;
                font-weight: 600;
                color: var(--text-sub);
                margin-bottom: 0.5rem;
            }
            .metric-value {
                font-size: 1.875rem;
                font-weight: 700;
                margin-bottom: 0.5rem;
            }
            .psnr .metric-value {
                color: #9333ea;
            }
            .ssim .metric-value {
                color: #4f46e5;
            }
            .mse .metric-value {
                color: #db2777;
            }
            .metric-desc {
                font-size: 0.75rem;
                color: var(--text-sub);
            }

            .info-section {
                background-color: #f9fafb;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1.25rem;
                margin-bottom: 1.5rem;
            }
            .info-title {
                font-weight: 600;
                margin-bottom: 0.75rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .info-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 1rem;
                font-size: 0.875rem;
            }
            @media (min-width: 768px) {
                .info-grid {
                    grid-template-columns: 1fr 1fr;
                }
            }

            .suggestion-box {
                background-color: #eff6ff;
                border-left: 4px solid var(--primary);
                padding: 1.25rem;
                border-radius: 0.25rem;
                margin-bottom: 1.5rem;
            }
            .suggestion-text {
                font-size: 0.875rem;
                color: #1e40af;
                line-height: 1.5;
            }

            .glossary {
                background-color: #f9fafb;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1.25rem;
            }
            .glossary p {
                font-size: 0.875rem;
                margin-bottom: 0.5rem;
                color: var(--text-sub);
            }
            .glossary strong {
                color: var(--text-main);
            }

            svg {
                vertical-align: middle;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>ğŸ“Š åœ–ç‰‡å£“ç¸®å“è³ªåˆ†æå·¥å…·</h1>
                <p class="subtitle">ä½¿ç”¨ PSNRã€MSEã€SSIM æŒ‡æ¨™é‡åŒ–åˆ†æåœ–ç‰‡å£“ç¸®å“è³ª</p>
            </header>

            <div class="upload-grid">
                <label class="upload-box" id="dropZoneOriginal">
                    <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                        ></path>
                    </svg>
                    <span class="upload-text">ä¸Šå‚³åŸå§‹åœ–ç‰‡</span>
                    <span style="font-size: 0.8rem; color: #666">é»æ“Šæˆ–å°‡åœ–ç‰‡æ‹–æ›³è‡³æ­¤</span>
                    <input type="file" accept="image/*" id="originalInput" />
                    <p id="originalName" class="file-name"></p>
                </label>

                <label class="upload-box" id="dropZoneCompressed">
                    <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                        ></path>
                    </svg>
                    <span class="upload-text">ä¸Šå‚³å£“ç¸®åœ–ç‰‡</span>
                    <span style="font-size: 0.8rem; color: #666">é»æ“Šæˆ–å°‡åœ–ç‰‡æ‹–æ›³è‡³æ­¤</span>
                    <input type="file" accept="image/*" id="compressedInput" />
                    <p id="compressedName" class="file-name"></p>
                </label>
            </div>

            <button id="analyzeBtn" class="btn-analyze" disabled>é–‹å§‹åˆ†æ</button>

            <div id="resultsSection">
                <div id="ratingCard" class="rating-card">
                    <div>
                        <h3 class="rating-title">å£“ç¸®å“è³ªè©•ç´š</h3>
                        <div class="rating-value" id="ratingValue"></div>
                    </div>
                    <div class="size-stat">
                        <p style="font-size: 0.875rem; color: var(--text-sub)">æª”æ¡ˆå¤§å°æ¸›å°‘</p>
                        <p class="size-percent" id="sizeReduction">0%</p>
                    </div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card psnr">
                        <h4 class="metric-label">PSNRï¼ˆå³°å€¼è¨Šå™ªæ¯”ï¼‰</h4>
                        <p class="metric-value" id="psnrValue">0 dB</p>
                        <p class="metric-desc" id="psnrDesc">--</p>
                    </div>
                    <div class="metric-card ssim">
                        <h4 class="metric-label">SSIMï¼ˆçµæ§‹ç›¸ä¼¼æ€§ï¼‰</h4>
                        <p class="metric-value" id="ssimValue">0</p>
                        <p class="metric-desc" id="ssimDesc">--</p>
                    </div>
                    <div class="metric-card mse">
                        <h4 class="metric-label">MSEï¼ˆå‡æ–¹èª¤å·®ï¼‰</h4>
                        <p class="metric-value" id="mseValue">0</p>
                        <p class="metric-desc" id="mseDesc">--</p>
                    </div>
                </div>

                <div class="info-section">
                    <h4 class="info-title">ğŸ“ æª”æ¡ˆè³‡è¨Š</h4>
                    <div class="info-grid">
                        <div>
                            <p>åœ–ç‰‡å°ºå¯¸ï¼š<span style="font-weight: 600" id="imgDimensions">-- x -- px</span></p>
                            <p>åŸå§‹æª”æ¡ˆï¼š<span style="font-weight: 600" id="infoOrigSize">0 KB</span></p>
                        </div>
                        <div>
                            <p>å£“ç¸®å¾Œæª”æ¡ˆï¼š<span style="font-weight: 600" id="infoCompSize">0 KB</span></p>
                            <p>
                                ç¯€çœç©ºé–“ï¼š<span style="font-weight: 600; color: var(--success)" id="infoSaved"
                                    >0 KB</span
                                >
                            </p>
                        </div>
                    </div>
                </div>

                <div class="suggestion-box">
                    <h4
                        style="
                            font-weight: 600;
                            color: #1e3a8a;
                            margin-bottom: 0.5rem;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        "
                    >
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                            ></path>
                        </svg>
                        ä½¿ç”¨å»ºè­°
                    </h4>
                    <div id="suggestionText" class="suggestion-text"></div>
                </div>
            </div>

            <div class="glossary">
                <h4 style="font-weight: 600; margin-bottom: 0.75rem">ğŸ“š æŒ‡æ¨™èªªæ˜</h4>
                <div>
                    <strong>PSNRï¼š</strong>
                    <p>æ•¸å€¼è¶Šé«˜è¶Šå¥½ã€‚40 dB ä»¥ä¸Šç‚ºå„ªç§€ã€‚</p>
                </div>
                <div>
                    <strong>SSIMï¼š</strong>
                    <p>ç¯„åœ 0-1ã€‚0.98 ä»¥ä¸Šç‚ºæ¥µä½³ã€‚</p>
                </div>
                <div>
                    <strong>MSEï¼š</strong>
                    <p>æ•¸å€¼è¶Šå°è¶Šå¥½ã€‚</p>
                </div>
            </div>
        </div>

        <script>
            // ç‹€æ…‹è®Šæ•¸
            let originalFile = null;
            let compressedFile = null;
            const analyzeBtn = document.getElementById("analyzeBtn");

            // çµ±ä¸€è™•ç†æª”æ¡ˆé‚è¼¯
            function handleFileSelection(file, type, nameId) {
                if (!file) return;

                // æª¢æŸ¥æ˜¯å¦ç‚ºåœ–ç‰‡
                if (!file.type.startsWith("image/")) {
                    alert("è«‹ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ");
                    return;
                }

                if (type === "original") originalFile = file;
                else compressedFile = file;

                const nameDisplay = document.getElementById(nameId);
                nameDisplay.textContent = `âœ“ ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;

                if (originalFile && compressedFile) {
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = "é–‹å§‹åˆ†æ";
                }
            }

            // è¨­å®šæ‹–æ›³èˆ‡é»æ“Šä¸Šå‚³åŠŸèƒ½
            function setupInteraction(zoneId, inputId, nameId, type) {
                const dropZone = document.getElementById(zoneId);
                const input = document.getElementById(inputId);

                // 1. è™•ç†é»æ“Šä¸Šå‚³ (Input change)
                input.addEventListener("change", (e) => {
                    handleFileSelection(e.target.files[0], type, nameId);
                });

                // 2. è™•ç†æ‹–æ›³ä¸Šå‚³ (Drag & Drop)
                // å¿…é ˆé˜»æ­¢ä»¥ä¸‹äº‹ä»¶çš„é è¨­è¡Œç‚ºï¼Œç€è¦½å™¨æ‰ä¸æœƒç›´æ¥é–‹åœ–
                ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                // è¦–è¦ºå›é¥‹ï¼šç•¶æª”æ¡ˆæ‹–æ›³é€²ä¾†æ™‚ highlight
                ["dragenter", "dragover"].forEach((eventName) => {
                    dropZone.addEventListener(eventName, () => dropZone.classList.add("drag-over"), false);
                });

                ["dragleave", "drop"].forEach((eventName) => {
                    dropZone.addEventListener(eventName, () => dropZone.classList.remove("drag-over"), false);
                });

                // è™•ç†æ”¾é–‹æª”æ¡ˆ (Drop)
                dropZone.addEventListener("drop", (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handleFileSelection(files[0], type, nameId);
                });
            }

            // åˆå§‹åŒ–å…©å€‹ä¸Šå‚³å€
            setupInteraction("dropZoneOriginal", "originalInput", "originalName", "original");
            setupInteraction("dropZoneCompressed", "compressedInput", "compressedName", "compressed");

            // æ ¸å¿ƒåˆ†ææŒ‰éˆ•
            analyzeBtn.addEventListener("click", async () => {
                if (!originalFile || !compressedFile) return;

                analyzeBtn.disabled = true;
                analyzeBtn.textContent = "åˆ†æä¸­...";

                try {
                    await performAnalysis();
                    const results = document.getElementById("resultsSection");
                    results.style.display = "block";
                    results.scrollIntoView({ behavior: "smooth" });
                } catch (error) {
                    alert(error.message);
                } finally {
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = "é‡æ–°åˆ†æ";
                }
            });

            // è¼‰å…¥åœ–ç‰‡ Promise
            function loadImage(file) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        img.onload = () => resolve(img);
                        img.onerror = () => reject(new Error("åœ–ç‰‡è¼‰å…¥å¤±æ•—"));
                        img.src = e.target.result;
                    };
                    reader.onerror = () => reject(new Error("æª”æ¡ˆè®€å–å¤±æ•—"));
                    reader.readAsDataURL(file);
                });
            }

            function getImageData(img) {
                const canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);
                return ctx.getImageData(0, 0, img.width, img.height);
            }

            function calculateMSE(data1, data2) {
                let sum = 0;
                const pixels = data1.length / 4;
                for (let i = 0; i < data1.length; i += 4) {
                    const r = data1[i] - data2[i];
                    const g = data1[i + 1] - data2[i + 1];
                    const b = data1[i + 2] - data2[i + 2];
                    sum += (r * r + g * g + b * b) / 3;
                }
                return sum / pixels;
            }

            function calculatePSNR(mse) {
                if (mse === 0) return Infinity;
                const maxPixelValue = 255;
                return 20 * Math.log10(maxPixelValue / Math.sqrt(mse));
            }

            function calculateSSIM(data1, data2, width, height) {
                const c1 = (0.01 * 255) ** 2;
                const c2 = (0.03 * 255) ** 2;

                let meanX = 0,
                    meanY = 0,
                    varX = 0,
                    varY = 0,
                    covar = 0;
                const pixels = width * height;

                for (let i = 0; i < data1.length; i += 4) {
                    const gray1 = (data1[i] + data1[i + 1] + data1[i + 2]) / 3;
                    const gray2 = (data2[i] + data2[i + 1] + data2[i + 2]) / 3;
                    meanX += gray1;
                    meanY += gray2;
                }
                meanX /= pixels;
                meanY /= pixels;

                for (let i = 0; i < data1.length; i += 4) {
                    const gray1 = (data1[i] + data1[i + 1] + data1[i + 2]) / 3;
                    const gray2 = (data2[i] + data2[i + 1] + data2[i + 2]) / 3;
                    varX += (gray1 - meanX) ** 2;
                    varY += (gray2 - meanY) ** 2;
                    covar += (gray1 - meanX) * (gray2 - meanY);
                }
                varX /= pixels;
                varY /= pixels;
                covar /= pixels;

                return (
                    ((2 * meanX * meanY + c1) * (2 * covar + c2)) /
                    ((meanX ** 2 + meanY ** 2 + c1) * (varX + varY + c2))
                );
            }

            async function performAnalysis() {
                const img1 = await loadImage(originalFile);
                const img2 = await loadImage(compressedFile);

                if (img1.width !== img2.width || img1.height !== img2.height) {
                    throw new Error("å…©å¼µåœ–ç‰‡çš„è§£æåº¦ï¼ˆå¯¬ x é«˜ï¼‰å¿…é ˆå®Œå…¨ç›¸åŒï¼Œå¦å‰‡ç„¡æ³•é€²è¡Œæ¯”å°ã€‚");
                }

                const data1 = getImageData(img1).data;
                const data2 = getImageData(img2).data;

                const mse = calculateMSE(data1, data2);
                const psnr = calculatePSNR(mse);
                const ssim = calculateSSIM(data1, data2, img1.width, img1.height);
                const reduction = ((originalFile.size - compressedFile.size) / originalFile.size) * 100;

                updateUI(mse, psnr, ssim, reduction, img1.width, img1.height);
            }

            function updateUI(mse, psnr, ssim, reduction, width, height) {
                document.getElementById("mseValue").textContent = mse.toFixed(2);
                document.getElementById("psnrValue").textContent =
                    psnr === Infinity ? "ç„¡é™å¤§" : psnr.toFixed(2) + " dB";
                document.getElementById("ssimValue").textContent = ssim.toFixed(4);
                document.getElementById("sizeReduction").textContent = reduction.toFixed(2) + "%";

                document.getElementById("imgDimensions").textContent = `${width} Ã— ${height} px`;
                document.getElementById("infoOrigSize").textContent = (originalFile.size / 1024).toFixed(2) + " KB";
                document.getElementById("infoCompSize").textContent = (compressedFile.size / 1024).toFixed(2) + " KB";
                document.getElementById("infoSaved").textContent =
                    ((originalFile.size - compressedFile.size) / 1024).toFixed(2) + " KB";

                const ratingCard = document.getElementById("ratingCard");
                const ratingValue = document.getElementById("ratingValue");
                let qualityText = "",
                    suggestionHTML = "";

                if (psnr >= 40 && ssim >= 0.98) {
                    qualityText = "å„ªç§€ (Excellent)";
                    ratingCard.style.backgroundColor = "var(--success-bg)";
                    ratingCard.style.borderColor = "var(--success-border)";
                    ratingValue.style.color = "var(--success)";
                    suggestionHTML = `<p>âœ“ é©åˆæ‰€æœ‰è£ç½®è§€çœ‹ï¼Œè‚‰çœ¼å¹¾ä¹ç„¡å·®ç•°ã€‚</p>`;
                } else if (psnr >= 35 && ssim >= 0.95) {
                    qualityText = "è‰¯å¥½ (Good)";
                    ratingCard.style.backgroundColor = "#eff6ff";
                    ratingCard.style.borderColor = "#bfdbfe";
                    ratingValue.style.color = "var(--primary)";
                    suggestionHTML = `<p>âœ“ é©åˆç¶²è·¯åˆ†äº«ï¼Œç´°ç¯€ä¿ç•™è‰¯å¥½ã€‚</p>`;
                } else if (psnr >= 30 && ssim >= 0.9) {
                    qualityText = "å¯æ¥å— (Acceptable)";
                    ratingCard.style.backgroundColor = "var(--warning-bg)";
                    ratingCard.style.borderColor = "var(--warning-border)";
                    ratingValue.style.color = "var(--warning)";
                    suggestionHTML = `<p>â–³ é©åˆæ‰‹æ©Ÿå°è¢å¹•ï¼Œå¤§è¢å¹•å¯è¦‹ç‘•ç–µã€‚</p>`;
                } else {
                    qualityText = "éœ€æ”¹å–„ (Poor)";
                    ratingCard.style.backgroundColor = "var(--danger-bg)";
                    ratingCard.style.borderColor = "var(--danger-border)";
                    ratingValue.style.color = "var(--danger)";
                    suggestionHTML = `<p>âœ— å“è³ªæå¤±æ˜é¡¯ï¼Œå»ºè­°èª¿æ•´å£“ç¸®åƒæ•¸ã€‚</p>`;
                }

                ratingValue.textContent = qualityText;
                document.getElementById("suggestionText").innerHTML = suggestionHTML;

                // æ›´æ–°æè¿°
                document.getElementById("psnrDesc").textContent =
                    psnr >= 40 ? "âœ“ å„ªç§€" : psnr >= 30 ? "â–³ å¯æ¥å—" : "âœ— è¼ƒå·®";
                document.getElementById("ssimDesc").textContent =
                    ssim >= 0.98 ? "âœ“ å„ªç§€" : ssim >= 0.9 ? "â–³ å¯æ¥å—" : "âœ— è¼ƒå·®";
                document.getElementById("mseDesc").textContent =
                    mse <= 50 ? "âœ“ å„ªç§€" : mse <= 200 ? "â–³ å¯æ¥å—" : "âœ— å·®ç•°å¤§";
            }
        </script>
    </body>
</html>
