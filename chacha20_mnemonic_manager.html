<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>助記詞管理工具 (ChaCha20-Poly1305)</title>
        <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
        <style>
            :root {
                --bg-main: #1e1e2f;
                --bg-card: #2f2f4f;
                --primary: #5865f2;
                --primary-hover: #4752c4;
                --secondary: #b9bbbe;
                --input-bg: #444;
                --text-color: #e8e8f0;
                --border-color: #4a4a5f;
                --error-color: #ff7f7f;
                --error-bg: #4f2e2e;
                --success-color: #60d978;
                --success-bg: #2a4a30;
                --button-reset-bg: #da373c;
                --button-reset-hover-bg: #a1282c;
            }
            body {
                background: var(--bg-main);
                color: var(--text-color);
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                padding: 1rem;
                line-height: 1.6;
            }
            .card {
                background: var(--bg-card);
                padding: 2rem;
                border-radius: 8px;
                max-width: 80%;
                margin: auto;
                border: 1px solid var(--border-color);
            }
            .card h1 {
                text-align: center;
                margin-top: 0;
                margin-bottom: 2rem;
            }
            .field {
                margin-bottom: 1.5rem;
            }
            label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 600;
                color: var(--secondary);
            }
            input,
            textarea,
            button {
                width: 100%;
                padding: 0.75rem;
                background: var(--input-bg);
                border: 1px solid var(--border-color);
                border-radius: 5px;
                color: var(--text-color);
                box-sizing: border-box;
                font-size: 1rem;
                transition: background-color 0.2s, border-color 0.2s;
            }
            input:focus,
            textarea:focus {
                outline: none;
                border-color: var(--primary);
            }
            button {
                cursor: pointer;
                background: var(--primary);
                font-weight: 600;
                border: none;
            }
            button:hover {
                background: var(--primary-hover);
            }
            .output-container {
                margin-top: 1.5rem;
            }
            .output {
                padding: 1rem;
                border-radius: 5px;
                min-height: 50px;
                white-space: pre-wrap;
                word-break: break-all;
                font-size: 1.1em;
                line-height: 1.5;
                border-left: 5px solid transparent;
                background-color: var(--input-bg);
                transition: background-color 0.3s, border-color 0.3s;
            }
            .output.success {
                color: var(--success-color);
                background-color: var(--success-bg);
                border-left-color: var(--success-color);
            }
            .output.error {
                color: var(--error-color);
                background-color: var(--error-bg);
                border-left-color: var(--error-color);
            }
            #jsonView {
                margin-top: 1rem;
                padding: 1rem;
                background: var(--input-bg);
                border: 1px solid var(--border-color);
                border-radius: 5px;
                white-space: pre-wrap;
                word-break: break-all;
                display: none;
            }
            .action-button-group {
                display: flex;
                gap: 1rem;
            }
            #resetBtn {
                background-color: var(--button-reset-bg);
            }
            #resetBtn:hover {
                background-color: var(--button-reset-hover-bg);
            }
            .output-copy-button {
                margin-top: 1rem;
            }
            .output-copy-button:hover {
                filter: brightness(110%);
            }
            footer {
                text-align: center;
                margin-top: 30px;
                font-size: 0.9em;
                color: var(--secondary);
            }
            .password-wrapper {
                position: relative;
                display: flex;
                align-items: center;
            }
            .toggle-password-icon {
                position: absolute;
                right: 12px;
                cursor: pointer;
                color: var(--secondary);
                transition: color 0.2s;
            }
            .toggle-password-icon:hover {
                color: var(--text-color);
            }
            .toggle-password-icon svg {
                width: 20px;
                height: 20px;
                vertical-align: middle;
                fill: currentColor;
            }
            #passphrase {
                padding-right: 40px;
            }
        </style>
    </head>
    <body>
        <div class="card">
            <h1>助記詞管理工具 (ChaCha20-Poly1305)</h1>
            <div class="field">
                <label for="mnemonic">助記詞或明文 (Plain-Text)</label>
                <textarea id="mnemonic" rows="4" placeholder="輸入助記詞"></textarea>
            </div>
            <div class="field">
                <label for="passphrase">密碼短語 (Passphrase)</label>
                <div class="password-wrapper">
                    <input id="passphrase" type="password" placeholder="輸入密碼短語" />
                    <span id="togglePassword" class="toggle-password-icon" title="顯示/隱藏密碼"></span>
                </div>
            </div>
            <div class="field">
                <button id="encryptBtn">加密並產生 QR Code</button>
            </div>
            <canvas
                id="qrCanvas"
                width="256"
                height="256"
                style="display: none; margin: auto; border-radius: 8px"
            ></canvas>
            <div id="jsonView"></div>
            <div class="field">
                <label for="base64json">密文 (Base64 JSON)</label>
                <textarea id="base64json" rows="6" placeholder="加密後之 Base64 JSON 將顯示於此"></textarea>
            </div>
            <div class="field">
                <button id="decryptBtn">解密</button>
            </div>
            <div class="field action-button-group">
                <button id="copyBtn" style="flex: 1">複製密文</button>
                <button id="pasteBtn" style="flex: 1">貼上密文</button>
                <button id="resetBtn" style="flex: 1">重設</button>
            </div>
            <div class="output-container">
                <div id="output" class="output">點擊按鈕開始操作...</div>
                <button id="copyDecryptedBtn" class="output-copy-button" style="display: none">複製解密結果</button>
            </div>
        </div>
        <footer>
            <p>&copy; <span id="currentYear"></span> Zanta's Customized ChaCha20 Tool for Cryptocurrency Wallets</p>
        </footer>

        <script type="module">
            import { chacha20poly1305 } from "https://cdn.jsdelivr.net/npm/@noble/ciphers/esm/chacha.js";

            const SALT_BYTES = 16;
            const NONCE_BYTES = 12;
            const NEW_DEFAULT_ITERATIONS = 900000; // 提升迭代次數
            const LEGACY_CHA_ITERATIONS = 300000; // 用於解密此工具舊格式的備用值
            const KEY_LENGTH_BITS = 256;

            const SVG_EYE_OPEN = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>`;
            const SVG_EYE_SLASH = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-slash-fill" viewBox="0 0 16 16"><path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7.029 7.029 0 0 0 2.79-.588zM5.21 3.088A7.028 7.028 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474L5.21 3.089z"/><path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829l-2.83-2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12-.708.708z"/></svg>`;

            document.getElementById("currentYear").textContent = new Date().getFullYear();
            function getObject(id) {
                return document.getElementById(id);
            }
            function setOutput(type, message) {
                const outputDiv = getObject("output");
                outputDiv.textContent = message;
                outputDiv.className = `output ${type}`;
                getObject("copyDecryptedBtn").style.display = "none";
            }
            function toBase64(uint8array) {
                return btoa(String.fromCharCode.apply(null, uint8array));
            }
            function fromBase64(base64) {
                return Uint8Array.from(atob(base64), (c) => c.charCodeAt(0));
            }

            async function encrypt() {
                const mnemonic = getObject("mnemonic").value.trim();
                const passphrase = getObject("passphrase").value;
                const jsonView = getObject("jsonView");
                jsonView.style.display = "none";
                if (!mnemonic || !passphrase) {
                    setOutput("error", "錯誤：助記詞和密碼短語不能為空。");
                    return;
                }
                setOutput("info", "⏳ 正在加密，請稍候...");
                await new Promise((r) => setTimeout(r, 50));

                try {
                    const enc = new TextEncoder();
                    const nonce = crypto.getRandomValues(new Uint8Array(NONCE_BYTES));
                    const salt = crypto.getRandomValues(new Uint8Array(SALT_BYTES));
                    const iterations = NEW_DEFAULT_ITERATIONS; // 使用新的迭代次數

                    const keyMaterial = await crypto.subtle.importKey(
                        "raw",
                        enc.encode(passphrase),
                        { name: "PBKDF2" },
                        false,
                        ["deriveBits"]
                    );
                    const keyBytes = new Uint8Array(
                        await crypto.subtle.deriveBits(
                            { name: "PBKDF2", salt, iterations, hash: "SHA-256" },
                            keyMaterial,
                            KEY_LENGTH_BITS
                        )
                    );

                    const plaintextBytes = enc.encode(mnemonic);
                    const aead = chacha20poly1305(keyBytes, nonce);
                    const ciphertextWithTag = aead.encrypt(plaintextBytes);

                    // 產生新的結構化 JSON
                    const json = {
                        keyDerivation: {
                            name: "PBKDF2",
                            salt: toBase64(salt),
                            iterations: iterations,
                            hash: "SHA-256",
                        },
                        encryption: {
                            name: "ChaCha20-Poly1305",
                            nonce: toBase64(nonce),
                            ciphertext: toBase64(ciphertextWithTag),
                        },
                    };

                    const outputBase64 = btoa(JSON.stringify(json));
                    getObject("base64json").value = outputBase64;
                    jsonView.textContent = JSON.stringify(json, null, 2);
                    jsonView.style.display = "block";

                    const qrCanvas = getObject("qrCanvas");
                    if (typeof QRCode !== "undefined") {
                        qrCanvas.style.display = "block";
                        QRCode.toCanvas(
                            qrCanvas,
                            outputBase64,
                            { errorCorrectionLevel: "H", width: 256 },
                            function (error) {
                                if (error) console.error("QR Code Error:", error);
                            }
                        );
                    } else {
                        console.warn("QRCode library not loaded.");
                        qrCanvas.style.display = "none";
                    }
                    setOutput("success", "✅ 加密成功！QR Code 與 Base64 密文已產生。");
                } catch (e) {
                    console.error("加密失敗:", e);
                    setOutput("error", `❌ 加密失敗：${e.message}`);
                }
            }

            async function decrypt() {
                const passphrase = getObject("passphrase").value;
                const base64json = getObject("base64json").value.trim();
                if (!passphrase || !base64json) {
                    setOutput("error", "錯誤：密文與密碼短語不能為空。");
                    return;
                }
                setOutput("info", "⏳ 正在解密，請稍候...");
                await new Promise((r) => setTimeout(r, 50));

                try {
                    const jsonString = atob(base64json);
                    const json = JSON.parse(jsonString);

                    let salt, iterations, nonce, ciphertextWithTag;

                    if (json.keyDerivation && json.encryption) {
                        // 處理新版結構化 JSON
                        console.log("偵測到新版 ChaCha20 格式。");
                        const kd = json.keyDerivation;
                        const encData = json.encryption;
                        if (kd.name !== "PBKDF2" || encData.name !== "ChaCha20-Poly1305")
                            throw new Error("不支援的演算法組合。");
                        salt = fromBase64(kd.salt);
                        iterations = kd.iterations;
                        nonce = fromBase64(encData.nonce);
                        ciphertextWithTag = fromBase64(encData.ciphertext);
                    } else if (json.algorithm && json.algorithm.name === "ChaCha20-Poly1305") {
                        // 處理此工具的舊版扁平化 ChaCha20 格式
                        console.log("偵測到舊版 ChaCha20 格式。");
                        salt = fromBase64(json.salt);
                        nonce = fromBase64(json.nonce);
                        ciphertextWithTag = fromBase64(json.ciphertext);
                        iterations = json.iterations || LEGACY_CHA_ITERATIONS; // 若舊格式無 iterations, 給予備用值
                    } else {
                        throw new Error("無法識別的密文格式。");
                    }

                    if (typeof iterations !== "number" || iterations <= 0)
                        throw new Error("JSON 中的 iterations 數值無效。");

                    const keyMaterial = await crypto.subtle.importKey(
                        "raw",
                        new TextEncoder().encode(passphrase),
                        { name: "PBKDF2" },
                        false,
                        ["deriveBits"]
                    );
                    const keyBytes = new Uint8Array(
                        await crypto.subtle.deriveBits(
                            { name: "PBKDF2", salt, iterations, hash: "SHA-256" },
                            keyMaterial,
                            KEY_LENGTH_BITS
                        )
                    );

                    const aead = chacha20poly1305(keyBytes, nonce);
                    const decryptedBytes = aead.decrypt(ciphertextWithTag);
                    const decryptedResult = new TextDecoder().decode(decryptedBytes);

                    setOutput("success", `✅ 成功解密！\n\n${decryptedResult}`);
                    const copyDecryptedBtn = getObject("copyDecryptedBtn");
                    copyDecryptedBtn.dataset.decryptedText = decryptedResult;
                    copyDecryptedBtn.style.display = "block";
                } catch (e) {
                    console.error("解密失敗:", e);
                    if (e.message?.toLowerCase().includes("tag") || e.message?.includes("MAC")) {
                        setOutput("error", "❌ 解密失敗：密碼短語不正確，或密文已被竄改。");
                    } else {
                        setOutput("error", `❌ 解密失敗：${e.message}`);
                    }
                }
            }

            function togglePasswordVisibility() {
                const passphraseInput = getObject("passphrase");
                const toggleIcon = getObject("togglePassword");
                if (passphraseInput.type === "password") {
                    passphraseInput.type = "text";
                    toggleIcon.innerHTML = SVG_EYE_SLASH;
                } else {
                    passphraseInput.type = "password";
                    toggleIcon.innerHTML = SVG_EYE_OPEN;
                }
            }

            function copyCipher() {
                const text = getObject("base64json").value;
                if (!text) {
                    setOutput("error", "錯誤：沒有可複製的密文。");
                    return;
                }
                navigator.clipboard
                    .writeText(text)
                    .then(() => setOutput("success", "✅ 已複製密文至剪貼簿。"))
                    .catch((err) => setOutput("error", `❌ 複製失敗: ${err.message}`));
            }
            function pasteCipher() {
                navigator.clipboard
                    .readText()
                    .then((text) => {
                        getObject("base64json").value = text;
                        setOutput("success", "✅ 已貼上剪貼簿內容。");
                    })
                    .catch((err) => setOutput("error", `❌ 貼上失敗: ${err.message}.`));
            }
            function copyDecrypted() {
                const decryptedText = getObject("copyDecryptedBtn").dataset.decryptedText;
                navigator.clipboard
                    .writeText(decryptedText)
                    .then(() => setOutput("success", "✅ 已複製解密結果到剪貼簿。"))
                    .catch((err) => setOutput("error", `❌ 複製解密結果失敗: ${err.message}`));
            }
            function resetAll() {
                ["mnemonic", "passphrase", "base64json"].forEach((id) => (getObject(id).value = ""));
                const canvas = getObject("qrCanvas");
                if (canvas && typeof canvas.getContext === "function") {
                    canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
                }
                canvas.style.display = "none";
                getObject("jsonView").style.display = "none";
                setOutput("", "點擊按鈕開始操作...");
                navigator.clipboard.writeText("").catch((err) => console.error("清除剪貼簿失敗", err));
            }

            function init() {
                getObject("encryptBtn").addEventListener("click", encrypt);
                getObject("decryptBtn").addEventListener("click", decrypt);
                getObject("copyBtn").addEventListener("click", copyCipher);
                getObject("pasteBtn").addEventListener("click", pasteCipher);
                getObject("resetBtn").addEventListener("click", resetAll);
                getObject("copyDecryptedBtn").addEventListener("click", copyDecrypted);

                const togglePassword = getObject("togglePassword");
                togglePassword.innerHTML = SVG_EYE_OPEN;
                togglePassword.addEventListener("click", togglePasswordVisibility);
            }
            document.addEventListener("DOMContentLoaded", init);
        </script>
    </body>
</html>
