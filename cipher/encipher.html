<!DOCTYPE html>
<html lang="zh-Hant" data-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Encipher v3.0 - é€²éšåŠ å¯†ã€è§£å¯†å™¨</title>

        <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/js-base64@3.7.7/base64.min.js"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/argon2-browser@1.18.0/dist/argon2-bundled.min.js"
            onerror="this.remove(); document.getElementById('backup-argon2-script').style.display='block';"
        ></script>
        <script
            id="backup-argon2-script"
            style="display: none"
            src="https://unpkg.com/argon2-browser@1.18.0/dist/argon2-bundled.min.js"
        ></script>

        <style>
            /* --- CSS è®Šæ•¸å®šç¾© (æ·ºè‰² & æ·±è‰²ä¸»é¡Œ) --- */
            :root {
                /* Palette - æ²‰ç©©è—é›è‰²ç³» */
                --primary-color: #4f46e5;
                --primary-hover-color: #6366f1;
                --primary-text-color: #ffffff;
                --secondary-color: #6b7280;
                --secondary-hover-color: #4b5563;
                --secondary-text-color: #ffffff;
                /* Status Colors */
                --success-color: #059669;
                --success-bg: #d1fae5;
                --error-color: #dc2626;
                --error-bg: #fee2e2;
                --info-color: #0891b2;
                --info-bg: #cffafe;
                --note-color: #92400e;
                --note-bg: #fefce8;
                --warning-color: #9a3412;
                --warning-bg: #ffedd5;
                /* UI Elements */
                --section-header-bg: #f8fafc;
                --bg-color: #f1f5f9;
                --container-bg: #ffffff;
                --text-color: #1f2937;
                --border-color: #e5e7eb;
                --input-bg: #f8fafc;
                --input-focus-shadow: rgba(79, 70, 229, 0.25);
                --button-disabled-bg: #d1d5db;
                --button-disabled-text-color: #9ca3af;
                --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
                --toast-bg: #1f2937;
                --toast-color: #f9fafb;
                --modal-backdrop-bg: rgba(0, 0, 0, 0.5);
                --tooltip-bg: #1f2937;
                --tooltip-color: #f9fafb;
                /* è¨­è¨ˆè¦ç¯„è®Šæ•¸ */
                --border-radius-sm: 5px;
                --border-radius-md: 12px;
                --border-radius-full: 50%;
                --transition-duration-fast: 0.2s;
                --transition-duration-normal: 0.3s;
                --transition-duration-slow: 0.4s;
                --z-index-content: 10;
                --z-index-dropdown: 20;
                --z-index-fixed: 1000;
                --z-index-modal: 1010;
                --z-index-toast: 1020;
            }
            :root[data-theme="dark"] {
                --primary-color: #6366f1;
                --primary-hover-color: #818cf8;
                --primary-text-color: #ffffff;
                --secondary-color: #9ca3af;
                --secondary-hover-color: #d1d5db;
                --secondary-text-color: #1e293b;
                --success-color: #6ee7b7;
                --success-bg: #064e3b;
                --error-color: #f87171;
                --error-bg: #7f1d1d;
                --info-color: #67e8f9;
                --info-bg: #164e63;
                --note-color: #fde047;
                --note-bg: #451a03;
                --warning-color: #fb923c;
                --warning-bg: #7c2d12;
                --section-header-bg: #293548;
                --bg-color: #1e293b;
                --container-bg: #334155;
                --text-color: #d1d5db;
                --border-color: #475569;
                --input-bg: #293548;
                --input-focus-shadow: rgba(99, 102, 241, 0.3);
                --button-disabled-bg: #293548;
                --button-disabled-text-color: #64748b;
                --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
                --toast-bg: #fde68a;
                --toast-color: #78350f;
                --modal-backdrop-bg: rgba(0, 0, 0, 0.7);
                --tooltip-bg: #fde68a;
                --tooltip-color: #78350f;
            }
            /* --- åŸºç¤ & ä½ˆå±€æ¨£å¼ --- */
            *,
            *::before,
            *::after {
                box-sizing: border-box;
            }
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                font-size: 1em;
                margin: 0;
                padding: 2rem;
                background-color: var(--bg-color);
                color: var(--text-color);
                line-height: 1.6;
                display: flex;
                flex-direction: column;
                align-items: center;
                min-height: 100vh;
                transition: background-color var(--transition-duration-normal), color var(--transition-duration-normal);
            }
            .container {
                width: 100%;
                max-width: 800px;
            }
            h1 {
                text-align: center;
                margin-bottom: 1.5rem; /* ç¸®å°æ¨™é¡Œèˆ‡ä¸‹æ–¹èªªæ˜å€å¡Šçš„é–“è· */
            }
            h4 {
                margin-top: 1.5rem;
                margin-bottom: 0.5rem;
                font-weight: 600;
            }
            label {
                font-weight: 600;
                display: block;
                margin-bottom: 0.5rem;
            }
            section {
                margin-bottom: 2.5rem;
            }
            section.card {
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius-md);
                background-color: var(--container-bg);
                box-shadow: var(--box-shadow);
                transition: background-color var(--transition-duration-normal),
                    border-color var(--transition-duration-normal), box-shadow var(--transition-duration-normal);
            }
            section.card > h2 {
                padding: 0.85rem 1.5rem;
                margin: 0;
                font-size: 1.5em;
                font-weight: 600;
                letter-spacing: 0.5px;
                color: var(--primary-text-color);
                background-color: var(--primary-color);
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
                transition: background-color var(--transition-duration-normal),
                    border-color var(--transition-duration-normal), color var(--transition-duration-normal);
                border-top-left-radius: var(--border-radius-md);
                border-top-right-radius: var(--border-radius-md);
            }
            :root[data-theme="dark"] section.card > h2 {
                border-bottom-color: rgba(255, 255, 255, 0.1);
            }
            .card-content {
                padding: 1.5rem;
            }
            .form-group {
                margin-bottom: 1.5rem;
            }
            /* --- çµ„ä»¶ï¼šæŒ‰éˆ• --- */
            .button-group {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                align-items: center;
            }
            button,
            .button {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
                padding: 0.75rem 1.5rem;
                background-color: var(--primary-color);
                color: var(--primary-text-color);
                border: 1px solid transparent;
                border-radius: var(--border-radius-sm);
                cursor: pointer;
                font-size: 1.1em;
                font-weight: 600;
                text-decoration: none;
                text-align: center;
                transition: background-color var(--transition-duration-normal), color var(--transition-duration-normal),
                    border-color var(--transition-duration-normal), transform var(--transition-duration-fast);
            }
            button:hover:not(:disabled),
            .button:hover:not(:disabled) {
                background-color: var(--primary-hover-color);
                transform: translateY(-1px);
            }
            button.secondary,
            .button.secondary {
                background-color: transparent;
                border-color: var(--secondary-color);
                color: var(--secondary-color);
            }
            button.secondary:hover:not(:disabled),
            .button.secondary:hover:not(:disabled) {
                background-color: var(--secondary-hover-color);
                border-color: var(--secondary-hover-color);
                color: var(--secondary-text-color);
            }
            button:disabled,
            .button:disabled {
                background-color: var(--button-disabled-bg);
                color: var(--button-disabled-text-color);
                border-color: transparent;
                cursor: not-allowed;
                opacity: 0.7;
            }
            :root[data-theme="dark"] button:disabled,
            :root[data-theme="dark"] .button:disabled {
                border: 1px solid var(--border-color);
            }
            /* --- è¡¨å–®å…ƒç´  --- */
            input[type="text"],
            input[type="password"],
            input[type="number"],
            textarea {
                width: 100%;
                padding: 0.75rem;
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius-sm);
                font-family: inherit;
                font-size: 1em;
                background-color: var(--input-bg);
                color: var(--text-color);
                transition: border-color var(--transition-duration-normal), box-shadow var(--transition-duration-normal),
                    background-color var(--transition-duration-normal);
            }
            input[type="text"]:focus,
            input[type="password"]:focus,
            input[type="number"]:focus,
            textarea:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0.2rem var(--input-focus-shadow);
            }
            textarea {
                min-height: 120px;
                resize: vertical;
            }
            div h4 {
                color: var(--warning-color);
            }
            .password-wrapper {
                position: relative;
                display: flex;
                align-items: center;
            }
            .toggle-password-icon {
                position: absolute;
                right: 12px;
                cursor: pointer;
                color: var(--secondary-color);
                transition: color 0.2s;
            }
            .password-wrapper input {
                padding-right: 40px;
            }
            /* --- NEW: Password Strength Meter --- */
            .password-strength-meter {
                height: 8px;
                width: 100%;
                background-color: var(--border-color);
                border-radius: 4px;
                margin-top: 8px;
                overflow: hidden;
            }
            .password-strength-meter-bar {
                height: 100%;
                width: 0;
                transition: width 0.3s, background-color 0.3s;
            }
            .password-strength-meter-text {
                font-size: 0.8em;
                margin-top: 4px;
                color: var(--secondary-color);
            }
            .strength-weak {
                background-color: var(--error-color);
            }
            .strength-medium {
                background-color: var(--warning-color);
            }
            .strength-strong {
                background-color: var(--success-color);
            }
            .option-group {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-bottom: 1.5rem;
            }
            .option {
                padding: 10px 15px;
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius-sm);
                cursor: pointer;
                transition: background-color var(--transition-duration-normal),
                    border-color var(--transition-duration-normal), color var(--transition-duration-normal);
                text-align: center;
                flex-grow: 1;
                flex-basis: calc(50% - 5px); /* 10px gap / 2 = 5px */
                max-width: calc(50% - 5px);
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .option.selected {
                background-color: var(--primary-color);
                color: var(--primary-text-color);
                border-color: var(--primary-color);
                font-weight: bold;
            }
            /* --- è¨Šæ¯å›é¥‹ --- */
            .message-block {
                padding: 0.75rem 1rem;
                border-radius: var(--border-radius-sm);
                margin-top: 1rem;
                border-left: 4px solid;
            }
            .hint-note {
                font-size: 0.9em;
                color: var(--note-color);
                background-color: var(--note-bg);
                border-color: var(--note-color);
                transition: all var(--transition-duration-normal) ease-in-out;
                margin-bottom: 1rem;
            }
            .output-box {
                padding: 1rem;
                border-radius: var(--border-radius-sm);
                border-left-width: 5px;
                white-space: pre-wrap;
                word-break: break-all;
                margin-top: 1.5rem;
            }
            .output-box.success {
                color: var(--success-color);
                border-color: var(--success-color);
                background-color: var(--success-bg);
            }
            .output-box.error {
                color: var(--error-color);
                border-color: var(--error-color);
                background-color: var(--error-bg);
            }
            .output-box.info {
                color: var(--info-color);
                border-color: var(--info-color);
                background-color: var(--info-bg);
            }
            footer {
                text-align: center;
                margin-top: auto;
                padding-top: 2rem;
                font-size: 0.9em;
                color: var(--secondary-color);
            }
            #toast {
                visibility: hidden;
                opacity: 0;
                min-width: 250px;
                background-color: var(--toast-bg);
                color: var(--toast-color);
                text-align: center;
                border-radius: var(--border-radius-sm);
                padding: 16px;
                position: fixed;
                z-index: var(--z-index-toast);
                left: 50%;
                transform: translateX(-50%);
                bottom: 30px;
                font-size: 1.1em;
                box-shadow: var(--box-shadow);
                transition: opacity 0.5s, visibility 0.5s, bottom 0.5s;
            }
            #toast.show {
                visibility: visible;
                opacity: 1;
            }
            .results-area {
                margin-top: 1.5rem;
            }
            #qrCanvas {
                border-radius: 8px;
                border: 1px solid var(--border-color);
                max-width: 100%;
                height: auto;
                display: block;
                margin: 1rem auto;
            }
            #jsonView {
                background-color: var(--section-header-bg);
            }
            #params-display-area {
                background-color: var(--input-bg);
                border: 1px solid var(--border-color);
                border-radius: 5px;
                padding: 1rem;
                margin-top: 1rem;
                margin-bottom: 1rem;
            }
            #params-display-area p {
                margin: 0.5rem 0;
            }
            #params-display-area p > span {
                font-weight: bold;
                color: var(--note-color);
            }
            .file-input-wrapper {
                position: relative;
                overflow: hidden;
                display: inline-block;
                width: 100%;
                border: 2px dashed var(--border-color);
                border-radius: 8px;
                padding: 2rem;
                text-align: center;
                cursor: pointer;
                transition: border-color 0.3s, background-color 0.3s;
            }
            .file-input-wrapper:hover,
            .file-input-wrapper.drag-over {
                border-color: var(--primary-color);
                background-color: var(--section-header-bg);
            }
            .file-input-wrapper input[type="file"] {
                position: absolute;
                left: 0;
                top: 0;
                opacity: 0;
                width: 100%;
                height: 100%;
                cursor: pointer;
            }
            .file-info {
                margin-top: 1rem;
                font-size: 0.9em;
                color: var(--secondary-color);
            }
            .file-info span {
                font-weight: bold;
                color: var(--text-color);
            }
            [hidden] {
                display: none !important;
            }
            /* --- FAB & Scroll-to-top --- */
            .fab {
                position: fixed;
                z-index: var(--z-index-fixed);
                width: 50px;
                height: 50px;
                background-color: var(--container-bg);
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius-full);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: var(--box-shadow);
                transition: all var(--transition-duration-normal) ease;
            }
            .fab:hover {
                transform: translateY(-2px) scale(1.05);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            }
            :root[data-theme="dark"] .fab:hover {
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            }
            #themeToggleBtn {
                top: 20px;
                right: 20px;
                color: var(--text-color);
                font-size: 1.5em;
            }
            #scroll-to-top {
                right: 25px;
                bottom: 25px;
                background-color: var(--primary-color);
                border: none;
                opacity: 0;
                visibility: hidden;
                transform: translateY(20px);
                transition: opacity var(--transition-duration-normal) ease,
                    visibility var(--transition-duration-normal) ease, transform var(--transition-duration-normal) ease,
                    background-color var(--transition-duration-normal) ease;
            }
            #scroll-to-top:hover {
                background-color: var(--primary-hover-color);
                transform: translateY(-2px);
            }
            #scroll-to-top.active {
                opacity: 0.9;
                visibility: visible;
                transform: translateY(0);
            }
            #scroll-to-top::after {
                content: "";
                width: 0;
                height: 0;
                border-left: 12px solid transparent;
                border-right: 12px solid transparent;
                border-bottom: 15px solid var(--primary-text-color);
                margin-bottom: 4px;
            }
            /* Argon2 åƒæ•¸å€å¡Š */
            #argon2-params-section {
                padding: 1.25rem;
                background-color: var(--section-header-bg);
                border-radius: var(--border-radius-sm);
                margin-top: -0.5rem; /* å¾®èª¿èˆ‡ä¸Šæ–¹é¸é …çš„é–“è· */
                margin-bottom: 1.5rem;
                border: 1px solid var(--border-color);
            }
            #argon2-params-section .form-group {
                margin-bottom: 1rem;
            }
            #argon2-params-section .form-group:last-child {
                margin-bottom: 0;
            }
            #argon2-params-section label {
                font-size: 0.9em;
            }
            #argon2-params-section .param-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 1rem;
            }
            #benchmarkStatus {
                font-size: 0.9em;
                font-style: italic;
                color: var(--info-color);
                margin-left: 1rem;
            }
            /* --- Accordion æ¨£å¼ --- */
            .accordion {
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius-sm);
                margin-bottom: 2.5rem;
            }
            .accordion-item + .accordion-item {
                border-top: 1px solid var(--border-color);
            }
            .accordion-header {
                width: 100%;
                background: none;
                border: none;
                padding: 1rem 1.5rem;
                text-align: left;
                cursor: pointer;
                font-size: 1.1em;
                font-weight: 600;
                color: var(--text-color);
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: background-color var(--transition-duration-normal), color var(--transition-duration-normal);
            }
            .accordion-header:hover,
            .accordion-header.active {
                background-color: var(--primary-color);
                color: var(--primary-text-color);
            }
            .accordion-header::after {
                content: "â–¼";
                font-size: 0.8em;
                transition: transform var(--transition-duration-normal);
            }
            .accordion-header.active::after {
                transform: rotate(180deg);
            }
            .accordion-content {
                background-color: var(--section-header-bg);
                max-height: 0;
                overflow: hidden;
                padding-left: 1.5rem;
                padding-right: 1.5rem;
                transition: max-height var(--transition-duration-slow) ease-out,
                    padding var(--transition-duration-slow) ease-out;
            }
            .accordion-header.active + .accordion-content {
                max-height: 2000px; /* å¢åŠ æœ€å¤§é«˜åº¦ä»¥å®¹ç´æ›´å¤šå…§å®¹ */
                padding-top: 1rem;
                padding-bottom: 1.5rem;
            }
            .accordion-content p,
            .accordion-content ul {
                margin-top: 0;
                margin-bottom: 1rem;
            }
            .accordion-content ul {
                padding-left: 20px;
            }
            .accordion-content li {
                margin-bottom: 0.5rem;
            }
            .accordion-content code {
                background-color: var(--bg-color);
                padding: 0.2em 0.4em;
                border-radius: 3px;
                font-family: "Courier New", Courier, monospace;
            }
            .accordion-content pre {
                background-color: var(--bg-color);
                padding: 1rem;
                border-radius: var(--border-radius-sm);
                white-space: pre-wrap;
                word-break: break-all;
            }

            @media (max-width: 768px) {
                body {
                    padding: 1rem;
                }
                .container {
                    padding: 0;
                }
                .button-group {
                    flex-direction: column;
                    align-items: stretch;
                }
                .button-group button.secondary {
                    max-width: none;
                }
                .card-content {
                    padding: 1rem;
                }
                section.card > h2 {
                    padding: 0.75rem 1rem;
                }
                .fab {
                    width: 44px;
                    height: 44px;
                }
                #themeToggleBtn {
                    top: 15px;
                    right: 15px;
                    font-size: 1.3em;
                }
                #scroll-to-top {
                    right: 20px;
                    bottom: 20px;
                }
                .accordion-header {
                    padding: 1rem;
                }
                .accordion-content {
                    padding-left: 1rem;
                    padding-right: 1rem;
                }
            }
        </style>
    </head>
    <body>
        <button id="themeToggleBtn" class="fab" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ™</button>

        <div class="container">
            <header>
                <h1>é€²éšåŠ å¯†ã€è§£å¯†å™¨ (v3.0)</h1>
            </header>

            <div class="accordion">
                <div class="accordion-item">
                    <button class="accordion-header" aria-expanded="false">â„¹ï¸ é—œæ–¼æœ¬å·¥å…· / v3.0 æŠ€è¡“è¦æ ¼</button>
                    <div class="accordion-content" aria-hidden="true">
                        <h4>å·¥å…·ç”¨é€”</h4>
                        <p>
                            é€™æ˜¯ä¸€å€‹ç´”å®¢æˆ¶ç«¯ (Client-side)
                            çš„åŠ å¯†èˆ‡è§£å¯†å·¥å…·ï¼Œæ‰€æœ‰é‹ç®—éƒ½åœ¨æ‚¨çš„ç€è¦½å™¨æœ¬æ©Ÿå®Œæˆï¼Œç¢ºä¿è³‡æ–™éš±ç§ã€‚å®ƒå¯ç”¨æ–¼åŠ å¯†æ•æ„Ÿæ–‡å­—æˆ–å°å‹æª”æ¡ˆï¼Œç”¢ç”Ÿä¸€å€‹å¯å®‰å…¨å‚³è¼¸çš„å¯†æ–‡ã€‚
                        </p>

                        <h4>ç‰ˆæœ¬ v3.0 èªªæ˜</h4>
                        <p style="color: var(--warning-color)">
                            <strong>é‡è¦ï¼š</strong>æ­¤ v3.0
                            ç‰ˆæœ¬æ¡ç”¨äº†å…¨æ–°çš„ã€æ›´ç©©å¥çš„åŠ å¯†æ ¼å¼ï¼Œ<strong>ä¸ç›¸å®¹</strong>æ–¼å…ˆå‰ç‰ˆæœ¬ (v1, v2)
                            ç”¢ç”Ÿçš„å¯†æ–‡ã€‚æœ¬æ¬¡æ›´æ–°æ—¨åœ¨å¾¹åº•è§£æ±ºèˆŠæ ¼å¼çš„è¨­è¨ˆç¼ºé™·ã€‚
                        </p>

                        <h4>æŠ€è¡“è¦æ ¼ (v3.0)</h4>
                        <ul>
                            <li>
                                <strong>åŠ å¯†æ ¼å¼ï¼š</strong> æœ€çµ‚è¼¸å‡ºç‚ºä¸€å€‹ Base64 ç·¨ç¢¼çš„ JSON ç‰©ä»¶ï¼Œæ ¼å¼ç‰ˆæœ¬ (`version`)
                                å›ºå®šç‚º `3`ã€‚
                            </li>
                            <li>
                                <strong>é‡‘é‘°è¡ç”Ÿ (KDF)ï¼š</strong> æ”¯æ´ <code>Argon2id</code> å’Œ <code>PBKDF2</code>ã€‚
                            </li>
                            <li>
                                <strong>å°ç¨±åŠ å¯†ï¼š</strong> æ”¯æ´ <code>AES-256-GCM</code> å’Œ
                                <code>ChaCha20-Poly1305</code>ï¼Œå…©è€…å‡ç‚ºèªè­‰åŠ å¯† (AEAD) æ¼”ç®—æ³•ã€‚
                            </li>
                            <li>
                                <strong>è³‡æ–™çµæ§‹</strong>: æ‰€æœ‰æ¼”ç®—æ³•çš„è¼¸å‡ºçµæ§‹å·²çµ±ä¸€ã€‚`nonce` (12ä½å…ƒçµ„) èˆ‡ `tag`
                                (16ä½å…ƒçµ„) å‡ç‚ºç¨ç«‹æ¬„ä½ã€‚
                            </li>
                        </ul>

                        <h4>çµ¦é–‹ç™¼è€…çš„è©±ï¼šå¯¦ä½œç›¸å®¹çš„ v3.0 è§£å¯†å™¨</h4>
                        <p>
                            <strong>æ ¸å¿ƒé—œéµï¼šAAD (èªè­‰é™„åŠ è³‡æ–™) çš„æ¨™æº–åŒ–é‡å»º</strong><br />
                            è§£å¯†æ™‚ï¼Œæ‚¨å¿…é ˆé‡å»ºä¸€å€‹èˆ‡åŠ å¯†æ™‚å®Œå…¨ç›¸åŒçš„ AADã€‚v3.0 çš„ AAD æ˜¯ä¸€å€‹å¾æœ€çµ‚è¼¸å‡º JSON
                            ä¸­æå–éƒ¨åˆ†æ¬„ä½å¾Œï¼Œç¶“é**æ¨™æº–åŒ–åºåˆ—åŒ–**è€Œæˆçš„ç·Šæ¹Š JSON å­—ä¸²ã€‚
                        </p>
                        <p>
                            <strong>AAD æ¨™æº–åŒ–åºåˆ—åŒ–è¦å‰‡ï¼š</strong><br />
                            åœ¨å°‡ AAD ç‰©ä»¶è½‰æ›ç‚º JSON å­—ä¸²å‰ï¼Œ<strong
                                >å¿…é ˆå°å…¶æ‰€æœ‰å±¤ç´šçš„ç‰©ä»¶éµ (key) é€²è¡Œéè¿´çš„å­—æ¯åºæ’åº</strong
                            >ã€‚é€™æ˜¯ç¢ºä¿è·¨å¹³å°ä¸€è‡´æ€§çš„å¼·åˆ¶è¦æ±‚ã€‚
                        </p>
                        <p>æ’åºå¾Œçš„ AAD ç‰©ä»¶çµæ§‹å¦‚ä¸‹ (ä¸å« `salt`, `nonce`, `tag` ç­‰æ¬„ä½):</p>
                        <pre><code>// æ’åºå¾Œçš„ AAD ç‰©ä»¶ç¯„ä¾‹
{
  "encryptionName": "AES-GCM",
  "keyDerivation": {
    "iterations": 4,
    "memory": 65536,
    "name": "Argon2id",
    "parallelism": 4
  },
  "version": 3
}</code></pre>

                        <h4>æ¨™æº–æ¸¬è©¦å‘é‡ (Test Vector)</h4>
                        <p>
                            ç‚ºäº†å”åŠ©ç¬¬ä¸‰æ–¹é–‹ç™¼è€…é©—è­‰å…¶è§£å¯†å¯¦ä½œçš„æ­£ç¢ºæ€§ï¼Œç‰¹æä¾›ä»¥ä¸‹æ¸¬è©¦æ¡ˆä¾‹ã€‚æ‚¨çš„ç¨‹å¼å¿…é ˆèƒ½å¤ ä½¿ç”¨ç›¸åŒçš„è¼¸å…¥ï¼Œç”¢ç”Ÿå®Œå…¨ä¸€è‡´çš„æœ€çµ‚
                            Base64 è¼¸å‡ºã€‚
                        </p>
                        <pre><code>// æ¸¬è©¦æ¡ˆä¾‹ 1: Argon2id + AES-GCM

// -- è¼¸å…¥ --
æ˜æ–‡ (Plaintext): "é€™æ˜¯ Zanta Gemini çš„ä¸€å‰‡æ¸¬è©¦è¨Šæ¯ã€‚"
å¯†ç¢¼çŸ­èª (Passphrase): "a_very_secure_password_123!@#"

// -- å›ºå®šåƒæ•¸ --
Salt (Base64): "rpe2h31xV/P58M51o3C5/g=="
Nonce (Base64): "g2vP0G3gC1b/tW9C"
Argon2 è¨˜æ†¶é«” (KiB): 65536
Argon2 è¿­ä»£æ¬¡æ•¸: 4
Argon2 å¹³è¡Œåº¦: 4

// -- ä¸­é–“ç”¢ç‰© (å¿…é ˆä¸€è‡´) --
æ¨™æº–åŒ– AAD (ç·Šæ¹Š JSON å­—ä¸²): 
{"encryptionName":"AES-GCM","keyDerivation":{"iterations":4,"memory":65536,"name":"Argon2id","parallelism":4},"version":3}

// -- æœ€çµ‚è¼¸å‡º (URL-Safe Base64) --
eyJ2ZXJzaW9uIjozLCJrZXlEZXJpdmF0aW9uIjp7Im5hbWUiOiJBcmdvbjJpZCIsIml0ZXJhdGlvbnMiOjQsIm1lbW9yeSI6NjU1MzYsInBhcmFsbGVsaXNtIjo0LCJzYWx0IjoicnBlMmhzMXhWL1A1OE01MW8zQzUvZyJ9LCJlbmNyeXB0aW9uIjp7Im5hbWUiOiJBRVMtR0NNIiwibm9uY2UiOiJnMjZQMEczZ0MxYi90VzlDIiwiY2lwaGVydGV4dCI6IkwzUXdqLTM2enZLUlJpSkVpMFlOSVFrNk05ZkNwS2txWl9iLUlPT2RKNkY0U1Y4dVNleXpfN3o4QSIsInRhZyI6Im1PZkpRclZtRzlBRlEwZVVtY0VSdFEifX0=
</code></pre>
                    </div>
                </div>
            </div>

            <main>
                <section class="card">
                    <h2>ğŸ” åŠ è§£å¯†å·¥å…·</h2>
                    <div class="card-content">
                        <div id="appModeSelector" class="option-group">
                            <div class="option selected" data-app-mode="text">ğŸ“ƒ ç´”æ–‡å­—æ¨¡å¼</div>
                            <div class="option" data-app-mode="file">ğŸ’¾ æª”æ¡ˆæ¨¡å¼</div>
                        </div>

                        <div id="text-mode-section">
                            <div id="modeSelector" class="option-group">
                                <div class="option selected" data-mode="encrypt">ğŸ”’ åŠ å¯†æ¨¡å¼</div>
                                <div class="option" data-mode="decrypt">ğŸ”“ è§£å¯†æ¨¡å¼</div>
                            </div>
                            <div id="encrypt-section">
                                <div class="form-group">
                                    <label for="mnemonic">æ˜æ–‡ (Plain-Text)</label>
                                    <textarea id="mnemonic" rows="4" placeholder="åœ¨æ­¤è¼¸å…¥è¦åŠ å¯†çš„æ–‡å­—"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>åŠ å¯†æ¼”ç®—æ³•</label>
                                    <div id="algoSelectionGroup" class="option-group">
                                        <div class="option selected" data-value="AES-GCM" title="AES-GCM">AES-GCM</div>
                                        <div class="option" data-value="ChaCha20-Poly1305" title="ChaCha20-Poly1305">
                                            ChaCha20-Poly1305
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>å¯†é‘°è¡ç”Ÿæ¼”ç®—æ³• (KDF)</label>
                                    <div id="kdfSelectionGroup" class="option-group">
                                        <div class="option selected" data-value="Argon2id">Argon2id</div>
                                        <div class="option" data-value="PBKDF2">PBKDF2</div>
                                    </div>
                                </div>
                                <div id="argon2-params-section" hidden>
                                    <div class="message-block hint-note" style="margin-top: 0; margin-bottom: 1rem">
                                        â„¹ï¸ Argon2
                                        åƒæ•¸æœƒå½±éŸ¿æ•ˆèƒ½èˆ‡å®‰å…¨æ€§ã€‚è¨˜æ†¶é«”è¶Šå¤§ã€è¿­ä»£æ¬¡æ•¸è¶Šå¤šï¼Œå®‰å…¨æ€§è¶Šé«˜ä½†é€Ÿåº¦è¶Šæ…¢ã€‚
                                    </div>
                                    <div class="param-grid">
                                        <div class="form-group">
                                            <label for="argon2-memory">è¨˜æ†¶é«” (MB)</label>
                                            <input type="number" id="argon2-memory" value="256" min="64" step="16" />
                                        </div>
                                        <div class="form-group">
                                            <label for="argon2-iterations">è¿­ä»£æ¬¡æ•¸</label>
                                            <input type="number" id="argon2-iterations" value="4" min="4" step="1" />
                                        </div>
                                        <div class="form-group">
                                            <label for="argon2-parallelism">å¹³è¡Œåº¦</label>
                                            <input type="number" id="argon2-parallelism" value="4" min="4" step="1" />
                                        </div>
                                    </div>
                                    <div class="button-group" style="margin-bottom: 1.5rem">
                                        <button
                                            id="benchmarkBtn"
                                            class="secondary"
                                            style="font-size: 0.9em; padding: 0.5rem 1rem"
                                        >
                                            âš¡ï¸ ç”¢ç”Ÿå»ºè­°åƒæ•¸
                                        </button>
                                        <span id="benchmarkStatus"></span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="passphrase-encrypt">å¯†ç¢¼çŸ­èª (Passphrase)</label>
                                    <div class="password-wrapper">
                                        <input id="passphrase-encrypt" type="password" placeholder="è¼¸å…¥å¯†ç¢¼çŸ­èª" />
                                        <span
                                            class="toggle-password-icon"
                                            data-for="passphrase-encrypt"
                                            title="é¡¯ç¤º/éš±è—å¯†ç¢¼"
                                        ></span>
                                    </div>
                                    <div class="password-strength-meter">
                                        <div
                                            id="password-strength-bar-encrypt"
                                            class="password-strength-meter-bar"
                                        ></div>
                                    </div>
                                    <div id="password-strength-text-encrypt" class="password-strength-meter-text"></div>
                                </div>
                                <div class="form-group">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 1rem">
                                        <input type="checkbox" id="self-verify-checkbox" style="width: auto" checked />
                                        <label for="self-verify-checkbox" style="margin-bottom: 0; font-weight: normal"
                                            >åŠ å¯†å¾Œè‡ªå‹•é©—è­‰ (æ¨è–¦)</label
                                        >
                                    </div>
                                    <button id="encryptBtn">ğŸ”’ åŸ·è¡ŒåŠ å¯†</button>
                                </div>
                            </div>
                            <div id="decrypt-section" hidden>
                                <div class="form-group">
                                    <label for="ciphertext-input">å¯†æ–‡ (Base64 JSON)</label>
                                    <textarea
                                        id="ciphertext-input"
                                        rows="6"
                                        placeholder="åœ¨æ­¤è²¼ä¸Š v3.0 æ ¼å¼çš„ Base64 å¯†æ–‡"
                                    ></textarea>
                                </div>
                                <div class="form-group">
                                    <button id="parseBtn" class="secondary">ğŸ” è§£æåƒæ•¸ (å¯é¸)</button>
                                </div>
                                <div id="params-display-area" hidden></div>
                                <div class="form-group">
                                    <label for="passphrase-decrypt">å¯†ç¢¼çŸ­èª (Passphrase)</label>
                                    <div class="password-wrapper">
                                        <input
                                            id="passphrase-decrypt"
                                            type="password"
                                            placeholder="è¼¸å…¥è§£å¯†ç”¨çš„å¯†ç¢¼çŸ­èª"
                                        />
                                        <span
                                            class="toggle-password-icon"
                                            data-for="passphrase-decrypt"
                                            title="é¡¯ç¤º/éš±è—å¯†ç¢¼"
                                        ></span>
                                    </div>
                                </div>
                                <div class="form-group"><button id="decryptBtn">ğŸ”“ é–‹å§‹è§£å¯†</button></div>
                            </div>
                        </div>

                        <div id="file-mode-section" hidden>
                            <div class="message-block hint-note" style="margin-top: 0">
                                â„¹ï¸ æª”æ¡ˆåŠ è§£å¯†æµç¨‹å…¨ç¨‹åœ¨æ‚¨çš„ç€è¦½å™¨æœ¬æ©Ÿå®Œæˆï¼Œæ‚¨çš„æª”æ¡ˆä¸æœƒè¢«ä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨ã€‚
                            </div>
                            <div id="file-encrypt-section" class="form-group" style="margin-top: 1rem">
                                <label>æª”æ¡ˆåŠ å¯†</label>
                                <div class="file-input-wrapper">
                                    <span>é»æ“Šæ­¤è™•é¸æ“‡æª”æ¡ˆï¼Œæˆ–å°‡æª”æ¡ˆæ‹–æ›³è‡³æ­¤</span>
                                    <input type="file" id="file-encrypt-input" />
                                </div>
                                <div id="file-encrypt-info" class="file-info" hidden></div>
                                <div class="form-group" style="margin-top: 1rem">
                                    <label for="passphrase-file-encrypt">å¯†ç¢¼çŸ­èª (Passphrase)</label>
                                    <div class="password-wrapper">
                                        <input
                                            id="passphrase-file-encrypt"
                                            type="password"
                                            placeholder="è¼¸å…¥åŠ å¯†ç”¨çš„å¯†ç¢¼çŸ­èª"
                                        />
                                        <span
                                            class="toggle-password-icon"
                                            data-for="passphrase-file-encrypt"
                                            title="é¡¯ç¤º/éš±è—å¯†ç¢¼"
                                        ></span>
                                    </div>
                                    <div class="password-strength-meter">
                                        <div id="password-strength-bar-file" class="password-strength-meter-bar"></div>
                                    </div>
                                    <div id="password-strength-text-file" class="password-strength-meter-text"></div>
                                </div>
                                <div class="form-group">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 1rem">
                                        <input
                                            type="checkbox"
                                            id="self-verify-file-checkbox"
                                            style="width: auto"
                                            checked
                                        />
                                        <label
                                            for="self-verify-file-checkbox"
                                            style="margin-bottom: 0; font-weight: normal"
                                            >åŠ å¯†å¾Œè‡ªå‹•é©—è­‰ (æ¨è–¦)</label
                                        >
                                    </div>
                                    <button id="encryptFileBtn">ğŸ”’ åŠ å¯†ä¸¦ä¸‹è¼‰æª”æ¡ˆ</button>
                                </div>
                            </div>
                            <hr style="margin: 2rem 0; border-color: var(--border-color); border-style: dashed" />
                            <div id="file-decrypt-section" class="form-group">
                                <label>æª”æ¡ˆè§£å¯†</label>
                                <div class="file-input-wrapper">
                                    <span>é»æ“Šé¸æ“‡åŠ å¯†æª” (.enc)ï¼Œæˆ–å°‡æª”æ¡ˆæ‹–æ›³è‡³æ­¤</span>
                                    <input type="file" id="file-decrypt-input" accept=".enc" />
                                </div>
                                <div id="file-decrypt-info" class="file-info" hidden></div>
                                <div class="form-group" style="margin-top: 1rem">
                                    <label for="passphrase-file-decrypt">å¯†ç¢¼çŸ­èª (Passphrase)</label>
                                    <div class="password-wrapper">
                                        <input
                                            id="passphrase-file-decrypt"
                                            type="password"
                                            placeholder="è¼¸å…¥è§£å¯†ç”¨çš„å¯†ç¢¼çŸ­èª"
                                        />
                                        <span
                                            class="toggle-password-icon"
                                            data-for="passphrase-file-decrypt"
                                            title="é¡¯ç¤º/éš±è—å¯†ç¢¼"
                                        ></span>
                                    </div>
                                </div>
                                <div class="form-group"><button id="decryptFileBtn">ğŸ”“ è§£å¯†ä¸¦ä¸‹è¼‰æª”æ¡ˆ</button></div>
                            </div>
                        </div>

                        <div class="button-group" style="justify-content: center; margin-top: 1.5rem">
                            <button id="pasteBtn" class="secondary" style="flex: 1; max-width: 200px" hidden>
                                ğŸ“‹ è²¼ä¸Šå¯†æ–‡
                            </button>
                            <button id="resetBtn" class="secondary" style="flex: 1; max-width: 200px">
                                ğŸ”„ å…¨éƒ¨é‡è¨­
                            </button>
                        </div>
                    </div>
                </section>

                <section class="card" id="results-area" hidden>
                    <h2>åŸ·è¡Œçµæœ</h2>
                    <div class="card-content">
                        <div id="output" class="output-box info">...</div>

                        <div id="text-mode-results" hidden>
                            <div class="form-group" style="margin-top: 1.5rem">
                                <label for="base64ResultView">æœ€çµ‚ Base64 å¯†æ–‡ (å¯è¤‡è£½/åˆ†äº«)</label>
                                <textarea id="base64ResultView" readonly rows="10"></textarea>
                                <div class="button-group" style="margin-top: 1rem; justify-content: center">
                                    <button id="copyBtn" class="secondary">ğŸ“š è¤‡è£½å¯†æ–‡</button>
                                    <button id="downloadBtn" class="secondary">â¬‡ï¸ ä¸‹è¼‰ç‚º .enc</button>
                                </div>
                            </div>
                            <div class="form-group" style="text-align: center">
                                <canvas id="qrCanvas" width="320" height="320"></canvas>
                            </div>
                            <div class="form-group">
                                <label for="jsonView">å…§éƒ¨ JSON çµæ§‹ (åƒ…ä¾›æª¢è¦–)</label>
                                <textarea id="jsonView" readonly rows="15"></textarea>
                            </div>
                        </div>

                        <div
                            id="decryption-actions"
                            class="button-group"
                            style="margin-top: 1rem; justify-content: center"
                            hidden
                        >
                            <button id="copyDecryptedBtn" class="secondary">ğŸ“š è¤‡è£½è§£å¯†çµæœ</button>
                        </div>
                    </div>
                </section>
            </main>
        </div>
        <footer>
            <p>&copy; <span id="currentYear"></span> Zanta's Utilities</p>
        </footer>
        <div id="toast"></div>
        <button id="scroll-to-top" class="fab" title="å›åˆ°é ‚ç«¯"></button>

        <script type="module">
            import { chacha20poly1305 } from "https://cdn.jsdelivr.net/npm/@noble/ciphers/esm/chacha.js";

            document.addEventListener("DOMContentLoaded", () => {
                const app = {
                    elements: {
                        // Main App
                        appModeSelector: document.getElementById("appModeSelector"),
                        textModeSection: document.getElementById("text-mode-section"),
                        fileModeSection: document.getElementById("file-mode-section"),
                        modeSelector: document.getElementById("modeSelector"),
                        encryptSection: document.getElementById("encrypt-section"),
                        decryptSection: document.getElementById("decrypt-section"),
                        mnemonic: document.getElementById("mnemonic"),
                        ciphertextInput: document.getElementById("ciphertext-input"),
                        passphraseEncrypt: document.getElementById("passphrase-encrypt"),
                        passphraseDecrypt: document.getElementById("passphrase-decrypt"),
                        algoSelectionGroup: document.getElementById("algoSelectionGroup"),
                        kdfSelectionGroup: document.getElementById("kdfSelectionGroup"),
                        argon2ParamsSection: document.getElementById("argon2-params-section"),
                        argon2Memory: document.getElementById("argon2-memory"),
                        argon2Iterations: document.getElementById("argon2-iterations"),
                        argon2Parallelism: document.getElementById("argon2-parallelism"),
                        encryptBtn: document.getElementById("encryptBtn"),
                        decryptBtn: document.getElementById("decryptBtn"),
                        parseBtn: document.getElementById("parseBtn"),
                        benchmarkBtn: document.getElementById("benchmarkBtn"),
                        benchmarkStatus: document.getElementById("benchmarkStatus"),
                        // NEW: Security feature elements
                        selfVerifyCheckbox: document.getElementById("self-verify-checkbox"),
                        selfVerifyFileCheckbox: document.getElementById("self-verify-file-checkbox"),
                        passwordStrengthBarEncrypt: document.getElementById("password-strength-bar-encrypt"),
                        passwordStrengthTextEncrypt: document.getElementById("password-strength-text-encrypt"),
                        passwordStrengthBarFile: document.getElementById("password-strength-bar-file"),
                        passwordStrengthTextFile: document.getElementById("password-strength-text-file"),
                        // File Handling
                        fileEncryptInput: document.getElementById("file-encrypt-input"),
                        fileEncryptInfo: document.getElementById("file-encrypt-info"),
                        passphraseFileEncrypt: document.getElementById("passphrase-file-encrypt"),
                        encryptFileBtn: document.getElementById("encryptFileBtn"),
                        fileDecryptInput: document.getElementById("file-decrypt-input"),
                        fileDecryptInfo: document.getElementById("file-decrypt-info"),
                        passphraseFileDecrypt: document.getElementById("passphrase-file-decrypt"),
                        decryptFileBtn: document.getElementById("decryptFileBtn"),
                        // Controls & Results
                        pasteBtn: document.getElementById("pasteBtn"),
                        resetBtn: document.getElementById("resetBtn"),
                        resultsArea: document.getElementById("results-area"),
                        textModeResults: document.getElementById("text-mode-results"),
                        output: document.getElementById("output"),
                        copyBtn: document.getElementById("copyBtn"),
                        downloadBtn: document.getElementById("downloadBtn"),
                        qrCanvas: document.getElementById("qrCanvas"),
                        jsonView: document.getElementById("jsonView"),
                        base64ResultView: document.getElementById("base64ResultView"),
                        paramsDisplayArea: document.getElementById("params-display-area"),
                        passwordToggles: document.querySelectorAll(".toggle-password-icon"),
                        decryptionActions: document.getElementById("decryption-actions"),
                        copyDecryptedBtn: document.getElementById("copyDecryptedBtn"),
                        // Template UI elements
                        themeToggleBtn: document.getElementById("themeToggleBtn"),
                        currentYear: document.getElementById("currentYear"),
                        toast: document.getElementById("toast"),
                        scrollTopBtn: document.getElementById("scroll-to-top"),
                        accordionContainer: document.querySelector(".accordion"),
                    },
                    state: {
                        currentAppMode: null,
                        currentMode: null,
                        selectedAlgorithm: null,
                        selectedKDF: null,
                        toastTimer: null,
                        lastEncryptedOutput: null,
                        lastDecryptedText: null,
                        fileToEncrypt: null,
                        fileToDecrypt: null,
                    },
                    constants: {
                        VERSION: 3,
                        SALT_BYTES: 16,
                        NONCE_BYTES: 12,
                        TAG_BYTES: 16,
                        TAG_LENGTH_BITS: 128,
                        KEY_LENGTH_BITS: 256,
                        PBKDF2_ITERATIONS: 2000000,
                        QR_CODE_MAX_BYTES: 2953,
                        FILE_SIZE_LIMIT_BYTES: 10 * 1024 * 1024,
                        // NEW: Security constants
                        ARGON2_MIN_MEM_MB: 64,
                        ARGON2_MIN_ITER: 4,
                        ARGON2_MIN_PARA: 4,
                        SVG_EYE_OPEN: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>`,
                        SVG_EYE_SLASH: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7.029 7.029 0 0 0 2.79-.588zM5.21 3.088A7.028 7.028 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474L5.21 3.089z"/><path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829l-2.83-2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12-.708.708z"/></svg>`,
                        MODE_TEXT: "text",
                        MODE_FILE: "file",
                        OP_ENCRYPT: "encrypt",
                        OP_DECRYPT: "decrypt",
                        ALGO_AES_GCM: "AES-GCM",
                        ALGO_CHACHA: "ChaCha20-Poly1305",
                        KDF_ARGON2: "Argon2id",
                        KDF_PBKDF2: "PBKDF2",
                        HASH_SHA256: "SHA-256",
                    },

                    init() {
                        this.elements.currentYear.textContent = new Date().getFullYear();
                        this.theme.init();
                        this.setupEventListeners();
                        this.state.currentAppMode = this.constants.MODE_TEXT;
                        this.state.selectedAlgorithm = this.constants.ALGO_AES_GCM;
                        this.state.selectedKDF = this.constants.KDF_ARGON2;
                        this.ui.setAppMode(this.state.currentAppMode);
                        this.utils.checkArgon2Ready();
                    },

                    setupEventListeners() {
                        this.elements.themeToggleBtn.addEventListener("click", () => this.theme.toggle());
                        this.elements.scrollTopBtn.addEventListener("click", () =>
                            window.scrollTo({ top: 0, behavior: "smooth" })
                        );
                        window.addEventListener("scroll", () =>
                            this.elements.scrollTopBtn.classList.toggle("active", window.scrollY > 300)
                        );

                        this.elements.appModeSelector.addEventListener("click", (e) => {
                            const target = e.target.closest(".option");
                            if (target?.dataset.appMode) this.ui.setAppMode(target.dataset.appMode);
                        });

                        this.elements.modeSelector.addEventListener("click", (e) => {
                            const target = e.target.closest(".option");
                            if (target?.dataset.mode) this.ui.setMode(target.dataset.mode);
                        });

                        this.elements.algoSelectionGroup.addEventListener("click", (e) => {
                            this.ui.handleOptionSelection(e, "selectedAlgorithm");
                        });

                        this.elements.kdfSelectionGroup.addEventListener("click", (e) => {
                            const changed = this.ui.handleOptionSelection(e, "selectedKDF");
                            if (changed) this.ui.toggleArgon2Params(app.state.selectedKDF === app.constants.KDF_ARGON2);
                        });

                        // NEW: Password strength listeners
                        this.elements.passphraseEncrypt.addEventListener("input", (e) =>
                            this.ui.updatePasswordStrength(e.target.value, "encrypt")
                        );
                        this.elements.passphraseFileEncrypt.addEventListener("input", (e) =>
                            this.ui.updatePasswordStrength(e.target.value, "file")
                        );

                        this.elements.encryptBtn.addEventListener("click", () => this.crypto.encryptText());
                        this.elements.decryptBtn.addEventListener("click", () => this.crypto.decryptText());
                        this.elements.parseBtn.addEventListener("click", () => this.crypto.parseParameters());
                        this.elements.benchmarkBtn.addEventListener("click", () => this.benchmark.run());
                        this.elements.fileEncryptInput.addEventListener("change", (e) =>
                            this.fileHandler.handleFileSelect(e, this.constants.OP_ENCRYPT)
                        );
                        this.elements.fileDecryptInput.addEventListener("change", (e) =>
                            this.fileHandler.handleFileSelect(e, this.constants.OP_DECRYPT)
                        );
                        this.elements.encryptFileBtn.addEventListener("click", () => this.crypto.encryptFile());
                        this.elements.decryptFileBtn.addEventListener("click", () => this.crypto.decryptFile());
                        this.elements.resetBtn.addEventListener("click", () => this.ui.resetAll());
                        this.elements.pasteBtn.addEventListener("click", () => this.utils.pasteTo("ciphertextInput"));
                        this.elements.copyBtn.addEventListener("click", () => this.utils.copyFromResult());
                        this.elements.copyDecryptedBtn.addEventListener("click", () =>
                            this.utils.copyDecryptedResult()
                        );
                        this.elements.downloadBtn.addEventListener("click", () => {
                            if (app.state.lastEncryptedOutput) {
                                this.utils.downloadAsFile(
                                    app.state.lastEncryptedOutput,
                                    `encrypted-v3-${Date.now()}.enc`
                                );
                            }
                        });
                        this.elements.passwordToggles.forEach((el) => {
                            el.innerHTML = this.constants.SVG_EYE_OPEN;
                            el.addEventListener("click", (e) => this.ui.togglePasswordVisibility(e.currentTarget));
                        });

                        const setupDragDrop = (wrapper, input) => {
                            if (!wrapper) return;
                            ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
                                wrapper.addEventListener(eventName, (e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                });
                            });
                            ["dragenter", "dragover"].forEach((eventName) =>
                                wrapper.addEventListener(eventName, () => wrapper.classList.add("drag-over"))
                            );
                            ["dragleave", "drop"].forEach((eventName) =>
                                wrapper.addEventListener(eventName, () => wrapper.classList.remove("drag-over"))
                            );
                            wrapper.addEventListener("drop", (e) => {
                                if (e.dataTransfer.files.length > 0) {
                                    input.files = e.dataTransfer.files;
                                    input.dispatchEvent(new Event("change", { bubbles: true }));
                                }
                            });
                        };
                        setupDragDrop(
                            this.elements.fileEncryptInput.closest(".file-input-wrapper"),
                            this.elements.fileEncryptInput
                        );
                        setupDragDrop(
                            this.elements.fileDecryptInput.closest(".file-input-wrapper"),
                            this.elements.fileDecryptInput
                        );

                        if (this.elements.accordionContainer) {
                            this.elements.accordionContainer.addEventListener("click", (e) => {
                                const header = e.target.closest(".accordion-header");
                                if (header) this.accordion.toggle(header);
                            });
                        }
                    },
                    benchmark: {
                        async run() {
                            const { elements, utils } = app;
                            if (!(await utils.checkArgon2Ready())) {
                                return utils.showToast("âŒ Argon2 å‡½å¼åº«æœªå°±ç·’ï¼Œç„¡æ³•æ¸¬è©¦ã€‚");
                            }

                            elements.benchmarkBtn.disabled = true;
                            elements.encryptBtn.disabled = true;
                            elements.benchmarkStatus.textContent = "â±ï¸ æ­£åœ¨åŸ·è¡ŒåŸºæº–æ¸¬è©¦ï¼Œè«‹ç¨å€™...";

                            try {
                                const targetMs = 1000;
                                const iterations = 4; // å›ºå®šè¿­ä»£æ¬¡æ•¸
                                const parallelism = navigator.hardwareConcurrency || 4;
                                const memoryLevelsMb = [1024, 512, 256, 128, 64, 32]; // å¾é«˜åˆ°ä½æ¸¬è©¦
                                let recommendedMemoryMb = 256; // é è¨­å€¼

                                for (const memMb of memoryLevelsMb) {
                                    const memKib = memMb * 1024;
                                    const startTime = performance.now();
                                    await argon2.hash({
                                        pass: "benchmark",
                                        salt: "benchmark-salt",
                                        time: iterations,
                                        mem: memKib,
                                        parallelism: parallelism,
                                        hashLen: 32,
                                        type: argon2.ArgonType.Argon2id,
                                    });
                                    const duration = performance.now() - startTime;
                                    if (duration < targetMs) {
                                        recommendedMemoryMb = memMb;
                                        break;
                                    }
                                    await new Promise((r) => setTimeout(r, 50));
                                }

                                elements.argon2Memory.value = recommendedMemoryMb;
                                elements.argon2Iterations.value = iterations;
                                elements.argon2Parallelism.value = parallelism;

                                elements.benchmarkStatus.textContent = `âœ… æ¸¬è©¦å®Œæˆï¼`;
                                utils.showToast(`âœ… å»ºè­°åƒæ•¸å·²ç”¢ç”Ÿä¸¦å¡«å…¥ï¼`);
                            } catch (e) {
                                elements.benchmarkStatus.textContent = "âŒ æ¸¬è©¦å¤±æ•—";
                                utils.showToast(`âŒ åŸºæº–æ¸¬è©¦å¤±æ•—: ${e.message}`);
                            } finally {
                                elements.benchmarkBtn.disabled = false;
                                elements.encryptBtn.disabled = false;
                                setTimeout(() => {
                                    elements.benchmarkStatus.textContent = "";
                                }, 4000);
                            }
                        },
                    },

                    ui: {
                        setAppMode(appMode) {
                            app.state.currentAppMode = appMode;
                            const isTextMode = appMode === app.constants.MODE_TEXT;
                            this.handleOptionSelection(
                                { target: app.elements.appModeSelector.querySelector(`[data-app-mode="${appMode}"]`) },
                                null
                            );
                            app.elements.textModeSection.hidden = !isTextMode;
                            app.elements.fileModeSection.hidden = isTextMode;
                            this.setMode(app.constants.OP_ENCRYPT);
                        },
                        setMode(mode) {
                            this.resetAll();
                            app.state.currentMode = mode;
                            const isEncrypt = mode === app.constants.OP_ENCRYPT;
                            this.handleOptionSelection(
                                { target: app.elements.modeSelector.querySelector(`[data-mode="${mode}"]`) },
                                null
                            );
                            app.elements.encryptSection.hidden = !isEncrypt;
                            app.elements.decryptSection.hidden = isEncrypt;
                            app.elements.pasteBtn.hidden = isEncrypt;
                        },
                        handleOptionSelection(e, stateKey) {
                            const target = e.target.closest(".option");
                            if (target && !target.classList.contains("selected")) {
                                const group = target.parentElement;
                                group.querySelector(".selected")?.classList.remove("selected");
                                target.classList.add("selected");
                                if (stateKey) app.state[stateKey] = target.dataset.value;
                                return true;
                            }
                            return false;
                        },
                        toggleArgon2Params(show) {
                            app.elements.argon2ParamsSection.hidden = !show;
                        },
                        setOutput(type, message) {
                            app.elements.resultsArea.hidden = false;
                            app.elements.output.className = `output-box ${type}`;
                            app.elements.output.innerHTML = message;
                            app.elements.textModeResults.hidden = true;
                            app.elements.decryptionActions.hidden = true;

                            if (type === "success" && app.state.currentAppMode === app.constants.MODE_TEXT) {
                                if (app.state.currentMode === app.constants.OP_ENCRYPT)
                                    app.elements.textModeResults.hidden = false;
                                else app.elements.decryptionActions.hidden = false;
                            }
                        },
                        resetAll() {
                            const fields = [
                                "mnemonic",
                                "ciphertextInput",
                                "passphraseEncrypt",
                                "passphraseDecrypt",
                                "passphraseFileEncrypt",
                                "passphraseFileDecrypt",
                            ];
                            fields.forEach((id) => (app.elements[id] ? (app.elements[id].value = "") : null));
                            this.updatePasswordStrength("", "encrypt"); // NEW: Reset password meter
                            this.updatePasswordStrength("", "file"); // NEW: Reset password meter
                            app.elements.fileEncryptInput.value = "";
                            app.elements.fileDecryptInput.value = "";
                            app.state.fileToEncrypt = null;
                            app.state.fileToDecrypt = null;
                            app.elements.fileEncryptInfo.hidden = true;
                            app.elements.fileDecryptInfo.hidden = true;
                            app.elements.resultsArea.hidden = true;
                            app.elements.textModeResults.hidden = true;
                            app.elements.decryptionActions.hidden = true;
                            app.elements.paramsDisplayArea.hidden = true;
                            app.state.lastEncryptedOutput = null;
                            app.state.lastDecryptedText = null;
                            app.state.selectedKDF = app.constants.KDF_ARGON2;
                            this.handleOptionSelection(
                                {
                                    target: app.elements.kdfSelectionGroup.querySelector(
                                        `[data-value="${app.constants.KDF_ARGON2}"]`
                                    ),
                                },
                                "selectedKDF"
                            );
                            this.toggleArgon2Params(true);
                            if (app.elements.qrCanvas) {
                                const ctx = app.elements.qrCanvas.getContext("2d");
                                if (ctx) ctx.clearRect(0, 0, app.elements.qrCanvas.width, app.elements.qrCanvas.height);
                            }
                        },
                        togglePasswordVisibility(icon) {
                            const input = document.getElementById(icon.dataset.for);
                            if (input.type === "password") {
                                input.type = "text";
                                icon.innerHTML = app.constants.SVG_EYE_SLASH;
                            } else {
                                input.type = "password";
                                icon.innerHTML = app.constants.SVG_EYE_OPEN;
                            }
                        },
                        // NEW: Update password strength UI
                        updatePasswordStrength(password, type) {
                            const strength = app.utils.checkPasswordStrength(password);
                            const bar =
                                type === "encrypt"
                                    ? app.elements.passwordStrengthBarEncrypt
                                    : app.elements.passwordStrengthBarFile;
                            const text =
                                type === "encrypt"
                                    ? app.elements.passwordStrengthTextEncrypt
                                    : app.elements.passwordStrengthTextFile;

                            bar.className = "password-strength-meter-bar"; // Reset classes
                            if (strength.level !== "empty") {
                                bar.classList.add(`strength-${strength.level}`);
                            }
                            bar.style.width = strength.score + "%";
                            text.textContent = strength.message;
                        },
                    },

                    fileHandler: {
                        handleFileSelect(event, type) {
                            const file = event.target.files[0];
                            if (!file) return;
                            const infoEl = app.elements[`file${type.charAt(0).toUpperCase() + type.slice(1)}Info`];
                            if (file.size > app.constants.FILE_SIZE_LIMIT_BYTES) {
                                infoEl.innerHTML = `<p style="color: var(--error-color);">âŒ æª”æ¡ˆéå¤§ï¼š${(
                                    file.size /
                                    1024 /
                                    1024
                                ).toFixed(2)} MB</p>`;
                                infoEl.hidden = false;
                                app.state[type === app.constants.OP_ENCRYPT ? "fileToEncrypt" : "fileToDecrypt"] = null;
                                return;
                            }
                            infoEl.innerHTML = `æª”æ¡ˆåç¨±: <span>${file.name}</span><br>æª”æ¡ˆå¤§å°: <span>${(
                                file.size / 1024
                            ).toFixed(2)} KB</span>`;
                            infoEl.hidden = false;
                            app.state[type === app.constants.OP_ENCRYPT ? "fileToEncrypt" : "fileToDecrypt"] = file;
                        },
                        readFileAsArrayBuffer: (file) => file.arrayBuffer(),
                        readFileAsText: (file) => file.text(),
                    },

                    crypto: {
                        _isAuthError(e) {
                            return (
                                e instanceof DOMException ||
                                (e.message &&
                                    (e.message.includes("Cannot decrypt") ||
                                        e.message.includes("tag") ||
                                        e.message.includes("Invalid password") ||
                                        e.message.includes("key.usages")))
                            );
                        },
                        _canonicalizeObject(obj) {
                            if (obj === null || typeof obj !== "object" || Array.isArray(obj)) {
                                return obj;
                            }
                            const sortedObj = {};
                            Object.keys(obj)
                                .sort()
                                .forEach((key) => {
                                    sortedObj[key] = this._canonicalizeObject(obj[key]);
                                });
                            return sortedObj;
                        },
                        _buildAad(json) {
                            const kd = json.keyDerivation;
                            const metaDataForAad = {
                                version: json.version,
                                keyDerivation: {
                                    name: kd.name,
                                    iterations: kd.iterations,
                                    memory: kd.memory,
                                    parallelism: kd.parallelism,
                                    hash: kd.hash,
                                },
                                encryptionName: json.encryption.name,
                            };
                            // Clean up undefined keys before canonicalization
                            Object.keys(metaDataForAad).forEach(
                                (key) => metaDataForAad[key] === undefined && delete metaDataForAad[key]
                            );
                            Object.keys(metaDataForAad.keyDerivation).forEach(
                                (key) =>
                                    metaDataForAad.keyDerivation[key] === undefined &&
                                    delete metaDataForAad.keyDerivation[key]
                            );

                            const canonicalized = this._canonicalizeObject(metaDataForAad);
                            return new TextEncoder().encode(JSON.stringify(canonicalized));
                        },
                        async deriveKey(passphrase, kdfParams) {
                            const salt = Base64.toUint8Array(kdfParams.salt);
                            if (kdfParams.name === app.constants.KDF_ARGON2) {
                                if (!(await app.utils.checkArgon2Ready())) {
                                    throw new Error(
                                        "Argon2 å‡½å¼åº«æœªæˆåŠŸè¼‰å…¥ï¼Œç„¡æ³•åŸ·è¡Œã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç€è¦½å™¨æ§åˆ¶å°ã€‚"
                                    );
                                }
                                const hash = await argon2.hash({
                                    pass: passphrase,
                                    salt: salt,
                                    time: kdfParams.iterations,
                                    mem: kdfParams.memory,
                                    parallelism: kdfParams.parallelism,
                                    hashLen: 32,
                                    type: argon2.ArgonType.Argon2id,
                                });
                                return hash.hash;
                            }
                            if (kdfParams.name === app.constants.KDF_PBKDF2) {
                                const keyMaterial = await crypto.subtle.importKey(
                                    "raw",
                                    new TextEncoder().encode(passphrase),
                                    { name: app.constants.KDF_PBKDF2 },
                                    false,
                                    ["deriveKey", "deriveBits"]
                                );
                                const usages =
                                    kdfParams.purpose === app.constants.OP_ENCRYPT ? ["encrypt"] : ["decrypt"];
                                if (kdfParams.cipher === app.constants.ALGO_AES_GCM) {
                                    return await crypto.subtle.deriveKey(
                                        {
                                            name: app.constants.KDF_PBKDF2,
                                            salt,
                                            iterations: kdfParams.iterations,
                                            hash: app.constants.HASH_SHA256,
                                        },
                                        keyMaterial,
                                        { name: app.constants.ALGO_AES_GCM, length: app.constants.KEY_LENGTH_BITS },
                                        false,
                                        usages
                                    );
                                } else {
                                    const derivedBits = await crypto.subtle.deriveBits(
                                        {
                                            name: app.constants.KDF_PBKDF2,
                                            salt,
                                            iterations: kdfParams.iterations,
                                            hash: app.constants.HASH_SHA256,
                                        },
                                        keyMaterial,
                                        app.constants.KEY_LENGTH_BITS
                                    );
                                    return new Uint8Array(derivedBits);
                                }
                            }
                            throw new Error("ä¸æ”¯æ´çš„å¯†é‘°è¡ç”Ÿæ¼”ç®—æ³•ã€‚");
                        },
                        async encrypt(dataToEncrypt, passphrase, selectedCipher, selectedKDF) {
                            const salt = crypto.getRandomValues(new Uint8Array(app.constants.SALT_BYTES));
                            let kdfParams, derivedKey, keyDerivationJson;
                            if (selectedKDF === app.constants.KDF_ARGON2) {
                                kdfParams = {
                                    name: app.constants.KDF_ARGON2,
                                    salt: Base64.fromUint8Array(salt, true),
                                    iterations: parseInt(app.elements.argon2Iterations.value, 10),
                                    memory: parseInt(app.elements.argon2Memory.value, 10) * 1024,
                                    parallelism: parseInt(app.elements.argon2Parallelism.value, 10),
                                };
                                derivedKey = await this.deriveKey(passphrase, kdfParams);
                                keyDerivationJson = {
                                    name: kdfParams.name,
                                    iterations: kdfParams.iterations,
                                    memory: kdfParams.memory,
                                    parallelism: kdfParams.parallelism,
                                };
                            } else {
                                kdfParams = {
                                    name: app.constants.KDF_PBKDF2,
                                    salt: Base64.fromUint8Array(salt, true),
                                    iterations: app.constants.PBKDF2_ITERATIONS,
                                    purpose: app.constants.OP_ENCRYPT,
                                    cipher: selectedCipher,
                                };
                                derivedKey = await this.deriveKey(passphrase, kdfParams);
                                keyDerivationJson = {
                                    name: app.constants.KDF_PBKDF2,
                                    iterations: kdfParams.iterations,
                                    hash: app.constants.HASH_SHA256,
                                };
                            }

                            const tempJsonForAad = {
                                version: app.constants.VERSION,
                                keyDerivation: { ...keyDerivationJson },
                                encryption: { name: selectedCipher },
                            };
                            const aad = this._buildAad(tempJsonForAad);

                            let encryptionOutput;
                            const nonce = crypto.getRandomValues(new Uint8Array(app.constants.NONCE_BYTES));

                            if (selectedCipher === app.constants.ALGO_AES_GCM) {
                                const aesKey =
                                    derivedKey instanceof CryptoKey
                                        ? derivedKey
                                        : await crypto.subtle.importKey(
                                              "raw",
                                              derivedKey,
                                              { name: app.constants.ALGO_AES_GCM },
                                              false,
                                              ["encrypt"]
                                          );
                                const encryptedBuffer = await crypto.subtle.encrypt(
                                    {
                                        name: app.constants.ALGO_AES_GCM,
                                        iv: nonce,
                                        tagLength: app.constants.TAG_LENGTH_BITS,
                                        additionalData: aad,
                                    },
                                    aesKey,
                                    dataToEncrypt
                                );
                                const ciphertext = encryptedBuffer.slice(
                                    0,
                                    encryptedBuffer.byteLength - app.constants.TAG_BYTES
                                );
                                const tag = encryptedBuffer.slice(encryptedBuffer.byteLength - app.constants.TAG_BYTES);
                                encryptionOutput = {
                                    name: app.constants.ALGO_AES_GCM,
                                    nonce: Base64.fromUint8Array(nonce, true),
                                    ciphertext: Base64.fromUint8Array(new Uint8Array(ciphertext), true),
                                    tag: Base64.fromUint8Array(new Uint8Array(tag), true),
                                };
                            } else {
                                // ChaCha20-Poly1305
                                const chachaKeyBytes = derivedKey;
                                const ciphertextWithTag = chacha20poly1305(chachaKeyBytes, nonce, aad).encrypt(
                                    new Uint8Array(dataToEncrypt)
                                );
                                const ciphertext = ciphertextWithTag.slice(
                                    0,
                                    ciphertextWithTag.length - app.constants.TAG_BYTES
                                );
                                const tag = ciphertextWithTag.slice(ciphertextWithTag.length - app.constants.TAG_BYTES);
                                encryptionOutput = {
                                    name: app.constants.ALGO_CHACHA,
                                    nonce: Base64.fromUint8Array(nonce, true),
                                    ciphertext: Base64.fromUint8Array(ciphertext, true),
                                    tag: Base64.fromUint8Array(tag, true),
                                };
                            }
                            const finalJson = {
                                version: app.constants.VERSION,
                                keyDerivation: { ...keyDerivationJson, salt: Base64.fromUint8Array(salt, true) },
                                encryption: encryptionOutput,
                            };
                            const finalBase64 = Base64.encode(JSON.stringify(finalJson), true);
                            return { finalBase64, jsonOutput: finalJson };
                        },
                        async decrypt(base64Cipher, passphrase) {
                            const jsonStr = Base64.decode(base64Cipher);
                            const json = JSON.parse(jsonStr);
                            if (!json.keyDerivation || !json.encryption || json.version !== app.constants.VERSION) {
                                throw new Error("ç„¡æ•ˆæˆ–ä¸æ”¯æ´çš„å¯†æ–‡æ ¼å¼ (åƒ…æ”¯æ´ v3.0)ã€‚");
                            }

                            const kdfParams = {
                                name: json.keyDerivation.name,
                                salt: json.keyDerivation.salt,
                                iterations: json.keyDerivation.iterations,
                                memory: json.keyDerivation.memory,
                                parallelism: json.keyDerivation.parallelism,
                                purpose: app.constants.OP_DECRYPT,
                                cipher: json.encryption.name,
                            };
                            const key = await this.deriveKey(passphrase, kdfParams);
                            const enc = json.encryption;
                            const aad = this._buildAad(json);
                            const nonce = Base64.toUint8Array(enc.nonce);
                            const ciphertext = Base64.toUint8Array(enc.ciphertext);
                            const tag = Base64.toUint8Array(enc.tag);

                            try {
                                if (enc.name === app.constants.ALGO_AES_GCM) {
                                    const aesKey =
                                        key instanceof CryptoKey
                                            ? key
                                            : await crypto.subtle.importKey(
                                                  "raw",
                                                  key,
                                                  { name: app.constants.ALGO_AES_GCM },
                                                  false,
                                                  ["decrypt"]
                                              );
                                    const combinedBuffer = new Uint8Array(ciphertext.length + tag.length);
                                    combinedBuffer.set(ciphertext, 0);
                                    combinedBuffer.set(tag, ciphertext.length);
                                    return await crypto.subtle.decrypt(
                                        {
                                            name: app.constants.ALGO_AES_GCM,
                                            iv: nonce,
                                            tagLength: app.constants.TAG_LENGTH_BITS,
                                            additionalData: aad,
                                        },
                                        aesKey,
                                        combinedBuffer
                                    );
                                } else if (enc.name === app.constants.ALGO_CHACHA) {
                                    const chachaKeyBytes =
                                        key instanceof Uint8Array ? key : await crypto.subtle.exportKey("raw", key);
                                    const combinedCiphertext = new Uint8Array(ciphertext.length + tag.length);
                                    combinedCiphertext.set(ciphertext);
                                    combinedCiphertext.set(tag, ciphertext.length);
                                    return chacha20poly1305(chachaKeyBytes, nonce, aad).decrypt(combinedCiphertext);
                                }
                                throw new Error("ä¸æ”¯æ´çš„è§£å¯†æ¼”ç®—æ³•ã€‚");
                            } catch (e) {
                                if (this._isAuthError(e)) {
                                    throw new Error("å¯†ç¢¼çŸ­èªä¸æ­£ç¢ºï¼Œæˆ–å¯†æ–‡å·²è¢«ç«„æ”¹ã€‚");
                                }
                                throw e;
                            }
                        },
                        async encryptText() {
                            const mnemonic = app.elements.mnemonic.value.trim();
                            const passphrase = app.elements.passphraseEncrypt.value;
                            if (!mnemonic || !passphrase) return app.utils.showToast("âŒ æ˜æ–‡å’Œå¯†ç¢¼çŸ­èªä¸èƒ½ç‚ºç©ºã€‚");

                            // NEW: Security checks
                            if (!app.utils.runSecurityChecks(passphrase, app.state.selectedKDF)) return;

                            app.ui.setOutput("info", "â³ æ­£åœ¨åŠ å¯†ï¼Œè«‹ç¨å€™...");
                            await new Promise((r) => setTimeout(r, 50));
                            const startTime = performance.now();
                            try {
                                const { finalBase64, jsonOutput } = await this.encrypt(
                                    new TextEncoder().encode(mnemonic),
                                    passphrase,
                                    app.state.selectedAlgorithm,
                                    app.state.selectedKDF
                                );
                                const duration = ((performance.now() - startTime) / 1000).toFixed(3);
                                app.state.lastEncryptedOutput = finalBase64;
                                app.ui.setOutput("success", `âœ… åŠ å¯†æˆåŠŸï¼ (è™•ç†æ™‚é–“ï¼š${duration} ç§’)`);

                                // NEW: Self-verification
                                if (app.elements.selfVerifyCheckbox.checked) {
                                    app.ui.setOutput("info", `âœ… åŠ å¯†æˆåŠŸï¼<br>...æ­£åœ¨é€²è¡Œè‡ªæˆ‘é©—è­‰...`);
                                    await new Promise((r) => setTimeout(r, 20)); // UI update
                                    try {
                                        await this.decrypt(finalBase64, passphrase);
                                        app.ui.setOutput(
                                            "success",
                                            `âœ… åŠ å¯†èˆ‡é©—è­‰å‡æˆåŠŸï¼ (ç¸½æ™‚é–“ï¼š${(
                                                (performance.now() - startTime) /
                                                1000
                                            ).toFixed(3)} ç§’)`
                                        );
                                    } catch (verifyError) {
                                        app.ui.setOutput(
                                            "error",
                                            `âŒ åš´é‡éŒ¯èª¤ï¼šåŠ å¯†å¾Œé©—è­‰å¤±æ•—ï¼è«‹å‹¿ä½¿ç”¨æ­¤å¯†æ–‡ï¼Œä¸¦å›å ±æ­¤å•é¡Œã€‚<br>éŒ¯èª¤è¨Šæ¯ï¼š${verifyError.message}`
                                        );
                                        return;
                                    }
                                }

                                app.elements.base64ResultView.value = finalBase64;
                                app.elements.jsonView.value = JSON.stringify(jsonOutput, null, 2);
                                app.elements.qrCanvas.hidden = finalBase64.length >= app.constants.QR_CODE_MAX_BYTES;
                                if (!app.elements.qrCanvas.hidden) {
                                    QRCode.toCanvas(app.elements.qrCanvas, finalBase64, {
                                        errorCorrectionLevel: "L",
                                        width: 320,
                                    });
                                }
                            } catch (e) {
                                app.ui.setOutput("error", `âŒ åŠ å¯†å¤±æ•—ï¼š${e.message}`);
                            }
                        },
                        async decryptText() {
                            const base64Cipher = app.elements.ciphertextInput.value.trim();
                            const passphrase = app.elements.passphraseDecrypt.value;
                            if (!base64Cipher || !passphrase) return app.utils.showToast("âŒ å¯†æ–‡å’Œå¯†ç¢¼çŸ­èªä¸èƒ½ç‚ºç©ºã€‚");
                            app.ui.setOutput("info", "â³ æ­£åœ¨è§£å¯†ï¼Œè«‹ç¨å€™...");
                            await new Promise((r) => setTimeout(r, 50));
                            const startTime = performance.now();
                            try {
                                const decryptedBytes = await this.decrypt(base64Cipher, passphrase);
                                const duration = ((performance.now() - startTime) / 1000).toFixed(3);
                                const decryptedText = new TextDecoder().decode(decryptedBytes);
                                app.state.lastDecryptedText = decryptedText;
                                let successMessage = `âœ… è§£å¯†æˆåŠŸ (è™•ç†æ™‚é–“ï¼š${duration} ç§’)<br><br><strong style="font-size: 1.1em; white-space: pre-wrap; word-break: break-word;">${decryptedText}</strong>`;
                                app.ui.setOutput("success", successMessage);
                            } catch (e) {
                                app.ui.setOutput("error", `âŒ è§£å¯†å¤±æ•—ï¼š${e.message}`);
                            }
                        },
                        async encryptFile() {
                            const file = app.state.fileToEncrypt;
                            const passphrase = app.elements.passphraseFileEncrypt.value;
                            if (!file || !passphrase) return app.utils.showToast("âŒ è«‹é¸æ“‡æª”æ¡ˆä¸¦è¼¸å…¥å¯†ç¢¼çŸ­èªã€‚");

                            // NEW: Security checks
                            const fileKDF = app.constants.KDF_ARGON2;
                            if (!app.utils.runSecurityChecks(passphrase, fileKDF, true)) return;

                            app.ui.setOutput("info", `â³ æ­£åœ¨ä½¿ç”¨ ${fileKDF} åŠ å¯†æª”æ¡ˆ ${file.name}ï¼Œè«‹ç¨å€™...`);
                            await new Promise((r) => setTimeout(r, 50));
                            const startTime = performance.now();
                            try {
                                const fileBuffer = await app.fileHandler.readFileAsArrayBuffer(file);
                                const { finalBase64 } = await this.encrypt(
                                    fileBuffer,
                                    passphrase,
                                    app.state.selectedAlgorithm,
                                    fileKDF
                                );
                                let duration = ((performance.now() - startTime) / 1000).toFixed(3);
                                app.ui.setOutput("success", `âœ… æª”æ¡ˆåŠ å¯†æˆåŠŸï¼ (è™•ç†æ™‚é–“ï¼š${duration} ç§’)`);

                                // NEW: Self-verification for files
                                if (app.elements.selfVerifyFileCheckbox.checked) {
                                    app.ui.setOutput("info", `âœ… æª”æ¡ˆåŠ å¯†æˆåŠŸï¼<br>...æ­£åœ¨é€²è¡Œè‡ªæˆ‘é©—è­‰...`);
                                    await new Promise((r) => setTimeout(r, 20)); // UI update
                                    try {
                                        await this.decrypt(finalBase64, passphrase);
                                        duration = ((performance.now() - startTime) / 1000).toFixed(3);
                                        app.ui.setOutput(
                                            "success",
                                            `âœ… æª”æ¡ˆåŠ å¯†èˆ‡é©—è­‰å‡æˆåŠŸï¼å·²é–‹å§‹ä¸‹è¼‰ã€‚ (ç¸½æ™‚é–“: ${duration} ç§’)`
                                        );
                                    } catch (verifyError) {
                                        app.ui.setOutput(
                                            "error",
                                            `âŒ åš´é‡éŒ¯èª¤ï¼šæª”æ¡ˆåŠ å¯†å¾Œé©—è­‰å¤±æ•—ï¼è«‹å‹¿ä½¿ç”¨æ­¤æª”æ¡ˆã€‚<br>éŒ¯èª¤è¨Šæ¯ï¼š${verifyError.message}`
                                        );
                                        return;
                                    }
                                }

                                app.utils.downloadAsFile(finalBase64, file.name + ".enc");
                                if (!app.elements.selfVerifyFileCheckbox.checked) {
                                    app.ui.setOutput(
                                        "success",
                                        `âœ… æª”æ¡ˆåŠ å¯†æˆåŠŸï¼å·²é–‹å§‹ä¸‹è¼‰ ${file.name + ".enc"} (è™•ç†æ™‚é–“ï¼š${duration} ç§’)`
                                    );
                                }
                            } catch (e) {
                                app.ui.setOutput("error", `âŒ æª”æ¡ˆåŠ å¯†å¤±æ•—ï¼š${e.message}`);
                            }
                        },
                        async decryptFile() {
                            const file = app.state.fileToDecrypt;
                            const passphrase = app.elements.passphraseFileDecrypt.value;
                            if (!file || !passphrase) return app.utils.showToast("âŒ è«‹é¸æ“‡æª”æ¡ˆä¸¦è¼¸å…¥å¯†ç¢¼çŸ­èªã€‚");
                            app.ui.setOutput("info", `â³ æ­£åœ¨è§£å¯†æª”æ¡ˆ ${file.name}ï¼Œè«‹ç¨å€™...`);
                            await new Promise((r) => setTimeout(r, 50));
                            const startTime = performance.now();
                            try {
                                const base64Cipher = await app.fileHandler.readFileAsText(file);
                                const decryptedBytes = await this.decrypt(base64Cipher, passphrase);
                                const duration = ((performance.now() - startTime) / 1000).toFixed(3);
                                const originalFilename = file.name.endsWith(".enc")
                                    ? file.name.slice(0, -4)
                                    : `decrypted-${file.name}`;
                                app.utils.downloadAsFile(new Blob([decryptedBytes]), originalFilename);
                                let successMessage = `âœ… æª”æ¡ˆè§£å¯†æˆåŠŸï¼å·²é–‹å§‹ä¸‹è¼‰ ${originalFilename} (è™•ç†æ™‚é–“ï¼š${duration} ç§’)`;
                                app.ui.setOutput("success", successMessage);
                            } catch (e) {
                                app.ui.setOutput("error", `âŒ è§£å¯†å¤±æ•—ï¼š${e.message}`);
                            }
                        },
                        async parseParameters() {
                            const base64Cipher = app.elements.ciphertextInput.value.trim();
                            if (!base64Cipher) return app.utils.showToast("è«‹å…ˆè²¼ä¸Šå¯†æ–‡");
                            try {
                                const json = JSON.parse(Base64.decode(base64Cipher));
                                const kd = json.keyDerivation;
                                const enc = json.encryption;
                                if (!kd || !enc) throw new Error("JSON çµæ§‹ä¸ç¬¦");
                                let kdfDetails = `${kd.name}`;
                                if (kd.name === app.constants.KDF_PBKDF2) {
                                    kdfDetails += ` (${kd.hash}, ${kd.iterations.toLocaleString("en-US")} è¿­ä»£)`;
                                } else if (kd.name === app.constants.KDF_ARGON2) {
                                    kdfDetails += ` (mem: ${kd.memory / 1024}MB, iter: ${kd.iterations}, parallel: ${
                                        kd.parallelism
                                    })`;
                                }
                                const versionInfo =
                                    json.version === app.constants.VERSION
                                        ? `v${json.version}`
                                        : `ä¸æ”¯æ´çš„ç‰ˆæœ¬ (${json.version})`;
                                app.elements.paramsDisplayArea.innerHTML = `<p>æ ¼å¼ç‰ˆæœ¬ï¼š<span>${versionInfo}</span></p>
                                 <p>é‡‘é‘°è¡ç”Ÿï¼š<span>${kdfDetails}</span></p>
                                 <p>åŠ å¯†æ¼”ç®—æ³•ï¼š<span>${enc.name}</span></p>
                                 <p style="color: var(--success-color);">ç‹€æ…‹ï¼š<span>åƒæ•¸å·²è¼‰å…¥ âœ…</span></p>`;
                                app.elements.paramsDisplayArea.hidden = false;
                            } catch (e) {
                                app.elements.paramsDisplayArea.innerHTML = `<p style="color: var(--error-color);">âŒ è§£æå¤±æ•—ï¼šç„¡æ•ˆçš„å¯†æ–‡æ ¼å¼ã€‚</p>`;
                                app.elements.paramsDisplayArea.hidden = false;
                            }
                        },
                    },
                    utils: {
                        copyFromResult() {
                            if (app.state.lastEncryptedOutput) {
                                navigator.clipboard.writeText(app.state.lastEncryptedOutput).then(
                                    () => this.showToast("âœ… å·²è¤‡è£½ Base64 å¯†æ–‡ï¼"),
                                    () => this.showToast("âŒ è¤‡è£½å¤±æ•—")
                                );
                            }
                        },
                        copyDecryptedResult() {
                            if (app.state.lastDecryptedText) {
                                navigator.clipboard.writeText(app.state.lastDecryptedText).then(
                                    () => this.showToast("âœ… å·²è¤‡è£½è§£å¯†çµæœï¼"),
                                    () => this.showToast("âŒ è¤‡è£½å¤±æ•—")
                                );
                            }
                        },
                        pasteTo(elementId) {
                            navigator.clipboard.readText().then(
                                (text) => {
                                    app.elements[elementId].value = text;
                                    this.showToast("âœ… å·²è²¼ä¸Šå…§å®¹ï¼");
                                },
                                () => this.showToast("âŒ è²¼ä¸Šå¤±æ•—")
                            );
                        },
                        downloadAsFile(content, filename) {
                            const blob =
                                content instanceof Blob
                                    ? content
                                    : new Blob([content], { type: "application/octet-stream" });
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement("a");
                            link.href = url;
                            link.download = filename;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        },
                        showToast(message) {
                            if (app.state.toastTimer) clearTimeout(app.state.toastTimer);
                            app.elements.toast.textContent = message;
                            app.elements.toast.className = "show";
                            app.state.toastTimer = setTimeout(() => {
                                app.elements.toast.className = "";
                                app.state.toastTimer = null;
                            }, 3000);
                        },
                        async checkArgon2Ready() {
                            if (typeof argon2 !== "undefined") return true;
                            return new Promise((resolve) => {
                                setTimeout(() => {
                                    if (typeof argon2 !== "undefined") {
                                        resolve(true);
                                    } else {
                                        resolve(false);
                                    }
                                }, 1000);
                            });
                        },
                        // NEW: Security check suite
                        runSecurityChecks(passphrase, selectedKDF, isFile = false) {
                            // 1. Weak password check
                            // const strength = this.checkPasswordStrength(passphrase);
                            // if (strength.level === "weak") {
                            //     if (
                            //         !window.confirm(
                            //             "âš ï¸ è­¦å‘Šï¼šæ‚¨ä½¿ç”¨çš„å¯†ç¢¼å¼·åº¦è¼ƒå¼±ï¼Œå¯èƒ½å®¹æ˜“è¢«ç ´è§£ã€‚\n\nç¢ºå®šè¦ç¹¼çºŒä½¿ç”¨æ­¤å¯†ç¢¼å—ï¼Ÿ"
                            //         )
                            //     ) {
                            //         return false;
                            //     }`
                            // }
                            // 2. Parameter sanity check
                            if (selectedKDF === app.constants.KDF_ARGON2) {
                                const mem = parseInt(app.elements.argon2Memory.value, 10);
                                const iter = parseInt(app.elements.argon2Iterations.value, 10);
                                const para = parseInt(app.elements.argon2Parallelism.value, 10);
                                if (
                                    mem < app.constants.ARGON2_MIN_MEM_MB ||
                                    iter < app.constants.ARGON2_MIN_ITER ||
                                    para < app.constants.ARGON2_MIN_PARA
                                ) {
                                    this.showToast("âŒ å®‰å…¨æ€§è­¦å‘Šï¼šArgon2 åƒæ•¸éä½ï¼");
                                    return false;
                                }
                            }
                            return true;
                        },
                        // NEW: Password strength logic
                        checkPasswordStrength(password) {
                            let score = 0;
                            let message = "";
                            let level = "empty";

                            if (password.length === 0) {
                                return { score: 0, message: "", level: "empty" };
                            }

                            // Score based on length
                            if (password.length >= 8) score += 25;
                            if (password.length >= 12) score += 25;

                            // Score based on character types
                            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score += 20; // Lower & Upper
                            if (/\d/.test(password)) score += 15; // Numbers
                            if (/[^a-zA-Z0-9]/.test(password)) score += 15; // Symbols

                            score = Math.min(score, 100);

                            if (score < 50) {
                                message = "å¼·åº¦ï¼šå¼±";
                                level = "weak";
                            } else if (score < 85) {
                                message = "å¼·åº¦ï¼šä¸­ç­‰";
                                level = "medium";
                            } else {
                                message = "å¼·åº¦ï¼šå¼·";
                                level = "strong";
                            }

                            return { score, message, level };
                        },
                    },
                    theme: {
                        init() {
                            const t = localStorage.getItem("my-app-theme") || "dark";
                            this.apply(t);
                        },
                        apply(t) {
                            document.documentElement.setAttribute("data-theme", t);
                            app.elements.themeToggleBtn.textContent = t === "dark" ? "â˜€ï¸" : "ğŸŒ™";
                            localStorage.setItem("my-app-theme", t);
                        },
                        toggle() {
                            const t = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
                            this.apply(t);
                        },
                    },
                    accordion: {
                        toggle(h) {
                            const isOpen = h.classList.contains("active");
                            h.classList.toggle("active");
                            h.setAttribute("aria-expanded", !isOpen);
                            h.nextElementSibling.setAttribute("aria-hidden", isOpen);
                        },
                    },
                };
                app.init();
            });
        </script>
    </body>
</html>
