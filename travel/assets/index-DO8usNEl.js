(function(){const y=document.createElement("link").relList;if(y&&y.supports&&y.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))m(o);new MutationObserver(o=>{for(const d of o)if(d.type==="childList")for(const b of d.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&m(b)}).observe(document,{childList:!0,subtree:!0});function f(o){const d={};return o.integrity&&(d.integrity=o.integrity),o.referrerPolicy&&(d.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?d.credentials="include":o.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function m(o){if(o.ep)return;o.ep=!0;const d=f(o);fetch(o.href,d)}})();function I(p){return p?p.toString().replace(/[&<>"']/g,y=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[y]):""}function ie(p,y){let f;return function(...m){const o=this;clearTimeout(f),f=setTimeout(()=>p.apply(o,m),y)}}class se{dbInstance=null;DB_NAME="TravelItinerariesDB_v3";STORE_NAME="itineraries";async init(){return this.dbInstance?this.dbInstance:new Promise((y,f)=>{const m=indexedDB.open(this.DB_NAME,1);m.onerror=o=>f("è³‡æ–™åº«é–‹å•Ÿå¤±æ•—",o.target.error),m.onsuccess=o=>{this.dbInstance=o.target.result,y(this.dbInstance)},m.onupgradeneeded=o=>{const d=o.target.result;d.objectStoreNames.contains(this.STORE_NAME)||d.createObjectStore(this.STORE_NAME,{keyPath:"id"})}})}async getStore(y="readonly"){return this.dbInstance||await this.init(),this.dbInstance.transaction(this.STORE_NAME,y).objectStore(this.STORE_NAME)}async saveItinerary(y){const f=await this.getStore("readwrite");return new Promise((m,o)=>{const d=f.put(y);d.onsuccess=m,d.onerror=o})}async deleteItinerary(y){const f=await this.getStore("readwrite");return new Promise((m,o)=>{const d=f.delete(y);d.onsuccess=m,d.onerror=o})}async getItineraries(){const y=await this.getStore();return new Promise((f,m)=>{const o=y.getAll();o.onsuccess=()=>f(o.result),o.onerror=m})}async getItineraryById(y){const f=await this.getStore();return new Promise((m,o)=>{const d=f.get(y);d.onsuccess=()=>m(d.result),d.onerror=o})}}document.addEventListener("DOMContentLoaded",()=>{const p=new se,y={apiKey:"AIzaSyCavD0SHOLcQBwjJJ3aCGCY7Po-t4QR31k",authDomain:"travel-itinerary-helper.firebaseapp.com",projectId:"travel-itinerary-helper",storageBucket:"travel-itinerary-helper.firebasestorage.app",messagingSenderId:"853427118697",appId:"1:853427118697:web:c2d4520a4fc565b98438f8",measurementId:"G-MG8CXYLNBE"};let f,m,o,d,b;const G=document.getElementById("map"),J=document.getElementById("itinerary-panel"),N=document.getElementById("panel-handle"),w=document.getElementById("itinerary-list"),A=document.getElementById("date-filters"),D=document.getElementById("category-filters"),R=document.getElementById("itinerary-title"),P=document.getElementById("add-location-container"),V=document.getElementById("map-offline-placeholder"),W=document.getElementById("filters"),q=document.getElementById("filters-handle"),k=document.getElementById("coordinates-warning"),e={appMode:"cloud",firebaseUser:null,currentItinerary:null,filter:{date:"all",category:"all"},editingLocationId:null},$={sight:{name:"æ™¯é»",color:"var(--category-sight)"},stay:{name:"ä½å®¿",color:"var(--category-stay)"},transport:{name:"äº¤é€š",color:"var(--category-transport)"},food:{name:"é¤é£²",color:"var(--category-food)"},default:{name:"å…¶ä»–",color:"var(--category-default)"}};async function K(){try{firebase.initializeApp(y),f=firebase.auth(),m=firebase.firestore(),await f.getRedirectResult(),e.appMode="cloud",console.log("Firebase connected. Running in Cloud Mode."),f.onAuthStateChanged(n=>{e.firebaseUser=n,F(n),j(),n?u(`æ­¡è¿, ${n.email}!`,"success"):u("æ‚¨å·²ç™»å‡º")})}catch(n){console.error("Firebase connection failed:",n),e.appMode="local",console.log("Running in Local Mode."),F(null),j(),ee(!0),setTimeout(M,100)}}function F(n){const i=document.getElementById("user-info"),t=document.getElementById("guest-info"),r=document.getElementById("manage-itineraries-btn");e.appMode==="cloud"&&n?(document.getElementById("user-email").textContent=n.email,i.classList.remove("hidden"),t.classList.add("hidden"),r.disabled=!1):(i.classList.add("hidden"),t.classList.remove("hidden"),r.disabled=!1),e.appMode==="local"&&t.classList.add("hidden")}async function C(){if(!e.currentItinerary)return;if((e.currentItinerary.dataSource||"local")==="cloud"){if(e.appMode!=="cloud"||!e.firebaseUser)return u("ç„¡æ³•å„²å­˜é›²ç«¯è¡Œç¨‹ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šä¸¦é‡æ–°æ•´ç†","error");await m.collection("itineraries").doc(e.currentItinerary.id).set(e.currentItinerary,{merge:!0})}else await p.saveItinerary(e.currentItinerary);u("è¡Œç¨‹å·²å„²å­˜ï¼","success")}async function z(n,i){if(i==="cloud"){if(!e.firebaseUser)return u("è«‹å…ˆç™»å…¥","error");await m.collection("itineraries").doc(n).delete()}else await p.deleteItinerary(n)}function x(){if(!e.currentItinerary)return j();const n=e.currentItinerary.locations,i=Q();R.textContent=e.currentItinerary.name,P.classList.remove("hidden"),X(n),Y(n,i),Z(i),_(n)}function j(){e.currentItinerary=null;let n="è«‹å¾ã€Œç®¡ç†ã€å»ºç«‹æˆ–è¼‰å…¥ä¸€å€‹è¡Œç¨‹";e.appMode==="cloud"&&!e.firebaseUser&&(n="è«‹å…ˆç™»å…¥ä»¥ç®¡ç†æ‚¨çš„è¡Œç¨‹"),R.textContent="å°šæœªè¼‰å…¥è¡Œç¨‹",P.classList.add("hidden"),w.innerHTML=`<p class="empty-message">${n}</p>`,A.innerHTML="",D.innerHTML="",b&&b.clearLayers(),_([])}function Q(){return e.currentItinerary?e.currentItinerary.locations.filter(n=>(e.filter.date==="all"||n.date===e.filter.date)&&(e.filter.category==="all"||n.category===e.filter.category)):[]}function Y(n,i){if(e.appMode==="cloud"&&!e.firebaseUser&&n.length>0)return;if(n.length===0){w.innerHTML='<p class="empty-message">æ­¤è¡Œç¨‹æ²’æœ‰ä»»ä½•åœ°é»ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢ç¬¬ä¸€å€‹æ™¯é»å§ï¼</p>';return}const t=n.reduce((a,c)=>(a[c.date]||(a[c.date]=[]),a[c.date].push(c),a),{}),r=e.filter.date!=="all"||e.filter.category!=="all",s=Object.keys(t).sort().map(a=>{const l=t[a].map(g=>{const E=i.some(B=>B.id===g.id);if(r&&!E)return"";const S=$[g.category]||$.default,U=i.findIndex(B=>B.id===g.id),T=E?U+1:"â€¢",v=I(g.location);return`<div class="location-item" data-id="${g.id}" draggable="true"><span class="location-number" style="color: ${S.color};">${T}</span><p>${v}</p><span class="category-badge" style="background-color: ${S.color};">${S.name}</span><div class="location-controls"><button class="edit-btn" title="ç·¨è¼¯">âœï¸</button><button class="delete-btn" title="åˆªé™¤">ğŸ—‘ï¸</button></div></div>`}).join("");return l?`<div class="day-group"><div class="day-header">${a}</div>${l}</div>`:""}).join("");w.innerHTML=s||'<p class="empty-message">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„æ™¯é»ã€‚</p>'}function X(n){const t=[...new Set(n.map(a=>a.date))].sort().map(a=>`<button data-date="${a}" class="${e.filter.date===a?"active":""}">${a}</button>`).join("");A.innerHTML=`<button data-date="all" class="${e.filter.date==="all"?"active":""}">å…¨éƒ¨æ—¥æœŸ</button>${t}`;const s=[...new Set(n.map(a=>a.category))].map(a=>{const c=$[a]||$.default;return`<button data-category="${a}" class="${e.filter.category===a?"active":""}">${c.name}</button>`}).join("");D.innerHTML=`<button data-category="all" class="${e.filter.category==="all"?"active":""}">å…¨éƒ¨åˆ†é¡</button>${s}`}function Z(n){if(!o||(b.clearLayers(),n.length===0))return;const i=L.latLngBounds();n.forEach((t,r)=>{const s=$[t.category]||$.default,a=L.divIcon({html:`<div style="background-color: ${s.color}; width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; box-shadow: var(--shadow); display: flex; justify-content: center; align-items: center; color: white; font-size: 14px; font-weight: bold;">${r+1}</div>`,className:"custom-marker-icon",iconSize:[28,28],iconAnchor:[14,14]}),c=L.marker(t.coordinates,{icon:a}),l=`<b>${I(t.location)}</b><br>${I(t.description||"ç„¡æè¿°")}`;c.bindPopup(l),c.addTo(b),i.extend(t.coordinates)});for(let t=0;t<n.length-1;t++)n[t].date===n[t+1].date&&L.polyline([n[t].coordinates,n[t+1].coordinates],{color:"#3388ff",weight:3,opacity:.7}).addTo(b);i.isValid()&&o.fitBounds(i.pad(.2),{maxZoom:15})}function _(n){document.getElementById("stats-days").innerText=new Set(n.map(t=>t.date)).size,document.getElementById("stats-locations").innerText=n.length;let i=0;o&&n.forEach((t,r)=>{r>0&&t.date===n[r-1].date&&(i+=o.distance(t.coordinates,n[r-1].coordinates))}),document.getElementById("stats-distance").innerText=(i/1e3).toFixed(1)}function ee(n){const i=document.getElementById("offline-warning-banner"),t=document.getElementById("app-container"),r=document.getElementById("search-location-btn");i.classList.toggle("hidden",!n),t.classList.toggle("offline",n),document.documentElement.style.setProperty("--primary-color","#e67e22"),r&&(r.disabled=!0,r.title="é›¢ç·šæ¨¡å¼ä¸‹ç„¡æ³•ä½¿ç”¨æœå°‹åŠŸèƒ½"),te()}function te(n){o&&(V.classList.toggle("hidden",!1),o.hasLayer(d)&&o.removeLayer(d))}async function ne(){if(!e.currentItinerary)return;const n=document.getElementById("location-name").value,i=document.getElementById("location-date").value,t=document.getElementById("location-category").value,r=document.getElementById("location-description").value,s=document.getElementById("location-coordinates").value;if(!n||!i||!s){u("åœ°é»åç¨±ã€æ—¥æœŸå’Œåº§æ¨™ç‚ºå¿…å¡«é …","error");return}const a=s.split(",").map(Number);if(a.length!==2||isNaN(a[0])||isNaN(a[1])){u("åº§æ¨™æ ¼å¼ä¸æ­£ç¢º","error");return}const c={date:i,location:n,category:t,description:r,coordinates:a};if(e.editingLocationId){const l=e.currentItinerary.locations.findIndex(g=>g.id===e.editingLocationId);l>-1&&(e.currentItinerary.locations[l]={...e.currentItinerary.locations[l],...c})}else c.id=`loc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,e.currentItinerary.locations.push(c);e.currentItinerary.locations.sort((l,g)=>new Date(l.date)-new Date(g.date));try{await C(),u("æ™¯é»å·²å„²å­˜ï¼","success"),h(document.getElementById("edit-location-modal"),!1),x()}catch(l){u(`å„²å­˜å¤±æ•—: ${l.message}`,"error")}}const re=ie(async()=>{const n=document.getElementById("location-name").value;if(!n)return;const i=document.getElementById("location-search-results");i.innerHTML="æœå°‹ä¸­...";try{const t=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(n)}&limit=5`,{headers:{"User-Agent":"TravelItineraryHelper/3.0"}});if(!t.ok)throw new Error("API è«‹æ±‚å¤±æ•—");const r=await t.json();r.length===0?i.innerHTML="æ‰¾ä¸åˆ°çµæœ":i.innerHTML=r.map(s=>`<div class="search-result-item" data-lat="${s.lat}" data-lon="${s.lon}">${I(s.display_name)}</div>`).join("")}catch(t){i.innerHTML="æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤",u(t.message,"error")}},500);function O(n,i){n.dataSource=i,e.currentItinerary=n,e.filter={date:"all",category:"all"},x(),h(document.getElementById("itinerary-manager-modal"),!1)}async function M(){const n=document.getElementById("itinerary-manager-list");n.innerHTML="<li>è®€å–ä¸­...</li>",h(document.getElementById("itinerary-manager-modal"),!0);let i="";if(e.appMode==="cloud"&&e.firebaseUser){i+="<h3>é›²ç«¯è¡Œç¨‹</h3>";try{const s=(await m.collection("itineraries").where("ownerId","==",e.firebaseUser.uid).orderBy("createdAt","desc").get()).docs.map(a=>({id:a.id,...a.data()}));s.length>0?i+=s.map(a=>`<li class="itinerary-manager-item" data-id="${a.id}" data-name="${I(a.name)}" data-source="cloud"><span class="itinerary-manager-item-name">${I(a.name)}</span><div class="itinerary-manager-item-actions"><button class="load-btn">è¼‰å…¥</button><button class="delete-btn">åˆªé™¤</button></div></li>`).join(""):i+="<li>ç„¡é›²ç«¯è¡Œç¨‹</li>"}catch(r){i+="<li>è®€å–é›²ç«¯è¡Œç¨‹å¤±æ•—</li>",console.error(r)}}const t=e.appMode==="local"?"<h3>æœ¬åœ°è¡Œç¨‹</h3>":"<h3>é›¢ç·š/æœ¬åœ°è¡Œç¨‹</h3>";i+=t;try{const r=await p.getItineraries();r.length>0?i+=r.map(s=>`<li class="itinerary-manager-item" data-id="${s.id}" data-name="${I(s.name)}" data-source="local"><span class="itinerary-manager-item-name">${I(s.name)}</span><div class="itinerary-manager-item-actions"><button class="load-btn">è¼‰å…¥</button>${e.appMode==="cloud"&&e.firebaseUser?'<button class="upload-btn">ä¸Šå‚³è‡³é›²ç«¯</button>':""}<button class="delete-btn">åˆªé™¤</button></div></li>`).join(""):i+="<li>ç„¡æœ¬åœ°è¡Œç¨‹</li>"}catch(r){i+="<li>è®€å–æœ¬åœ°è¡Œç¨‹å¤±æ•—</li>",console.error(r)}n.innerHTML=i}function ae(){document.querySelectorAll(".close-modal-btn").forEach(t=>t.addEventListener("click",()=>h(t.closest(".modal-backdrop"),!1))),document.getElementById("show-login-btn").addEventListener("click",()=>h(document.getElementById("login-modal"),!0)),document.getElementById("logout-btn").addEventListener("click",()=>f.signOut()),document.getElementById("login-btn").addEventListener("click",async()=>{const t=document.getElementById("login-email").value,r=document.getElementById("login-password").value;if(!t||!r)return u("è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼","warning");try{await f.signInWithEmailAndPassword(t,r),h(document.getElementById("login-modal"),!1)}catch(s){u(`ç™»å…¥å¤±æ•—: ${s.message}`,"error")}}),document.getElementById("manage-itineraries-btn").addEventListener("click",M),document.getElementById("itinerary-manager-list").addEventListener("click",async t=>{const r=t.target,s=r.closest(".itinerary-manager-item");if(!s)return;const a=s.dataset.id,c=s.dataset.source,l=s.dataset.name;if(r.classList.contains("load-btn")){let g;if(c==="cloud"){const E=await m.collection("itineraries").doc(a).get();g={id:E.id,...E.data()}}else g=await p.getItineraryById(a);g&&O(g,c)}else if(r.classList.contains("delete-btn"))confirm(`ç¢ºå®šè¦å¾ ${c==="cloud"?"é›²ç«¯":"æœ¬æ©Ÿ"} åˆªé™¤è¡Œç¨‹ "${l}" å—ï¼Ÿ`)&&(await z(a,c),e.currentItinerary&&e.currentItinerary.id===a&&j(),u("è¡Œç¨‹å·²åˆªé™¤","success"),M());else if(r.classList.contains("upload-btn")){if(!e.firebaseUser)return u("è«‹å…ˆç™»å…¥æ‰èƒ½ä¸Šå‚³","error");const g=await p.getItineraryById(a);if(!g)return u("æ‰¾ä¸åˆ°æœ¬åœ°è¡Œç¨‹","error");g.ownerId=e.firebaseUser.uid,delete g.hash,delete g.salt,await m.collection("itineraries").doc(g.id).set(g),u("è¡Œç¨‹å·²æˆåŠŸä¸Šå‚³è‡³é›²ç«¯ï¼","success"),confirm("ä¸Šå‚³æˆåŠŸï¼Œè¦åˆªé™¤é€™å°é›»è…¦ä¸Šçš„æœ¬åœ°å‰¯æœ¬å—ï¼Ÿ")&&await z(a,"local"),M()}}),document.getElementById("create-new-itinerary-btn").addEventListener("click",()=>{document.getElementById("new-itinerary-name").value="",h(document.getElementById("create-itinerary-modal"),!0)}),document.getElementById("save-new-itinerary-btn").addEventListener("click",async()=>{const t=document.getElementById("new-itinerary-name").value;if(!t)return u("è«‹è¼¸å…¥è¡Œç¨‹åç¨±","error");if(e.appMode==="local"||!e.firebaseUser){const r={id:`local_${Date.now()}`,name:t,locations:[],createdAt:new Date().toISOString()};await p.saveItinerary(r),O(r,"local"),u("æœ¬åœ°è¡Œç¨‹å·²å»ºç«‹!","success")}else{const r={name:t,ownerId:e.firebaseUser.uid,createdAt:firebase.firestore.FieldValue.serverTimestamp(),locations:[]},s=await m.collection("itineraries").add(r);O({id:s.id,...r},"cloud"),u("é›²ç«¯è¡Œç¨‹å·²å»ºç«‹!","success")}h(document.getElementById("create-itinerary-modal"),!1),h(document.getElementById("itinerary-manager-modal"),!1)}),document.getElementById("add-location-btn").addEventListener("click",()=>{e.editingLocationId=null,document.getElementById("edit-location-title").textContent="æ–°å¢æ™¯é»";let t=new Date().toISOString().split("T")[0];e.currentItinerary.locations.length>0&&(t=e.currentItinerary.locations[e.currentItinerary.locations.length-1].date),document.getElementById("location-name").value="",document.getElementById("location-date").value=t,document.getElementById("location-category").value="sight",document.getElementById("location-description").value="",document.getElementById("location-coordinates").value="",document.getElementById("location-search-results").innerHTML="",k.classList.add("hidden"),h(document.getElementById("edit-location-modal"),!0)}),document.getElementById("save-location-btn").addEventListener("click",ne),document.getElementById("search-location-btn").addEventListener("click",re),document.getElementById("location-coordinates").addEventListener("input",()=>{k.classList.remove("hidden")}),document.getElementById("location-search-results").addEventListener("click",t=>{const r=t.target.closest(".search-result-item");r&&(document.getElementById("location-name").value=r.textContent,document.getElementById("location-coordinates").value=`${r.dataset.lat}, ${r.dataset.lon}`,document.getElementById("location-search-results").innerHTML="",k.classList.add("hidden"))}),w.addEventListener("click",t=>{if(e.appMode==="cloud"&&!e.firebaseUser&&!e.currentItinerary||!e.currentItinerary)return;const r=t.target,s=r.closest(".location-item");if(!s)return;const a=s.dataset.id,c=e.currentItinerary.locations.find(l=>l.id===a);r.closest(".edit-btn")?(e.editingLocationId=a,document.getElementById("edit-location-title").textContent="ç·¨è¼¯æ™¯é»",document.getElementById("location-name").value=c.location,document.getElementById("location-date").value=c.date,document.getElementById("location-category").value=c.category,document.getElementById("location-description").value=c.description,document.getElementById("location-coordinates").value=c.coordinates.join(", "),document.getElementById("location-search-results").innerHTML="",k.classList.add("hidden"),h(document.getElementById("edit-location-modal"),!0)):r.closest(".delete-btn")?confirm(`ç¢ºå®šè¦åˆªé™¤æ™¯é» "${c.location}" å—ï¼Ÿ`)&&(e.currentItinerary.locations=e.currentItinerary.locations.filter(l=>l.id!==a),C().then(()=>x())):c&&o.flyTo(c.coordinates,15)});let n=null;w.addEventListener("dragstart",t=>{if(e.appMode==="cloud"&&!e.firebaseUser&&!e.currentItinerary||!e.currentItinerary)return;const r=t.target.closest(".location-item");r&&(n=r.dataset.id,setTimeout(()=>r.classList.add("dragging"),0))}),w.addEventListener("dragover",t=>{n&&t.preventDefault()}),w.addEventListener("drop",t=>{if(!n)return;t.preventDefault();const r=t.target.closest(".location-item"),s=e.currentItinerary.locations.findIndex(c=>c.id===n);let a=e.currentItinerary.locations.findIndex(c=>c.id===r?.dataset.id);if(s!==-1&&a!==-1&&s!==a){const[c]=e.currentItinerary.locations.splice(s,1);e.currentItinerary.locations.splice(a,0,c),c.date=e.currentItinerary.locations[a].date,C().then(()=>x())}n=null,document.querySelector(".dragging")?.classList.remove("dragging")}),w.addEventListener("dragend",()=>{n=null,document.querySelector(".dragging")?.classList.remove("dragging")}),document.getElementById("filters").addEventListener("click",t=>{if(t.target.tagName!=="BUTTON")return;const r=t.target;r.dataset.date!==void 0&&(e.filter.date=r.dataset.date),r.dataset.category!==void 0&&(e.filter.category=r.dataset.category),x()}),N.addEventListener("click",()=>{J.classList.toggle("open"),N.classList.toggle("open"),o&&setTimeout(()=>o.invalidateSize(!0),300)}),q.addEventListener("click",()=>{W.classList.toggle("collapsed"),q.classList.toggle("collapsed")}),document.getElementById("export-json").addEventListener("click",()=>{if(!e.currentItinerary)return u("å°šæœªè¼‰å…¥è¡Œç¨‹","warning");const t=JSON.stringify(e.currentItinerary,null,4),r=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(r),a=document.createElement("a");a.href=s,a.download=`${e.currentItinerary.name}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)}),document.getElementById("export-printable").addEventListener("click",()=>{if(!e.currentItinerary||e.currentItinerary.locations.length===0)return u("æ²’æœ‰å¯åˆ—å°çš„è¡Œç¨‹è³‡æ–™","warning");const{name:t,locations:r}=e.currentItinerary;u("æ­£åœ¨æº–å‚™é è¦½é é¢...","normal");const s=r.reduce((v,B)=>(v[B.date]=v[B.date]||[],v[B.date].push(B),v),{}),a=document.getElementById("stats-days").innerText,c=document.getElementById("stats-locations").innerText,l=document.getElementById("stats-distance").innerText,g=`ç¸½å¤©æ•¸: ${a} å¤© | ç¸½åœ°é»: ${c} å€‹ | ç¸½è·é›¢: ${l} km`;let E='<table border=1 style="width:100%;border-collapse:collapse;font-size:12px;border-color:#ccc"><thead><tr style=background-color:#f2f2f2><th style="padding:8px;width:40px">#</th><th style=padding:8px>åœ°é»</th><th style="padding:8px;width:80px">åˆ†é¡</th><th style=padding:8px>æè¿°</th></tr></thead><tbody>',S=1;for(const v of Object.keys(s).sort()){const B=new Date(v).toLocaleDateString("zh-TW",{weekday:"long"});E+=`<tr style="background-color:#e9ecef;font-weight:bold"><td colspan=4 style="padding:10px;border-left:none;border-right:none">${v} (${B})</td></tr>`;for(const H of s[v])E+=`<tr><td style="padding:8px;text-align:center">${S++}</td><td style=padding:8px>${I(H.location)}</td><td style=padding:8px>${I($[H.category]?.name||"å…¶ä»–")}</td><td style=padding:8px>${I(H.description)}</td></tr>`}E+="</tbody></table>";const U=`<html><head><title>${I(t)} - å¯åˆ—å°ç‰ˆ</title><meta charset=UTF-8><style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;margin:20px}h1{color:#2c3e50}p{color:#333}table{border:1px solid #ccc}th,td{border:1px solid #ccc}@media print{@page{margin:20mm}body{margin:0;-webkit-print-color-adjust:exact;print-color-adjust:exact}h1,p{margin-bottom:15px}table{page-break-inside:auto}tr{page-break-inside:avoid;page-break-after:auto}}</style></head><body><h1>${I(t)}</h1><p>${I(g)}</p>${E}</body></html>`,T=window.open();T.document.write(U),T.document.close(),setTimeout(()=>T.print(),500)});const i=document.getElementById("json-file-input");document.getElementById("load-from-json-btn").addEventListener("click",()=>{i.click()}),i.addEventListener("change",t=>{const r=t.target.files[0];if(!r)return;const s=new FileReader;s.onload=async a=>{try{const c=a.target.result,l=JSON.parse(c);if(!l||!l.id||!l.name||!Array.isArray(l.locations))throw new Error("æª”æ¡ˆå…§å®¹ä¸¦éæœ‰æ•ˆçš„è¡Œç¨‹æ ¼å¼ã€‚");delete l.ownerId,l.dataSource="local",await p.saveItinerary(l),u("è¡Œç¨‹å·²æˆåŠŸå¾ JSON è¼‰å…¥ï¼","success"),M()}catch(c){console.error("è¼‰å…¥ JSON å¤±æ•—:",c),u(`è¼‰å…¥å¤±æ•—: ${c.message}`,"error")}finally{t.target.value=null}},s.onerror=()=>{u("è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤","error"),t.target.value=null},s.readAsText(r)})}function h(n,i){n&&n.classList.toggle("hidden",!i)}function u(n,i="normal"){const t=document.createElement("div");t.className=`toast-message ${i}`,t.textContent=n,document.body.appendChild(t),setTimeout(()=>t.classList.add("show"),10),setTimeout(()=>{t.classList.remove("show"),t.addEventListener("transitionend",()=>t.remove())},3e3)}function oe(){o=L.map(G).setView([25.105497,121.517594],10),d=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(o),b=L.layerGroup().addTo(o),ae(),K()}oe()});
