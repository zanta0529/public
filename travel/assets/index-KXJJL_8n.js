(function(){const b=document.createElement("link").relList;if(b&&b.supports&&b.supports("modulepreload"))return;for(const d of document.querySelectorAll('link[rel="modulepreload"]'))u(d);new MutationObserver(d=>{for(const c of d)if(c.type==="childList")for(const I of c.addedNodes)I.tagName==="LINK"&&I.rel==="modulepreload"&&u(I)}).observe(document,{childList:!0,subtree:!0});function f(d){const c={};return d.integrity&&(c.integrity=d.integrity),d.referrerPolicy&&(c.referrerPolicy=d.referrerPolicy),d.crossOrigin==="use-credentials"?c.credentials="include":d.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function u(d){if(d.ep)return;d.ep=!0;const c=f(d);fetch(d.href,c)}})();const T=(()=>{let $;const b="TravelItinerariesDB_v3",f="itineraries";async function u(){return new Promise((c,I)=>{const h=indexedDB.open(b,1);h.onerror=p=>I("è³‡æ–™åº«é–‹å•Ÿå¤±æ•—",p.target.error),h.onsuccess=p=>{$=p.target.result,c($)},h.onupgradeneeded=p=>{const g=p.target.result;g.objectStoreNames.contains(f)||g.createObjectStore(f,{keyPath:"id"})}})}async function d(c="readonly"){return $||await u(),$.transaction(f,c).objectStore(f)}return{init:u,async saveItinerary(c){const I=await d("readwrite");return new Promise((h,p)=>{const g=I.put(c);g.onsuccess=h,g.onerror=p})},async getItineraries(){const c=await d();return new Promise((I,h)=>{const p=c.getAll();p.onsuccess=()=>I(p.result),p.onerror=h})},async getItineraryById(c){const I=await d();return new Promise((h,p)=>{const g=I.get(c);g.onsuccess=()=>h(g.result),g.onerror=p})},async deleteItinerary(c){const I=await d("readwrite");return new Promise((h,p)=>{const g=I.delete(c);g.onsuccess=h,g.onerror=p})}}})();(()=>{const $=new TextEncoder;async function b(f,u){const d=await crypto.subtle.importKey("raw",$.encode(f),{name:"PBKDF2"},!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveBits({name:"PBKDF2",salt:u,iterations:1e5,hash:"SHA-256"},d,256)}return{async hashPassword(f){const u=crypto.getRandomValues(new Uint8Array(16)),d=await b(f,u);return{hash:Array.from(new Uint8Array(d)).map(h=>h.toString(16).padStart(2,"0")).join(""),salt:u}},async verifyPassword(f,u,d){const c=await b(f,u);return Array.from(new Uint8Array(c)).map(p=>p.toString(16).padStart(2,"0")).join("")===d}}})();document.addEventListener("DOMContentLoaded",()=>{const $={apiKey:void 0,authDomain:void 0,projectId:void 0,storageBucket:void 0,messagingSenderId:void 0,appId:void 0,measurementId:void 0};let b,f,u,d,c;const I=document.getElementById("map"),h=document.getElementById("itinerary-panel"),p=document.getElementById("panel-handle"),g=document.getElementById("itinerary-list"),N=document.getElementById("date-filters"),P=document.getElementById("category-filters"),q=document.getElementById("itinerary-title"),F=document.getElementById("add-location-container"),V=document.getElementById("map-offline-placeholder"),G=document.getElementById("filters"),R=document.getElementById("filters-handle"),t={appMode:"cloud",firebaseUser:null,currentItinerary:null,filter:{date:"all",category:"all"},editingLocationId:null},M={sight:{name:"æ™¯é»",color:"var(--category-sight)"},stay:{name:"ä½å®¿",color:"var(--category-stay)"},transport:{name:"äº¤é€š",color:"var(--category-transport)"},food:{name:"é¤é£²",color:"var(--category-food)"},default:{name:"å…¶ä»–",color:"var(--category-default)"}};async function J(){try{firebase.initializeApp($),b=firebase.auth(),f=firebase.firestore(),await b.getRedirectResult(),t.appMode="cloud",console.log("Firebase connected. Running in Cloud Mode."),b.onAuthStateChanged(n=>{t.firebaseUser=n,z(n),H(),n?m(`æ­¡è¿, ${n.email}!`,"success"):m("æ‚¨å·²ç™»å‡º")})}catch(n){console.error("Firebase connection failed:",n),t.appMode="local",console.log("Running in Local Mode."),z(null),H(),Y(!0),setTimeout(k,100)}}function z(n){const o=document.getElementById("user-info"),e=document.getElementById("guest-info"),r=document.getElementById("manage-itineraries-btn");t.appMode==="cloud"&&n?(document.getElementById("user-email").textContent=n.email,o.classList.remove("hidden"),e.classList.add("hidden"),r.disabled=!1):(o.classList.add("hidden"),e.classList.remove("hidden"),r.disabled=!1),t.appMode==="local"&&e.classList.add("hidden")}async function A(){if(!t.currentItinerary)return;if((t.currentItinerary.dataSource||"local")==="cloud"){if(t.appMode!=="cloud"||!t.firebaseUser)return m("ç„¡æ³•å„²å­˜é›²ç«¯è¡Œç¨‹ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šä¸¦é‡æ–°æ•´ç†","error");await f.collection("itineraries").doc(t.currentItinerary.id).set(t.currentItinerary,{merge:!0})}else await T.saveItinerary(t.currentItinerary);m("è¡Œç¨‹å·²å„²å­˜ï¼","success")}async function _(n,o){if(o==="cloud"){if(!t.firebaseUser)return m("è«‹å…ˆç™»å…¥","error");await f.collection("itineraries").doc(n).delete()}else await T.deleteItinerary(n)}function S(){if(!t.currentItinerary)return H();const n=t.currentItinerary.locations,o=W();q.textContent=t.currentItinerary.name,F.classList.remove("hidden"),Q(n),Z(n,o),X(o),K(n)}function H(){t.currentItinerary=null;let n="è«‹å¾ã€Œç®¡ç†ã€å»ºç«‹æˆ–è¼‰å…¥ä¸€å€‹è¡Œç¨‹";t.appMode==="cloud"&&!t.firebaseUser&&(n="è«‹å…ˆç™»å…¥ä»¥ç®¡ç†æ‚¨çš„è¡Œç¨‹"),q.textContent="å°šæœªè¼‰å…¥è¡Œç¨‹",F.classList.add("hidden"),g.innerHTML=`<p class="empty-message">${n}</p>`,N.innerHTML="",P.innerHTML="",c&&c.clearLayers(),K([])}function W(){return t.currentItinerary?t.currentItinerary.locations.filter(n=>(t.filter.date==="all"||n.date===t.filter.date)&&(t.filter.category==="all"||n.category===t.filter.category)):[]}function Z(n,o){if(t.appMode==="cloud"&&!t.firebaseUser&&n.length>0)return;if(n.length===0){g.innerHTML='<p class="empty-message">æ­¤è¡Œç¨‹æ²’æœ‰ä»»ä½•åœ°é»ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢ç¬¬ä¸€å€‹æ™¯é»å§ï¼</p>';return}const e=n.reduce((a,s)=>(a[s.date]||(a[s.date]=[]),a[s.date].push(s),a),{}),r=t.filter.date!=="all"||t.filter.category!=="all",i=Object.keys(e).sort().map(a=>{const l=e[a].map(y=>{const B=o.some(x=>x.id===y.id);if(r&&!B)return"";const j=M[y.category]||M.default,O=o.findIndex(x=>x.id===y.id),U=B?O+1:"â€¢",w=E(y.location);return`<div class="location-item" data-id="${y.id}" draggable="true"><span class="location-number" style="color: ${j.color};">${U}</span><p>${w}</p><span class="category-badge" style="background-color: ${j.color};">${j.name}</span><div class="location-controls"><button class="edit-btn" title="ç·¨è¼¯">âœï¸</button><button class="delete-btn" title="åˆªé™¤">ğŸ—‘ï¸</button></div></div>`}).join("");return l?`<div class="day-group"><div class="day-header">${a}</div>${l}</div>`:""}).join("");g.innerHTML=i||'<p class="empty-message">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„æ™¯é»ã€‚</p>'}function Q(n){const e=[...new Set(n.map(a=>a.date))].sort().map(a=>`<button data-date="${a}" class="${t.filter.date===a?"active":""}">${a}</button>`).join("");N.innerHTML=`<button data-date="all" class="${t.filter.date==="all"?"active":""}">å…¨éƒ¨æ—¥æœŸ</button>${e}`;const i=[...new Set(n.map(a=>a.category))].map(a=>{const s=M[a]||M.default;return`<button data-category="${a}" class="${t.filter.category===a?"active":""}">${s.name}</button>`}).join("");P.innerHTML=`<button data-category="all" class="${t.filter.category==="all"?"active":""}">å…¨éƒ¨åˆ†é¡</button>${i}`}function X(n){if(!u||(c.clearLayers(),n.length===0))return;const o=L.latLngBounds();n.forEach((e,r)=>{const i=M[e.category]||M.default,a=L.divIcon({html:`<div style="background-color: ${i.color}; width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; box-shadow: var(--shadow); display: flex; justify-content: center; align-items: center; color: white; font-size: 14px; font-weight: bold;">${r+1}</div>`,className:"custom-marker-icon",iconSize:[28,28],iconAnchor:[14,14]}),s=L.marker(e.coordinates,{icon:a}),l=`<b>${E(e.location)}</b><br>${E(e.description||"ç„¡æè¿°")}`;s.bindPopup(l),s.addTo(c),o.extend(e.coordinates)});for(let e=0;e<n.length-1;e++)n[e].date===n[e+1].date&&L.polyline([n[e].coordinates,n[e+1].coordinates],{color:"#3388ff",weight:3,opacity:.7}).addTo(c);o.isValid()&&u.fitBounds(o.pad(.2),{maxZoom:15})}function K(n){document.getElementById("stats-days").innerText=new Set(n.map(e=>e.date)).size,document.getElementById("stats-locations").innerText=n.length;let o=0;u&&n.forEach((e,r)=>{r>0&&e.date===n[r-1].date&&(o+=u.distance(e.coordinates,n[r-1].coordinates))}),document.getElementById("stats-distance").innerText=(o/1e3).toFixed(1)}function Y(n){const o=document.getElementById("offline-warning-banner"),e=document.getElementById("app-container"),r=document.getElementById("search-location-btn");o.classList.toggle("hidden",!n),e.classList.toggle("offline",n),document.documentElement.style.setProperty("--primary-color","#e67e22"),r&&(r.disabled=!0,r.title="é›¢ç·šæ¨¡å¼ä¸‹ç„¡æ³•ä½¿ç”¨æœå°‹åŠŸèƒ½"),ee()}function ee(n){u&&(V.classList.toggle("hidden",!1),u.hasLayer(d)&&u.removeLayer(d))}async function te(){if(!t.currentItinerary)return;const n=document.getElementById("location-name").value,o=document.getElementById("location-date").value,e=document.getElementById("location-category").value,r=document.getElementById("location-description").value,i=document.getElementById("location-coordinates").value;if(!n||!o||!i){m("åœ°é»åç¨±ã€æ—¥æœŸå’Œåº§æ¨™ç‚ºå¿…å¡«é …","error");return}const a=i.split(",").map(Number);if(a.length!==2||isNaN(a[0])||isNaN(a[1])){m("åº§æ¨™æ ¼å¼ä¸æ­£ç¢º","error");return}const s={date:o,location:n,category:e,description:r,coordinates:a};if(t.editingLocationId){const l=t.currentItinerary.locations.findIndex(y=>y.id===t.editingLocationId);l>-1&&(t.currentItinerary.locations[l]={...t.currentItinerary.locations[l],...s})}else s.id=`loc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,t.currentItinerary.locations.push(s);t.currentItinerary.locations.sort((l,y)=>new Date(l.date)-new Date(y.date));try{await A(),m("æ™¯é»å·²å„²å­˜ï¼","success"),v(document.getElementById("edit-location-modal"),!1),S()}catch(l){m(`å„²å­˜å¤±æ•—: ${l.message}`,"error")}}const ne=ae(async()=>{const n=document.getElementById("location-name").value;if(!n)return;const o=document.getElementById("location-search-results");o.innerHTML="æœå°‹ä¸­...";try{const e=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(n)}&limit=5`,{headers:{"User-Agent":"TravelItineraryHelper/3.0"}});if(!e.ok)throw new Error("API è«‹æ±‚å¤±æ•—");const r=await e.json();r.length===0?o.innerHTML="æ‰¾ä¸åˆ°çµæœ":o.innerHTML=r.map(i=>`<div class="search-result-item" data-lat="${i.lat}" data-lon="${i.lon}">${E(i.display_name)}</div>`).join("")}catch(e){o.innerHTML="æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤",m(e.message,"error")}},500);function C(n,o){n.dataSource=o,t.currentItinerary=n,t.filter={date:"all",category:"all"},S(),v(document.getElementById("itinerary-manager-modal"),!1)}async function k(){const n=document.getElementById("itinerary-manager-list");n.innerHTML="<li>è®€å–ä¸­...</li>",v(document.getElementById("itinerary-manager-modal"),!0);let o="";if(t.appMode==="cloud"&&t.firebaseUser){o+="<h3>é›²ç«¯è¡Œç¨‹</h3>";try{const i=(await f.collection("itineraries").where("ownerId","==",t.firebaseUser.uid).orderBy("createdAt","desc").get()).docs.map(a=>({id:a.id,...a.data()}));i.length>0?o+=i.map(a=>`<li class="itinerary-manager-item" data-id="${a.id}" data-name="${E(a.name)}" data-source="cloud"><span class="itinerary-manager-item-name">${E(a.name)}</span><div class="itinerary-manager-item-actions"><button class="load-btn">è¼‰å…¥</button><button class="delete-btn">åˆªé™¤</button></div></li>`).join(""):o+="<li>ç„¡é›²ç«¯è¡Œç¨‹</li>"}catch(r){o+="<li>è®€å–é›²ç«¯è¡Œç¨‹å¤±æ•—</li>",console.error(r)}}const e=t.appMode==="local"?"<h3>æœ¬åœ°è¡Œç¨‹</h3>":"<h3>é›¢ç·š/æœ¬åœ°è¡Œç¨‹</h3>";o+=e;try{const r=await T.getItineraries();r.length>0?o+=r.map(i=>`<li class="itinerary-manager-item" data-id="${i.id}" data-name="${E(i.name)}" data-source="local"><span class="itinerary-manager-item-name">${E(i.name)}</span><div class="itinerary-manager-item-actions"><button class="load-btn">è¼‰å…¥</button>${t.appMode==="cloud"&&t.firebaseUser?'<button class="upload-btn">ä¸Šå‚³è‡³é›²ç«¯</button>':""}<button class="delete-btn">åˆªé™¤</button></div></li>`).join(""):o+="<li>ç„¡æœ¬åœ°è¡Œç¨‹</li>"}catch(r){o+="<li>è®€å–æœ¬åœ°è¡Œç¨‹å¤±æ•—</li>",console.error(r)}n.innerHTML=o}function re(){document.querySelectorAll(".close-modal-btn").forEach(e=>e.addEventListener("click",()=>v(e.closest(".modal-backdrop"),!1))),document.getElementById("show-login-btn").addEventListener("click",()=>v(document.getElementById("login-modal"),!0)),document.getElementById("logout-btn").addEventListener("click",()=>b.signOut()),document.getElementById("login-btn").addEventListener("click",async()=>{const e=document.getElementById("login-email").value,r=document.getElementById("login-password").value;if(!e||!r)return m("è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼","warning");try{await b.signInWithEmailAndPassword(e,r),v(document.getElementById("login-modal"),!1)}catch(i){m(`ç™»å…¥å¤±æ•—: ${i.message}`,"error")}}),document.getElementById("manage-itineraries-btn").addEventListener("click",k),document.getElementById("itinerary-manager-list").addEventListener("click",async e=>{const r=e.target,i=r.closest(".itinerary-manager-item");if(!i)return;const a=i.dataset.id,s=i.dataset.source,l=i.dataset.name;if(r.classList.contains("load-btn")){let y;if(s==="cloud"){const B=await f.collection("itineraries").doc(a).get();y={id:B.id,...B.data()}}else y=await T.getItineraryById(a);y&&C(y,s)}else if(r.classList.contains("delete-btn"))confirm(`ç¢ºå®šè¦å¾ ${s==="cloud"?"é›²ç«¯":"æœ¬æ©Ÿ"} åˆªé™¤è¡Œç¨‹ "${l}" å—ï¼Ÿ`)&&(await _(a,s),t.currentItinerary&&t.currentItinerary.id===a&&H(),m("è¡Œç¨‹å·²åˆªé™¤","success"),k());else if(r.classList.contains("upload-btn")){if(!t.firebaseUser)return m("è«‹å…ˆç™»å…¥æ‰èƒ½ä¸Šå‚³","error");const y=await T.getItineraryById(a);if(!y)return m("æ‰¾ä¸åˆ°æœ¬åœ°è¡Œç¨‹","error");y.ownerId=t.firebaseUser.uid,delete y.hash,delete y.salt,await f.collection("itineraries").doc(y.id).set(y),m("è¡Œç¨‹å·²æˆåŠŸä¸Šå‚³è‡³é›²ç«¯ï¼","success"),confirm("ä¸Šå‚³æˆåŠŸï¼Œè¦åˆªé™¤é€™å°é›»è…¦ä¸Šçš„æœ¬åœ°å‰¯æœ¬å—ï¼Ÿ")&&await _(a,"local"),k()}}),document.getElementById("create-new-itinerary-btn").addEventListener("click",()=>{document.getElementById("new-itinerary-name").value="",v(document.getElementById("create-itinerary-modal"),!0)}),document.getElementById("save-new-itinerary-btn").addEventListener("click",async()=>{const e=document.getElementById("new-itinerary-name").value;if(!e)return m("è«‹è¼¸å…¥è¡Œç¨‹åç¨±","error");if(t.appMode==="local"||!t.firebaseUser){const r={id:`local_${Date.now()}`,name:e,locations:[],createdAt:new Date().toISOString()};await T.saveItinerary(r),C(r,"local"),m("æœ¬åœ°è¡Œç¨‹å·²å»ºç«‹!","success")}else{const r={name:e,ownerId:t.firebaseUser.uid,createdAt:firebase.firestore.FieldValue.serverTimestamp(),locations:[]},i=await f.collection("itineraries").add(r);C({id:i.id,...r},"cloud"),m("é›²ç«¯è¡Œç¨‹å·²å»ºç«‹!","success")}v(document.getElementById("create-itinerary-modal"),!1),v(document.getElementById("itinerary-manager-modal"),!1)}),document.getElementById("add-location-btn").addEventListener("click",()=>{t.editingLocationId=null,document.getElementById("edit-location-title").textContent="æ–°å¢æ™¯é»";let e=new Date().toISOString().split("T")[0];t.currentItinerary.locations.length>0&&(e=t.currentItinerary.locations[t.currentItinerary.locations.length-1].date),document.getElementById("location-name").value="",document.getElementById("location-date").value=e,document.getElementById("location-category").value="sight",document.getElementById("location-description").value="",document.getElementById("location-coordinates").value="",document.getElementById("location-search-results").innerHTML="",v(document.getElementById("edit-location-modal"),!0)}),document.getElementById("save-location-btn").addEventListener("click",te),document.getElementById("search-location-btn").addEventListener("click",ne),document.getElementById("location-search-results").addEventListener("click",e=>{const r=e.target.closest(".search-result-item");r&&(document.getElementById("location-name").value=r.textContent,document.getElementById("location-coordinates").value=`${r.dataset.lat}, ${r.dataset.lon}`,document.getElementById("location-search-results").innerHTML="")}),g.addEventListener("click",e=>{if(t.appMode==="cloud"&&!t.firebaseUser&&!t.currentItinerary||!t.currentItinerary)return;const r=e.target,i=r.closest(".location-item");if(!i)return;const a=i.dataset.id,s=t.currentItinerary.locations.find(l=>l.id===a);r.closest(".edit-btn")?(t.editingLocationId=a,document.getElementById("edit-location-title").textContent="ç·¨è¼¯æ™¯é»",document.getElementById("location-name").value=s.location,document.getElementById("location-date").value=s.date,document.getElementById("location-category").value=s.category,document.getElementById("location-description").value=s.description,document.getElementById("location-coordinates").value=s.coordinates.join(", "),document.getElementById("location-search-results").innerHTML="",v(document.getElementById("edit-location-modal"),!0)):r.closest(".delete-btn")?confirm(`ç¢ºå®šè¦åˆªé™¤æ™¯é» "${s.location}" å—ï¼Ÿ`)&&(t.currentItinerary.locations=t.currentItinerary.locations.filter(l=>l.id!==a),A().then(()=>S())):s&&u.flyTo(s.coordinates,15)});let n=null;g.addEventListener("dragstart",e=>{if(t.appMode==="cloud"&&!t.firebaseUser&&!t.currentItinerary||!t.currentItinerary)return;const r=e.target.closest(".location-item");r&&(n=r.dataset.id,setTimeout(()=>r.classList.add("dragging"),0))}),g.addEventListener("dragover",e=>{n&&e.preventDefault()}),g.addEventListener("drop",e=>{if(!n)return;e.preventDefault();const r=e.target.closest(".location-item"),i=t.currentItinerary.locations.findIndex(s=>s.id===n);let a=t.currentItinerary.locations.findIndex(s=>s.id===r?.dataset.id);if(i!==-1&&a!==-1&&i!==a){const[s]=t.currentItinerary.locations.splice(i,1);t.currentItinerary.locations.splice(a,0,s),s.date=t.currentItinerary.locations[a].date,A().then(()=>S())}n=null,document.querySelector(".dragging")?.classList.remove("dragging")}),g.addEventListener("dragend",()=>{n=null,document.querySelector(".dragging")?.classList.remove("dragging")}),document.getElementById("filters").addEventListener("click",e=>{if(e.target.tagName!=="BUTTON")return;const r=e.target;r.dataset.date!==void 0&&(t.filter.date=r.dataset.date),r.dataset.category!==void 0&&(t.filter.category=r.dataset.category),S()}),p.addEventListener("click",()=>{h.classList.toggle("open"),p.classList.toggle("open"),u&&setTimeout(()=>u.invalidateSize(!0),300)}),R.addEventListener("click",()=>{G.classList.toggle("collapsed"),R.classList.toggle("collapsed")}),document.getElementById("export-json").addEventListener("click",()=>{if(!t.currentItinerary)return m("å°šæœªè¼‰å…¥è¡Œç¨‹","warning");const e=JSON.stringify(t.currentItinerary,null,4),r=new Blob([e],{type:"application/json"}),i=URL.createObjectURL(r),a=document.createElement("a");a.href=i,a.download=`${t.currentItinerary.name}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)}),document.getElementById("export-printable").addEventListener("click",()=>{if(!t.currentItinerary||t.currentItinerary.locations.length===0)return m("æ²’æœ‰å¯åˆ—å°çš„è¡Œç¨‹è³‡æ–™","warning");const{name:e,locations:r}=t.currentItinerary;m("æ­£åœ¨æº–å‚™é è¦½é é¢...","normal");const i=r.reduce((w,x)=>(w[x.date]=w[x.date]||[],w[x.date].push(x),w),{}),a=document.getElementById("stats-days").innerText,s=document.getElementById("stats-locations").innerText,l=document.getElementById("stats-distance").innerText,y=`ç¸½å¤©æ•¸: ${a} å¤© | ç¸½åœ°é»: ${s} å€‹ | ç¸½è·é›¢: ${l} km`;let B='<table border=1 style="width:100%;border-collapse:collapse;font-size:12px;border-color:#ccc"><thead><tr style=background-color:#f2f2f2><th style="padding:8px;width:40px">#</th><th style=padding:8px>åœ°é»</th><th style="padding:8px;width:80px">åˆ†é¡</th><th style=padding:8px>æè¿°</th></tr></thead><tbody>',j=1;for(const w of Object.keys(i).sort()){const x=new Date(w).toLocaleDateString("zh-TW",{weekday:"long"});B+=`<tr style="background-color:#e9ecef;font-weight:bold"><td colspan=4 style="padding:10px;border-left:none;border-right:none">${w} (${x})</td></tr>`;for(const D of i[w])B+=`<tr><td style="padding:8px;text-align:center">${j++}</td><td style=padding:8px>${E(D.location)}</td><td style=padding:8px>${E(M[D.category]?.name||"å…¶ä»–")}</td><td style=padding:8px>${E(D.description)}</td></tr>`}B+="</tbody></table>";const O=`<html><head><title>${E(e)} - å¯åˆ—å°ç‰ˆ</title><meta charset=UTF-8><style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;margin:20px}h1{color:#2c3e50}p{color:#333}table{border:1px solid #ccc}th,td{border:1px solid #ccc}@media print{@page{margin:20mm}body{margin:0;-webkit-print-color-adjust:exact;print-color-adjust:exact}h1,p{margin-bottom:15px}table{page-break-inside:auto}tr{page-break-inside:avoid;page-break-after:auto}}</style></head><body><h1>${E(e)}</h1><p>${E(y)}</p>${B}</body></html>`,U=window.open();U.document.write(O),U.document.close(),setTimeout(()=>U.print(),500)});const o=document.getElementById("json-file-input");document.getElementById("load-from-json-btn").addEventListener("click",()=>{o.click()}),o.addEventListener("change",e=>{const r=e.target.files[0];if(!r)return;const i=new FileReader;i.onload=async a=>{try{const s=a.target.result,l=JSON.parse(s);if(!l||!l.id||!l.name||!Array.isArray(l.locations))throw new Error("æª”æ¡ˆå…§å®¹ä¸¦éæœ‰æ•ˆçš„è¡Œç¨‹æ ¼å¼ã€‚");delete l.ownerId,l.dataSource="local",await T.saveItinerary(l),m("è¡Œç¨‹å·²æˆåŠŸå¾ JSON è¼‰å…¥ï¼","success"),k()}catch(s){console.error("è¼‰å…¥ JSON å¤±æ•—:",s),m(`è¼‰å…¥å¤±æ•—: ${s.message}`,"error")}finally{e.target.value=null}},i.onerror=()=>{m("è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤","error"),e.target.value=null},i.readAsText(r)})}function v(n,o){n&&n.classList.toggle("hidden",!o)}function m(n,o="normal"){const e=document.createElement("div");e.className=`toast-message ${o}`,e.textContent=n,document.body.appendChild(e),setTimeout(()=>e.classList.add("show"),10),setTimeout(()=>{e.classList.remove("show"),e.addEventListener("transitionend",()=>e.remove())},3e3)}function E(n){return n?n.toString().replace(/[&<>"']/g,o=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[o]):""}function ae(n,o){let e;return function(...r){const i=this;clearTimeout(e),e=setTimeout(()=>n.apply(i,r),o)}}function oe(){u=L.map(I).setView([25.105497,121.517594],10),d=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(u),c=L.layerGroup().addTo(u),re(),J()}oe()});
