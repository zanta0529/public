(function(){const I=document.createElement("link").relList;if(I&&I.supports&&I.supports("modulepreload"))return;for(const d of document.querySelectorAll('link[rel="modulepreload"]'))k(d);new MutationObserver(d=>{for(const l of d)if(l.type==="childList")for(const y of l.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&k(y)}).observe(document,{childList:!0,subtree:!0});function E(d){const l={};return d.integrity&&(l.integrity=d.integrity),d.referrerPolicy&&(l.referrerPolicy=d.referrerPolicy),d.crossOrigin==="use-credentials"?l.credentials="include":d.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function k(d){if(d.ep)return;d.ep=!0;const l=E(d);fetch(d.href,l)}})();document.addEventListener("DOMContentLoaded",()=>{const M={apiKey:"AIzaSyCavD0SHOLcQBwjJJ3aCGCY7Po-t4QR31k",authDomain:"travel-itinerary-helper.firebaseapp.com",projectId:"travel-itinerary-helper",storageBucket:"travel-itinerary-helper.firebasestorage.app",messagingSenderId:"853427118697",appId:"1:853427118697:web:c2d4520a4fc565b98438f8",measurementId:"G-MG8CXYLNBE"};firebase.initializeApp(M);const I=firebase.auth(),E=firebase.firestore(),k=document.getElementById("map"),d=document.getElementById("itinerary-panel"),l=document.getElementById("panel-handle"),y=document.getElementById("itinerary-list"),H=document.getElementById("date-filters"),j=document.getElementById("category-filters"),O=document.getElementById("itinerary-title"),N=document.getElementById("add-location-container"),r={currentUser:null,currentItinerary:null,filter:{date:"all",category:"all"},editingLocationId:null},b={sight:{name:"æ™¯é»",color:"var(--category-sight)"},stay:{name:"ä½å®¿",color:"var(--category-stay)"},transport:{name:"äº¤é€š",color:"var(--category-transport)"},food:{name:"é¤é£²",color:"var(--category-food)"},default:{name:"å…¶ä»–",color:"var(--category-default)"}},B=L.map(k).setView([25.105497,121.517594],10);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(B);const U=L.layerGroup().addTo(B);I.onAuthStateChanged(n=>{r.currentUser=n,z(n),C(),n?s(`æ­¡è¿, ${n.email}!`,"success"):s("æ‚¨å·²ç™»å‡º")});function z(n){const t=document.getElementById("user-info"),e=document.getElementById("guest-info");n?(document.getElementById("user-email").textContent=n.email,t.classList.remove("hidden"),e.classList.add("hidden")):(t.classList.add("hidden"),e.classList.remove("hidden"))}const w={async getItineraries(){if(!r.currentUser)return[];try{return(await E.collection("itineraries").where("ownerId","==",r.currentUser.uid).orderBy("createdAt","desc").get()).docs.map(t=>({id:t.id,...t.data()}))}catch(n){return console.error("Error getting itineraries:",n),s("è®€å–è¡Œç¨‹å¤±æ•—","error"),[]}},async saveItinerary(n){if(!r.currentUser)throw new Error("User not logged in");await E.collection("itineraries").doc(n.id).set(n,{merge:!0})},async createItinerary(n){if(!r.currentUser)throw new Error("User not logged in");const t={name:n,ownerId:r.currentUser.uid,createdAt:firebase.firestore.FieldValue.serverTimestamp(),locations:[]};return{id:(await E.collection("itineraries").add(t)).id,...t}},async deleteItinerary(n){if(!r.currentUser)throw new Error("User not logged in");await E.collection("itineraries").doc(n).delete()}};function $(){if(!r.currentItinerary)return C();const n=r.currentItinerary.locations,t=R();O.textContent=r.currentItinerary.name,N.classList.toggle("hidden",!r.currentUser||!r.currentItinerary),F(n),D(n,t),P(t),A(n)}function C(){r.currentItinerary=null;const n=r.currentUser?"è«‹å¾ã€Œç®¡ç†ã€å»ºç«‹æˆ–è¼‰å…¥ä¸€å€‹è¡Œç¨‹":"è«‹å…ˆç™»å…¥ä»¥ç®¡ç†æ‚¨çš„è¡Œç¨‹";O.textContent="å°šæœªè¼‰å…¥è¡Œç¨‹",N.classList.add("hidden"),y.innerHTML=`<p class="empty-message">${n}</p>`,H.innerHTML="",j.innerHTML="",U.clearLayers(),A([])}function R(){return r.currentItinerary?r.currentItinerary.locations.filter(n=>(r.filter.date==="all"||n.date===r.filter.date)&&(r.filter.category==="all"||n.category===r.filter.category)):[]}function D(n,t){if(!r.currentUser)return;if(n.length===0){y.innerHTML='<p class="empty-message">æ­¤è¡Œç¨‹æ²’æœ‰ä»»ä½•åœ°é»ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢ç¬¬ä¸€å€‹æ™¯é»å§ï¼</p>';return}const e=n.reduce((a,c)=>(a[c.date]||(a[c.date]=[]),a[c.date].push(c),a),{}),o=r.filter.date!=="all"||r.filter.category!=="all",i=Object.keys(e).sort().map(a=>{const m=e[a].map(g=>{const S=t.some(v=>v.id===g.id);if(o&&!S)return"";const x=b[g.category]||b.default,T=t.findIndex(v=>v.id===g.id),p=S?T+1:"â€¢",h=f(g.location);return`
                    <div class="location-item" data-id="${g.id}" draggable="true">
                        <span class="location-number" style="color: ${x.color};">${p}</span>
                        <p>${h}</p>
                        <span class="category-badge" style="background-color: ${x.color};">${x.name}</span>
                        <div class="location-controls">
                            <button class="edit-btn" title="ç·¨è¼¯">âœï¸</button>
                            <button class="delete-btn" title="åˆªé™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>`}).join("");return m?`<div class="day-group"><div class="day-header">${a}</div>${m}</div>`:""}).join("");y.innerHTML=i||'<p class="empty-message">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„æ™¯é»ã€‚</p>'}function F(n){const e=[...new Set(n.map(a=>a.date))].sort().map(a=>`<button data-date="${a}" class="${r.filter.date===a?"active":""}">${a}</button>`).join("");H.innerHTML=`<button data-date="all" class="${r.filter.date==="all"?"active":""}">å…¨éƒ¨æ—¥æœŸ</button>${e}`;const i=[...new Set(n.map(a=>a.category))].map(a=>{const c=b[a]||b.default;return`<button data-category="${a}" class="${r.filter.category===a?"active":""}">${c.name}</button>`}).join("");j.innerHTML=`<button data-category="all" class="${r.filter.category==="all"?"active":""}">å…¨éƒ¨åˆ†é¡</button>${i}`}function P(n){if(U.clearLayers(),n.length===0)return;const t=L.latLngBounds();n.forEach((e,o)=>{const i=b[e.category]||b.default,a=L.divIcon({html:`<div style="background-color: ${i.color}; width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; box-shadow: var(--shadow); display: flex; justify-content: center; align-items: center; color: white; font-size: 14px; font-weight: bold;">${o+1}</div>`,className:"custom-marker-icon",iconSize:[28,28],iconAnchor:[14,14]}),c=L.marker(e.coordinates,{icon:a}),m=`<b>${f(e.location)}</b><br>${f(e.description||"ç„¡æè¿°")}`;c.bindPopup(m),c.addTo(U),t.extend(e.coordinates)});for(let e=0;e<n.length-1;e++)n[e].date===n[e+1].date&&L.polyline([n[e].coordinates,n[e+1].coordinates],{color:"#3388ff",weight:3,opacity:.7}).addTo(U);t.isValid()&&B.fitBounds(t.pad(.2),{maxZoom:15})}function A(n){document.getElementById("stats-days").innerText=new Set(n.map(e=>e.date)).size,document.getElementById("stats-locations").innerText=n.length;let t=0;n.forEach((e,o)=>{o>0&&e.date===n[o-1].date&&(t+=B.distance(e.coordinates,n[o-1].coordinates))}),document.getElementById("stats-distance").innerText=(t/1e3).toFixed(1)}async function G(){if(!r.currentItinerary)return;const n=document.getElementById("location-name").value,t=document.getElementById("location-date").value,e=document.getElementById("location-category").value,o=document.getElementById("location-description").value,i=document.getElementById("location-coordinates").value;if(!n||!t||!i){s("åœ°é»åç¨±ã€æ—¥æœŸå’Œåº§æ¨™ç‚ºå¿…å¡«é …","error");return}const a=i.split(",").map(Number);if(a.length!==2||isNaN(a[0])||isNaN(a[1])){s("åº§æ¨™æ ¼å¼ä¸æ­£ç¢º","error");return}const c={date:t,location:n,category:e,description:o,coordinates:a,image:""};if(r.editingLocationId){const m=r.currentItinerary.locations.findIndex(g=>g.id===r.editingLocationId);m>-1&&(r.currentItinerary.locations[m]={...r.currentItinerary.locations[m],...c})}else c.id=`loc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,r.currentItinerary.locations.push(c);r.currentItinerary.locations.sort((m,g)=>new Date(m.date)-new Date(g.date));try{await w.saveItinerary(r.currentItinerary),s("æ™¯é»å·²å„²å­˜ï¼","success"),u(document.getElementById("edit-location-modal"),!1),$()}catch(m){s(`å„²å­˜å¤±æ•—: ${m.message}`,"error")}}const V=W(async()=>{const n=document.getElementById("location-name").value;if(!n)return;const t=document.getElementById("location-search-results");t.innerHTML="æœå°‹ä¸­...";try{const e=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(n)}&limit=5`,{headers:{"User-Agent":"TravelItineraryHelper/3.0"}});if(!e.ok)throw new Error("API è«‹æ±‚å¤±æ•—");const o=await e.json();o.length===0?t.innerHTML="æ‰¾ä¸åˆ°çµæœ":t.innerHTML=o.map(i=>`<div class="search-result-item" data-lat="${i.lat}" data-lon="${i.lon}">${f(i.display_name)}</div>`).join("")}catch(e){t.innerHTML="æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤",s(e.message,"error")}},500);function q(n){r.currentItinerary=n,r.filter={date:"all",category:"all"},$(),u(document.getElementById("itinerary-manager-modal"),!1)}function J(){document.querySelectorAll(".close-modal-btn").forEach(t=>{t.addEventListener("click",()=>u(t.closest(".modal-backdrop"),!1))}),document.getElementById("show-login-btn").addEventListener("click",()=>u(document.getElementById("login-modal"),!0)),document.getElementById("show-signup-btn").addEventListener("click",()=>u(document.getElementById("signup-modal"),!0)),document.getElementById("logout-btn").addEventListener("click",()=>I.signOut()),document.getElementById("login-btn").addEventListener("click",async()=>{const t=document.getElementById("login-email").value,e=document.getElementById("login-password").value;if(!t||!e)return s("è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼","warning");try{await I.signInWithEmailAndPassword(t,e),u(document.getElementById("login-modal"),!1)}catch(o){s(`ç™»å…¥å¤±æ•—: ${o.message}`,"error")}}),document.getElementById("signup-btn").addEventListener("click",async()=>{const t=document.getElementById("signup-email").value,e=document.getElementById("signup-password").value;if(!t||!e)return s("è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼","warning");try{await I.createUserWithEmailAndPassword(t,e),u(document.getElementById("signup-modal"),!1)}catch(o){s(`è¨»å†Šå¤±æ•—: ${o.message}`,"error")}}),document.getElementById("manage-itineraries-btn").addEventListener("click",async()=>{if(!r.currentUser)return s("è«‹å…ˆç™»å…¥","warning");const t=await w.getItineraries(),e=document.getElementById("itinerary-manager-list");t.length===0?e.innerHTML="<li>æ‚¨å°šæœªå»ºç«‹ä»»ä½•è¡Œç¨‹ã€‚</li>":e.innerHTML=t.map(o=>`
                    <li class="itinerary-manager-item" data-id="${o.id}" data-name="${f(o.name)}">
                        <span class="itinerary-manager-item-name">${f(o.name)}</span>
                        <div class="itinerary-manager-item-actions">
                            <button class="load-btn">è¼‰å…¥</button>
                            <button class="delete-btn">åˆªé™¤</button>
                        </div>
                    </li>`).join(""),u(document.getElementById("itinerary-manager-modal"),!0)}),document.getElementById("itinerary-manager-list").addEventListener("click",async t=>{if(!r.currentUser)return;const e=t.target,o=e.closest(".itinerary-manager-item");if(!o)return;const i=o.dataset.id,a=o.dataset.name;if(e.classList.contains("load-btn")){const c=await E.collection("itineraries").doc(i).get();q({id:c.id,...c.data()})}else e.classList.contains("delete-btn")&&confirm(`ç¢ºå®šè¦åˆªé™¤è¡Œç¨‹ "${a}" å—ï¼Ÿ`)&&(await w.deleteItinerary(i),r.currentItinerary&&r.currentItinerary.id===i&&C(),s("è¡Œç¨‹å·²åˆªé™¤","success"),u(e.closest(".modal-backdrop"),!1))}),document.getElementById("create-new-itinerary-btn").addEventListener("click",()=>{u(document.getElementById("create-itinerary-modal"),!0)}),document.getElementById("save-new-itinerary-btn").addEventListener("click",async()=>{const t=document.getElementById("new-itinerary-name").value;if(!t){s("è«‹è¼¸å…¥è¡Œç¨‹åç¨±","error");return}try{const e=await w.createItinerary(t);q(e),s("è¡Œç¨‹å·²å»ºç«‹!","success"),u(document.getElementById("create-itinerary-modal"),!1),u(document.getElementById("itinerary-manager-modal"),!1)}catch(e){s(`å»ºç«‹å¤±æ•—: ${e.message}`,"error")}}),document.getElementById("add-location-btn").addEventListener("click",()=>{r.editingLocationId=null,document.getElementById("edit-location-title").textContent="æ–°å¢æ™¯é»";let t=new Date().toISOString().split("T")[0];r.currentItinerary.locations.length>0&&(t=r.currentItinerary.locations[r.currentItinerary.locations.length-1].date),document.getElementById("location-name").value="",document.getElementById("location-date").value=t,document.getElementById("location-category").value="sight",document.getElementById("location-description").value="",document.getElementById("location-coordinates").value="",document.getElementById("location-search-results").innerHTML="",u(document.getElementById("edit-location-modal"),!0)}),document.getElementById("save-location-btn").addEventListener("click",G),document.getElementById("search-location-btn").addEventListener("click",V),document.getElementById("location-search-results").addEventListener("click",t=>{const e=t.target.closest(".search-result-item");e&&(document.getElementById("location-name").value=e.textContent,document.getElementById("location-coordinates").value=`${e.dataset.lat}, ${e.dataset.lon}`,document.getElementById("location-search-results").innerHTML="")}),y.addEventListener("click",t=>{if(!r.currentUser||!r.currentItinerary)return;const e=t.target,o=e.closest(".location-item");if(!o)return;const i=o.dataset.id,a=r.currentItinerary.locations.find(c=>c.id===i);e.closest(".edit-btn")?(r.editingLocationId=i,document.getElementById("edit-location-title").textContent="ç·¨è¼¯æ™¯é»",document.getElementById("location-name").value=a.location,document.getElementById("location-date").value=a.date,document.getElementById("location-category").value=a.category,document.getElementById("location-description").value=a.description,document.getElementById("location-coordinates").value=a.coordinates.join(", "),u(document.getElementById("edit-location-modal"),!0)):e.closest(".delete-btn")?confirm(`ç¢ºå®šè¦åˆªé™¤æ™¯é» "${a.location}" å—ï¼Ÿ`)&&(r.currentItinerary.locations=r.currentItinerary.locations.filter(c=>c.id!==i),w.saveItinerary(r.currentItinerary).then(()=>$())):a&&B.flyTo(a.coordinates,15)});let n=null;y.addEventListener("dragstart",t=>{if(!r.currentUser||!r.currentItinerary)return;const e=t.target.closest(".location-item");e&&(n=e.dataset.id,setTimeout(()=>e.classList.add("dragging"),0))}),y.addEventListener("dragover",t=>{n&&t.preventDefault()}),y.addEventListener("drop",t=>{if(!n)return;t.preventDefault();const e=t.target.closest(".location-item"),o=r.currentItinerary.locations.findIndex(a=>a.id===n);let i=r.currentItinerary.locations.findIndex(a=>a.id===e?.dataset.id);if(o!==-1&&i!==-1&&o!==i){const[a]=r.currentItinerary.locations.splice(o,1);r.currentItinerary.locations.splice(i,0,a),a.date=r.currentItinerary.locations[i].date,w.saveItinerary(r.currentItinerary).then(()=>$())}n=null,document.querySelector(".dragging")?.classList.remove("dragging")}),y.addEventListener("dragend",()=>{n=null,document.querySelector(".dragging")?.classList.remove("dragging")}),document.getElementById("filters").addEventListener("click",t=>{if(t.target.tagName!=="BUTTON")return;const e=t.target;e.dataset.date!==void 0&&(r.filter.date=e.dataset.date),e.dataset.category!==void 0&&(r.filter.category=e.dataset.category),$()}),l.addEventListener("click",()=>{d.classList.toggle("open"),l.classList.toggle("open"),setTimeout(()=>B.invalidateSize(!0),300)}),document.getElementById("export-json").addEventListener("click",()=>{if(!r.currentItinerary)return s("å°šæœªè¼‰å…¥è¡Œç¨‹","warning");const t=JSON.stringify(r.currentItinerary,null,4),e=new Blob([t],{type:"application/json"}),o=URL.createObjectURL(e),i=document.createElement("a");i.href=o,i.download=`${r.currentItinerary.name}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)}),document.getElementById("export-printable").addEventListener("click",()=>{if(!r.currentItinerary)return s("æ²’æœ‰å¯åˆ—å°çš„è¡Œç¨‹è³‡æ–™","warning");const{name:t,locations:e}=r.currentItinerary;if(e.length===0)return void s("è¡Œç¨‹ä¸­æ²’æœ‰ä»»ä½•åœ°é»","warning");s("æ­£åœ¨æº–å‚™é è¦½é é¢...","normal");const o=e.reduce((p,h)=>(p[h.date]||(p[h.date]=[]),p[h.date].push(h),p),{}),i=document.getElementById("stats-days").innerText,a=document.getElementById("stats-locations").innerText,c=document.getElementById("stats-distance").innerText,m=`ç¸½å¤©æ•¸: ${i} å¤© | ç¸½åœ°é»: ${a} å€‹ | ç¸½è·é›¢: ${c} km`;let g=`
<table border=1 style="width:100%;border-collapse:collapse;font-size:12px;border-color:#ccc"><thead><tr style=background-color:#f2f2f2><th style="padding:8px;width:40px">#</th><th style=padding:8px>åœ°é»</th><th style="padding:8px;width:80px">åˆ†é¡</th><th style=padding:8px>æè¿°</th></tr></thead><tbody>`,S=1;for(const p of Object.keys(o).sort()){const h=new Date(p).toLocaleDateString("zh-TW",{weekday:"long"});g+=`
<tr style="background-color:#e9ecef;font-weight:bold"><td colspan=4 style="padding:10px;border-left:none;border-right:none">${p} (${h})</td></tr>`;for(const v of o[p])g+=`
<tr><td style="padding:8px;text-align:center">${S++}</td><td style=padding:8px>${f(v.location)}</td><td style=padding:8px>${f(b[v.category]?.name||"å…¶ä»–")}</td><td style=padding:8px>${f(v.description)}</td></tr>`}g+="</tbody></table>";const x=`
<html><head><title>${f(t)} - å¯åˆ—å°ç‰ˆ</title><meta charset=UTF-8><style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;margin:20px}h1{color:#2c3e50}p{color:#333}table{border:1px solid #ccc}th,td{border:1px solid #ccc}@media print{@page{margin:20mm}body{margin:0;-webkit-print-color-adjust:exact;print-color-adjust:exact}h1,p{margin-bottom:15px}table{page-break-inside:auto}tr{page-break-inside:avoid;page-break-after:auto}}</style></head><body><h1>${f(t)}</h1><p>${f(m)}</p>${g}</body></html>`,T=window.open();T.document.write(x),T.document.close(),setTimeout(()=>T.print(),500)})}function u(n,t){n&&n.classList.toggle("hidden",!t)}function s(n,t="normal"){const e=document.createElement("div");e.className=`toast-message ${t}`,e.textContent=n,document.body.appendChild(e),setTimeout(()=>e.classList.add("show"),10),setTimeout(()=>{e.classList.remove("show"),e.addEventListener("transitionend",()=>e.remove())},3e3)}function f(n){return n?n.toString().replace(/[&<>"']/g,function(t){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]}):""}function W(n,t){let e;return function(...o){const i=this;clearTimeout(e),e=setTimeout(()=>n.apply(i,o),t)}}function _(){J(),C()}_()});
