(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const d of document.querySelectorAll('link[rel="modulepreload"]'))s(d);new MutationObserver(d=>{for(const u of d)if(u.type==="childList")for(const E of u.addedNodes)E.tagName==="LINK"&&E.rel==="modulepreload"&&s(E)}).observe(document,{childList:!0,subtree:!0});function a(d){const u={};return d.integrity&&(u.integrity=d.integrity),d.referrerPolicy&&(u.referrerPolicy=d.referrerPolicy),d.crossOrigin==="use-credentials"?u.credentials="include":d.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function s(d){if(d.ep)return;d.ep=!0;const u=a(d);fetch(d.href,u)}})();function B(t){return t?t.toString().replace(/[&<>"']/g,i=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[i]):""}function V(t,i){let a;return function(...s){const d=this;clearTimeout(a),a=setTimeout(()=>t.apply(d,s),i)}}class Y{dbInstance=null;DB_NAME="TravelItinerariesDB_v3";STORE_NAME="itineraries";async init(){return this.dbInstance?this.dbInstance:new Promise((i,a)=>{const s=indexedDB.open(this.DB_NAME,1);s.onerror=d=>a("資料庫開啟失敗",d.target.error),s.onsuccess=d=>{this.dbInstance=d.target.result,i(this.dbInstance)},s.onupgradeneeded=d=>{const u=d.target.result;u.objectStoreNames.contains(this.STORE_NAME)||u.createObjectStore(this.STORE_NAME,{keyPath:"id"})}})}async getStore(i="readonly"){return this.dbInstance||await this.init(),this.dbInstance.transaction(this.STORE_NAME,i).objectStore(this.STORE_NAME)}async saveItinerary(i){const a=await this.getStore("readwrite");return new Promise((s,d)=>{const u=a.put(i);u.onsuccess=s,u.onerror=d})}async deleteItinerary(i){const a=await this.getStore("readwrite");return new Promise((s,d)=>{const u=a.delete(i);u.onsuccess=s,u.onerror=d})}async getItineraries(){const i=await this.getStore();return new Promise((a,s)=>{const d=i.getAll();d.onsuccess=()=>a(d.result),d.onerror=s})}async getItineraryById(i){const a=await this.getStore();return new Promise((s,d)=>{const u=a.get(i);u.onsuccess=()=>s(u.result),u.onerror=d})}}let b={},I={},T,A,x,_;const C={sight:{name:"景點",color:"var(--category-sight)"},stay:{name:"住宿",color:"var(--category-stay)"},transport:{name:"交通",color:"var(--category-transport)"},food:{name:"餐飲",color:"var(--category-food)"},default:{name:"其他",color:"var(--category-default)"}},r={sharingItinerary:null,init(t){b=t.elements,I=t.globalState,T=t.map,A=t.tileLayer,x=t.layerGroup,_=t.getFilteredLocations},toggleModal(t,i){t&&t.classList.toggle("hidden",!i)},showToast(t,i="normal"){const a=document.createElement("div");a.className=`toast-message ${i}`,a.textContent=t,document.body.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove())},3e3)},showShareModal(t=""){const i=document.getElementById("share-link-input"),a=document.getElementById("generate-share-link-btn"),s=document.getElementById("copy-share-link-btn");i.value=t,t?(i.select(),a.textContent="重新產生",s.disabled=!1):(i.placeholder="點擊下方按鈕以產生連結...",a.textContent="產生連結",s.disabled=!0),this.toggleModal(document.getElementById("share-modal"),!0)},updateAuthUI(){const{userInfo:t,guestInfo:i,manageBtn:a,userEmail:s}=b,{firebaseUser:d,appMode:u}=I;u==="cloud"&&d?(s.textContent=d.email,t.classList.remove("hidden"),i.classList.add("hidden"),a.disabled=!1):(t.classList.add("hidden"),i.classList.remove("hidden"),a.disabled=!1),u==="local"&&i.classList.add("hidden")},enterReadOnlyMode(t){document.body.classList.add("readonly-mode"),b.itineraryPanel.classList.contains("open")||(b.itineraryPanel.classList.add("open"),b.panelHandle.classList.add("open"),T&&setTimeout(()=>T.invalidateSize(!0),300));const i=document.querySelector(".panel-header h1");i&&(i.textContent="唯讀分享"),b.itineraryTitleEl.textContent=`${t} (唯讀)`},createItineraryList(t,i){const{itineraryListContainer:a}=b;if(I.appMode==="cloud"&&!I.firebaseUser&&t.length>0)return;if(t.length===0){a.innerHTML='<p class="empty-message">此行程沒有任何地點，點擊下方按鈕新增第一個景點吧！</p>';return}const s=t.reduce((E,h)=>(E[h.date]||(E[h.date]=[]),E[h.date].push(h),E),{}),d=I.filter.date!=="all"||I.filter.category!=="all",u=Object.keys(s).sort().map(E=>{const f=s[E].map(e=>{const D=i.some(U=>U.id===e.id);if(d&&!D)return"";const S=C[e.category]||C.default,k=i.findIndex(U=>U.id===e.id),H=D?k+1:"•",P=B(e.location),z=I.isReadOnlyMode?"":`
                            <div class="location-controls">
                                <button class="edit-btn" title="編輯">✏️</button>
                                <button class="delete-btn" title="刪除">🗑️</button>
                            </div>
                        `;return`<div class="location-item" data-id="${e.id}" draggable="${!I.isReadOnlyMode}"><span class="location-number" style="color: ${S.color};">${H}</span><p>${P}</p><span class="category-badge" style="background-color: ${S.color};">${S.name}</span>${z}</div>`}).join("");return f?`<div class="day-group"><div class="day-header">${E}</div>${f}</div>`:""}).join("");a.innerHTML=u||'<p class="empty-message">沒有符合篩選條件的景點。</p>'},createFilterControls(t){const{dateFiltersContainer:i,categoryFiltersContainer:a}=b,d=[...new Set(t.map(h=>h.date))].sort().map(h=>`<button data-date="${h}" class="${I.filter.date===h?"active":""}">${h}</button>`).join("");i.innerHTML=`<button data-date="all" class="${I.filter.date==="all"?"active":""}">全部日期</button>${d}`;const E=[...new Set(t.map(h=>h.category))].map(h=>{const f=C[h]||C.default;return`<button data-category="${h}" class="${I.filter.category===h?"active":""}">${f.name}</button>`}).join("");a.innerHTML=`<button data-category="all" class="${I.filter.category==="all"?"active":""}">全部分類</button>${E}`},refreshUI(){if(!I.currentItinerary)return this.resetUI();const t=I.currentItinerary.locations,i=_();b.itineraryTitleEl.textContent=I.isReadOnlyMode?`${I.currentItinerary.name} (唯讀)`:I.currentItinerary.name,b.addLocationContainer.classList.toggle("hidden",I.isReadOnlyMode||!I.currentItinerary),this.createFilterControls(t),this.createItineraryList(t,i),this.drawMap(i),this.updateStats(t)},resetUI(){let t="請從「管理」建立或載入一個行程";I.appMode==="cloud"&&!I.firebaseUser&&(t="請先登入以管理您的行程"),b.itineraryTitleEl.textContent="尚未載入行程",b.addLocationContainer.classList.add("hidden"),b.itineraryListContainer.innerHTML=`<p class="empty-message">${t}</p>`,b.dateFiltersContainer.innerHTML="",b.categoryFiltersContainer.innerHTML="",x&&x.clearLayers(),this.updateStats([])},drawMap(t){if(!T||(x.clearLayers(),t.length===0))return;const i=L.latLngBounds();t.forEach((a,s)=>{const d=C[a.category]||C.default,u=L.divIcon({html:`<div style="background-color: ${d.color}; width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; box-shadow: var(--shadow); display: flex; justify-content: center; align-items: center; color: white; font-size: 14px; font-weight: bold;">${s+1}</div>`,className:"custom-marker-icon",iconSize:[28,28],iconAnchor:[14,14]}),E=L.marker(a.coordinates,{icon:u}),h=`<b>${B(a.location)}</b><br>${B(a.description||"無描述")}`;E.bindPopup(h),E.addTo(x),i.extend(a.coordinates)});for(let a=0;a<t.length-1;a++)t[a].date===t[a+1].date&&L.polyline([t[a].coordinates,t[a+1].coordinates],{color:"#3388ff",weight:3,opacity:.7}).addTo(x);i.isValid()&&T.fitBounds(i.pad(.2),{maxZoom:15})},updateStats(t){b.statsDays.innerText=new Set(t.map(a=>a.date)).size,b.statsLocations.innerText=t.length;let i=0;T&&t.forEach((a,s)=>{s>0&&a.date===t[s-1].date&&(i+=T.distance(a.coordinates,t[s-1].coordinates))}),b.statsDistance.innerText=(i/1e3).toFixed(1)},showOfflineWarning(t){const{offlineWarningBanner:i,appContainer:a,searchLocationBtn:s}=b;i.classList.toggle("hidden",!t),a.classList.toggle("offline",t),t?(document.documentElement.style.setProperty("--primary-color","#e67e22"),s&&(s.disabled=!0,s.title="離線模式下無法使用搜尋功能")):(document.documentElement.style.setProperty("--primary-color","#3498db"),s&&(s.disabled=!1,s.title="")),this.handleMapOfflineState(t)},handleMapOfflineState(t){T&&(b.mapOfflinePlaceholder.classList.toggle("hidden",!t),t?T.hasLayer(A)&&T.removeLayer(A):T.hasLayer(A)||A.addTo(T))}};function Z(){{console.warn("Google Analytics Measurement ID 尚未設定。");return}}document.addEventListener("DOMContentLoaded",()=>{const t=new Y,i={apiKey:"AIzaSyCavD0SHOLcQBwjJJ3aCGCY7Po-t4QR31k",authDomain:"travel-itinerary-helper.firebaseapp.com",projectId:"travel-itinerary-helper",storageBucket:"travel-itinerary-helper.firebasestorage.app",messagingSenderId:"853427118697",appId:"1:853427118697:web:c2d4520a4fc565b98438f8",measurementId:void 0};let a,s,d,u,E,h;const f={mapElement:document.getElementById("map"),itineraryPanel:document.getElementById("itinerary-panel"),panelHandle:document.getElementById("panel-handle"),itineraryListContainer:document.getElementById("itinerary-list"),dateFiltersContainer:document.getElementById("date-filters"),categoryFiltersContainer:document.getElementById("category-filters"),itineraryTitleEl:document.getElementById("itinerary-title"),addLocationContainer:document.getElementById("add-location-container"),mapOfflinePlaceholder:document.getElementById("map-offline-placeholder"),filters:document.getElementById("filters"),filtersHandle:document.getElementById("filters-handle"),coordinatesWarning:document.getElementById("coordinates-warning"),userInfo:document.getElementById("user-info"),guestInfo:document.getElementById("guest-info"),manageBtn:document.getElementById("manage-itineraries-btn"),userEmail:document.getElementById("user-email"),statsDays:document.getElementById("stats-days"),statsLocations:document.getElementById("stats-locations"),statsDistance:document.getElementById("stats-distance"),offlineWarningBanner:document.getElementById("offline-warning-banner"),appContainer:document.getElementById("app-container"),searchLocationBtn:document.getElementById("search-location-btn")},e={appMode:"cloud",firebaseUser:null,currentItinerary:null,filter:{date:"all",category:"all"},editingLocationId:null,isReadOnlyMode:!1};async function D(){try{firebase.initializeApp(i),a=firebase.auth(),s=firebase.firestore(),d=firebase.functions(),await a.getRedirectResult(),e.appMode="cloud",console.log("Firebase connected. Running in Cloud Mode."),a.onAuthStateChanged(m=>{e.firebaseUser=m,r.updateAuthUI(),r.resetUI(),m?r.showToast(`歡迎, ${m.email}!`,"success"):r.showToast("您已登出")})}catch(m){console.error("Firebase connection failed:",m),e.appMode="local",console.log("Running in Local Mode."),r.updateAuthUI(),r.resetUI(),r.showOfflineWarning(!0),setTimeout(O,100)}}async function S(m){e.isReadOnlyMode=!0;try{firebase.initializeApp(i),s=firebase.firestore();const y=await s.collection("sharedItineraries").doc(m).get();if(y.exists){const n=y.data();r.enterReadOnlyMode(n.name),R({id:y.id,...n},"shared")}else r.showToast("找不到這個分享的行程","error"),f.itineraryTitleEl.textContent="無效的分享連結"}catch(y){console.error("Failed to load shared itinerary:",y),r.showToast("讀取分享行程時發生錯誤","error"),f.itineraryTitleEl.textContent="讀取失敗"}}async function k(){if(!e.currentItinerary)return;if(e.isReadOnlyMode)return r.showToast("唯讀模式下無法儲存行程","warning");if((e.currentItinerary.dataSource||"local")==="cloud"){if(e.appMode!=="cloud"||!e.firebaseUser)return r.showToast("無法儲存雲端行程，請檢查網路連線並重新整理","error");await s.collection("itineraries").doc(e.currentItinerary.id).set(e.currentItinerary,{merge:!0})}else await t.saveItinerary(e.currentItinerary);r.showToast("行程已儲存！","success")}async function H(m,y){if(y==="cloud"){if(!e.firebaseUser)return r.showToast("請先登入","error");await s.collection("itineraries").doc(m).delete()}else await t.deleteItinerary(m)}function P(){return e.currentItinerary?e.currentItinerary.locations.filter(m=>(e.filter.date==="all"||m.date===e.filter.date)&&(e.filter.category==="all"||m.category===e.filter.category)):[]}async function z(){if(!e.currentItinerary)return;const m=document.getElementById("location-name").value,y=document.getElementById("location-date").value,n=document.getElementById("location-category").value,o=document.getElementById("location-description").value,c=document.getElementById("location-coordinates").value;if(!m||!y||!c)return r.showToast("地點名稱、日期和座標為必填項","error");const l=c.split(",").map(Number);if(l.length!==2||isNaN(l[0])||isNaN(l[1]))return r.showToast("座標格式不正確","error");const g={date:y,location:m,category:n,description:o,coordinates:l};if(e.editingLocationId){const p=e.currentItinerary.locations.findIndex(w=>w.id===e.editingLocationId);p>-1&&(e.currentItinerary.locations[p]={...e.currentItinerary.locations[p],...g})}else g.id=`loc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,e.currentItinerary.locations.push(g);e.currentItinerary.locations.sort((p,w)=>new Date(p.date)-new Date(w.date));try{await k(),r.showToast("景點已儲存！","success"),r.toggleModal(document.getElementById("edit-location-modal"),!1),r.refreshUI()}catch(p){r.showToast(`儲存失敗: ${p.message}`,"error")}}const U=V(async()=>{const m=document.getElementById("location-name").value;if(!m)return;const y=document.getElementById("location-search-results");y.innerHTML="搜尋中...";try{const n=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(m)}&limit=5`,{headers:{"User-Agent":"TravelItineraryHelper/3.0"}});if(!n.ok)throw new Error("API 請求失敗");const o=await n.json();o.length===0?y.innerHTML="找不到結果":y.innerHTML=o.map(c=>`<div class="search-result-item" data-lat="${c.lat}" data-lon="${c.lon}">${B(c.display_name)}</div>`).join("")}catch(n){y.innerHTML="搜尋時發生錯誤",r.showToast(n.message,"error")}},500);function R(m,y){m.dataSource=y,e.currentItinerary=m,e.filter={date:"all",category:"all"},r.refreshUI(),r.toggleModal(document.getElementById("itinerary-manager-modal"),!1)}async function O(){const m=document.getElementById("itinerary-manager-list");m.innerHTML="<li>讀取中...</li>",r.toggleModal(document.getElementById("itinerary-manager-modal"),!0);let y="";if(e.appMode==="cloud"&&e.firebaseUser){y+="<h3>雲端行程</h3>";try{const c=(await s.collection("itineraries").where("ownerId","==",e.firebaseUser.uid).orderBy("createdAt","desc").get()).docs.map(l=>({id:l.id,...l.data()}));c.length>0?y+=c.map(l=>`<li class="itinerary-manager-item" data-id="${l.id}" data-name="${B(l.name)}" data-source="cloud">
                                    <span class="itinerary-manager-item-name">${B(l.name)}</span>
                                    <div class="itinerary-manager-item-actions">
                                        <button class="load-btn">載入</button>
                                        <button class="share-btn">分享</button>
                                        <button class="delete-btn">刪除</button>
                                    </div>
                                </li>`).join(""):y+="<li>無雲端行程</li>"}catch(o){y+="<li>讀取雲端行程失敗</li>",console.error(o)}}const n=e.appMode==="local"?"<h3>本地行程</h3>":"<h3>離線/本地行程</h3>";y+=n;try{const o=await t.getItineraries();o.length>0?y+=o.map(c=>`<li class="itinerary-manager-item" data-id="${c.id}" data-name="${B(c.name)}" data-source="local">
                                <span class="itinerary-manager-item-name">${B(c.name)}</span>
                                <div class="itinerary-manager-item-actions">
                                    <button class="load-btn">載入</button>
                                    ${e.appMode==="cloud"&&e.firebaseUser?'<button class="upload-btn">上傳至雲端</button>':""}
                                    <button class="delete-btn">刪除</button>
                                </div>
                            </li>`).join(""):y+="<li>無本地行程</li>"}catch(o){y+="<li>讀取本地行程失敗</li>",console.error(o)}m.innerHTML=y}function W(){document.querySelectorAll(".close-modal-btn").forEach(n=>n.addEventListener("click",()=>r.toggleModal(n.closest(".modal-backdrop"),!1))),document.getElementById("show-login-btn").addEventListener("click",()=>r.toggleModal(document.getElementById("login-modal"),!0)),document.getElementById("logout-btn").addEventListener("click",()=>a.signOut()),document.getElementById("login-btn").addEventListener("click",async()=>{const n=document.getElementById("login-email").value,o=document.getElementById("login-password").value;if(!n||!o)return r.showToast("請輸入電子郵件和密碼","warning");try{await a.signInWithEmailAndPassword(n,o),r.toggleModal(document.getElementById("login-modal"),!1)}catch(c){r.showToast(`登入失敗: ${c.message}`,"error")}}),document.getElementById("manage-itineraries-btn").addEventListener("click",O),document.getElementById("itinerary-manager-list").addEventListener("click",async n=>{const o=n.target,c=o.closest(".itinerary-manager-item");if(!c)return;const l=c.dataset.id,g=c.dataset.source,p=c.dataset.name;if(o.classList.contains("load-btn")){let w;if(g==="cloud"){const v=await s.collection("itineraries").doc(l).get();w={id:v.id,...v.data()}}else w=await t.getItineraryById(l);w&&R(w,g)}else if(o.classList.contains("delete-btn"))confirm(`確定要從 ${g==="cloud"?"雲端":"本機"} 刪除行程 "${p}" 嗎？`)&&(await H(l,g),e.currentItinerary&&e.currentItinerary.id===l&&r.resetUI(),r.showToast("行程已刪除","success"),O());else if(o.classList.contains("upload-btn")){if(!e.firebaseUser)return r.showToast("請先登入才能上傳","error");const w=await t.getItineraryById(l);if(!w)return r.showToast("找不到本地行程","error");const v={...w,ownerId:e.firebaseUser.uid,createdAt:firebase.firestore.FieldValue.serverTimestamp()};delete v.hash,delete v.salt,await s.collection("itineraries").doc(v.id).set(v),r.showToast("行程已成功上傳至雲端！","success"),confirm("上傳成功，要刪除這台電腦上的本地副本嗎？")&&await H(l,"local"),O()}else o.classList.contains("share-btn")&&(r.sharingItinerary={id:l,name:p},r.showShareModal())}),document.getElementById("generate-share-link-btn").addEventListener("click",async n=>{const{id:o,name:c}=r.sharingItinerary;if(!(!o||!e.firebaseUser)){n.target.disabled=!0,n.target.textContent="產生中...";try{const l=await e.firebaseUser.getIdToken(),p=`https://us-central1-${i.projectId}.cloudfunctions.net/createShareLink`,w=await fetch(p,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({data:{itineraryId:o}})});if(!w.ok){const N=await w.json();throw new Error(N.error||`伺服器錯誤: ${w.status}`)}const v=await w.json(),F=v.data.shareId;if(F){const j=`${`${window.location.origin}${window.location.pathname.replace(/index\.html$/,"")}`}share/${F}`;r.showShareModal(j)}else throw new Error(v.data.error||"未能取得分享 ID")}catch(l){console.error("產生分享連結失敗:",l),r.showToast(`產生分享連結失敗: ${l.message}`,"error")}finally{n.target.disabled=!1,n.target.textContent="重新產生"}}}),document.getElementById("copy-share-link-btn").addEventListener("click",()=>{const n=document.getElementById("share-link-input");n.value&&navigator.clipboard.writeText(n.value).then(()=>r.showToast("連結已複製！","success")).catch(()=>r.showToast("複製失敗","error"))}),document.getElementById("create-new-itinerary-btn").addEventListener("click",()=>{document.getElementById("new-itinerary-name").value="",r.toggleModal(document.getElementById("create-itinerary-modal"),!0)}),document.getElementById("save-new-itinerary-btn").addEventListener("click",async()=>{const n=document.getElementById("new-itinerary-name").value;if(!n)return r.showToast("請輸入行程名稱","error");if(e.appMode==="local"||!e.firebaseUser){const o={id:`local_${Date.now()}`,name:n,locations:[],createdAt:new Date().toISOString()};await t.saveItinerary(o),R(o,"local"),r.showToast("本地行程已建立!","success")}else{const o={name:n,ownerId:e.firebaseUser.uid,createdAt:firebase.firestore.FieldValue.serverTimestamp(),locations:[]},c=await s.collection("itineraries").add(o);R({id:c.id,...o},"cloud"),r.showToast("雲端行程已建立!","success")}r.toggleModal(document.getElementById("create-itinerary-modal"),!1),r.toggleModal(document.getElementById("itinerary-manager-modal"),!1)}),document.getElementById("add-location-btn").addEventListener("click",()=>{e.editingLocationId=null,document.getElementById("edit-location-title").textContent="新增景點";let n=new Date().toISOString().split("T")[0];e.currentItinerary.locations.length>0&&(n=e.currentItinerary.locations[e.currentItinerary.locations.length-1].date),document.getElementById("location-name").value="",document.getElementById("location-date").value=n,document.getElementById("location-category").value="sight",document.getElementById("location-description").value="",document.getElementById("location-coordinates").value="",document.getElementById("location-search-results").innerHTML="",f.coordinatesWarning.classList.add("hidden"),r.toggleModal(document.getElementById("edit-location-modal"),!0)}),document.getElementById("save-location-btn").addEventListener("click",z),document.getElementById("search-location-btn").addEventListener("click",U),document.getElementById("location-coordinates").addEventListener("input",()=>{f.coordinatesWarning.classList.remove("hidden")}),document.getElementById("location-search-results").addEventListener("click",n=>{const o=n.target.closest(".search-result-item");o&&(document.getElementById("location-name").value=o.textContent,document.getElementById("location-coordinates").value=`${o.dataset.lat}, ${o.dataset.lon}`,document.getElementById("location-search-results").innerHTML="",f.coordinatesWarning.classList.add("hidden"))}),f.itineraryListContainer.addEventListener("click",n=>{if(e.isReadOnlyMode||e.appMode==="cloud"&&!e.firebaseUser&&!e.currentItinerary||!e.currentItinerary)return;const o=n.target,c=o.closest(".location-item");if(!c)return;const l=c.dataset.id,g=e.currentItinerary.locations.find(p=>p.id===l);o.closest(".edit-btn")?(e.editingLocationId=l,document.getElementById("edit-location-title").textContent="編輯景點",document.getElementById("location-name").value=g.location,document.getElementById("location-date").value=g.date,document.getElementById("location-category").value=g.category,document.getElementById("location-description").value=g.description,document.getElementById("location-coordinates").value=g.coordinates.join(", "),document.getElementById("location-search-results").innerHTML="",f.coordinatesWarning.classList.add("hidden"),r.toggleModal(document.getElementById("edit-location-modal"),!0)):o.closest(".delete-btn")?confirm(`確定要刪除景點 "${g.location}" 嗎？`)&&(e.currentItinerary.locations=e.currentItinerary.locations.filter(p=>p.id!==l),k().then(()=>r.refreshUI())):g&&u.flyTo(g.coordinates,15)});let m=null;f.itineraryListContainer.addEventListener("dragstart",n=>{if(e.isReadOnlyMode||e.appMode==="cloud"&&!e.firebaseUser&&!e.currentItinerary||!e.currentItinerary)return;const o=n.target.closest(".location-item");o&&(m=o.dataset.id,setTimeout(()=>o.classList.add("dragging"),0))}),f.itineraryListContainer.addEventListener("dragover",n=>{m&&n.preventDefault()}),f.itineraryListContainer.addEventListener("drop",n=>{if(!m)return;n.preventDefault();const o=n.target.closest(".location-item"),c=e.currentItinerary.locations.findIndex(g=>g.id===m);let l=e.currentItinerary.locations.findIndex(g=>g.id===o?.dataset.id);if(c!==-1&&l!==-1&&c!==l){const[g]=e.currentItinerary.locations.splice(c,1);e.currentItinerary.locations.splice(l,0,g),g.date=e.currentItinerary.locations[l].date,k().then(()=>r.refreshUI())}m=null,document.querySelector(".dragging")?.classList.remove("dragging")}),f.itineraryListContainer.addEventListener("dragend",()=>{m=null,document.querySelector(".dragging")?.classList.remove("dragging")}),f.filters.addEventListener("click",n=>{if(n.target.tagName!=="BUTTON")return;const o=n.target;o.dataset.date!==void 0&&(e.filter.date=o.dataset.date),o.dataset.category!==void 0&&(e.filter.category=o.dataset.category),r.refreshUI()}),f.panelHandle.addEventListener("click",()=>{f.itineraryPanel.classList.toggle("open"),f.panelHandle.classList.toggle("open"),u&&setTimeout(()=>u.invalidateSize(!0),300)}),f.filtersHandle.addEventListener("click",()=>{f.filters.classList.toggle("collapsed"),f.filtersHandle.classList.toggle("collapsed")}),document.getElementById("export-json").addEventListener("click",()=>{if(!e.currentItinerary)return r.showToast("尚未載入行程","warning");const n=JSON.stringify(e.currentItinerary,null,4),o=new Blob([n],{type:"application/json"}),c=URL.createObjectURL(o),l=document.createElement("a");l.href=c,l.download=`${e.currentItinerary.name}.json`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(c)}),document.getElementById("export-printable").addEventListener("click",()=>{if(!e.currentItinerary||e.currentItinerary.locations.length===0)return r.showToast("沒有可列印的行程資料","warning");const{name:n,locations:o}=e.currentItinerary;r.showToast("正在準備預覽頁面...","normal");const c=o.reduce((M,$)=>(M[$.date]=M[$.date]||[],M[$.date].push($),M),{}),l=f.statsDays.innerText,g=f.statsLocations.innerText,p=f.statsDistance.innerText,w=`總天數: ${l} 天 | 總地點: ${g} 個 | 總距離: ${p} km`;let v='<table border=1 style="width:100%;border-collapse:collapse;font-size:12px;border-color:#ccc"><thead><tr style=background-color:#f2f2f2><th style="padding:8px;width:40px">#</th><th style=padding:8px>地點</th><th style="padding:8px;width:80px">分類</th><th style=padding:8px>描述</th></tr></thead><tbody>',F=1;for(const M of Object.keys(c).sort()){const $=new Date(M).toLocaleDateString("zh-TW",{weekday:"long"});v+=`<tr style="background-color:#e9ecef;font-weight:bold"><td colspan=4 style="padding:10px;border-left:none;border-right:none">${M} (${$})</td></tr>`;for(const q of c[M]){const J={sight:{name:"景點"},stay:{name:"住宿"},transport:{name:"交通"},food:{name:"餐飲"},default:{name:"其他"}};v+=`<tr><td style="padding:8px;text-align:center">${F++}</td><td style=padding:8px>${B(q.location)}</td><td style=padding:8px>${B(J[q.category]?.name||"其他")}</td><td style=padding:8px>${B(q.description)}</td></tr>`}}v+="</tbody></table>";const N=`<html><head><title>${B(n)} - 可列印版</title><meta charset=UTF-8><style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;margin:20px}h1{color:#2c3e50}p{color:#333}table{border:1px solid #ccc}th,td{border:1px solid #ccc}@media print{@page{margin:20mm}body{margin:0;-webkit-print-color-adjust:exact;print-color-adjust:exact}h1,p{margin-bottom:15px}table{page-break-inside:auto}tr{page-break-inside:avoid;page-break-after:auto}}</style></head><body><h1>${B(n)}</h1><p>${B(w)}</p>${v}</body></html>`,j=window.open();j.document.write(N),j.document.close(),setTimeout(()=>j.print(),500)});const y=document.getElementById("json-file-input");document.getElementById("load-from-json-btn").addEventListener("click",()=>{y.click()}),y.addEventListener("change",n=>{const o=n.target.files[0];if(!o)return;const c=new FileReader;c.onload=async l=>{try{const g=l.target.result,p=JSON.parse(g);if(!p||!p.id||!p.name||!Array.isArray(p.locations))throw new Error("檔案內容並非有效的行程格式。");delete p.ownerId,p.dataSource="local",await t.saveItinerary(p),r.showToast("行程已成功從 JSON 載入！","success"),O()}catch(g){console.error("載入 JSON 失敗:",g),r.showToast(`載入失敗: ${g.message}`,"error")}finally{n.target.value=null}},c.onerror=()=>{r.showToast("讀取檔案時發生錯誤","error"),n.target.value=null},c.readAsText(o)})}function G(){u=L.map(f.mapElement).setView([25.105497,121.517594],10),E=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(u),h=L.layerGroup().addTo(u),L.Control.Copyright=L.Control.extend({onAdd:function(c){const l=L.DomUtil.create("div","leaflet-control-copyright");return l.innerHTML=`&copy; <span id="currentYear"></span> Zanta's Utilities`,L.DomEvent.disableClickPropagation(l),l},onRemove:function(c){}}),new L.Control.Copyright({position:"bottomleft"}).addTo(u),document.getElementById("currentYear").textContent=new Date().getFullYear(),r.init({elements:f,globalState:e,map:u,tileLayer:E,layerGroup:h,getFilteredLocations:P}),W();const n=window.location.pathname.match(/\/share\/([a-zA-Z0-9_-]+)$/);if(n&&n[1]){const c=n[1];S(c)}else D();["test","development"].includes("production")||Z()}G()});
