(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))l(r);new MutationObserver(r=>{for(const m of r)if(m.type==="childList")for(const h of m.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&l(h)}).observe(document,{childList:!0,subtree:!0});function a(r){const m={};return r.integrity&&(m.integrity=r.integrity),r.referrerPolicy&&(m.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?m.credentials="include":r.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function l(r){if(r.ep)return;r.ep=!0;const m=a(r);fetch(r.href,m)}})();function E(t){return t?t.toString().replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[s]):""}function G(t,s){let a;return function(...l){const r=this;clearTimeout(a),a=setTimeout(()=>t.apply(r,l),s)}}class J{dbInstance=null;DB_NAME="TravelItinerariesDB_v3";STORE_NAME="itineraries";async init(){return this.dbInstance?this.dbInstance:new Promise((s,a)=>{const l=indexedDB.open(this.DB_NAME,1);l.onerror=r=>a("è³‡æ–™åº«é–‹å•Ÿå¤±æ•—",r.target.error),l.onsuccess=r=>{this.dbInstance=r.target.result,s(this.dbInstance)},l.onupgradeneeded=r=>{const m=r.target.result;m.objectStoreNames.contains(this.STORE_NAME)||m.createObjectStore(this.STORE_NAME,{keyPath:"id"})}})}async getStore(s="readonly"){return this.dbInstance||await this.init(),this.dbInstance.transaction(this.STORE_NAME,s).objectStore(this.STORE_NAME)}async saveItinerary(s){const a=await this.getStore("readwrite");return new Promise((l,r)=>{const m=a.put(s);m.onsuccess=l,m.onerror=r})}async deleteItinerary(s){const a=await this.getStore("readwrite");return new Promise((l,r)=>{const m=a.delete(s);m.onsuccess=l,m.onerror=r})}async getItineraries(){const s=await this.getStore();return new Promise((a,l)=>{const r=s.getAll();r.onsuccess=()=>a(r.result),r.onerror=l})}async getItineraryById(s){const a=await this.getStore();return new Promise((l,r)=>{const m=a.get(s);m.onsuccess=()=>l(m.result),m.onerror=r})}}let I={},b={},B,H,k,P;const U={sight:{name:"æ™¯é»",color:"var(--category-sight)"},stay:{name:"ä½å®¿",color:"var(--category-stay)"},transport:{name:"äº¤é€š",color:"var(--category-transport)"},food:{name:"é¤é£²",color:"var(--category-food)"},default:{name:"å…¶ä»–",color:"var(--category-default)"}},i={init(t){I=t.elements,b=t.globalState,B=t.map,H=t.tileLayer,k=t.layerGroup,P=t.getFilteredLocations},toggleModal(t,s){t&&t.classList.toggle("hidden",!s)},showToast(t,s="normal"){const a=document.createElement("div");a.className=`toast-message ${s}`,a.textContent=t,document.body.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove())},3e3)},updateAuthUI(){const{userInfo:t,guestInfo:s,manageBtn:a,userEmail:l}=I,{firebaseUser:r,appMode:m}=b;m==="cloud"&&r?(l.textContent=r.email,t.classList.remove("hidden"),s.classList.add("hidden"),a.disabled=!1):(t.classList.add("hidden"),s.classList.remove("hidden"),a.disabled=!1),m==="local"&&s.classList.add("hidden")},createItineraryList(t,s){const{itineraryListContainer:a}=I;if(b.appMode==="cloud"&&!b.firebaseUser&&t.length>0)return;if(t.length===0){a.innerHTML='<p class="empty-message">æ­¤è¡Œç¨‹æ²’æœ‰ä»»ä½•åœ°é»ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢ç¬¬ä¸€å€‹æ™¯é»å§ï¼</p>';return}const l=t.reduce((h,c)=>(h[c.date]||(h[c.date]=[]),h[c.date].push(c),h),{}),r=b.filter.date!=="all"||b.filter.category!=="all",m=Object.keys(l).sort().map(h=>{const e=l[h].map($=>{const x=s.some(T=>T.id===$.id);if(r&&!x)return"";const C=U[$.category]||U.default,A=s.findIndex(T=>T.id===$.id),j=x?A+1:"â€¢",O=E($.location);return`<div class="location-item" data-id="${$.id}" draggable="true"><span class="location-number" style="color: ${C.color};">${j}</span><p>${O}</p><span class="category-badge" style="background-color: ${C.color};">${C.name}</span>
                            <div class="location-controls">
                                <button class="edit-btn" title="ç·¨è¼¯">âœï¸</button>
                                <button class="delete-btn" title="åˆªé™¤">ğŸ—‘ï¸</button>
                            </div>
                        </div>`}).join("");return e?`<div class="day-group"><div class="day-header">${h}</div>${e}</div>`:""}).join("");a.innerHTML=m||'<p class="empty-message">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„æ™¯é»ã€‚</p>'},createFilterControls(t){const{dateFiltersContainer:s,categoryFiltersContainer:a}=I,r=[...new Set(t.map(c=>c.date))].sort().map(c=>`<button data-date="${c}" class="${b.filter.date===c?"active":""}">${c}</button>`).join("");s.innerHTML=`<button data-date="all" class="${b.filter.date==="all"?"active":""}">å…¨éƒ¨æ—¥æœŸ</button>${r}`;const h=[...new Set(t.map(c=>c.category))].map(c=>{const e=U[c]||U.default;return`<button data-category="${c}" class="${b.filter.category===c?"active":""}">${e.name}</button>`}).join("");a.innerHTML=`<button data-category="all" class="${b.filter.category==="all"?"active":""}">å…¨éƒ¨åˆ†é¡</button>${h}`},refreshUI(){if(!b.currentItinerary)return this.resetUI();const t=b.currentItinerary.locations,s=P();I.itineraryTitleEl.textContent=b.currentItinerary.name,I.addLocationContainer.classList.toggle("hidden",!b.currentItinerary),this.createFilterControls(t),this.createItineraryList(t,s),this.drawMap(s),this.updateStats(t)},resetUI(){let t="è«‹å¾ã€Œç®¡ç†ã€å»ºç«‹æˆ–è¼‰å…¥ä¸€å€‹è¡Œç¨‹";b.appMode==="cloud"&&!b.firebaseUser&&(t="è«‹å…ˆç™»å…¥ä»¥ç®¡ç†æ‚¨çš„è¡Œç¨‹"),I.itineraryTitleEl.textContent="å°šæœªè¼‰å…¥è¡Œç¨‹",I.addLocationContainer.classList.add("hidden"),I.itineraryListContainer.innerHTML=`<p class="empty-message">${t}</p>`,I.dateFiltersContainer.innerHTML="",I.categoryFiltersContainer.innerHTML="",k&&k.clearLayers(),this.updateStats([])},drawMap(t){if(!B||(k.clearLayers(),t.length===0))return;const s=L.latLngBounds();t.forEach((a,l)=>{const r=U[a.category]||U.default,m=L.divIcon({html:`<div style="background-color: ${r.color}; width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; box-shadow: var(--shadow); display: flex; justify-content: center; align-items: center; color: white; font-size: 14px; font-weight: bold;">${l+1}</div>`,className:"custom-marker-icon",iconSize:[28,28],iconAnchor:[14,14]}),h=L.marker(a.coordinates,{icon:m}),c=`<b>${E(a.location)}</b><br>${E(a.description||"ç„¡æè¿°")}`;h.bindPopup(c),h.addTo(k),s.extend(a.coordinates)});for(let a=0;a<t.length-1;a++)t[a].date===t[a+1].date&&L.polyline([t[a].coordinates,t[a+1].coordinates],{color:"#3388ff",weight:3,opacity:.7}).addTo(k);s.isValid()&&B.fitBounds(s.pad(.2),{maxZoom:15})},updateStats(t){I.statsDays.innerText=new Set(t.map(a=>a.date)).size,I.statsLocations.innerText=t.length;let s=0;B&&t.forEach((a,l)=>{l>0&&a.date===t[l-1].date&&(s+=B.distance(a.coordinates,t[l-1].coordinates))}),I.statsDistance.innerText=(s/1e3).toFixed(1)},showOfflineWarning(t){const{offlineWarningBanner:s,appContainer:a,searchLocationBtn:l}=I;s.classList.toggle("hidden",!t),a.classList.toggle("offline",t),t?(document.documentElement.style.setProperty("--primary-color","#e67e22"),l&&(l.disabled=!0,l.title="é›¢ç·šæ¨¡å¼ä¸‹ç„¡æ³•ä½¿ç”¨æœå°‹åŠŸèƒ½")):(document.documentElement.style.setProperty("--primary-color","#3498db"),l&&(l.disabled=!1,l.title="")),this.handleMapOfflineState(t)},handleMapOfflineState(t){B&&(I.mapOfflinePlaceholder.classList.toggle("hidden",!t),t?B.hasLayer(H)&&B.removeLayer(H):B.hasLayer(H)||H.addTo(B))}};function V(){{console.warn("Google Analytics Measurement ID å°šæœªè¨­å®šã€‚");return}}document.addEventListener("DOMContentLoaded",()=>{const t=new J,s={apiKey:"AIzaSyCavD0SHOLcQBwjJJ3aCGCY7Po-t4QR31k",authDomain:"travel-itinerary-helper.firebaseapp.com",projectId:"travel-itinerary-helper",storageBucket:"travel-itinerary-helper.firebasestorage.app",messagingSenderId:"853427118697",appId:"1:853427118697:web:c2d4520a4fc565b98438f8",measurementId:void 0};let a,l,r,m,h;const c={mapElement:document.getElementById("map"),itineraryPanel:document.getElementById("itinerary-panel"),panelHandle:document.getElementById("panel-handle"),itineraryListContainer:document.getElementById("itinerary-list"),dateFiltersContainer:document.getElementById("date-filters"),categoryFiltersContainer:document.getElementById("category-filters"),itineraryTitleEl:document.getElementById("itinerary-title"),addLocationContainer:document.getElementById("add-location-container"),mapOfflinePlaceholder:document.getElementById("map-offline-placeholder"),filters:document.getElementById("filters"),filtersHandle:document.getElementById("filters-handle"),coordinatesWarning:document.getElementById("coordinates-warning"),userInfo:document.getElementById("user-info"),guestInfo:document.getElementById("guest-info"),manageBtn:document.getElementById("manage-itineraries-btn"),userEmail:document.getElementById("user-email"),statsDays:document.getElementById("stats-days"),statsLocations:document.getElementById("stats-locations"),statsDistance:document.getElementById("stats-distance"),offlineWarningBanner:document.getElementById("offline-warning-banner"),appContainer:document.getElementById("app-container"),searchLocationBtn:document.getElementById("search-location-btn")},e={appMode:"cloud",firebaseUser:null,currentItinerary:null,filter:{date:"all",category:"all"},editingLocationId:null};async function $(){try{firebase.initializeApp(s),a=firebase.auth(),l=firebase.firestore(),await a.getRedirectResult(),e.appMode="cloud",console.log("Firebase connected. Running in Cloud Mode."),a.onAuthStateChanged(g=>{e.firebaseUser=g,i.updateAuthUI(),i.resetUI(),g?i.showToast(`æ­¡è¿, ${g.email}!`,"success"):i.showToast("æ‚¨å·²ç™»å‡º")})}catch(g){console.error("Firebase connection failed:",g),e.appMode="local",console.log("Running in Local Mode."),i.updateAuthUI(),i.resetUI(),i.showOfflineWarning(!0),setTimeout(T,100)}}async function x(){if(!e.currentItinerary)return;if((e.currentItinerary.dataSource||"local")==="cloud"){if(e.appMode!=="cloud"||!e.firebaseUser)return i.showToast("ç„¡æ³•å„²å­˜é›²ç«¯è¡Œç¨‹ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šä¸¦é‡æ–°æ•´ç†","error");await l.collection("itineraries").doc(e.currentItinerary.id).set(e.currentItinerary,{merge:!0})}else await t.saveItinerary(e.currentItinerary);i.showToast("è¡Œç¨‹å·²å„²å­˜ï¼","success")}async function C(g,f){if(f==="cloud"){if(!e.firebaseUser)return i.showToast("è«‹å…ˆç™»å…¥","error");await l.collection("itineraries").doc(g).delete()}else await t.deleteItinerary(g)}function A(){return e.currentItinerary?e.currentItinerary.locations.filter(g=>(e.filter.date==="all"||g.date===e.filter.date)&&(e.filter.category==="all"||g.category===e.filter.category)):[]}async function j(){if(!e.currentItinerary)return;const g=document.getElementById("location-name").value,f=document.getElementById("location-date").value,o=document.getElementById("location-category").value,n=document.getElementById("location-description").value,d=document.getElementById("location-coordinates").value;if(!g||!f||!d)return i.showToast("åœ°é»åç¨±ã€æ—¥æœŸå’Œåº§æ¨™ç‚ºå¿…å¡«é …","error");const u=d.split(",").map(Number);if(u.length!==2||isNaN(u[0])||isNaN(u[1]))return i.showToast("åº§æ¨™æ ¼å¼ä¸æ­£ç¢º","error");const y={date:f,location:g,category:o,description:n,coordinates:u};if(e.editingLocationId){const p=e.currentItinerary.locations.findIndex(w=>w.id===e.editingLocationId);p>-1&&(e.currentItinerary.locations[p]={...e.currentItinerary.locations[p],...y})}else y.id=`loc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,e.currentItinerary.locations.push(y);e.currentItinerary.locations.sort((p,w)=>new Date(p.date)-new Date(w.date));try{await x(),i.showToast("æ™¯é»å·²å„²å­˜ï¼","success"),i.toggleModal(document.getElementById("edit-location-modal"),!1),i.refreshUI()}catch(p){i.showToast(`å„²å­˜å¤±æ•—: ${p.message}`,"error")}}const O=G(async()=>{const g=document.getElementById("location-name").value;if(!g)return;const f=document.getElementById("location-search-results");f.innerHTML="æœå°‹ä¸­...";try{const o=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(g)}&limit=5`,{headers:{"User-Agent":"TravelItineraryHelper/3.0"}});if(!o.ok)throw new Error("API è«‹æ±‚å¤±æ•—");const n=await o.json();n.length===0?f.innerHTML="æ‰¾ä¸åˆ°çµæœ":f.innerHTML=n.map(d=>`<div class="search-result-item" data-lat="${d.lat}" data-lon="${d.lon}">${E(d.display_name)}</div>`).join("")}catch(o){f.innerHTML="æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤",i.showToast(o.message,"error")}},500);function D(g,f){g.dataSource=f,e.currentItinerary=g,e.filter={date:"all",category:"all"},i.refreshUI(),i.toggleModal(document.getElementById("itinerary-manager-modal"),!1)}async function T(){const g=document.getElementById("itinerary-manager-list");g.innerHTML="<li>è®€å–ä¸­...</li>",i.toggleModal(document.getElementById("itinerary-manager-modal"),!0);let f="";if(e.appMode==="cloud"&&e.firebaseUser){f+="<h3>é›²ç«¯è¡Œç¨‹</h3>";try{const d=(await l.collection("itineraries").where("ownerId","==",e.firebaseUser.uid).orderBy("createdAt","desc").get()).docs.map(u=>({id:u.id,...u.data()}));d.length>0?f+=d.map(u=>`<li class="itinerary-manager-item" data-id="${u.id}" data-name="${E(u.name)}" data-source="cloud">
                                    <span class="itinerary-manager-item-name">${E(u.name)}</span>
                                    <div class="itinerary-manager-item-actions">
                                        <button class="load-btn">è¼‰å…¥</button>
                                        <button class="delete-btn">åˆªé™¤</button>
                                    </div>
                                </li>`).join(""):f+="<li>ç„¡é›²ç«¯è¡Œç¨‹</li>"}catch(n){f+="<li>è®€å–é›²ç«¯è¡Œç¨‹å¤±æ•—</li>",console.error(n)}}const o=e.appMode==="local"?"<h3>æœ¬åœ°è¡Œç¨‹</h3>":"<h3>é›¢ç·š/æœ¬åœ°è¡Œç¨‹</h3>";f+=o;try{const n=await t.getItineraries();n.length>0?f+=n.map(d=>`<li class="itinerary-manager-item" data-id="${d.id}" data-name="${E(d.name)}" data-source="local">
                                <span class="itinerary-manager-item-name">${E(d.name)}</span>
                                <div class="itinerary-manager-item-actions">
                                    <button class="load-btn">è¼‰å…¥</button>
                                    ${e.appMode==="cloud"&&e.firebaseUser?'<button class="upload-btn">ä¸Šå‚³è‡³é›²ç«¯</button>':""}
                                    <button class="delete-btn">åˆªé™¤</button>
                                </div>
                            </li>`).join(""):f+="<li>ç„¡æœ¬åœ°è¡Œç¨‹</li>"}catch(n){f+="<li>è®€å–æœ¬åœ°è¡Œç¨‹å¤±æ•—</li>",console.error(n)}g.innerHTML=f}function R(){document.querySelectorAll(".close-modal-btn").forEach(o=>o.addEventListener("click",()=>i.toggleModal(o.closest(".modal-backdrop"),!1))),document.getElementById("show-login-btn").addEventListener("click",()=>i.toggleModal(document.getElementById("login-modal"),!0)),document.getElementById("logout-btn").addEventListener("click",()=>a.signOut()),document.getElementById("login-btn").addEventListener("click",async()=>{const o=document.getElementById("login-email").value,n=document.getElementById("login-password").value;if(!o||!n)return i.showToast("è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼","warning");try{await a.signInWithEmailAndPassword(o,n),i.toggleModal(document.getElementById("login-modal"),!1)}catch(d){i.showToast(`ç™»å…¥å¤±æ•—: ${d.message}`,"error")}}),document.getElementById("manage-itineraries-btn").addEventListener("click",T),document.getElementById("itinerary-manager-list").addEventListener("click",async o=>{const n=o.target,d=n.closest(".itinerary-manager-item");if(!d)return;const u=d.dataset.id,y=d.dataset.source,p=d.dataset.name;if(n.classList.contains("load-btn")){let w;if(y==="cloud"){const v=await l.collection("itineraries").doc(u).get();w={id:v.id,...v.data()}}else w=await t.getItineraryById(u);w&&D(w,y)}else if(n.classList.contains("delete-btn"))confirm(`ç¢ºå®šè¦å¾ ${y==="cloud"?"é›²ç«¯":"æœ¬æ©Ÿ"} åˆªé™¤è¡Œç¨‹ "${p}" å—ï¼Ÿ`)&&(await C(u,y),e.currentItinerary&&e.currentItinerary.id===u&&i.resetUI(),i.showToast("è¡Œç¨‹å·²åˆªé™¤","success"),T());else if(n.classList.contains("upload-btn")){if(!e.firebaseUser)return i.showToast("è«‹å…ˆç™»å…¥æ‰èƒ½ä¸Šå‚³","error");const w=await t.getItineraryById(u);if(!w)return i.showToast("æ‰¾ä¸åˆ°æœ¬åœ°è¡Œç¨‹","error");const v={...w,ownerId:e.firebaseUser.uid,createdAt:firebase.firestore.FieldValue.serverTimestamp()};delete v.hash,delete v.salt,await l.collection("itineraries").doc(v.id).set(v),i.showToast("è¡Œç¨‹å·²æˆåŠŸä¸Šå‚³è‡³é›²ç«¯ï¼","success"),confirm("ä¸Šå‚³æˆåŠŸï¼Œè¦åˆªé™¤é€™å°é›»è…¦ä¸Šçš„æœ¬åœ°å‰¯æœ¬å—ï¼Ÿ")&&await C(u,"local"),T()}}),document.getElementById("create-new-itinerary-btn").addEventListener("click",()=>{document.getElementById("new-itinerary-name").value="",i.toggleModal(document.getElementById("create-itinerary-modal"),!0)}),document.getElementById("save-new-itinerary-btn").addEventListener("click",async()=>{const o=document.getElementById("new-itinerary-name").value;if(!o)return i.showToast("è«‹è¼¸å…¥è¡Œç¨‹åç¨±","error");if(e.appMode==="local"||!e.firebaseUser){const n={id:`local_${Date.now()}`,name:o,locations:[],createdAt:new Date().toISOString()};await t.saveItinerary(n),D(n,"local"),i.showToast("æœ¬åœ°è¡Œç¨‹å·²å»ºç«‹!","success")}else{const n={name:o,ownerId:e.firebaseUser.uid,createdAt:firebase.firestore.FieldValue.serverTimestamp(),locations:[]},d=await l.collection("itineraries").add(n);D({id:d.id,...n},"cloud"),i.showToast("é›²ç«¯è¡Œç¨‹å·²å»ºç«‹!","success")}i.toggleModal(document.getElementById("create-itinerary-modal"),!1),i.toggleModal(document.getElementById("itinerary-manager-modal"),!1)}),document.getElementById("add-location-btn").addEventListener("click",()=>{e.editingLocationId=null,document.getElementById("edit-location-title").textContent="æ–°å¢æ™¯é»";let o=new Date().toISOString().split("T")[0];e.currentItinerary.locations.length>0&&(o=e.currentItinerary.locations[e.currentItinerary.locations.length-1].date),document.getElementById("location-name").value="",document.getElementById("location-date").value=o,document.getElementById("location-category").value="sight",document.getElementById("location-description").value="",document.getElementById("location-coordinates").value="",document.getElementById("location-search-results").innerHTML="",c.coordinatesWarning.classList.add("hidden"),i.toggleModal(document.getElementById("edit-location-modal"),!0)}),document.getElementById("save-location-btn").addEventListener("click",j),document.getElementById("search-location-btn").addEventListener("click",O),document.getElementById("location-coordinates").addEventListener("input",()=>{c.coordinatesWarning.classList.remove("hidden")}),document.getElementById("location-search-results").addEventListener("click",o=>{const n=o.target.closest(".search-result-item");n&&(document.getElementById("location-name").value=n.textContent,document.getElementById("location-coordinates").value=`${n.dataset.lat}, ${n.dataset.lon}`,document.getElementById("location-search-results").innerHTML="",c.coordinatesWarning.classList.add("hidden"))}),c.itineraryListContainer.addEventListener("click",o=>{if(e.appMode==="cloud"&&!e.firebaseUser&&!e.currentItinerary||!e.currentItinerary)return;const n=o.target,d=n.closest(".location-item");if(!d)return;const u=d.dataset.id,y=e.currentItinerary.locations.find(p=>p.id===u);n.closest(".edit-btn")?(e.editingLocationId=u,document.getElementById("edit-location-title").textContent="ç·¨è¼¯æ™¯é»",document.getElementById("location-name").value=y.location,document.getElementById("location-date").value=y.date,document.getElementById("location-category").value=y.category,document.getElementById("location-description").value=y.description,document.getElementById("location-coordinates").value=y.coordinates.join(", "),document.getElementById("location-search-results").innerHTML="",c.coordinatesWarning.classList.add("hidden"),i.toggleModal(document.getElementById("edit-location-modal"),!0)):n.closest(".delete-btn")?confirm(`ç¢ºå®šè¦åˆªé™¤æ™¯é» "${y.location}" å—ï¼Ÿ`)&&(e.currentItinerary.locations=e.currentItinerary.locations.filter(p=>p.id!==u),x().then(()=>i.refreshUI())):y&&r.flyTo(y.coordinates,15)});let g=null;c.itineraryListContainer.addEventListener("dragstart",o=>{if(!e.currentItinerary)return;const n=o.target.closest(".location-item");n&&(g=n.dataset.id,setTimeout(()=>n.classList.add("dragging"),0))}),c.itineraryListContainer.addEventListener("dragover",o=>{g&&o.preventDefault()}),c.itineraryListContainer.addEventListener("drop",o=>{if(!g)return;o.preventDefault();const n=o.target.closest(".location-item"),d=e.currentItinerary.locations.findIndex(y=>y.id===g);let u=e.currentItinerary.locations.findIndex(y=>y.id===n?.dataset.id);if(d!==-1&&u!==-1&&d!==u){const[y]=e.currentItinerary.locations.splice(d,1);e.currentItinerary.locations.splice(u,0,y),y.date=e.currentItinerary.locations[u].date,x().then(()=>i.refreshUI())}g=null,document.querySelector(".dragging")?.classList.remove("dragging")}),c.itineraryListContainer.addEventListener("dragend",()=>{g=null,document.querySelector(".dragging")?.classList.remove("dragging")}),c.filters.addEventListener("click",o=>{if(o.target.tagName!=="BUTTON")return;const n=o.target;n.dataset.date!==void 0&&(e.filter.date=n.dataset.date),n.dataset.category!==void 0&&(e.filter.category=n.dataset.category),i.refreshUI()}),c.panelHandle.addEventListener("click",()=>{c.itineraryPanel.classList.toggle("open"),c.panelHandle.classList.toggle("open"),r&&setTimeout(()=>r.invalidateSize(!0),300)}),c.filtersHandle.addEventListener("click",()=>{c.filters.classList.toggle("collapsed"),c.filtersHandle.classList.toggle("collapsed")}),document.getElementById("export-json").addEventListener("click",()=>{if(!e.currentItinerary)return i.showToast("å°šæœªè¼‰å…¥è¡Œç¨‹","warning");const o=JSON.stringify(e.currentItinerary,null,4),n=new Blob([o],{type:"application/json"}),d=URL.createObjectURL(n),u=document.createElement("a");u.href=d,u.download=`${e.currentItinerary.name}.json`,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(d)}),document.getElementById("export-printable").addEventListener("click",()=>{if(!e.currentItinerary||e.currentItinerary.locations.length===0)return i.showToast("æ²’æœ‰å¯åˆ—å°çš„è¡Œç¨‹è³‡æ–™","warning");const{name:o,locations:n}=e.currentItinerary;i.showToast("æ­£åœ¨æº–å‚™é è¦½é é¢...","normal");const d=n.reduce((M,S)=>(M[S.date]=M[S.date]||[],M[S.date].push(S),M),{}),u=c.statsDays.innerText,y=c.statsLocations.innerText,p=c.statsDistance.innerText,w=`ç¸½å¤©æ•¸: ${u} å¤© | ç¸½åœ°é»: ${y} å€‹ | ç¸½è·é›¢: ${p} km`;let v='<table border=1 style="width:100%;border-collapse:collapse;font-size:12px;border-color:#ccc"><thead><tr style=background-color:#f2f2f2><th style="padding:8px;width:40px">#</th><th style=padding:8px>åœ°é»</th><th style="padding:8px;width:80px">åˆ†é¡</th><th style=padding:8px>æè¿°</th></tr></thead><tbody>',z=1;for(const M of Object.keys(d).sort()){const S=new Date(M).toLocaleDateString("zh-TW",{weekday:"long"});v+=`<tr style="background-color:#e9ecef;font-weight:bold"><td colspan=4 style="padding:10px;border-left:none;border-right:none">${M} (${S})</td></tr>`;for(const N of d[M]){const W={sight:{name:"æ™¯é»"},stay:{name:"ä½å®¿"},transport:{name:"äº¤é€š"},food:{name:"é¤é£²"},default:{name:"å…¶ä»–"}};v+=`<tr><td style="padding:8px;text-align:center">${z++}</td><td style=padding:8px>${E(N.location)}</td><td style=padding:8px>${E(W[N.category]?.name||"å…¶ä»–")}</td><td style=padding:8px>${E(N.description)}</td></tr>`}}v+="</tbody></table>";const _=`<html><head><title>${E(o)} - å¯åˆ—å°ç‰ˆ</title><meta charset=UTF-8><style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;margin:20px}h1{color:#2c3e50}p{color:#333}table{border:1px solid #ccc}th,td{border:1px solid #ccc}@media print{@page{margin:20mm}body{margin:0;-webkit-print-color-adjust:exact;print-color-adjust:exact}h1,p{margin-bottom:15px}table{page-break-inside:auto}tr{page-break-inside:avoid;page-break-after:auto}}</style></head><body><h1>${E(o)}</h1><p>${E(w)}</p>${v}</body></html>`,F=window.open();F.document.write(_),F.document.close(),setTimeout(()=>F.print(),500)});const f=document.getElementById("json-file-input");document.getElementById("load-from-json-btn").addEventListener("click",()=>{f.click()}),f.addEventListener("change",o=>{const n=o.target.files[0];if(!n)return;const d=new FileReader;d.onload=async u=>{try{const y=u.target.result,p=JSON.parse(y);if(!p||!p.id||!p.name||!Array.isArray(p.locations))throw new Error("æª”æ¡ˆå…§å®¹ä¸¦éæœ‰æ•ˆçš„è¡Œç¨‹æ ¼å¼ã€‚");delete p.ownerId,p.dataSource="local",await t.saveItinerary(p),i.showToast("è¡Œç¨‹å·²æˆåŠŸå¾ JSON è¼‰å…¥ï¼","success"),T()}catch(y){console.error("è¼‰å…¥ JSON å¤±æ•—:",y),i.showToast(`è¼‰å…¥å¤±æ•—: ${y.message}`,"error")}finally{o.target.value=null}},d.onerror=()=>{i.showToast("è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤","error"),o.target.value=null},d.readAsText(n)})}function q(){r=L.map(c.mapElement).setView([25.105497,121.517594],10),m=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(r),h=L.layerGroup().addTo(r),L.Control.Copyright=L.Control.extend({onAdd:function(o){const n=L.DomUtil.create("div","leaflet-control-copyright");return n.innerHTML=`&copy; <span id="currentYear"></span> Zanta's Utilities`,L.DomEvent.disableClickPropagation(n),n},onRemove:function(o){}}),new L.Control.Copyright({position:"bottomleft"}).addTo(r),document.getElementById("currentYear").textContent=new Date().getFullYear(),i.init({elements:c,globalState:e,map:r,tileLayer:m,layerGroup:h,getFilteredLocations:A}),R(),$(),["test","development"].includes("production")||V()}q()});
