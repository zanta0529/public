(function(){const E=document.createElement("link").relList;if(E&&E.supports&&E.supports("modulepreload"))return;for(const u of document.querySelectorAll('link[rel="modulepreload"]'))p(u);new MutationObserver(u=>{for(const m of u)if(m.type==="childList")for(const b of m.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&p(b)}).observe(document,{childList:!0,subtree:!0});function T(u){const m={};return u.integrity&&(m.integrity=u.integrity),u.referrerPolicy&&(m.referrerPolicy=u.referrerPolicy),u.crossOrigin==="use-credentials"?m.credentials="include":u.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function p(u){if(u.ep)return;u.ep=!0;const m=T(u);fetch(u.href,m)}})();document.addEventListener("DOMContentLoaded",()=>{const j=document.getElementById("map"),E=document.getElementById("itinerary-panel"),T=document.getElementById("panel-handle"),p=document.getElementById("itinerary-list"),u=document.getElementById("date-filters"),m=document.getElementById("category-filters"),b=document.getElementById("manage-itineraries-btn"),k=document.getElementById("itinerary-manager-modal"),C=document.getElementById("create-itinerary-modal"),B=document.getElementById("password-prompt-modal"),M=document.getElementById("edit-location-modal"),P=document.getElementById("itinerary-title"),A=document.getElementById("read-only-indicator"),q=document.getElementById("add-location-container"),U=document.getElementById("export-json"),F=document.getElementById("export-printable"),a={currentItinerary:null,isReadOnly:!0,filter:{date:"all",category:"all"},editingLocationId:null},h={sight:{name:"景點",color:"var(--category-sight)"},stay:{name:"住宿",color:"var(--category-stay)"},transport:{name:"交通",color:"var(--category-transport)"},food:{name:"餐飲",color:"var(--category-food)"},default:{name:"其他",color:"var(--category-default)"}},v=L.map(j).setView([25.105497,121.517594],10);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(v);const S=L.layerGroup().addTo(v),f=(()=>{let r;const n="TravelItinerariesDB",t="itineraries";async function o(){return new Promise((e,s)=>{const d=indexedDB.open(n,1);d.onerror=c=>s("資料庫開啟失敗",c.target.error),d.onsuccess=c=>{r=c.target.result,e(r)},d.onupgradeneeded=c=>{const l=c.target.result;l.objectStoreNames.contains(t)||l.createObjectStore(t,{keyPath:"id"})}})}async function i(e="readonly"){return r||await o(),r.transaction(t,e).objectStore(t)}return{init:o,async saveItinerary(e){const s=await i("readwrite");return new Promise((d,c)=>{const l=s.put(e);l.onsuccess=d,l.onerror=c})},async getItineraries(){const e=await i();return new Promise((s,d)=>{const c=e.getAll();c.onsuccess=()=>s(c.result),c.onerror=d})},async getItineraryById(e){const s=await i();return new Promise((d,c)=>{const l=s.get(e);l.onsuccess=()=>d(l.result),l.onerror=c})},async deleteItinerary(e){const s=await i("readwrite");return new Promise((d,c)=>{const l=s.delete(e);l.onsuccess=d,l.onerror=c})}}})(),D=(()=>{const r=new TextEncoder;async function n(t,o){const i=await crypto.subtle.importKey("raw",r.encode(t),{name:"PBKDF2"},!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveBits({name:"PBKDF2",salt:o,iterations:1e5,hash:"SHA-256"},i,256)}return{async hashPassword(t){const o=crypto.getRandomValues(new Uint8Array(16)),i=await n(t,o);return{hash:Array.from(new Uint8Array(i)).map(d=>d.toString(16).padStart(2,"0")).join(""),salt:o}},async verifyPassword(t,o,i){const e=await n(t,o);return Array.from(new Uint8Array(e)).map(c=>c.toString(16).padStart(2,"0")).join("")===i}}})();function w(){if(!a.currentItinerary){O();return}const r=a.currentItinerary.locations,n=z();P.textContent=a.currentItinerary.name,A.classList.toggle("hidden",!a.isReadOnly),q.classList.toggle("hidden",a.isReadOnly),V(r),J(r,n),_(n),R(r)}function O(){P.textContent="尚未載入行程",A.classList.add("hidden"),q.classList.add("hidden"),p.innerHTML='<p class="empty-message">請從「管理」建立或載入一個行程。</p>',u.innerHTML="",m.innerHTML="",S.clearLayers(),R([])}function z(){return a.currentItinerary?a.currentItinerary.locations.filter(r=>(a.filter.date==="all"||r.date===a.filter.date)&&(a.filter.category==="all"||r.category===a.filter.category)):[]}function J(r,n){if(r.length===0){p.innerHTML=a.isReadOnly?'<p class="empty-message">此行程沒有任何地點。</p>':'<p class="empty-message">此行程沒有任何地點，點擊下方按鈕新增第一個景點吧！</p>';return}const t=r.reduce((e,s)=>(e[s.date]||(e[s.date]=[]),e[s.date].push(s),e),{}),o=a.filter.date!=="all"||a.filter.category!=="all",i=Object.keys(t).sort().map(e=>{const d=t[e].map(c=>{const l=n.some(N=>N.id===c.id);if(o&&!l)return"";const $=h[c.category]||h.default,X=n.findIndex(N=>N.id===c.id),Y=l?X+1:"•",tt=g(c.location);return`
                    <div class="location-item" data-id="${c.id}" draggable="${!a.isReadOnly}">
                        <span class="location-number" style="color: ${$.color};">${Y}</span>
                        <p>${tt}</p>
                        <span class="category-badge" style="background-color: ${$.color};">${$.name}</span>
                        ${a.isReadOnly?"":`
                        <div class="location-controls">
                            <button class="edit-btn" title="編輯">✏️</button>
                            <button class="delete-btn" title="刪除">🗑️</button>
                        </div>`}
                    </div>`}).join("");return d?`<div class="day-group"><div class="day-header">${e}</div>${d}</div>`:""}).join("");p.innerHTML=i||'<p class="empty-message">沒有符合篩選條件的景點。</p>'}function V(r){const t=[...new Set(r.map(e=>e.date))].sort().map(e=>`<button data-date="${e}" class="${a.filter.date===e?"active":""}">${e}</button>`).join("");u.innerHTML=`<button data-date="all" class="${a.filter.date==="all"?"active":""}">全部日期</button>${t}`;const i=[...new Set(r.map(e=>e.category))].map(e=>{const s=h[e]||h.default;return`<button data-category="${e}" class="${a.filter.category===e?"active":""}">${s.name}</button>`}).join("");m.innerHTML=`<button data-category="all" class="${a.filter.category==="all"?"active":""}">全部分類</button>${i}`}function _(r){if(S.clearLayers(),r.length===0)return;const n=L.latLngBounds();r.forEach((t,o)=>{const i=h[t.category]||h.default,e=L.divIcon({html:`<div style="background-color: ${i.color}; width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; box-shadow: var(--shadow); display: flex; justify-content: center; align-items: center; color: white; font-size: 14px; font-weight: bold;">${o+1}</div>`,className:"custom-marker-icon",iconSize:[28,28],iconAnchor:[14,14]}),s=L.marker(t.coordinates,{icon:e}),d=`<b>${g(t.location)}</b><br>${g(t.description||"無描述")}`;s.bindPopup(d),s.addTo(S),n.extend(t.coordinates)});for(let t=0;t<r.length-1;t++)r[t].date===r[t+1].date&&L.polyline([r[t].coordinates,r[t+1].coordinates],{color:"#3388ff",weight:3,opacity:.7}).addTo(S);n.isValid()&&v.fitBounds(n.pad(.2),{maxZoom:15})}function R(r){document.getElementById("stats-days").innerText=new Set(r.map(t=>t.date)).size,document.getElementById("stats-locations").innerText=r.length;let n=0;r.forEach((t,o)=>{o>0&&t.date===r[o-1].date&&(n+=v.distance(t.coordinates,r[o-1].coordinates))}),document.getElementById("stats-distance").innerText=(n/1e3).toFixed(1)}function I(r,n){r.classList.toggle("hidden",!n)}async function x(){const r=await f.getItineraries(),n=document.getElementById("itinerary-manager-list");r.length===0?n.innerHTML="<li>尚未建立任何行程。</li>":n.innerHTML=r.map(t=>`
                <li class="itinerary-manager-item" data-id="${t.id}">
                    <span class="itinerary-manager-item-name">${g(t.name)}</span>
                    <div class="itinerary-manager-item-actions">
                        <button class="load-btn">載入</button>
                        <button class="delete-btn">刪除</button>
                    </div>
                </li>
            `).join(""),I(k,!0)}function H(r,n){a.currentItinerary=r,a.isReadOnly=n,a.filter={date:"all",category:"all"},w(),I(k,!1),I(B,!1)}async function K(){const r=document.getElementById("location-name").value,n=document.getElementById("location-date").value,t=document.getElementById("location-category").value,o=document.getElementById("location-description").value,i=document.getElementById("location-coordinates").value;if(!r||!n||!i){y("地點名稱、日期和座標為必填項","error");return}const e=i.split(",").map(Number);if(e.length!==2||isNaN(e[0])||isNaN(e[1])){y("座標格式不正確","error");return}const s={date:n,location:r,category:t,description:o,coordinates:e,image:""};if(a.editingLocationId){const d=a.currentItinerary.locations.findIndex(c=>c.id===a.editingLocationId);d>-1&&(a.currentItinerary.locations[d]={...a.currentItinerary.locations[d],...s})}else s.id=`loc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,a.currentItinerary.locations.push(s);a.currentItinerary.locations.sort((d,c)=>new Date(d.date)-new Date(c.date)),await f.saveItinerary(a.currentItinerary),y("景點已儲存！","success"),I(M,!1),w()}const G=Z(async()=>{const r=document.getElementById("location-name").value;if(!r)return;const n=document.getElementById("location-search-results");n.innerHTML="搜尋中...";try{const t=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(r)}&limit=5`,{headers:{"User-Agent":"TravelItineraryHelper/2.1"}});if(!t.ok)throw new Error("API 請求失敗");const o=await t.json();o.length===0?n.innerHTML="找不到結果":n.innerHTML=o.map(i=>`<div class="search-result-item" data-lat="${i.lat}" data-lon="${i.lon}">${g(i.display_name)}</div>`).join("")}catch(t){n.innerHTML="搜尋時發生錯誤",y(t.message,"error")}},500);function W(){document.querySelectorAll(".close-modal-btn").forEach(n=>{n.addEventListener("click",()=>I(n.closest(".modal-backdrop"),!1))}),b.addEventListener("click",x),k.addEventListener("click",async n=>{const t=n.target,o=t.closest(".itinerary-manager-item");if(!o)return;const i=o.dataset.id;if(t.classList.contains("load-btn")){const e=await f.getItineraryById(i);e.hash?(I(B,!0),B.dataset.id=i):H(e,!1)}else if(t.classList.contains("delete-btn")){const e=o.querySelector(".itinerary-manager-item-name").textContent;confirm(`確定要刪除行程 "${e}" 嗎？此操作無法復原。`)&&(await f.deleteItinerary(i),a.currentItinerary&&a.currentItinerary.id===i&&(a.currentItinerary=null,O()),y("行程已刪除","success"),x())}}),document.getElementById("create-new-itinerary-btn").addEventListener("click",()=>{I(C,!0)}),document.getElementById("import-itinerary-btn").addEventListener("click",()=>{document.getElementById("import-file-input").click()}),document.getElementById("import-file-input").addEventListener("change",n=>{const t=n.target.files[0];if(!t)return;const o=new FileReader;o.onload=async i=>{try{const e=JSON.parse(i.target.result);if(!e.id||!e.name||!e.locations)throw new Error("無效的檔案格式");await f.saveItinerary(e),y(`行程 "${e.name}" 已成功匯入！`,"success"),x()}catch(e){y(`匯入失敗: ${e.message}`,"error")}},o.readAsText(t),n.target.value=""}),document.getElementById("save-new-itinerary-btn").addEventListener("click",async()=>{const n=document.getElementById("new-itinerary-name").value,t=document.getElementById("new-itinerary-password").value;if(!n){y("請輸入行程名稱","error");return}const o={id:`it_${Date.now()}`,name:n,createdAt:new Date().toISOString(),locations:[],hash:null,salt:null};if(t){const{hash:i,salt:e}=await D.hashPassword(t);o.hash=i,o.salt=e}await f.saveItinerary(o),y("行程已建立！","success"),I(C,!1),x()}),document.getElementById("submit-password-btn").addEventListener("click",async()=>{const n=B.dataset.id,t=document.getElementById("itinerary-password-input").value,o=await f.getItineraryById(n);await D.verifyPassword(t,o.salt,o.hash)?H(o,!1):y("密碼錯誤！","error"),document.getElementById("itinerary-password-input").value=""}),document.getElementById("load-readonly-btn").addEventListener("click",async()=>{const n=B.dataset.id,t=await f.getItineraryById(n);H(t,!0)}),document.getElementById("add-location-btn").addEventListener("click",()=>{a.editingLocationId=null,document.getElementById("edit-location-title").textContent="新增景點";let n=new Date().toISOString().split("T")[0];a.currentItinerary&&a.currentItinerary.locations.length>0&&(n=a.currentItinerary.locations[a.currentItinerary.locations.length-1].date),document.getElementById("location-name").value="",document.getElementById("location-date").value=n,document.getElementById("location-category").value="sight",document.getElementById("location-description").value="",document.getElementById("location-coordinates").value="",document.getElementById("location-search-results").innerHTML="",I(M,!0)}),document.getElementById("save-location-btn").addEventListener("click",K),document.getElementById("search-location-btn").addEventListener("click",G),document.getElementById("location-search-results").addEventListener("click",n=>{const t=n.target.closest(".search-result-item");t&&(document.getElementById("location-name").value=t.textContent,document.getElementById("location-coordinates").value=`${t.dataset.lat}, ${t.dataset.lon}`,document.getElementById("location-search-results").innerHTML="")}),p.addEventListener("click",n=>{const t=n.target,o=t.closest(".location-item");if(!o)return;const i=o.dataset.id;if(t.closest(".edit-btn")){a.editingLocationId=i;const e=a.currentItinerary.locations.find(s=>s.id===i);document.getElementById("edit-location-title").textContent="編輯景點",document.getElementById("location-name").value=e.location,document.getElementById("location-date").value=e.date,document.getElementById("location-category").value=e.category,document.getElementById("location-description").value=e.description,document.getElementById("location-coordinates").value=e.coordinates.join(", "),I(M,!0)}else if(t.closest(".delete-btn")){const e=o.querySelector("p").textContent;confirm(`確定要刪除景點 "${e}" 嗎？`)&&(a.currentItinerary.locations=a.currentItinerary.locations.filter(s=>s.id!==i),f.saveItinerary(a.currentItinerary),w())}else{const e=a.currentItinerary.locations.find(s=>s.id===i);e&&v.flyTo(e.coordinates,15)}});let r=null;p.addEventListener("dragstart",n=>{if(a.isReadOnly)return;const t=n.target.closest(".location-item");t&&(r=t.dataset.id,setTimeout(()=>t.classList.add("dragging"),0))}),p.addEventListener("dragover",n=>{a.isReadOnly||!r||n.preventDefault()}),p.addEventListener("drop",n=>{if(a.isReadOnly||!r)return;n.preventDefault();const t=n.target.closest(".location-item"),o=a.currentItinerary.locations.findIndex(e=>e.id===r);let i=a.currentItinerary.locations.findIndex(e=>e.id===t?.dataset.id);if(o!==-1&&i!==-1&&o!==i){const[e]=a.currentItinerary.locations.splice(o,1);a.currentItinerary.locations.splice(i,0,e);const s=a.currentItinerary.locations[i].date;e.date=s,f.saveItinerary(a.currentItinerary),w()}r=null,document.querySelector(".dragging")?.classList.remove("dragging")}),p.addEventListener("dragend",()=>{r=null,document.querySelector(".dragging")?.classList.remove("dragging")}),document.getElementById("filters").addEventListener("click",n=>{if(n.target.tagName!=="BUTTON")return;const t=n.target;t.dataset.date!==void 0&&(a.filter.date=t.dataset.date),t.dataset.category!==void 0&&(a.filter.category=t.dataset.category),w()}),T.addEventListener("click",()=>{E.classList.toggle("open"),T.classList.toggle("open"),setTimeout(()=>v.invalidateSize(!0),300)}),U.addEventListener("click",()=>{if(!a.currentItinerary){y("尚未載入任何行程","warning");return}const n=JSON.parse(JSON.stringify(a.currentItinerary));delete n.salt;const t=JSON.stringify(n,null,4),o=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(o),e=document.createElement("a");e.href=i,e.download=`${a.currentItinerary.name}.json`,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(i),y("行程資料已匯出為 JSON 檔！","success")}),F.addEventListener("click",()=>{if(!a.currentItinerary||a.currentItinerary.locations.length===0){y("沒有可列印的行程資料","warning");return}y("正在準備預覽頁面...","normal");const n=a.currentItinerary.locations,t=document.getElementById("stats-days").innerText,o=document.getElementById("stats-locations").innerText,i=document.getElementById("stats-distance").innerText,e=`總天數: ${t} 天 | 總地點: ${o} 個 | 總距離: ${i} km`;let s=`
                <table border="1" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th style="padding: 8px;">#</th>
                            <th style="padding: 8px;">日期</th>
                            <th style="padding: 8px;">地點</th>
                            <th style="padding: 8px;">分類</th>
                            <th style="padding: 8px;">描述</th>
                        </tr>
                    </thead>
                    <tbody>`;n.forEach((l,$)=>{s+=`
                    <tr>
                        <td style="padding: 8px;">${$+1}</td>
                        <td style="padding: 8px;">${g(l.date)}</td>
                        <td style="padding: 8px;">${g(l.location)}</td>
                        <td style="padding: 8px;">${g(h[l.category]?.name||"其他")}</td>
                        <td style="padding: 8px;">${g(l.description)}</td>
                    </tr>`}),s+="</tbody></table>";const d=`
                <html>
                <head>
                    <title>${g(a.currentItinerary.name)} - 可列印版</title>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: sans-serif; margin: 20px; }
                        h1, p { margin-bottom: 15px; }
                        @media print {
                            @page { margin: 20mm; }
                            body { margin: 0; }
                            table { page-break-inside: auto; }
                            tr { page-break-inside: avoid; page-break-after: auto; }
                        }
                    </style>
                </head>
                <body>
                    <h1>${g(a.currentItinerary.name)}</h1>
                    <p>${g(e)}</p>
                    ${s}
                </body>
                </html>`,c=window.open();c.document.write(d),c.document.close(),setTimeout(()=>c.print(),500)})}function y(r,n="normal"){const t=document.createElement("div");t.className=`toast-message ${n}`,t.textContent=r,document.body.appendChild(t),setTimeout(()=>t.classList.add("show"),10),setTimeout(()=>{t.classList.remove("show"),t.addEventListener("transitionend",()=>t.remove())},3e3)}function g(r){return r?r.replace(/[&<>"']/g,function(n){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[n]}):""}function Z(r,n){let t;return function(...o){const i=this;clearTimeout(t),t=setTimeout(()=>r.apply(i,o),n)}}async function Q(){await f.init(),W(),O(),x()}Q()});
