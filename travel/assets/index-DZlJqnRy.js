(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))l(r);new MutationObserver(r=>{for(const m of r)if(m.type==="childList")for(const h of m.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&l(h)}).observe(document,{childList:!0,subtree:!0});function n(r){const m={};return r.integrity&&(m.integrity=r.integrity),r.referrerPolicy&&(m.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?m.credentials="include":r.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function l(r){if(r.ep)return;r.ep=!0;const m=n(r);fetch(r.href,m)}})();function w(t){return t?t.toString().replace(/[&<>"']/g,o=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[o]):""}function W(t,o){let n;return function(...l){const r=this;clearTimeout(n),n=setTimeout(()=>t.apply(r,l),o)}}class J{dbInstance=null;DB_NAME="TravelItinerariesDB_v3";STORE_NAME="itineraries";async init(){return this.dbInstance?this.dbInstance:new Promise((o,n)=>{const l=indexedDB.open(this.DB_NAME,1);l.onerror=r=>n("資料庫開啟失敗",r.target.error),l.onsuccess=r=>{this.dbInstance=r.target.result,o(this.dbInstance)},l.onupgradeneeded=r=>{const m=r.target.result;m.objectStoreNames.contains(this.STORE_NAME)||m.createObjectStore(this.STORE_NAME,{keyPath:"id"})}})}async getStore(o="readonly"){return this.dbInstance||await this.init(),this.dbInstance.transaction(this.STORE_NAME,o).objectStore(this.STORE_NAME)}async saveItinerary(o){const n=await this.getStore("readwrite");return new Promise((l,r)=>{const m=n.put(o);m.onsuccess=l,m.onerror=r})}async deleteItinerary(o){const n=await this.getStore("readwrite");return new Promise((l,r)=>{const m=n.delete(o);m.onsuccess=l,m.onerror=r})}async getItineraries(){const o=await this.getStore();return new Promise((n,l)=>{const r=o.getAll();r.onsuccess=()=>n(r.result),r.onerror=l})}async getItineraryById(o){const n=await this.getStore();return new Promise((l,r)=>{const m=n.get(o);m.onsuccess=()=>l(m.result),m.onerror=r})}}let b={},E={},v,D,U,P;const k={sight:{name:"景點",color:"var(--category-sight)"},stay:{name:"住宿",color:"var(--category-stay)"},transport:{name:"交通",color:"var(--category-transport)"},food:{name:"餐飲",color:"var(--category-food)"},default:{name:"其他",color:"var(--category-default)"}},s={init(t){b=t.elements,E=t.globalState,v=t.map,D=t.tileLayer,U=t.layerGroup,P=t.getFilteredLocations},toggleModal(t,o){t&&t.classList.toggle("hidden",!o)},showToast(t,o="normal"){const n=document.createElement("div");n.className=`toast-message ${o}`,n.textContent=t,document.body.appendChild(n),setTimeout(()=>n.classList.add("show"),10),setTimeout(()=>{n.classList.remove("show"),n.addEventListener("transitionend",()=>n.remove())},3e3)},updateAuthUI(){const{userInfo:t,guestInfo:o,manageBtn:n,userEmail:l}=b,{firebaseUser:r,appMode:m}=E;m==="cloud"&&r?(l.textContent=r.email,t.classList.remove("hidden"),o.classList.add("hidden"),n.disabled=!1):(t.classList.add("hidden"),o.classList.remove("hidden"),n.disabled=!1),m==="local"&&o.classList.add("hidden")},createItineraryList(t,o){const{itineraryListContainer:n}=b;if(E.appMode==="cloud"&&!E.firebaseUser&&t.length>0)return;if(t.length===0){n.innerHTML='<p class="empty-message">此行程沒有任何地點，點擊下方按鈕新增第一個景點吧！</p>';return}const l=t.reduce((h,c)=>(h[c.date]||(h[c.date]=[]),h[c.date].push(c),h),{}),r=E.filter.date!=="all"||E.filter.category!=="all",m=Object.keys(l).sort().map(h=>{const e=l[h].map(T=>{const x=o.some(M=>M.id===T.id);if(r&&!x)return"";const C=k[T.category]||k.default,H=o.findIndex(M=>M.id===T.id),A=x?H+1:"•",O=w(T.location);return`<div class="location-item" data-id="${T.id}" draggable="true"><span class="location-number" style="color: ${C.color};">${A}</span><p>${O}</p><span class="category-badge" style="background-color: ${C.color};">${C.name}</span><div class="location-controls"><button class="edit-btn" title="編輯">✏️</button><button class="delete-btn" title="刪除">🗑️</button></div></div>`}).join("");return e?`<div class="day-group"><div class="day-header">${h}</div>${e}</div>`:""}).join("");n.innerHTML=m||'<p class="empty-message">沒有符合篩選條件的景點。</p>'},createFilterControls(t){const{dateFiltersContainer:o,categoryFiltersContainer:n}=b,r=[...new Set(t.map(c=>c.date))].sort().map(c=>`<button data-date="${c}" class="${E.filter.date===c?"active":""}">${c}</button>`).join("");o.innerHTML=`<button data-date="all" class="${E.filter.date==="all"?"active":""}">全部日期</button>${r}`;const h=[...new Set(t.map(c=>c.category))].map(c=>{const e=k[c]||k.default;return`<button data-category="${c}" class="${E.filter.category===c?"active":""}">${e.name}</button>`}).join("");n.innerHTML=`<button data-category="all" class="${E.filter.category==="all"?"active":""}">全部分類</button>${h}`},refreshUI(){if(!E.currentItinerary)return this.resetUI();const t=E.currentItinerary.locations,o=P();b.itineraryTitleEl.textContent=E.currentItinerary.name,b.addLocationContainer.classList.remove("hidden"),this.createFilterControls(t),this.createItineraryList(t,o),this.drawMap(o),this.updateStats(t)},resetUI(){let t="請從「管理」建立或載入一個行程";E.appMode==="cloud"&&!E.firebaseUser&&(t="請先登入以管理您的行程"),b.itineraryTitleEl.textContent="尚未載入行程",b.addLocationContainer.classList.add("hidden"),b.itineraryListContainer.innerHTML=`<p class="empty-message">${t}</p>`,b.dateFiltersContainer.innerHTML="",b.categoryFiltersContainer.innerHTML="",U&&U.clearLayers(),this.updateStats([])},drawMap(t){if(!v||(U.clearLayers(),t.length===0))return;const o=L.latLngBounds();t.forEach((n,l)=>{const r=k[n.category]||k.default,m=L.divIcon({html:`<div style="background-color: ${r.color}; width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; box-shadow: var(--shadow); display: flex; justify-content: center; align-items: center; color: white; font-size: 14px; font-weight: bold;">${l+1}</div>`,className:"custom-marker-icon",iconSize:[28,28],iconAnchor:[14,14]}),h=L.marker(n.coordinates,{icon:m}),c=`<b>${w(n.location)}</b><br>${w(n.description||"無描述")}`;h.bindPopup(c),h.addTo(U),o.extend(n.coordinates)});for(let n=0;n<t.length-1;n++)t[n].date===t[n+1].date&&L.polyline([t[n].coordinates,t[n+1].coordinates],{color:"#3388ff",weight:3,opacity:.7}).addTo(U);o.isValid()&&v.fitBounds(o.pad(.2),{maxZoom:15})},updateStats(t){b.statsDays.innerText=new Set(t.map(n=>n.date)).size,b.statsLocations.innerText=t.length;let o=0;v&&t.forEach((n,l)=>{l>0&&n.date===t[l-1].date&&(o+=v.distance(n.coordinates,t[l-1].coordinates))}),b.statsDistance.innerText=(o/1e3).toFixed(1)},showOfflineWarning(t){const{offlineWarningBanner:o,appContainer:n,searchLocationBtn:l}=b;o.classList.toggle("hidden",!t),n.classList.toggle("offline",t),t?(document.documentElement.style.setProperty("--primary-color","#e67e22"),l&&(l.disabled=!0,l.title="離線模式下無法使用搜尋功能")):(document.documentElement.style.setProperty("--primary-color","#3498db"),l&&(l.disabled=!1,l.title="")),this.handleMapOfflineState(t)},handleMapOfflineState(t){v&&(b.mapOfflinePlaceholder.classList.toggle("hidden",!t),t?v.hasLayer(D)&&v.removeLayer(D):v.hasLayer(D)||D.addTo(v))}};function Y(){const t="G-MG8CXYLNBE",o=document.createElement("script");o.async=!0,o.src=`https://www.googletagmanager.com/gtag/js?id=${t}`,document.head.appendChild(o);const n=document.createElement("script");n.innerHTML=`
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '${t}');
    `,document.head.appendChild(n)}document.addEventListener("DOMContentLoaded",()=>{const t=new J,o={apiKey:"AIzaSyCavD0SHOLcQBwjJJ3aCGCY7Po-t4QR31k",authDomain:"travel-itinerary-helper.firebaseapp.com",projectId:"travel-itinerary-helper",storageBucket:"travel-itinerary-helper.firebasestorage.app",messagingSenderId:"853427118697",appId:"1:853427118697:web:c2d4520a4fc565b98438f8",measurementId:"G-MG8CXYLNBE"};let n,l,r,m,h;const c={mapElement:document.getElementById("map"),itineraryPanel:document.getElementById("itinerary-panel"),panelHandle:document.getElementById("panel-handle"),itineraryListContainer:document.getElementById("itinerary-list"),dateFiltersContainer:document.getElementById("date-filters"),categoryFiltersContainer:document.getElementById("category-filters"),itineraryTitleEl:document.getElementById("itinerary-title"),addLocationContainer:document.getElementById("add-location-container"),mapOfflinePlaceholder:document.getElementById("map-offline-placeholder"),filters:document.getElementById("filters"),filtersHandle:document.getElementById("filters-handle"),coordinatesWarning:document.getElementById("coordinates-warning"),userInfo:document.getElementById("user-info"),guestInfo:document.getElementById("guest-info"),manageBtn:document.getElementById("manage-itineraries-btn"),userEmail:document.getElementById("user-email"),statsDays:document.getElementById("stats-days"),statsLocations:document.getElementById("stats-locations"),statsDistance:document.getElementById("stats-distance"),offlineWarningBanner:document.getElementById("offline-warning-banner"),appContainer:document.getElementById("app-container"),searchLocationBtn:document.getElementById("search-location-btn")},e={appMode:"cloud",firebaseUser:null,currentItinerary:null,filter:{date:"all",category:"all"},editingLocationId:null};async function T(){try{firebase.initializeApp(o),n=firebase.auth(),l=firebase.firestore(),await n.getRedirectResult(),e.appMode="cloud",console.log("Firebase connected. Running in Cloud Mode."),n.onAuthStateChanged(g=>{e.firebaseUser=g,s.updateAuthUI(),s.resetUI(),g?s.showToast(`歡迎, ${g.email}!`,"success"):s.showToast("您已登出")})}catch(g){console.error("Firebase connection failed:",g),e.appMode="local",console.log("Running in Local Mode."),s.updateAuthUI(),s.resetUI(),s.showOfflineWarning(!0),setTimeout(j,100)}}async function x(){if(!e.currentItinerary)return;if((e.currentItinerary.dataSource||"local")==="cloud"){if(e.appMode!=="cloud"||!e.firebaseUser)return s.showToast("無法儲存雲端行程，請檢查網路連線並重新整理","error");await l.collection("itineraries").doc(e.currentItinerary.id).set(e.currentItinerary,{merge:!0})}else await t.saveItinerary(e.currentItinerary);s.showToast("行程已儲存！","success")}async function C(g,p){if(p==="cloud"){if(!e.firebaseUser)return s.showToast("請先登入","error");await l.collection("itineraries").doc(g).delete()}else await t.deleteItinerary(g)}function H(){return e.currentItinerary?e.currentItinerary.locations.filter(g=>(e.filter.date==="all"||g.date===e.filter.date)&&(e.filter.category==="all"||g.category===e.filter.category)):[]}async function A(){if(!e.currentItinerary)return;const g=document.getElementById("location-name").value,p=document.getElementById("location-date").value,i=document.getElementById("location-category").value,a=document.getElementById("location-description").value,d=document.getElementById("location-coordinates").value;if(!g||!p||!d)return s.showToast("地點名稱、日期和座標為必填項","error");const u=d.split(",").map(Number);if(u.length!==2||isNaN(u[0])||isNaN(u[1]))return s.showToast("座標格式不正確","error");const y={date:p,location:g,category:i,description:a,coordinates:u};if(e.editingLocationId){const f=e.currentItinerary.locations.findIndex(I=>I.id===e.editingLocationId);f>-1&&(e.currentItinerary.locations[f]={...e.currentItinerary.locations[f],...y})}else y.id=`loc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,e.currentItinerary.locations.push(y);e.currentItinerary.locations.sort((f,I)=>new Date(f.date)-new Date(I.date));try{await x(),s.showToast("景點已儲存！","success"),s.toggleModal(document.getElementById("edit-location-modal"),!1),s.refreshUI()}catch(f){s.showToast(`儲存失敗: ${f.message}`,"error")}}const O=W(async()=>{const g=document.getElementById("location-name").value;if(!g)return;const p=document.getElementById("location-search-results");p.innerHTML="搜尋中...";try{const i=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(g)}&limit=5`,{headers:{"User-Agent":"TravelItineraryHelper/3.0"}});if(!i.ok)throw new Error("API 請求失敗");const a=await i.json();a.length===0?p.innerHTML="找不到結果":p.innerHTML=a.map(d=>`<div class="search-result-item" data-lat="${d.lat}" data-lon="${d.lon}">${w(d.display_name)}</div>`).join("")}catch(i){p.innerHTML="搜尋時發生錯誤",s.showToast(i.message,"error")}},500);function M(g,p){g.dataSource=p,e.currentItinerary=g,e.filter={date:"all",category:"all"},s.refreshUI(),s.toggleModal(document.getElementById("itinerary-manager-modal"),!1)}async function j(){const g=document.getElementById("itinerary-manager-list");g.innerHTML="<li>讀取中...</li>",s.toggleModal(document.getElementById("itinerary-manager-modal"),!0);let p="";if(e.appMode==="cloud"&&e.firebaseUser){p+="<h3>雲端行程</h3>";try{const d=(await l.collection("itineraries").where("ownerId","==",e.firebaseUser.uid).orderBy("createdAt","desc").get()).docs.map(u=>({id:u.id,...u.data()}));d.length>0?p+=d.map(u=>`<li class="itinerary-manager-item" data-id="${u.id}" data-name="${w(u.name)}" data-source="cloud"><span class="itinerary-manager-item-name">${w(u.name)}</span><div class="itinerary-manager-item-actions"><button class="load-btn">載入</button><button class="delete-btn">刪除</button></div></li>`).join(""):p+="<li>無雲端行程</li>"}catch(a){p+="<li>讀取雲端行程失敗</li>",console.error(a)}}const i=e.appMode==="local"?"<h3>本地行程</h3>":"<h3>離線/本地行程</h3>";p+=i;try{const a=await t.getItineraries();a.length>0?p+=a.map(d=>`<li class="itinerary-manager-item" data-id="${d.id}" data-name="${w(d.name)}" data-source="local"><span class="itinerary-manager-item-name">${w(d.name)}</span><div class="itinerary-manager-item-actions"><button class="load-btn">載入</button>${e.appMode==="cloud"&&e.firebaseUser?'<button class="upload-btn">上傳至雲端</button>':""}<button class="delete-btn">刪除</button></div></li>`).join(""):p+="<li>無本地行程</li>"}catch(a){p+="<li>讀取本地行程失敗</li>",console.error(a)}g.innerHTML=p}function R(){document.querySelectorAll(".close-modal-btn").forEach(i=>i.addEventListener("click",()=>s.toggleModal(i.closest(".modal-backdrop"),!1))),document.getElementById("show-login-btn").addEventListener("click",()=>s.toggleModal(document.getElementById("login-modal"),!0)),document.getElementById("logout-btn").addEventListener("click",()=>n.signOut()),document.getElementById("login-btn").addEventListener("click",async()=>{const i=document.getElementById("login-email").value,a=document.getElementById("login-password").value;if(!i||!a)return s.showToast("請輸入電子郵件和密碼","warning");try{await n.signInWithEmailAndPassword(i,a),s.toggleModal(document.getElementById("login-modal"),!1)}catch(d){s.showToast(`登入失敗: ${d.message}`,"error")}}),document.getElementById("manage-itineraries-btn").addEventListener("click",j),document.getElementById("itinerary-manager-list").addEventListener("click",async i=>{const a=i.target,d=a.closest(".itinerary-manager-item");if(!d)return;const u=d.dataset.id,y=d.dataset.source,f=d.dataset.name;if(a.classList.contains("load-btn")){let I;if(y==="cloud"){const $=await l.collection("itineraries").doc(u).get();I={id:$.id,...$.data()}}else I=await t.getItineraryById(u);I&&M(I,y)}else if(a.classList.contains("delete-btn"))confirm(`確定要從 ${y==="cloud"?"雲端":"本機"} 刪除行程 "${f}" 嗎？`)&&(await C(u,y),e.currentItinerary&&e.currentItinerary.id===u&&s.resetUI(),s.showToast("行程已刪除","success"),j());else if(a.classList.contains("upload-btn")){if(!e.firebaseUser)return s.showToast("請先登入才能上傳","error");const I=await t.getItineraryById(u);if(!I)return s.showToast("找不到本地行程","error");I.ownerId=e.firebaseUser.uid,delete I.hash,delete I.salt,await l.collection("itineraries").doc(I.id).set(I),s.showToast("行程已成功上傳至雲端！","success"),confirm("上傳成功，要刪除這台電腦上的本地副本嗎？")&&await C(u,"local"),j()}}),document.getElementById("create-new-itinerary-btn").addEventListener("click",()=>{document.getElementById("new-itinerary-name").value="",s.toggleModal(document.getElementById("create-itinerary-modal"),!0)}),document.getElementById("save-new-itinerary-btn").addEventListener("click",async()=>{const i=document.getElementById("new-itinerary-name").value;if(!i)return s.showToast("請輸入行程名稱","error");if(e.appMode==="local"||!e.firebaseUser){const a={id:`local_${Date.now()}`,name:i,locations:[],createdAt:new Date().toISOString()};await t.saveItinerary(a),M(a,"local"),s.showToast("本地行程已建立!","success")}else{const a={name:i,ownerId:e.firebaseUser.uid,createdAt:firebase.firestore.FieldValue.serverTimestamp(),locations:[]},d=await l.collection("itineraries").add(a);M({id:d.id,...a},"cloud"),s.showToast("雲端行程已建立!","success")}s.toggleModal(document.getElementById("create-itinerary-modal"),!1),s.toggleModal(document.getElementById("itinerary-manager-modal"),!1)}),document.getElementById("add-location-btn").addEventListener("click",()=>{e.editingLocationId=null,document.getElementById("edit-location-title").textContent="新增景點";let i=new Date().toISOString().split("T")[0];e.currentItinerary.locations.length>0&&(i=e.currentItinerary.locations[e.currentItinerary.locations.length-1].date),document.getElementById("location-name").value="",document.getElementById("location-date").value=i,document.getElementById("location-category").value="sight",document.getElementById("location-description").value="",document.getElementById("location-coordinates").value="",document.getElementById("location-search-results").innerHTML="",c.coordinatesWarning.classList.add("hidden"),s.toggleModal(document.getElementById("edit-location-modal"),!0)}),document.getElementById("save-location-btn").addEventListener("click",A),document.getElementById("search-location-btn").addEventListener("click",O),document.getElementById("location-coordinates").addEventListener("input",()=>{c.coordinatesWarning.classList.remove("hidden")}),document.getElementById("location-search-results").addEventListener("click",i=>{const a=i.target.closest(".search-result-item");a&&(document.getElementById("location-name").value=a.textContent,document.getElementById("location-coordinates").value=`${a.dataset.lat}, ${a.dataset.lon}`,document.getElementById("location-search-results").innerHTML="",c.coordinatesWarning.classList.add("hidden"))}),c.itineraryListContainer.addEventListener("click",i=>{if(e.appMode==="cloud"&&!e.firebaseUser&&!e.currentItinerary||!e.currentItinerary)return;const a=i.target,d=a.closest(".location-item");if(!d)return;const u=d.dataset.id,y=e.currentItinerary.locations.find(f=>f.id===u);a.closest(".edit-btn")?(e.editingLocationId=u,document.getElementById("edit-location-title").textContent="編輯景點",document.getElementById("location-name").value=y.location,document.getElementById("location-date").value=y.date,document.getElementById("location-category").value=y.category,document.getElementById("location-description").value=y.description,document.getElementById("location-coordinates").value=y.coordinates.join(", "),document.getElementById("location-search-results").innerHTML="",c.coordinatesWarning.classList.add("hidden"),s.toggleModal(document.getElementById("edit-location-modal"),!0)):a.closest(".delete-btn")?confirm(`確定要刪除景點 "${y.location}" 嗎？`)&&(e.currentItinerary.locations=e.currentItinerary.locations.filter(f=>f.id!==u),x().then(()=>s.refreshUI())):y&&r.flyTo(y.coordinates,15)});let g=null;c.itineraryListContainer.addEventListener("dragstart",i=>{if(e.appMode==="cloud"&&!e.firebaseUser&&!e.currentItinerary||!e.currentItinerary)return;const a=i.target.closest(".location-item");a&&(g=a.dataset.id,setTimeout(()=>a.classList.add("dragging"),0))}),c.itineraryListContainer.addEventListener("dragover",i=>{g&&i.preventDefault()}),c.itineraryListContainer.addEventListener("drop",i=>{if(!g)return;i.preventDefault();const a=i.target.closest(".location-item"),d=e.currentItinerary.locations.findIndex(y=>y.id===g);let u=e.currentItinerary.locations.findIndex(y=>y.id===a?.dataset.id);if(d!==-1&&u!==-1&&d!==u){const[y]=e.currentItinerary.locations.splice(d,1);e.currentItinerary.locations.splice(u,0,y),y.date=e.currentItinerary.locations[u].date,x().then(()=>s.refreshUI())}g=null,document.querySelector(".dragging")?.classList.remove("dragging")}),c.itineraryListContainer.addEventListener("dragend",()=>{g=null,document.querySelector(".dragging")?.classList.remove("dragging")}),c.filters.addEventListener("click",i=>{if(i.target.tagName!=="BUTTON")return;const a=i.target;a.dataset.date!==void 0&&(e.filter.date=a.dataset.date),a.dataset.category!==void 0&&(e.filter.category=a.dataset.category),s.refreshUI()}),c.panelHandle.addEventListener("click",()=>{c.itineraryPanel.classList.toggle("open"),c.panelHandle.classList.toggle("open"),r&&setTimeout(()=>r.invalidateSize(!0),300)}),c.filtersHandle.addEventListener("click",()=>{c.filters.classList.toggle("collapsed"),c.filtersHandle.classList.toggle("collapsed")}),document.getElementById("export-json").addEventListener("click",()=>{if(!e.currentItinerary)return s.showToast("尚未載入行程","warning");const i=JSON.stringify(e.currentItinerary,null,4),a=new Blob([i],{type:"application/json"}),d=URL.createObjectURL(a),u=document.createElement("a");u.href=d,u.download=`${e.currentItinerary.name}.json`,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(d)}),document.getElementById("export-printable").addEventListener("click",()=>{if(!e.currentItinerary||e.currentItinerary.locations.length===0)return s.showToast("沒有可列印的行程資料","warning");const{name:i,locations:a}=e.currentItinerary;s.showToast("正在準備預覽頁面...","normal");const d=a.reduce((B,S)=>(B[S.date]=B[S.date]||[],B[S.date].push(S),B),{}),u=c.statsDays.innerText,y=c.statsLocations.innerText,f=c.statsDistance.innerText,I=`總天數: ${u} 天 | 總地點: ${y} 個 | 總距離: ${f} km`;let $='<table border=1 style="width:100%;border-collapse:collapse;font-size:12px;border-color:#ccc"><thead><tr style=background-color:#f2f2f2><th style="padding:8px;width:40px">#</th><th style=padding:8px>地點</th><th style="padding:8px;width:80px">分類</th><th style=padding:8px>描述</th></tr></thead><tbody>',z=1;for(const B of Object.keys(d).sort()){const S=new Date(B).toLocaleDateString("zh-TW",{weekday:"long"});$+=`<tr style="background-color:#e9ecef;font-weight:bold"><td colspan=4 style="padding:10px;border-left:none;border-right:none">${B} (${S})</td></tr>`;for(const F of d[B]){const _={sight:{name:"景點"},stay:{name:"住宿"},transport:{name:"交通"},food:{name:"餐飲"},default:{name:"其他"}};$+=`<tr><td style="padding:8px;text-align:center">${z++}</td><td style=padding:8px>${w(F.location)}</td><td style=padding:8px>${w(_[F.category]?.name||"其他")}</td><td style=padding:8px>${w(F.description)}</td></tr>`}}$+="</tbody></table>";const G=`<html><head><title>${w(i)} - 可列印版</title><meta charset=UTF-8><style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;margin:20px}h1{color:#2c3e50}p{color:#333}table{border:1px solid #ccc}th,td{border:1px solid #ccc}@media print{@page{margin:20mm}body{margin:0;-webkit-print-color-adjust:exact;print-color-adjust:exact}h1,p{margin-bottom:15px}table{page-break-inside:auto}tr{page-break-inside:avoid;page-break-after:auto}}</style></head><body><h1>${w(i)}</h1><p>${w(I)}</p>${$}</body></html>`,N=window.open();N.document.write(G),N.document.close(),setTimeout(()=>N.print(),500)});const p=document.getElementById("json-file-input");document.getElementById("load-from-json-btn").addEventListener("click",()=>{p.click()}),p.addEventListener("change",i=>{const a=i.target.files[0];if(!a)return;const d=new FileReader;d.onload=async u=>{try{const y=u.target.result,f=JSON.parse(y);if(!f||!f.id||!f.name||!Array.isArray(f.locations))throw new Error("檔案內容並非有效的行程格式。");delete f.ownerId,f.dataSource="local",await t.saveItinerary(f),s.showToast("行程已成功從 JSON 載入！","success"),j()}catch(y){console.error("載入 JSON 失敗:",y),s.showToast(`載入失敗: ${y.message}`,"error")}finally{i.target.value=null}},d.onerror=()=>{s.showToast("讀取檔案時發生錯誤","error"),i.target.value=null},d.readAsText(a)})}function q(){r=L.map(c.mapElement).setView([25.105497,121.517594],10),m=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(r),h=L.layerGroup().addTo(r),L.Control.Copyright=L.Control.extend({onAdd:function(i){const a=L.DomUtil.create("div","leaflet-control-copyright");return a.innerHTML=`&copy; <span id="currentYear"></span> Zanta's Utilities`,L.DomEvent.disableClickPropagation(a),a},onRemove:function(i){}}),new L.Control.Copyright({position:"bottomleft"}).addTo(r),document.getElementById("currentYear").textContent=new Date().getFullYear(),s.init({elements:c,globalState:e,map:r,tileLayer:m,layerGroup:h,getFilteredLocations:H}),R(),T(),["test","development"].includes("production")||Y()}q()});
