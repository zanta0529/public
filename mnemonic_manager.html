<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>助記詞管理工具（AES-GCM + QR Code）</title>
        <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
        <style>
            :root {
                --bg-main: #1e1e2f;
                --bg-card: #2f2f4f;
                --primary: #5865f2;
                --primary-hover: #4752c4;
                --secondary: #b9bbbe;
                --input-bg: #444;
                --text-color: #e8e8f0;
                --border-color: #4a4a5f;
                --error-color: #ff7f7f;
                --error-bg: #4f2e2e;
                --success-color: #60d978;
                --success-bg: #2a4a30;
                --button-reset-bg: #da373c;
                --button-reset-hover-bg: #a1282c;
            }
            body {
                background: var(--bg-main);
                color: var(--text-color);
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                padding: 1rem;
                line-height: 1.6;
            }
            .card {
                background: var(--bg-card);
                padding: 2rem;
                border-radius: 8px;
                max-width: 80%;
                margin: auto;
                border: 1px solid var(--border-color);
            }
            .card h1 {
                text-align: center;
                margin-top: 0;
                margin-bottom: 2rem;
            }
            .field {
                margin-bottom: 1.5rem;
            }
            label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 600;
                color: var(--secondary);
            }
            input,
            textarea,
            button {
                width: 100%;
                padding: 0.75rem;
                background: var(--input-bg);
                border: 1px solid var(--border-color);
                border-radius: 5px;
                color: var(--text-color);
                box-sizing: border-box;
                font-size: 1rem;
                transition: background-color 0.2s, border-color 0.2s;
            }
            input:focus,
            textarea:focus {
                outline: none;
                border-color: var(--primary);
            }
            button {
                cursor: pointer;
                background: var(--primary);
                font-weight: 600;
                border: none;
            }
            button:hover {
                background: var(--primary-hover);
            }

            /* --- 輸出與日誌樣式 (比照 decrypt_text.html) --- */
            .output-container {
                margin-top: 1.5rem;
            }
            .output {
                padding: 1rem;
                border-radius: 5px;
                min-height: 50px;
                white-space: pre-wrap;
                word-break: break-all;
                font-size: 1.1em;
                line-height: 1.5;
                border-left: 5px solid transparent; /* 預設透明邊框 */
                background-color: var(--input-bg);
                transition: background-color 0.3s, border-color 0.3s;
            }
            .output.success {
                color: var(--success-color);
                background-color: var(--success-bg);
                border-left-color: var(--success-color);
            }
            .output.error {
                color: var(--error-color);
                background-color: var(--error-bg);
                border-left-color: var(--error-color);
            }
            #jsonView {
                margin-top: 1rem;
                padding: 1rem;
                background: var(--input-bg);
                border: 1px solid var(--border-color);
                border-radius: 5px;
                white-space: pre-wrap;
                word-break: break-all;
                display: none;
            }

            /* --- 特殊按鈕 --- */
            .action-button-group {
                display: flex;
                gap: 1rem;
            }
            #resetBtn {
                background-color: var(--button-reset-bg);
            }
            #resetBtn:hover {
                background-color: var(--button-reset-hover-bg);
            }
            .output-copy-button {
                margin-top: 1rem;
            }
            .output-copy-button:hover {
                filter: brightness(110%);
            }
            footer {
                text-align: center;
                margin-top: 30px;
                font-size: 0.9em;
                color: var(--secondary-color);
            }
        </style>
    </head>
    <body>
        <div class="card">
            <h1>加密貨幣錢包助記詞管理工具</h1>
            <div class="field">
                <label for="mnemonic">助記詞或明文 (Plain-Text)</label>
                <textarea id="mnemonic" rows="4" placeholder="輸入助記詞"></textarea>
            </div>
            <div class="field">
                <label for="passphrase">密碼短語 (Passphrase)</label>
                <input id="passphrase" type="password" placeholder="輸入密碼短語" />
            </div>
            <div class="field">
                <button id="encryptBtn">加密並產生 QR Code</button>
            </div>
            <canvas
                id="qrCanvas"
                width="256"
                height="256"
                style="display: none; margin: auto; border-radius: 8px"
            ></canvas>
            <div id="jsonView"></div>
            <div class="field">
                <label for="base64json">密文 (Base64 JSON)</label>
                <textarea id="base64json" rows="6" placeholder="加密後之 Base64 JSON 將顯示於此"></textarea>
            </div>
            <div class="field">
                <button id="decryptBtn">解密</button>
            </div>
            <div class="field action-button-group">
                <button id="copyBtn" style="flex: 1">複製密文</button>
                <button id="pasteBtn" style="flex: 1">貼上密文</button>
                <button id="resetBtn" style="flex: 1">重設</button>
            </div>
            <div class="output-container">
                <div id="output" class="output">點擊按鈕開始操作...</div>
                <button id="copyDecryptedBtn" class="output-copy-button" style="display: none">複製解密結果</button>
            </div>
        </div>
        <footer>
            <p>&copy; <span id="currentYear"></span> Zanta's AES Tools</p>
        </footer>

        <script>
            const SALT_BYTES = 16;
            const IV_BYTES = 12;
            const DEFAULT_ITERATIONS = 300000;
            const KEY_LENGTH = 256;
            const TAG_LENGTH = 128;

            document.getElementById("currentYear").textContent = new Date().getFullYear();

            function getObject(id) {
                return document.getElementById(id);
            }

            function setOutput(type, message) {
                const outputDiv = getObject("output");
                outputDiv.textContent = message;
                outputDiv.className = `output ${type}`;
                getObject("copyDecryptedBtn").style.display = "none";
            }

            async function encrypt() {
                const mnemonic = getObject("mnemonic").value.trim();
                const passphrase = getObject("passphrase").value;
                const jsonView = getObject("jsonView");

                jsonView.style.display = "none";

                if (!mnemonic || !passphrase) {
                    setOutput("error", "錯誤：助記詞和密碼短語不能為空。");
                    return;
                }

                try {
                    const enc = new TextEncoder();
                    const iv = crypto.getRandomValues(new Uint8Array(IV_BYTES));
                    const salt = crypto.getRandomValues(new Uint8Array(SALT_BYTES));
                    const iterations = DEFAULT_ITERATIONS;
                    const keySize = KEY_LENGTH;
                    const tagLength = TAG_LENGTH;

                    const keyMaterial = await crypto.subtle.importKey(
                        "raw",
                        enc.encode(passphrase),
                        { name: "PBKDF2" },
                        false,
                        ["deriveKey"]
                    );
                    const key = await crypto.subtle.deriveKey(
                        { name: "PBKDF2", salt, iterations, hash: "SHA-256" },
                        keyMaterial,
                        { name: "AES-GCM", length: keySize },
                        false,
                        ["encrypt"]
                    );
                    const data = enc.encode(mnemonic);
                    const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv, tagLength }, key, data);
                    const ciphertext = new Uint8Array(encrypted.slice(0, -tagLength / 8));
                    const tag = new Uint8Array(encrypted.slice(-tagLength / 8));

                    const json = {
                        salt: btoa(String.fromCharCode(...salt)),
                        iterations,
                        keySize,
                        iv: btoa(String.fromCharCode(...iv)),
                        ciphertext: btoa(String.fromCharCode(...ciphertext)),
                        tag: btoa(String.fromCharCode(...tag)),
                        algorithm: {
                            name: "AES-GCM",
                            ivLength: iv.length,
                            tagLength,
                            keyDerivation: { name: "PBKDF2", hash: "SHA-256" },
                        },
                    };

                    const outputBase64 = btoa(JSON.stringify(json));
                    getObject("qrCanvas").style.display = "block";
                    QRCode.toCanvas(getObject("qrCanvas"), outputBase64, { errorCorrectionLevel: "H", width: 256 });
                    getObject("base64json").value = outputBase64;
                    jsonView.textContent = JSON.stringify(json, null, 2);
                    jsonView.style.display = "block";
                    setOutput("success", "✅ 加密成功！QR Code 與 Base64 密文已產生。");
                } catch (e) {
                    console.error("加密失敗:", e);
                    setOutput("error", `❌ 加密失敗：${e.message}`);
                }
            }

            async function decrypt() {
                const passphrase = getObject("passphrase").value;
                const base64json = getObject("base64json").value.trim();

                if (!passphrase || !base64json) {
                    setOutput("error", "錯誤：密文與密碼短語不能為空。");
                    return;
                }

                try {
                    const jsonString = atob(base64json);
                    const json = JSON.parse(jsonString);
                    const salt = Uint8Array.from(atob(json.salt), (c) => c.charCodeAt(0));
                    const iv = Uint8Array.from(atob(json.iv), (c) => c.charCodeAt(0));
                    const ciphertext = Uint8Array.from(atob(json.ciphertext), (c) => c.charCodeAt(0));
                    const tag = Uint8Array.from(atob(json.tag), (c) => c.charCodeAt(0));
                    const iterations = json.iterations;
                    const keySize = json.keySize;
                    const tagLength = json.algorithm?.tagLength || TAG_LENGTH;

                    if (typeof iterations !== "number" || iterations <= 0)
                        throw new Error("Invalid iterations value in JSON.");
                    if (keySize !== KEY_LENGTH) throw new Error("Unexpected key size in JSON.");

                    const keyMaterial = await crypto.subtle.importKey(
                        "raw",
                        new TextEncoder().encode(passphrase),
                        { name: "PBKDF2" },
                        false,
                        ["deriveKey"]
                    );
                    const key = await crypto.subtle.deriveKey(
                        { name: "PBKDF2", salt, iterations, hash: "SHA-256" },
                        keyMaterial,
                        { name: "AES-GCM", length: keySize },
                        false,
                        ["decrypt"]
                    );
                    const fullCipher = new Uint8Array([...ciphertext, ...tag]);
                    const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv, tagLength }, key, fullCipher);
                    const decryptedResult = new TextDecoder().decode(decrypted);

                    setOutput("success", `✅ 成功解密！\n\n${decryptedResult}`);

                    const copyDecryptedBtn = getObject("copyDecryptedBtn");
                    copyDecryptedBtn.dataset.decryptedText = decryptedResult;
                    copyDecryptedBtn.style.display = "block";
                } catch (e) {
                    console.error("解密失敗:", e);
                    setOutput("error", "❌ 解密失敗：輸入的資料格式錯誤、已損毀，或密碼短語不正確。");
                }
            }

            function copyCipher() {
                const text = getObject("base64json").value;
                if (!text) {
                    setOutput("error", "錯誤：沒有可複製的密文。");
                    return;
                }
                navigator.clipboard
                    .writeText(text)
                    .then(() => setOutput("success", "✅ 已複製密文至剪貼簿。"))
                    .catch((err) => {
                        console.error("複製失敗:", err);
                        setOutput("error", `❌ 複製失敗: ${err.message}`);
                    });
            }

            function pasteCipher() {
                navigator.clipboard
                    .readText()
                    .then((text) => {
                        getObject("base64json").value = text;
                        setOutput("success", "✅ 已貼上剪貼簿內容。");
                    })
                    .catch((err) => {
                        console.error("貼上失敗:", err);
                        setOutput("error", `❌ 貼上失敗: ${err.message}. 瀏覽器可能不支援或未授權。`);
                    });
            }

            function copyDecrypted() {
                const decryptedText = getObject("copyDecryptedBtn").dataset.decryptedText;
                navigator.clipboard
                    .writeText(decryptedText)
                    .then(() => setOutput("success", "✅ 已複製解密結果到剪貼簿。"))
                    .catch((err) => {
                        console.error("複製解密結果失敗:", err);
                        setOutput("error", `❌ 複製解密結果失敗: ${err.message}`);
                    });
            }

            function resetAll() {
                ["mnemonic", "passphrase", "base64json"].forEach((id) => (getObject(id).value = ""));
                const canvas = getObject("qrCanvas");
                canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
                canvas.style.display = "none";
                getObject("jsonView").style.display = "none";
                setOutput("", "點擊按鈕開始操作...");
                navigator.clipboard.writeText("").catch((err) => console.error("清除剪貼簿失敗", err));
            }

            function init() {
                getObject("encryptBtn").addEventListener("click", encrypt);
                getObject("decryptBtn").addEventListener("click", decrypt);
                getObject("copyBtn").addEventListener("click", copyCipher);
                getObject("pasteBtn").addEventListener("click", pasteCipher);
                getObject("resetBtn").addEventListener("click", resetAll);
                getObject("copyDecryptedBtn").addEventListener("click", copyDecrypted);
            }

            document.addEventListener("DOMContentLoaded", init);
        </script>
    </body>
</html>
