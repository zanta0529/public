<!doctype html>
<html lang="zh-Hant" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; object-src 'none';"
    />
    <link rel="icon" href="/public/shamir/logo.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="/public/shamir/logo.svg" />
    <title>Shamir's Secret Sharing</title>
    <script type="module" crossorigin src="/public/shamir/assets/index-C5nyMZdG.js"></script>
    <link rel="stylesheet" crossorigin href="/public/shamir/assets/index-BwVL6Jug.css">
  <link rel="manifest" href="/public/shamir/manifest.webmanifest"><script id="vite-plugin-pwa:register-sw" src="/public/shamir/registerSW.js"></script></head>
  <body>
    <div class="container">
      <h1>Shamir's Secret Sharing v1.2</h1>

      <div class="accordion-container">
        <div class="accordion-item">
          <button class="accordion-header" aria-expanded="false">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="16 18 22 12 16 6"></polyline>
              <polyline points="8 6 2 12 8 18"></polyline>
              <line x1="15" y1="4" x2="9" y2="20"></line>
            </svg>
            <span>技術規格與第三方重建指南</span>
            <svg
              class="chevron"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="accordion-content" style="display: none">
            <div class="tech-specs">
              <ul>
                <li><b>演算法基礎:</b> 本工具基於 Adi Shamir 秘密分享演算法，並在 <b>GF(2^8)</b> 有限域上運算。</li>
                <li><b>質多項式:</b> 使用的質多項式為 <b>0x1D</b> (x⁸+x⁴+x³+x+1)，此為 AES 加密標準採用的通用選項。</li>
                <li>
                  <b>編碼與填充:</b> 秘密字串 (UTF-8) 被轉換為二進位字串，前方附加一個 "1" 位元標記，並補零至 8
                  位元的倍數 (規格 ID: `secrets.js-1bit`)。
                </li>
                <li>
                  <b>安全亂數:</b> 多項式係數由瀏覽器內建的密碼學安全亂數產生器
                  <code>window.crypto.getRandomValues()</code> 產生。
                </li>
                <li>
                  <b>安全聲明:</b>
                  本工具未經第三方專業安全審計，處理高敏感度資訊時，建議在可信賴的離線環境中使用本工具。
                </li>
              </ul>
            </div>

            <p style="border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem">
              為確保互操作性，本工具產生的分割值為 Base64 或 Base58Check 編碼後資料，解碼後均為一個包含元資料的 JSON
              字串。第三方工具必須能解析此結構以正確重建祕密。
            </p>
            <h4>分片 (Share) JSON 結構</h4>
            <pre><code class="language-json">{
  "v": "1.2",       // 規格版本號
  "n": 5,           // 總分割數 (n)
  "k": 3,           // 重建門檻值 (k)
  "p": "1D",        // 質多項式 (GF(2^8) AES)
  "enc": "utf8",    // 原始祕密的編碼 (固定為 utf8)
  "pad": "secrets.js-1bit", // 填充方案
  "cs": "sha256-4", // 校驗碼演算法 (sha256 取前 4 bytes)
  "id": 1,          // 此分片的 X 軸座標 (1-255)
  "share": [ ... ], // 分片的 Y 軸座標 (Uint8Array)
  "chk": "..."     // 8 字元校驗碼 (sha256(json_without_chk).substr(0, 8))
}</code></pre>
            <h4>重建步驟</h4>
            <ol>
              <li>取得至少 <strong>k</strong> 份分割值字串 (Base64 or Base58Check)。</li>
              <li>將分割值字串解碼為 JSON 字串 (Base64: <code>atob()</code> | Base58Check: <code>decode()</code>)。</li>
              <li>將 JSON 字串解析為物件 (<code>JSON.parse()</code>)。</li>
              <li>
                <b>[重要] 驗證校驗碼 (chk):</b> 移除 <code>chk</code> 欄位後，對剩餘物件進行
                <code>JSON.stringify()</code>，計算其 SHA-256 雜湊，取前 8 個字元，必須與
                <code>chk</code> 欄位的值完全相符。
              </li>
              <li>檢查所有分片的 <code>v</code>, <code>n</code>, <code>k</code>, <code>p</code> 等參數是否一致。</li>
              <li>收集至少 <strong>k</strong> 組 <code>id</code> (X座標) 與 <code>share</code> (Y座標陣列)。</li>
              <li>
                使用拉格朗日插值法 (Lagrange Interpolation) 在 GF(2^8) 有限域 (質多項式 0x1D) 上，對
                <code>share</code> 陣列中的每一位元組，在 X=0 處求值，以還原祕密的位元組陣列。
              </li>
              <li>
                <b>[重要] 解除填充 (Padding):</b> 根據 <code>pad</code> 欄位 (<code>secrets.js-1bit</code>)
                移除填充。本工具的填充方案是在原始祕密的二進位字串前附加一個 "1" 位元，然後補零至 8
                的倍數。解碼時，找到第一個 "1"，其後的所有位元即為原始祕密的二進位字串。
              </li>
              <li>將解碼後的二進位字串依 <code>enc</code> (<code>utf8</code>) 格式轉回原始字串。</li>
            </ol>
          </div>
        </div>
      </div>

      <div class="mode-switcher">
        <button id="modeSplitBtn" class="mode-btn active">分割</button>
        <button id="modeReconstructBtn" class="mode-btn">重建</button>
      </div>

      <div id="splitSection" class="content-section active">
        <h2>分割秘密</h2>
        <div class="form-group">
          <label for="originalString">原始字串</label>
          <textarea id="originalString" rows="3" placeholder="請在此輸入任何您想加密保護的文字..."></textarea>
        </div>
        <div class_name="form-grid">
          <div class_name="form-group">
            <label for="n">總分割數 (n)</label>
            <input type="number" id="n" min="2" max="255" placeholder="e.g., 5" inputmode="numeric" pattern="[0-9]*" />
            <div id="nErrorMessage" class="input-error-message"></div>
          </div>
          <div class_name="form-group">
            <label for="k">重建門檻值 (k)</label>
            <input type="number" id="k" min="2" max="255" placeholder="e.g., 3" inputmode="numeric" pattern="[0-9]*" />
            <div id="kErrorMessage" class="input-error-message"></div>
          </div>
        </div>
        <div id="splitError" class="output-box error" style="display: none"></div>
        <div class="button-group">
          <button id="generateBtn">產生分割值</button>
          <button id="clearSplitBtn" class="secondary">清除</button>
        </div>
        <div id="splitResultArea" style="display: none">
          <div class="result-header">
            <h2>分割結果</h2>
            <div class="encoding-switcher">
              <span>Base64</span>
              <label class="switch">
                <input type="checkbox" id="encodingToggle" />
                <span class="slider round"></span>
              </label>
              <span>Base58Check</span>
              <span
                class="tooltip-icon"
                data-tooltip="Base58Check 是一種常用於加密貨幣的編碼方式。它移除了視覺上易混淆的字元 (0, O, I, l)，並內建校驗碼 (Checksum) 來驗證資料完整性，大幅降低手動抄寫時的出錯風險。"
                >ⓘ</span
              >
            </div>
          </div>
          <table id="splitResultTable">
            <thead>
              <tr>
                <th style="width: 30px">ID</th>
                <th>編碼分割值</th>
                <th style="width: 150px">操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="reconstructSection" class="content-section">
        <h2>重建秘密</h2>

        <div id="reconstructionQueue">
          <div id="queueProgress" class="queue-progress">請從「分割」頁面加入分割值，或從下方手動貼上</div>
          <div id="queueList"></div>
        </div>

        <div class_name="form-group">
          <label for="customShareInput">手動貼上 Base64 / Base58Check 分割值</label>
          <textarea
            id="customShareInput"
            rows="2"
            placeholder="貼上符合 v1.2+ 規範，包含元資料與校驗碼的 Base64 或 Base58Check 編碼分割值..."
          ></textarea>
          <div class="button-group" style="margin-top: 0.5rem; justify-content: flex-end">
            <button id="addCustomShareBtn" class="secondary" style="flex: 0 1 auto">加入佇列</button>
          </div>
        </div>

        <div id="reconstructionResult" class="output-box" style="display: none"></div>

        <div class="button-group">
          <button id="reconstructBtn">重建秘密</button>
          <button id="clearQueueBtn" class="secondary">清空佇列</button>
        </div>
      </div>

      <footer>
        <p>
          &copy; <span id="currentYear"></span> Zanta's Utilities
          <button id="themeToggleBtn" title="切換主題">🌙</button>
        </p>
      </footer>

      <div id="qrModal">
        <div id="qrCodeContainer" onclick="event.stopPropagation()"></div>
      </div>

      <div id="toast"></div>
    </div>
  </body>
</html>
