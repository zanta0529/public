<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shamir ç¥•å¯†é‡å»ºå·¥å…·</title>
    <style>
      /* --- åŸºç¤æ¨£å¼ --- */
      :root {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        --slate-900: #0f172a;
        --purple-900: #581c87;
        --purple-400: #c084fc;
        --purple-200: #e9d5ff;
        --purple-100: #f3e8ff;
        --purple-600: #9333ea;
        --purple-700: #7e22ce;
        --pink-600: #db2777;
        --pink-700: #be185d;
        --red-600: rgba(220, 38, 38, 0.8);
        --red-700: #b91c1c;
        --blue-500: #3b82f6;
        --blue-200: #bfdbfe;
        --blue-100: #dbeafe;
        --green-500: #22c55e;
        --green-300: #86efac;
        --green-200: #bbf7d0;
        --white-10: rgba(255, 255, 255, 0.1);
        --white-20: rgba(255, 255, 255, 0.2);
        --black-30: rgba(0, 0, 0, 0.3);
        --purple-border-20: rgba(216, 180, 254, 0.2);
        --purple-border-30: rgba(216, 180, 254, 0.3);
        --purple-placeholder: rgba(216, 180, 254, 0.5);
        --focus-ring: rgba(192, 132, 252, 0.5);
        --red-border-50: rgba(248, 113, 113, 0.5);
        --red-bg-20: rgba(248, 113, 113, 0.2);
        --red-200: #fecaca;
        --red-100: #fee2e2;
        --green-border-50: rgba(74, 222, 128, 0.5);
        --green-bg-20: rgba(74, 222, 128, 0.2);
        --blue-border-50: rgba(96, 165, 250, 0.5);
        --blue-bg-20: rgba(96, 165, 250, 0.2);
      }
      body {
        min-height: 100vh;
        background: linear-gradient(to bottom right, var(--slate-900), var(--purple-900), var(--slate-900));
        padding: 1.5rem;
        margin: 0;
        color: white;
      }
      .container {
        max-width: 56rem;
        margin-left: auto;
        margin-right: auto;
      }

      /* --- æ¨™é¡Œå€ --- */
      .header {
        text-align: center;
        margin-bottom: 2rem;
      }
      .header-flex {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }
      .header-flex svg {
        width: 2.5rem;
        height: 2.5rem;
        color: var(--purple-400);
      }
      .header h1 {
        font-size: 2.25rem;
        line-height: 2.5rem;
        font-weight: 700;
        color: white;
        margin: 0;
      }
      .header p {
        color: var(--purple-200);
        font-size: 1.125rem;
        line-height: 1.75rem;
        margin: 0;
      }

      /* --- å¡ç‰‡æ¨£å¼ --- */
      .card {
        background-color: var(--white-10);
        backdrop-filter: blur(4px);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--purple-border-20);
      }
      .card h2 {
        font-size: 1.25rem;
        line-height: 1.75rem;
        font-weight: 600;
        color: white;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .card h2 svg {
        width: 1.25rem;
        height: 1.25rem;
      }

      /* --- è¦æ ¼å¡ç‰‡ --- */
      .spec-grid {
        display: grid;
        gap: 1rem;
      }
      @media (min-width: 768px) {
        .spec-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      .spec-grid h3 {
        color: var(--purple-200);
        font-weight: 600;
        margin-bottom: 0.5rem;
        margin-top: 0;
      }
      .spec-grid ul {
        color: var(--purple-100);
        font-size: 0.875rem;
        line-height: 1.25rem;
        padding-left: 0;
        margin: 0;
        list-style: none;
      }
      .spec-grid li {
        margin-top: 0.25rem;
      }

      /* --- è¼¸å…¥å¡ç‰‡ --- */
      .input-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
      }
      .shares-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .share-item {
        display: flex;
        gap: 0.5rem;
      }
      .share-item textarea {
        flex: 1 1 0%;
        padding: 0.75rem 1rem;
        background-color: var(--white-20);
        border: 1px solid var(--purple-border-30);
        border-radius: 0.5rem;
        color: white;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
        font-size: 0.875rem;
        line-height: 1.25rem;
        resize: none;
      }
      .share-item textarea::placeholder {
        color: var(--purple-placeholder);
      }
      .share-item textarea:focus {
        outline: 2px solid transparent;
        outline-offset: 2px;
        border-color: var(--purple-400);
        box-shadow: 0 0 0 2px var(--focus-ring);
      }
      .share-item .remove-btn {
        padding: 0.5rem 0.75rem;
        background-color: var(--red-600);
        align-self: flex-start;
      }
      .share-item .remove-btn:hover {
        background-color: var(--red-700);
      }

      /* --- æŒ‰éˆ• --- */
      button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        color: white;
        transition: background-color 150ms cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        cursor: pointer;
      }
      button:focus {
        outline: 2px solid transparent;
        outline-offset: 2px;
      }
      .btn-add {
        padding: 0.5rem 1rem;
        background-color: var(--purple-600);
      }
      .btn-add:hover {
        background-color: var(--purple-700);
      }
      .btn-reconstruct {
        width: 100%;
        margin-top: 1rem;
        padding: 0.75rem 1.5rem;
        background-image: linear-gradient(to right, var(--purple-600), var(--pink-600));
      }
      .btn-reconstruct:hover {
        background-image: linear-gradient(to right, var(--purple-700), var(--pink-700));
      }
      button svg {
        width: 1rem;
        height: 1rem;
      }
      .btn-reconstruct svg {
        width: 1.25rem;
        height: 1.25rem;
      }

      /* --- çµæœ/éŒ¯èª¤/è³‡è¨Š å€å¡Š --- */
      .info-block {
        background-color: var(--blue-bg-20);
        border: 1px solid var(--blue-border-50);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
      }
      .info-block h3 {
        font-size: 1.125rem;
        line-height: 1.75rem;
        font-weight: 600;
        color: white;
        margin-bottom: 0.75rem;
        margin-top: 0;
      }
      .info-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.75rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
      }
      @media (min-width: 768px) {
        .info-grid {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
      }
      .info-grid span:first-child {
        color: var(--blue-200);
      }
      .info-grid span:last-child {
        color: white;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      }

      .error-block {
        background-color: var(--red-bg-20);
        border: 1px solid var(--red-border-50);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
      }
      .error-block svg {
        width: 1.25rem;
        height: 1.25rem;
        color: var(--red-200);
        flex-shrink: 0;
        margin-top: 0.125rem;
      }
      .error-block div {
        flex: 1;
      }
      .error-block h3 {
        font-weight: 600;
        color: var(--red-100);
        margin-bottom: 0.25rem;
        margin-top: 0;
      }
      .error-block p {
        color: var(--red-100);
        font-size: 0.875rem;
        line-height: 1.25rem;
        margin: 0;
      }

      .result-block {
        background-color: var(--green-bg-20);
        border: 1px solid var(--green-border-50);
        border-radius: 0.5rem;
        padding: 1.5rem;
      }
      .result-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      .result-header svg {
        width: 1.5rem;
        height: 1.5rem;
        color: var(--green-300);
      }
      .result-header h3 {
        font-size: 1.25rem;
        line-height: 1.75rem;
        font-weight: 600;
        color: white;
        margin: 0;
      }
      .result-body {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .result-body label {
        font-size: 0.875rem;
        line-height: 1.25rem;
        color: var(--green-200);
        margin-bottom: 0.5rem;
        display: block;
      }
      .result-box {
        background-color: var(--black-30);
        border-radius: 0.5rem;
        padding: 1rem;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
        word-break: break-all;
      }
      .result-text {
        color: white;
        font-size: 1.125rem;
        line-height: 1.75rem;
        white-space: pre-wrap; /* é¡¯ç¤ºæ›è¡Œç¬¦ */
      }
      .result-hex {
        color: var(--green-300);
        font-size: 0.875rem;
        line-height: 1.25rem;
      }
      .result-note {
        background-color: var(--blue-bg-20);
        border: 1px solid var(--blue-border-50);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 1rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
        color: var(--blue-100);
      }
      .result-note strong {
        color: var(--blue-100);
      }

      /* --- ä½¿ç”¨èªªæ˜ --- */
      .instructions-card {
        margin-top: 2rem;
        background-color: var(--white-10);
        border-color: var(--purple-border-20);
      }
      .instructions-card ol {
        color: var(--purple-200);
        font-size: 0.875rem;
        line-height: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        list-style-type: decimal;
        list-style-position: inside;
        padding-left: 0;
        margin: 0;
      }

      /* --- éš±è—å…ƒç´  --- */
      [style*='display: none'] {
        display: none !important;
      }
    </style>
    <!-- <script
      src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.11.1/sha256.min.js"
      integrity="sha512-YVITnHZw4RIWJdL3B3qiUUjFwe2999f7+GY9p75emmKu62hze4Tr1hSG5SSDPAp1WaMMbjGOZL9YaNzO5UDpYg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script> -->
    <script src="./sha256.min.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-flex">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
          <h1 class="text-4xl font-bold text-white">Shamir ç¥•å¯†é‡å»ºå·¥å…·</h1>
        </div>
        <p class="text-purple-200 text-lg">åŸºæ–¼ GF(2^8) æœ‰é™åŸŸçš„ç¥•å¯†åˆ†äº«é‡å»º</p>
      </div>

      <div class="card">
        <h2 class="text-xl font-semibold text-white mb-3 flex items-center gap-2">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <path d="M10 16.5c.5.3 1.2.5 2 .5s1.5-.2 2-.5"></path>
            <path d="M10 13.5c.5.3 1.2.5 2 .5s1.5-.2 2-.5"></path>
            <path d="M14 19.5c-.5-.3-1.2-.5-2-.5s-1.5.2-2 .5"></path>
            <path d="M10 10.5c.5.3 1.2.5 2 .5s1.5-.2 2-.5"></path>
          </svg>
          æŠ€è¡“è¦æ ¼èˆ‡åˆ†ç‰‡æ ¼å¼
        </h2>
        <div class="spec-grid">
          <div>
            <h3 class="text-purple-200 font-semibold mb-2">æ¼”ç®—æ³•è¦æ ¼</h3>
            <ul class="text-purple-100 space-y-1">
              <li>â€¢ åŸºæ–¼ GF(2^8) æœ‰é™åŸŸ</li>
              <li>â€¢ è³ªå¤šé …å¼ï¼š0x1D</li>
              <li>â€¢ UTF-8 ç·¨ç¢¼</li>
              <li>â€¢ SHA-256 æ ¡é©—ï¼ˆå‰ 4 ä½å…ƒçµ„ï¼‰</li>
            </ul>
          </div>
          <div>
            <h3 class="text-purple-200 font-semibold mb-2">åˆ†ç‰‡æ ¼å¼ï¼ˆBase64 JSONï¼‰</h3>
            <ul class="text-purple-100 space-y-1">
              <li>â€¢ v: ç‰ˆæœ¬è™Ÿ</li>
              <li>â€¢ n: ç¸½åˆ†ç‰‡æ•¸</li>
              <li>â€¢ k: é‡å»ºé–¾å€¼</li>
              <li>â€¢ id: åˆ†ç‰‡ç·¨è™Ÿ</li>
              <li>â€¢ share: åˆ†ç‰‡è³‡æ–™é™£åˆ—</li>
              <li>â€¢ chk: æ ¡é©—ç¢¼</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="input-header">
          <h2 class="text-xl font-semibold text-white">è¼¸å…¥ç¥•å¯†åˆ†ç‰‡ï¼ˆBase64ï¼‰</h2>
          <button id="add-share-btn" class="btn-add">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            æ–°å¢åˆ†ç‰‡
          </button>
        </div>

        <div id="shares-list" class="shares-list"></div>

        <button id="reconstruct-btn" class="btn-reconstruct">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
          </svg>
          é‡å»ºç¥•å¯†
        </button>
      </div>

      <div id="info-block" class="info-block" style="display: none">
        <h3 class="text-lg font-semibold text-white mb-3">åˆ†ç‰‡è³‡è¨Š</h3>
        <div class="info-grid">
          <div>
            <span class="text-blue-200">ç‰ˆæœ¬ï¼š</span>
            <span id="info-version" class="text-white font-mono"></span>
          </div>
          <div>
            <span class="text-blue-200">ç¸½åˆ†ç‰‡æ•¸ï¼š</span>
            <span id="info-n" class="text-white font-mono"></span>
          </div>
          <div>
            <span class="text-blue-200">é‡å»ºé–¾å€¼ï¼š</span>
            <span id="info-k" class="text-white font-mono"></span>
          </div>
          <div>
            <span class="text-blue-200">å¤šé …å¼ï¼š</span>
            <span id="info-polynomial" class="text-white font-mono"></span>
          </div>
          <div>
            <span class="text-blue-200">ç·¨ç¢¼ï¼š</span>
            <span id="info-encoding" class="text-white font-mono"></span>
          </div>
          <div>
            <span class="text-blue-200">ä½¿ç”¨åˆ†ç‰‡ï¼š</span>
            <span id="info-used-shares" class="text-white font-mono"></span>
          </div>
        </div>
      </div>

      <div id="error-block" class="error-block" style="display: none">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <div>
          <h3 class="font-semibold text-red-200 mb-1">é‡å»ºå¤±æ•—</h3>
          <p id="error-message" class="text-red-100 text-sm"></p>
        </div>
      </div>

      <div id="result-block" class="result-block" style="display: none">
        <div class="result-header">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          <h3 class="text-xl font-semibold text-white">é‡å»ºæˆåŠŸï¼</h3>
        </div>

        <div class="result-body">
          <div>
            <label class="text-sm text-green-200 mb-2 block">ä½¿ç”¨åˆ†ç‰‡æ•¸é‡</label>
            <div id="result-share-count" class="text-white font-mono text-lg"></div>
          </div>

          <div>
            <label class="text-sm text-green-200 mb-2 block">é‡å»ºçš„ç¥•å¯†ï¼ˆæ–‡å­—ï¼‰</label>
            <div id="result-text" class="result-box result-text"></div>
          </div>

          <div>
            <label class="text-sm text-green-200 mb-2 block">åå…­é€²ä½è¡¨ç¤º</label>
            <div id="result-hex" class="result-box result-hex"></div>
          </div>

          <div class="result-note">
            <p class="text-sm text-blue-100">
              <strong>ğŸ’¡ æç¤ºï¼š</strong>æ¯å€‹åˆ†ç‰‡éƒ½æœ‰è‡ªå·±çš„æ ¡é©—ç¢¼ï¼ˆchk
              æ¬„ä½ï¼‰ï¼Œç”¨æ–¼é©—è­‰è©²åˆ†ç‰‡çš„å®Œæ•´æ€§ï¼Œè€Œéé©—è­‰é‡å»ºå¾Œçš„ç¥•å¯†ã€‚
              å¦‚æœé‡å»ºéç¨‹æ²’æœ‰éŒ¯èª¤ï¼Œå‰‡é‡å»ºçš„çµæœå°±æ˜¯æ­£ç¢ºçš„åŸå§‹ç¥•å¯†ã€‚
            </p>
          </div>
        </div>
      </div>

      <div class="card instructions-card">
        <h3 class="text-lg font-semibold text-white mb-3">ä½¿ç”¨èªªæ˜</h3>
        <ol class="text-purple-200 space-y-2 text-sm list-decimal list-inside">
          <li>è²¼ä¸Šè‡³å°‘ 2 å€‹ Base64 ç·¨ç¢¼çš„ JSON æ ¼å¼åˆ†ç‰‡</li>
          <li>æ¯å€‹åˆ†ç‰‡åŒ…å«ç‰ˆæœ¬ã€åˆ†ç‰‡ç·¨è™Ÿã€é–¾å€¼ç­‰è³‡è¨Š</li>
          <li>é»æ“Šã€Œé‡å»ºç¥•å¯†ã€æŒ‰éˆ•é€²è¡Œé‡å»º</li>
          <li>ç³»çµ±æœƒè‡ªå‹•é©—è­‰åˆ†ç‰‡æ•¸é‡æ˜¯å¦é”åˆ°é–¾å€¼ (k)</li>
          <li>é‡å»ºå¾Œæœƒé¡¯ç¤ºåŸå§‹ç¥•å¯†ä¸¦é€²è¡Œ SHA-256 æ ¡é©—ç¢¼é©—è­‰</li>
          <li>æ ¡é©—é€šéè¡¨ç¤ºé‡å»ºçš„ç¥•å¯†æ­£ç¢ºç„¡èª¤</li>
        </ol>
      </div>
    </div>

    <script type="module">
      // --- DOM å…ƒç´  ---
      const sharesList = document.getElementById('shares-list');
      const addShareBtn = document.getElementById('add-share-btn');
      const reconstructBtn = document.getElementById('reconstruct-btn');
      const infoBlock = document.getElementById('info-block');
      const errorBlock = document.getElementById('error-block');
      const resultBlock = document.getElementById('result-block');

      // --- æ ¸å¿ƒæ¼”ç®—æ³•é‚è¼¯ (å¾ .tsx ç§»æ¤) ---

      // GF(2^8) æœ‰é™åŸŸé‹ç®— - å®Œå…¨å°æ‡‰åŸå§‹ shamir.js çš„å¯¦ä½œ
      const GF256 = {
        LOG: new Array(256).fill(0),
        EXP: new Array(512).fill(0),
        primitive: 29, // 0x1D for 8-bit
        maxShares: 255,

        init() {
          let x = 1;
          for (let i = 0; i < this.maxShares; i++) {
            this.EXP[i] = x;
            this.LOG[x] = i;
            x <<= 1; // x = x * 2
            if (x >= 256) {
              x ^= this.primitive;
              x &= this.maxShares;
            }
          }
          // æ“´å±• EXP è¡¨ä»¥æ–¹ä¾¿æ¨¡é‹ç®—
          for (let i = 255; i < 512; i++) {
            this.EXP[i] = this.EXP[i - 255];
          }
        },
      };

      // åˆå§‹åŒ–æœ‰é™åŸŸ
      GF256.init();

      // Base64 è§£ç¢¼
      const base64Decode = (str) => {
        try {
          const decoded = atob(str.trim());
          return JSON.parse(decoded);
        } catch (e) {
          throw new Error(`Base64 è§£ç¢¼å¤±æ•—: ${e.message}`);
        }
      };

      // [ä¿®æ”¹] è§£æåˆ†ç‰‡ - æ”¯æ´ Base64 JSON æ ¼å¼ (å«æ ¡é©—ç¢¼é©—è­‰)
      const parseShare = (shareStr) => {
        try {
          const trimmed = shareStr.trim();
          if (!trimmed) return null;

          // è§£ç¢¼ Base64 ä¸¦è§£æ JSON
          const shareObj = base64Decode(trimmed);

          // --- [æ–°å¢] æ ¡é©—ç¢¼é©—è­‰é‚è¼¯ (ç§»æ¤è‡ª main.js) ---
          const { chk, ...shareData } = shareObj;

          if (!chk) {
            throw new Error('æ ¼å¼ä¸æ­£ç¢ºï¼šç¼ºå°‘æ ¡é©—ç¢¼ (chk) æ¬„ä½ã€‚');
          }

          // é‡æ–°è¨ˆç®—æ ¡é©—ç¢¼
          // æˆ‘å€‘å¿…é ˆå° *ä¸åŒ…å«* 'chk' æ¬„ä½çš„ç‰©ä»¶é€²è¡Œ stringify
          const expectedChecksum = window.sha256(JSON.stringify(shareData)).substring(0, 8);

          if (chk !== expectedChecksum) {
            console.error(`æ ¡é©—å¤±æ•—: é æœŸ ${expectedChecksum}, å¾—åˆ° ${chk}`);
            throw new Error('Checksum é©—è­‰å¤±æ•—ï¼æ­¤åˆ†ç‰‡å¯èƒ½å·²ææ¯€æˆ–è¢«ç«„æ”¹ã€‚');
          }
          // --- [æ–°å¢] é©—è­‰çµæŸ ---

          // é©—è­‰å¿…è¦æ¬„ä½ (ç¾åœ¨å¾ shareData è®€å–)
          if (!shareData.id || !shareData.share || !Array.isArray(shareData.share)) {
            throw new Error('åˆ†ç‰‡æ ¼å¼ä¸å®Œæ•´ (ç¼ºå°‘ id æˆ– share æ¬„ä½)');
          }

          // é©—è­‰ share å…§å®¹
          if (!shareData.share.every((val) => typeof val === 'number' && val >= 0 && val <= 255)) {
            throw new Error('åˆ†ç‰‡ä¸­çš„ share é™£åˆ—åŒ…å«ç„¡æ•ˆçš„æ•¸å­— (æ‡‰ç‚º 0-255 ä¹‹é–“çš„æ•¸å­—)ã€‚');
          }

          return {
            x: shareData.id,
            data: new Uint8Array(shareData.share),
            version: shareData.v,
            n: shareData.n,
            k: shareData.k,
            polynomial: shareData.p,
            encoding: shareData.enc,
            padding: shareData.pad,
            checksum: chk, // å„²å­˜å·²é©—è­‰çš„æ ¡é©—ç¢¼
          };
        } catch (e) {
          // å°‡éŒ¯èª¤è¨Šæ¯å‚³éå‡ºå»
          throw new Error(e.message.startsWith('åˆ†ç‰‡è§£æå¤±æ•—') ? e.message : `åˆ†ç‰‡è§£æå¤±æ•—: ${e.message}`);
        }
      };

      // Lagrange æ’å€¼æ³•é‡å»ºç¥•å¯†
      const reconstructSecret = (parsedShares) => {
        // [ä¿®æ”¹] å¾ç¬¬ä¸€å€‹åˆ†ç‰‡ç²å– k å€¼
        const k = parsedShares[0].k;
        if (!k || parsedShares.length < k) {
          throw new Error(`è‡³å°‘éœ€è¦ ${k || '?'} å€‹åˆ†ç‰‡æ‰èƒ½é‡å»ºç¥•å¯†`);
        }

        const dataLength = parsedShares[0].data.length;

        // æª¢æŸ¥æ‰€æœ‰åˆ†ç‰‡é•·åº¦æ˜¯å¦ä¸€è‡´
        for (let share of parsedShares) {
          if (share.data.length !== dataLength) {
            throw new Error('æ‰€æœ‰åˆ†ç‰‡çš„é•·åº¦å¿…é ˆç›¸åŒ');
          }
        }

        // é©—è­‰åˆ†ç‰‡åƒæ•¸ä¸€è‡´æ€§
        const firstShare = parsedShares[0];
        for (let share of parsedShares) {
          if (share.n !== firstShare.n || share.k !== firstShare.k) {
            throw new Error('åˆ†ç‰‡åƒæ•¸ä¸ä¸€è‡´ï¼ˆn æˆ– k å€¼ä¸åŒï¼‰');
          }
        }

        // [ä¿®æ”¹] åªå–å‰ k å€‹åˆ†ç‰‡é€²è¡Œé‡å»º
        const sharesToUse = parsedShares.slice(0, k);
        const x_coords = sharesToUse.map((s) => s.x);

        // é‡å»ºæ¯å€‹å…ƒç´ 
        let reconstructedBinaryString = '';

        for (let i = 0; i < dataLength; i++) {
          const y_coords = sharesToUse.map((s) => s.data[i]);
          const reconstructedElement = reconstructElementSJS(x_coords, y_coords, k);

          reconstructedBinaryString += reconstructedElement.toString(2).padStart(8, '0');
        }

        return reconstructedBinaryString;
      };

      // Lagrange æ’å€¼é‡å»ºå–®å€‹å…ƒç´ ï¼ˆå®Œå…¨å°æ‡‰åŸå§‹ _reconstructElementSJSï¼‰
      const reconstructElementSJS = (x_coords, y_coords, k) => {
        let sum = 0;
        const at = 0; // æˆ‘å€‘è¦é‡å»º P(0)

        // [ä¿®æ”¹] ç¢ºä¿åªä½¿ç”¨ k å€‹åˆ†ç‰‡
        for (let i = 0; i < k; i++) {
          if (y_coords[i] === 0) continue;

          let product = GF256.LOG[y_coords[i]]; // log(y_i)

          for (let j = 0; j < k; j++) {
            if (i === j) continue;

            if (at === x_coords[j]) {
              product = -1;
              break;
            }

            const numerator = at ^ x_coords[j]; // 0 XOR x_j = x_j
            const denominator = x_coords[i] ^ x_coords[j];

            if (denominator === 0) {
              // é¿å…é™¤ä»¥é›¶ï¼ˆç†è«–ä¸Šä¸æ‡‰ç™¼ç”Ÿï¼Œé™¤éæœ‰é‡è¤‡çš„ idï¼‰
              product = -1;
              break;
            }

            product = (product + GF256.LOG[numerator] - GF256.LOG[denominator] + GF256.maxShares) % GF256.maxShares;
          }

          sum = product === -1 ? sum : sum ^ GF256.EXP[product];
        }

        return sum;
      };

      // ç§»é™¤å¡«å……ä½å…ƒï¼ˆsecrets.js-1bit æ ¼å¼ï¼‰
      const removePaddingFromBinary = (binaryString) => {
        const markerIndex = binaryString.indexOf('1');
        if (markerIndex === -1) {
          // å¦‚æœæ²’æœ‰ '1' æ¨™è¨˜ï¼ˆä¾‹å¦‚ï¼ŒåŸå§‹ç§˜å¯†æ˜¯ç©ºå­—ä¸²ï¼‰ï¼Œå‰‡è¿”å›ç©º
          return '';
        }
        return binaryString.slice(markerIndex + 1);
      };

      // äºŒé€²ä½å­—ä¸²è½‰åå…­é€²ä½
      const binaryToHex = (binaryString) => {
        // [ä¿®æ”¹] ç¢ºä¿åœ¨äºŒé€²ä½å­—ä¸²ç‚ºç©ºæ™‚è¿”å›ç©ºå­—ä¸²
        if (!binaryString) {
          return '';
        }
        const paddedBinary = binaryString.padStart(Math.ceil(binaryString.length / 4) * 4, '0');
        let hex = '';
        for (let i = 0; i < paddedBinary.length; i += 4) {
          const chunk = paddedBinary.substring(i, i + 4);
          hex += parseInt(chunk, 2).toString(16);
        }
        return hex;
      };

      // åå…­é€²ä½è½‰ UTF-8 å­—ä¸²ï¼ˆå°æ‡‰åŸå§‹ç¨‹å¼ç¢¼çš„ _hex2strï¼‰
      const hexToStr = (hexStr) => {
        let str = '';
        let i = 0;

        // [ä¿®æ”¹] ç¢ºä¿ hexStr é•·åº¦ç‚ºå¶æ•¸
        if (hexStr.length % 2 !== 0) {
          console.warn('åå…­é€²ä½å­—ä¸²é•·åº¦ç‚ºå¥‡æ•¸ï¼Œå¯èƒ½å·²ææ¯€:', hexStr);
          // ä¸Ÿæ£„æœ€å¾Œä¸€å€‹ä¸å®Œæ•´çš„å­—å…ƒ
          hexStr = hexStr.substring(0, hexStr.length - 1);
        }

        while (i < hexStr.length) {
          let charCode;
          let byte1 = parseInt(hexStr.substring(i, i + 2), 16);
          i += 2;

          if (isNaN(byte1)) {
            throw new Error('åŒ…å«ç„¡æ•ˆçš„åå…­é€²ä½å­—å…ƒã€‚');
          }

          if (byte1 < 0x80) {
            charCode = byte1;
          } else if ((byte1 & 0xe0) === 0xc0) {
            let byte2 = parseInt(hexStr.substring(i, i + 2), 16);
            i += 2;
            charCode = ((byte1 & 0x1f) << 6) | (byte2 & 0x3f);
          } else if ((byte1 & 0xf0) === 0xe0) {
            let byte2 = parseInt(hexStr.substring(i, i + 2), 16);
            i += 2;
            let byte3 = parseInt(hexStr.substring(i, i + 2), 16);
            i += 2;
            charCode = ((byte1 & 0x0f) << 12) | ((byte2 & 0x3f) << 6) | (byte3 & 0x3f);
          } else if ((byte1 & 0xf8) === 0xf0) {
            let byte2 = parseInt(hexStr.substring(i, i + 2), 16);
            i += 2;
            let byte3 = parseInt(hexStr.substring(i, i + 2), 16);
            i += 2;
            let byte4 = parseInt(hexStr.substring(i, i + 2), 16);
            i += 2;
            charCode = ((byte1 & 0x07) << 18) | ((byte2 & 0x3f) << 12) | ((byte3 & 0x3f) << 6) | (byte4 & 0x3f);
          } else {
            throw new Error('Invalid UTF-8 sequence in hex string.');
          }
          str += String.fromCodePoint(charCode);
        }
        return str;
      };

      // äºŒé€²ä½å­—ä¸²è½‰ç‚º UTF-8 å­—ä¸²
      const binaryStringToText = (binaryString) => {
        try {
          const unpaddedBinary = removePaddingFromBinary(binaryString);
          const hexString = binaryToHex(unpaddedBinary);
          // [ä¿®æ”¹] è™•ç†ç©ºå­—ä¸²çš„ç‰¹æ®Šæƒ…æ³
          if (hexString === '') {
            return '';
          }
          return hexToStr(hexString);
        } catch (e) {
          throw new Error(`UTF-8 è§£ç¢¼å¤±æ•—: ${e.message}`);
        }
      };

      // [åˆªé™¤] ä¸å†éœ€è¦ç•°æ­¥çš„ Web Crypto API
      // const calculateChecksum = async (data) => { ... };

      // --- DOM æ“ä½œé‚è¼¯ ---

      let shareCount = 0;

      const createShareInput = () => {
        shareCount++;
        const index = shareCount;
        const div = document.createElement('div');
        div.className = 'share-item';
        div.setAttribute('data-index', index);

        const textarea = document.createElement('textarea');
        textarea.rows = 3;
        textarea.placeholder = `åˆ†ç‰‡ ${index} (Base64 ç·¨ç¢¼çš„ JSON)`;
        textarea.className = 'share-textarea';

        div.appendChild(textarea);

        if (shareCount > 2) {
          const button = document.createElement('button');
          button.className = 'remove-btn';
          button.title = 'ç§»é™¤åˆ†ç‰‡';
          button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`;
          button.onclick = () => removeShare(div);
          div.appendChild(button);
        }

        sharesList.appendChild(div);
      };

      const removeShare = (element) => {
        if (sharesList.children.length > 2) {
          sharesList.removeChild(element);
        }
      };

      const addShare = () => {
        createShareInput();
      };

      // è™•ç†é‡å»º
      const handleReconstruct = async () => {
        let parsedShares = [];
        try {
          // é‡ç½® UI
          errorBlock.style.display = 'none';
          resultBlock.style.display = 'none';
          infoBlock.style.display = 'none';

          const textareas = sharesList.querySelectorAll('.share-textarea');
          const shares = Array.from(textareas).map((t) => t.value);

          // éæ¿¾ç©ºç™½åˆ†ç‰‡ä¸¦è§£æ
          const validShares = shares.filter((s) => s.trim() !== '');
          if (validShares.length < 2) {
            throw new Error('è«‹è‡³å°‘è¼¸å…¥ 2 å€‹æœ‰æ•ˆçš„åˆ†ç‰‡');
          }

          // [ä¿®æ”¹] åœ¨ map ä¸­è™•ç†è§£æéŒ¯èª¤
          let parseError = null;
          parsedShares = validShares
            .map((shareStr, index) => {
              try {
                return parseShare(shareStr);
              } catch (e) {
                if (!parseError) {
                  parseError = `åˆ†ç‰‡ ${index + 1} éŒ¯èª¤: ${e.message}`;
                }
                return null;
              }
            })
            .filter((s) => s !== null);

          // å¦‚æœåœ¨è§£æéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œç«‹å³æ‹‹å‡º
          if (parseError) {
            throw new Error(parseError);
          }

          if (parsedShares.length < 2) {
            throw new Error('æ²’æœ‰è¶³å¤ çš„æœ‰æ•ˆåˆ†ç‰‡ï¼ˆè«‹æª¢æŸ¥æ ¼å¼æˆ–æ ¡é©—ç¢¼ï¼‰');
          }

          // æª¢æŸ¥æ˜¯å¦é”åˆ°é–¾å€¼
          const k = parsedShares[0].k;
          if (!k) {
            throw new Error('ç„¡æ³•å¾åˆ†ç‰‡ä¸­è®€å–é‡å»ºé–¾å€¼ (k)ï¼Œè«‹ç¢ºèªåˆ†ç‰‡æ ¼å¼æ­£ç¢ºã€‚');
          }
          if (parsedShares.length < k) {
            throw new Error(`éœ€è¦è‡³å°‘ ${k} å€‹åˆ†ç‰‡æ‰èƒ½é‡å»ºç¥•å¯†ï¼ˆç›®å‰åªæœ‰ ${parsedShares.length} å€‹æœ‰æ•ˆåˆ†ç‰‡ï¼‰`);
          }

          // é¡¯ç¤ºåˆ†ç‰‡è³‡è¨Š
          const firstShare = parsedShares[0];
          document.getElementById('info-version').textContent = firstShare.version || 'N/A';
          document.getElementById('info-n').textContent = firstShare.n || 'N/A';
          document.getElementById('info-k').textContent = firstShare.k || 'N/A';
          document.getElementById('info-polynomial').textContent = firstShare.polynomial
            ? `0x${firstShare.polynomial}`
            : 'N/A';
          document.getElementById('info-encoding').textContent = firstShare.encoding || 'N/A';
          document.getElementById('info-used-shares').textContent = parsedShares
            .map((s) => s.x)
            .sort((a, b) => a - b)
            .join(', ');
          infoBlock.style.display = 'block';

          // é‡å»ºç¥•å¯†
          const reconstructedBinaryString = reconstructSecret(parsedShares);
          const secretText = binaryStringToText(reconstructedBinaryString);
          const hexDisplay = binaryToHex(reconstructedBinaryString);

          // é¡¯ç¤ºçµæœ
          document.getElementById('result-share-count').textContent = `${parsedShares.length} å€‹åˆ†ç‰‡`;
          document.getElementById('result-text').textContent = secretText;
          document.getElementById('result-hex').textContent = hexDisplay;
          resultBlock.style.display = 'block';
        } catch (e) {
          document.getElementById('error-message').textContent = e.message;
          errorBlock.style.display = 'block';
          console.error('é‡å»ºéŒ¯èª¤:', e);
        }
      };

      // --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š ---
      addShareBtn.addEventListener('click', addShare);
      reconstructBtn.addEventListener('click', handleReconstruct);

      // åˆå§‹åŒ– 2 å€‹è¼¸å…¥æ¡†
      createShareInput();
      createShareInput();
    </script>
  </body>
</html>
