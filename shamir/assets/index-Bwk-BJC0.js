(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))n(e);new MutationObserver(e=>{for(const l of e)if(l.type==="childList")for(const x of l.addedNodes)x.tagName==="LINK"&&x.rel==="modulepreload"&&n(x)}).observe(document,{childList:!0,subtree:!0});function a(e){const l={};return e.integrity&&(l.integrity=e.integrity),e.referrerPolicy&&(l.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?l.credentials="include":e.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(e){if(e.ep)return;e.ep=!0;const l=a(e);fetch(e.href,l)}})();var at=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ct(A){if(Object.prototype.hasOwnProperty.call(A,"__esModule"))return A;var o=A.default;if(typeof o=="function"){var a=function n(){var e=!1;try{e=this instanceof n}catch{}return e?Reflect.construct(o,arguments,this.constructor):o.apply(this,arguments)};a.prototype=o.prototype}else a={};return Object.defineProperty(a,"__esModule",{value:!0}),Object.keys(A).forEach(function(n){var e=Object.getOwnPropertyDescriptor(A,n);Object.defineProperty(a,n,e.get?e:{enumerable:!0,get:function(){return A[n]}})}),a}var tt={exports:{}};const ht={},lt=Object.freeze(Object.defineProperty({__proto__:null,default:ht},Symbol.toStringTag,{value:"Module"})),et=ct(lt);/**
 * [js-sha256]{@link https://github.com/emn178/js-sha256}
 *
 * @version 0.11.1
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2025
 * @license MIT
 */var rt;function ft(){return rt||(rt=1,(function(A){(function(){var o="input is invalid type",a=typeof window=="object",n=a?window:{};n.JS_SHA256_NO_WINDOW&&(a=!1);var e=!a&&typeof self=="object",l=!n.JS_SHA256_NO_NODE_JS&&typeof process=="object"&&process.versions&&process.versions.node&&process.type!="renderer";l?n=at:e&&(n=self);var x=!n.JS_SHA256_NO_COMMON_JS&&!0&&A.exports,p=!n.JS_SHA256_NO_ARRAY_BUFFER&&typeof ArrayBuffer<"u",r="0123456789abcdef".split(""),E=[-2147483648,8388608,32768,128],C=[24,16,8,0],P=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],J=["hex","array","digest","arrayBuffer"],w=[];(n.JS_SHA256_NO_NODE_JS||!Array.isArray)&&(Array.isArray=function(t){return Object.prototype.toString.call(t)==="[object Array]"}),p&&(n.JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW||!ArrayBuffer.isView)&&(ArrayBuffer.isView=function(t){return typeof t=="object"&&t.buffer&&t.buffer.constructor===ArrayBuffer});var z=function(t,h){return function(d){return new B(h,!0).update(d)[t]()}},Q=function(t){var h=z("hex",t);l&&(h=Y(h,t)),h.create=function(){return new B(t)},h.update=function(f){return h.create().update(f)};for(var d=0;d<J.length;++d){var c=J[d];h[c]=z(c,t)}return h},Y=function(t,h){var d=et,c=et.Buffer,f=h?"sha224":"sha256",s;c.from&&!n.JS_SHA256_NO_BUFFER_FROM?s=c.from:s=function(i){return new c(i)};var g=function(i){if(typeof i=="string")return d.createHash(f).update(i,"utf8").digest("hex");if(i==null)throw new Error(o);return i.constructor===ArrayBuffer&&(i=new Uint8Array(i)),Array.isArray(i)||ArrayBuffer.isView(i)||i.constructor===c?d.createHash(f).update(s(i)).digest("hex"):t(i)};return g},G=function(t,h){return function(d,c){return new q(d,h,!0).update(c)[t]()}},V=function(t){var h=G("hex",t);h.create=function(f){return new q(f,t)},h.update=function(f,s){return h.create(f).update(s)};for(var d=0;d<J.length;++d){var c=J[d];h[c]=G(c,t)}return h};function B(t,h){h?(w[0]=w[16]=w[1]=w[2]=w[3]=w[4]=w[5]=w[6]=w[7]=w[8]=w[9]=w[10]=w[11]=w[12]=w[13]=w[14]=w[15]=0,this.blocks=w):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=t}B.prototype.update=function(t){if(!this.finalized){var h,d=typeof t;if(d!=="string"){if(d==="object"){if(t===null)throw new Error(o);if(p&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!Array.isArray(t)&&(!p||!ArrayBuffer.isView(t)))throw new Error(o)}else throw new Error(o);h=!0}for(var c,f=0,s,g=t.length,i=this.blocks;f<g;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,this.block=i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),h)for(s=this.start;f<g&&s<64;++f)i[s>>>2]|=t[f]<<C[s++&3];else for(s=this.start;f<g&&s<64;++f)c=t.charCodeAt(f),c<128?i[s>>>2]|=c<<C[s++&3]:c<2048?(i[s>>>2]|=(192|c>>>6)<<C[s++&3],i[s>>>2]|=(128|c&63)<<C[s++&3]):c<55296||c>=57344?(i[s>>>2]|=(224|c>>>12)<<C[s++&3],i[s>>>2]|=(128|c>>>6&63)<<C[s++&3],i[s>>>2]|=(128|c&63)<<C[s++&3]):(c=65536+((c&1023)<<10|t.charCodeAt(++f)&1023),i[s>>>2]|=(240|c>>>18)<<C[s++&3],i[s>>>2]|=(128|c>>>12&63)<<C[s++&3],i[s>>>2]|=(128|c>>>6&63)<<C[s++&3],i[s>>>2]|=(128|c&63)<<C[s++&3]);this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.block=i[16],this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},B.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,h=this.lastByteIndex;t[16]=this.block,t[h>>>2]|=E[h&3],this.block=t[16],h>=56&&(this.hashed||this.hash(),t[0]=this.block,t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.hBytes<<3|this.bytes>>>29,t[15]=this.bytes<<3,this.hash()}},B.prototype.hash=function(){var t=this.h0,h=this.h1,d=this.h2,c=this.h3,f=this.h4,s=this.h5,g=this.h6,i=this.h7,m=this.blocks,b,I,_,O,y,k,M,U,D,$,u;for(b=16;b<64;++b)y=m[b-15],I=(y>>>7|y<<25)^(y>>>18|y<<14)^y>>>3,y=m[b-2],_=(y>>>17|y<<15)^(y>>>19|y<<13)^y>>>10,m[b]=m[b-16]+I+m[b-7]+_<<0;for(u=h&d,b=0;b<64;b+=4)this.first?(this.is224?(U=300032,y=m[0]-1413257819,i=y-150054599<<0,c=y+24177077<<0):(U=704751109,y=m[0]-210244248,i=y-1521486534<<0,c=y+143694565<<0),this.first=!1):(I=(t>>>2|t<<30)^(t>>>13|t<<19)^(t>>>22|t<<10),_=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7),U=t&h,O=U^t&d^u,M=f&s^~f&g,y=i+_+M+P[b]+m[b],k=I+O,i=c+y<<0,c=y+k<<0),I=(c>>>2|c<<30)^(c>>>13|c<<19)^(c>>>22|c<<10),_=(i>>>6|i<<26)^(i>>>11|i<<21)^(i>>>25|i<<7),D=c&t,O=D^c&h^U,M=i&f^~i&s,y=g+_+M+P[b+1]+m[b+1],k=I+O,g=d+y<<0,d=y+k<<0,I=(d>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),_=(g>>>6|g<<26)^(g>>>11|g<<21)^(g>>>25|g<<7),$=d&c,O=$^d&t^D,M=g&i^~g&f,y=s+_+M+P[b+2]+m[b+2],k=I+O,s=h+y<<0,h=y+k<<0,I=(h>>>2|h<<30)^(h>>>13|h<<19)^(h>>>22|h<<10),_=(s>>>6|s<<26)^(s>>>11|s<<21)^(s>>>25|s<<7),u=h&d,O=u^h&c^$,M=s&g^~s&i,y=f+_+M+P[b+3]+m[b+3],k=I+O,f=t+y<<0,t=y+k<<0,this.chromeBugWorkAround=!0;this.h0=this.h0+t<<0,this.h1=this.h1+h<<0,this.h2=this.h2+d<<0,this.h3=this.h3+c<<0,this.h4=this.h4+f<<0,this.h5=this.h5+s<<0,this.h6=this.h6+g<<0,this.h7=this.h7+i<<0},B.prototype.hex=function(){this.finalize();var t=this.h0,h=this.h1,d=this.h2,c=this.h3,f=this.h4,s=this.h5,g=this.h6,i=this.h7,m=r[t>>>28&15]+r[t>>>24&15]+r[t>>>20&15]+r[t>>>16&15]+r[t>>>12&15]+r[t>>>8&15]+r[t>>>4&15]+r[t&15]+r[h>>>28&15]+r[h>>>24&15]+r[h>>>20&15]+r[h>>>16&15]+r[h>>>12&15]+r[h>>>8&15]+r[h>>>4&15]+r[h&15]+r[d>>>28&15]+r[d>>>24&15]+r[d>>>20&15]+r[d>>>16&15]+r[d>>>12&15]+r[d>>>8&15]+r[d>>>4&15]+r[d&15]+r[c>>>28&15]+r[c>>>24&15]+r[c>>>20&15]+r[c>>>16&15]+r[c>>>12&15]+r[c>>>8&15]+r[c>>>4&15]+r[c&15]+r[f>>>28&15]+r[f>>>24&15]+r[f>>>20&15]+r[f>>>16&15]+r[f>>>12&15]+r[f>>>8&15]+r[f>>>4&15]+r[f&15]+r[s>>>28&15]+r[s>>>24&15]+r[s>>>20&15]+r[s>>>16&15]+r[s>>>12&15]+r[s>>>8&15]+r[s>>>4&15]+r[s&15]+r[g>>>28&15]+r[g>>>24&15]+r[g>>>20&15]+r[g>>>16&15]+r[g>>>12&15]+r[g>>>8&15]+r[g>>>4&15]+r[g&15];return this.is224||(m+=r[i>>>28&15]+r[i>>>24&15]+r[i>>>20&15]+r[i>>>16&15]+r[i>>>12&15]+r[i>>>8&15]+r[i>>>4&15]+r[i&15]),m},B.prototype.toString=B.prototype.hex,B.prototype.digest=function(){this.finalize();var t=this.h0,h=this.h1,d=this.h2,c=this.h3,f=this.h4,s=this.h5,g=this.h6,i=this.h7,m=[t>>>24&255,t>>>16&255,t>>>8&255,t&255,h>>>24&255,h>>>16&255,h>>>8&255,h&255,d>>>24&255,d>>>16&255,d>>>8&255,d&255,c>>>24&255,c>>>16&255,c>>>8&255,c&255,f>>>24&255,f>>>16&255,f>>>8&255,f&255,s>>>24&255,s>>>16&255,s>>>8&255,s&255,g>>>24&255,g>>>16&255,g>>>8&255,g&255];return this.is224||m.push(i>>>24&255,i>>>16&255,i>>>8&255,i&255),m},B.prototype.array=B.prototype.digest,B.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(this.is224?28:32),h=new DataView(t);return h.setUint32(0,this.h0),h.setUint32(4,this.h1),h.setUint32(8,this.h2),h.setUint32(12,this.h3),h.setUint32(16,this.h4),h.setUint32(20,this.h5),h.setUint32(24,this.h6),this.is224||h.setUint32(28,this.h7),t};function q(t,h,d){var c,f=typeof t;if(f==="string"){var s=[],g=t.length,i=0,m;for(c=0;c<g;++c)m=t.charCodeAt(c),m<128?s[i++]=m:m<2048?(s[i++]=192|m>>>6,s[i++]=128|m&63):m<55296||m>=57344?(s[i++]=224|m>>>12,s[i++]=128|m>>>6&63,s[i++]=128|m&63):(m=65536+((m&1023)<<10|t.charCodeAt(++c)&1023),s[i++]=240|m>>>18,s[i++]=128|m>>>12&63,s[i++]=128|m>>>6&63,s[i++]=128|m&63);t=s}else if(f==="object"){if(t===null)throw new Error(o);if(p&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!Array.isArray(t)&&(!p||!ArrayBuffer.isView(t)))throw new Error(o)}else throw new Error(o);t.length>64&&(t=new B(h,!0).update(t).array());var b=[],I=[];for(c=0;c<64;++c){var _=t[c]||0;b[c]=92^_,I[c]=54^_}B.call(this,h,d),this.update(I),this.oKeyPad=b,this.inner=!0,this.sharedMemory=d}q.prototype=new B,q.prototype.finalize=function(){if(B.prototype.finalize.call(this),this.inner){this.inner=!1;var t=this.array();B.call(this,this.is224,this.sharedMemory),this.update(this.oKeyPad),this.update(t),B.prototype.finalize.call(this)}};var T=Q();T.sha256=T,T.sha224=Q(!0),T.sha256.hmac=V(),T.sha224.hmac=V(!0),x?A.exports=T:(n.sha256=T.sha256,n.sha224=T.sha224)})()})(tt)),tt.exports}var nt=ft();class st{constructor(o,a,n){if(a<2||n<2||n>a||a>255||n>255)throw new Error("k 和 n 必須是 2 到 255 之間的整數，且 k <= n。");if(typeof o!="string")throw new Error("秘密必須是字串。");this.n=a,this.k=n,this.config={bits:8,radix:16,maxShares:255,primitivePolynomials:[null,null,1,3,3,5,3,3,29],logs:new Array(256),exps:new Array(256)},this._secretsJS_initGF(this.config.bits);const e=this._str2hex(o);let l="1"+this._hex2bin(e);const x=this.config.bits,p=l.length%x;p&&(l="0".repeat(x-p)+l),this.processedSecretElements=this._splitNumStringToIntArray(l,x)}_secretsJS_initGF(o){const a=this.config.primitivePolynomials[o];if(!a)throw new Error(`Unsupported bit size for GF: ${o}`);let n=1;for(let e=0;e<this.config.maxShares;e++)this.config.exps[e]=n,this.config.logs[n]=e,n<<=1,n>=256&&(n^=a,n&=this.config.maxShares)}_padLeft(o,a){let n=o.length%a;return n?"0".repeat(a-n)+o:o}_str2hex(o){let a="";for(let n=0;n<o.length;n++){let e=o.charCodeAt(n);e<128?a+=e.toString(16).padStart(2,"0"):e<2048?(a+=(192|e>>6).toString(16).padStart(2,"0"),a+=(128|e&63).toString(16).padStart(2,"0")):e<55296||e>=57344?(a+=(224|e>>12).toString(16).padStart(2,"0"),a+=(128|e>>6&63).toString(16).padStart(2,"0"),a+=(128|e&63).toString(16).padStart(2,"0")):(e=65536+((e&1023)<<10|o.charCodeAt(++n)&1023),a+=(240|e>>18).toString(16).padStart(2,"0"),a+=(128|e>>12&63).toString(16).padStart(2,"0"),a+=(128|e>>6&63).toString(16).padStart(2,"0"),a+=(128|e&63).toString(16).padStart(2,"0"))}return a}_hex2bin(o){let a="";for(let n=0;n<o.length;n++){let e=parseInt(o[n],16);if(isNaN(e))throw new Error("Invalid hex character in _hex2bin.");a+=e.toString(2).padStart(4,"0")}return a}_bin2hex(o){let a="";o=this._padLeft(o,4);for(let n=0;n<o.length;n+=4){let e=o.substring(n,n+4);a+=parseInt(e,2).toString(16)}return a}_hex2str(o){let a="",n=0;for(;n<o.length;){let e,l=parseInt(o.substring(n,n+2),16);if(n+=2,l<128)e=l;else if((l&224)===192){let x=parseInt(o.substring(n,n+2),16);n+=2,e=(l&31)<<6|x&63}else if((l&240)===224){let x=parseInt(o.substring(n,n+2),16);n+=2;let p=parseInt(o.substring(n,n+2),16);n+=2,e=(l&15)<<12|(x&63)<<6|p&63}else if((l&248)===240){let x=parseInt(o.substring(n,n+2),16);n+=2;let p=parseInt(o.substring(n,n+2),16);n+=2;let r=parseInt(o.substring(n,n+2),16);n+=2,e=(l&7)<<18|(x&63)<<12|(p&63)<<6|r&63}else throw new Error("Invalid UTF-8 sequence in hex string.");a+=String.fromCodePoint(e)}return a}_splitNumStringToIntArray(o,a){const n=[];for(let e=0;e<o.length;e+=a)n.push(parseInt(o.substring(e,e+a),2));return n}_getRandomByte(){const o=new Uint8Array(1);return window.crypto.getRandomValues(o),o[0]}_evalPolynomialSJS(o,a){let n=0;const e=this.config.logs[o];for(let l=a.length-1;l>=0;l--)n===0?n=a[l]:n=this.config.exps[(e+this.config.logs[n])%this.config.maxShares]^a[l];return n}generateShares(){const o=[];for(let a=0;a<this.n;a++)o[a]={id:a+1,value:new Array(this.processedSecretElements.length)};for(let a=0;a<this.processedSecretElements.length;a++){const e=[this.processedSecretElements[a]];for(let l=1;l<this.k;l++)e[l]=this._getRandomByte();for(let l=0;l<this.n;l++){const x=o[l].id;o[l].value[a]=this._evalPolynomialSJS(x,e)}}return o}_reconstructElementSJS(o,a){let n=0;const e=0;for(let l=0;l<this.k;l++){if(a[l]===0)continue;let x=this.config.logs[a[l]];for(let p=0;p<this.k;p++)if(l!==p){if(e===o[p]){x=-1;break}x=(x+this.config.logs[e^o[p]]-this.config.logs[o[l]^o[p]]+this.config.maxShares)%this.config.maxShares}n=x===-1?n:n^this.config.exps[x]}return n}reconstructSecret(o){if(o.length<this.k)throw new Error(`至少需要 ${this.k} 份分割值才能重建。`);const a=o.slice(0,this.k),n=a[0].value.length;if(!a.every(r=>r.value.length===n))throw new Error("所有用於重建的分割值長度必須一致。");let e="";const l=a.map(r=>r.id);for(let r=0;r<n;r++){const E=a.map(P=>P.value[r]),C=this._reconstructElementSJS(l,E);e+=this._padLeft(C.toString(2),this.config.bits)}const x=e.slice(e.indexOf("1")+1),p=this._bin2hex(x);return this._hex2str(p)}}var X={exports:{}},ut=X.exports,it;function dt(){return it||(it=1,(function(A){(function(){var o,a,n,e;for(n=(A!==null?A.exports:void 0)||(window.Base58={}),o="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",a={},e=0;e<o.length;)a[o.charAt(e)]=e,e++;n.encode=function(l){var x,p,r;if(l.length===0)return"";for(e=void 0,r=void 0,p=[0],e=0;e<l.length;){for(r=0;r<p.length;)p[r]<<=8,r++;for(p[0]+=l[e],x=0,r=0;r<p.length;)p[r]+=x,x=p[r]/58|0,p[r]%=58,++r;for(;x;)p.push(x%58),x=x/58|0;e++}for(e=0;l[e]===0&&e<l.length-1;)p.push(0),e++;return p.reverse().map(function(E){return o[E]}).join("")},n.decode=function(l){var x,p,r,E;if(l.length===0)return new(typeof Uint8Array<"u"&&Uint8Array!==null?Uint8Array:Buffer)(0);for(e=void 0,E=void 0,x=[0],e=0;e<l.length;){if(p=l[e],!(p in a))throw"Base58.decode received unacceptable input. Character '"+p+"' is not in the Base58 alphabet.";for(E=0;E<x.length;)x[E]*=58,E++;for(x[0]+=a[p],r=0,E=0;E<x.length;)x[E]+=r,r=x[E]>>8,x[E]&=255,++E;for(;r;)x.push(r&255),r>>=8;e++}for(e=0;l[e]==="1"&&e<l.length-1;)x.push(0),e++;return new(typeof Uint8Array<"u"&&Uint8Array!==null?Uint8Array:Buffer)(x.reverse())}}).call(ut)})(X)),X.exports}var ot=dt();document.addEventListener("DOMContentLoaded",()=>{const A=document.createElement("script");A.src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js",A.onload=()=>console.log("QRCode.js loaded."),document.head.appendChild(A);const o=document.getElementById("modeSplitBtn"),a=document.getElementById("modeReconstructBtn"),n=document.getElementById("splitSection"),e=document.getElementById("reconstructSection"),l=document.getElementById("originalString"),x=document.getElementById("n"),p=document.getElementById("k"),r=document.getElementById("kErrorMessage"),E=document.getElementById("generateBtn"),C=document.getElementById("clearSplitBtn"),P=document.getElementById("splitError"),J=document.getElementById("splitResultArea"),w=document.querySelector("#splitResultTable tbody"),z=document.getElementById("queueProgress"),Q=document.getElementById("queueList"),Y=document.getElementById("customShareInput"),G=document.getElementById("addCustomShareBtn"),V=document.getElementById("reconstructBtn"),B=document.getElementById("clearQueueBtn"),q=document.getElementById("reconstructionResult"),T=document.getElementById("themeToggleBtn"),t=document.getElementById("qrModal"),h=document.getElementById("qrCodeContainer"),d=document.getElementById("toast"),c=document.getElementById("encodingToggle");let f=null,s=[],g=[];document.getElementById("currentYear").textContent=new Date().getFullYear();const i="zanta-shamir-secret-sharing-theme",m=u=>{d.textContent=u,d.className="show",setTimeout(()=>{d.className=d.className.replace("show","")},3e3)},b=u=>{u==="split"?(o.classList.add("active"),a.classList.remove("active"),n.classList.add("active"),e.classList.remove("active")):(o.classList.remove("active"),a.classList.add("active"),n.classList.remove("active"),e.classList.add("active"))},I=u=>{P.textContent=u,P.style.display="block"},_=()=>{P.style.display="none"},O=(u,F)=>{q.textContent=u,q.className=`output-box ${F}`,q.style.display="block"},y=()=>{q.style.display="none"},k=()=>{Q.innerHTML="";const u=f?f.k:s.length>=2?"k?":"?";s.length===0?z.textContent="請先產生或手動加入分割值":z.textContent=`已選擇 ${s.length} / ${u} 份分割值`,s.forEach(v=>{const S=document.createElement("div");S.className="queue-item";const R=`ID: ${v.id}`,j=document.createElement("span");j.textContent=`${R}`,S.appendChild(j);const N=document.createElement("button");N.textContent="移除",N.onclick=()=>{s=s.filter(L=>L.id!==v.id),k()},S.appendChild(N),Q.appendChild(S)});let F=!1;f?F=s.length>=f.k:F=s.length>=(parseInt(p.value)||2),V.disabled=!F},M=u=>{if(s.some(F=>F.id===u.id)){m(`ID 為 ${u.id} 的分割值已在佇列中。`);return}s.push(u),k(),b("reconstruct")},U=()=>{const u=x.value,F=p.value;let v=!0;if(r.textContent="",document.getElementById("nErrorMessage").textContent="",u===""&&F==="")return E.disabled=!0,!1;const S=parseInt(u),R=parseInt(F);return(u===""||isNaN(S)||S<2||S>255)&&(document.getElementById("nErrorMessage").textContent="n 必須是 2 到 255 之間的數字",v=!1),(F===""||isNaN(R)||R<2||R>255)&&(r.textContent="k 必須是 2 到 255 之間的數字",v=!1),v&&R>S&&(r.textContent="k (門檻值) 不能大於 n (總分割數)",v=!1),E.disabled=!v,v};function D(u,F){w.innerHTML="",u.forEach(v=>{let S;const R=JSON.stringify(v);if(F==="base58"){const Z=new TextEncoder().encode(R);S=ot.encode(Z)}else S=btoa(R);const j=w.insertRow();j.insertCell(0).textContent=v.id,j.insertCell(1).textContent=S;const N=j.insertCell(2),L=document.createElement("div");L.className="action-button-container";const H=document.createElement("button");H.textContent="加入",H.title="加入重建佇列",H.className="action-btn",H.onclick=()=>M({id:v.id,value:v.share});const K=document.createElement("button");K.textContent="複製",K.title="複製編碼後的分割值",K.className="action-btn secondary",K.onclick=()=>{navigator.clipboard.writeText(S).then(()=>m(`ID ${v.id} 的分割值已複製！`)).catch(Z=>m("複製失敗: "+Z))};const W=document.createElement("button");W.textContent="QR",W.title="產生此分割值的 QR Code",W.className="action-btn qr",W.onclick=()=>{h.innerHTML="",typeof QRCode<"u"?(new QRCode(h,{text:S,width:256,height:256,colorDark:document.documentElement.getAttribute("data-theme")==="dark"?"#e8e8f0":"#000000",colorLight:document.documentElement.getAttribute("data-theme")==="dark"?"#2f2f4f":"#ffffff",correctLevel:QRCode.CorrectLevel.M}),t.style.display="flex"):I("QR Code 函式庫載入失敗。")},L.appendChild(H),L.appendChild(K),L.appendChild(W),N.appendChild(L)})}x.addEventListener("input",U),p.addEventListener("input",U),o.addEventListener("click",()=>b("split")),a.addEventListener("click",()=>b("reconstruct")),E.addEventListener("click",()=>{_(),J.style.display="none";try{const u=l.value,F=parseInt(x.value),v=parseInt(p.value);if(u===""&&!confirm("您確定要分享一個空字串嗎？"))return;if(!x.value||!p.value)throw new Error("n 和 k 皆必須填寫。");if(!U()){I("請修正 n 或 k 的錯誤。");return}f=new st(u,F,v),g=f.generateShares().map(j=>{const N={v:"1.1",n:f.n,k:f.k,p:"1D",cs:"sha256-4",id:j.id,share:j.value},L=nt.sha256(JSON.stringify(N)).substring(0,8);return N.chk=L,N});const R=c.checked?"base58":"base64";D(g,R),J.style.display="block",s=[],k()}catch(u){console.error("Generate Error:",u),I(`錯誤: ${u.message}`)}}),c.addEventListener("change",u=>{const F=u.target.checked?"base58":"base64";g.length>0&&D(g,F)}),C.addEventListener("click",()=>{l.value="",x.value="",p.value="",r.textContent="",document.getElementById("nErrorMessage").textContent="",_(),J.style.display="none",f=null,s=[],g=[],k(),U()}),G.addEventListener("click",()=>{y();try{const u=Y.value.trim();if(!u)throw new Error("輸入不能為空。");let F;try{F=atob(u)}catch{try{const H=ot.decode(u);F=new TextDecoder().decode(H)}catch{throw new Error("無法解析輸入，請確認其為有效的 Base64 或 Base58 編碼。")}}const v=JSON.parse(F),{chk:S,...R}=v;if(!S)throw new Error("格式不正確：缺少校驗碼 (chk) 欄位。請使用 v1.1 或更高版本產生的分割值。");const j=nt.sha256(JSON.stringify(R)).substring(0,8);if(S!==j)throw new Error("Checksum 驗證失敗！此分割值可能已損毀或被竄改。");const N={id:R.id,value:R.share};if(typeof N.id!="number"||!Array.isArray(N.value))throw new Error("Base64 解碼後的格式不正確，缺少 id 或 share (必須是陣列) 欄位。");if(!N.value.every(L=>typeof L=="number"&&L>=0&&L<=255))throw new Error("分割值中的 share 陣列包含無效的數字 (應為 0-255 之間的數字)。");M(N),Y.value=""}catch(u){console.error("Add Custom Share Error:",u),O(`加入失敗: ${u.message}`,"error")}}),B.addEventListener("click",()=>{s=[],y(),k()}),V.addEventListener("click",()=>{try{if(s.length===0)throw new Error("重建佇列是空的。請加入分割值。");let u=f?f.k:parseInt(p.value),F=f?f.n:parseInt(x.value);if(isNaN(u)||u<2)throw new Error("錯誤：無法確定重建所需的門檻值 (k)。請在「分割」頁面設定 k 值。");if(s.length<u)throw new Error(`需要 ${u} 份分割值，目前只有 ${s.length} 份。`);let v=f;v||((isNaN(F)||F<u||F>255)&&(F=255),v=new st("temp",F,u));const S=v.reconstructSecret(s);O(S,"success")}catch(u){console.error("Reconstruct Error:",u),O(`重建失敗: ${u.message}`,"error")}}),t.addEventListener("click",u=>{u.target===t&&(t.style.display="none")});const $=u=>{document.documentElement.setAttribute("data-theme",u),T.textContent=u==="dark"?"☀️":"🌙",localStorage.setItem(i,u)};T.addEventListener("click",()=>{const u=document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark";$(u)}),$(localStorage.getItem(i)||"dark"),U(),k()});
