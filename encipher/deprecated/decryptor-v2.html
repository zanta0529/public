<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AES-GCM è§£å¯†å·¥å…· v2</title>
    <script
      src="https://cdn.jsdelivr.net/npm/argon2-browser@1.18.0/dist/argon2-bundled.min.js"
      onerror="
        this.remove();
        document.getElementById('backup-argon2-script').style.display = 'block';
      "
    ></script>
    <script
      id="backup-argon2-script"
      style="display: none"
      src="https://unpkg.com/argon2-browser@1.18.0/dist/argon2-bundled.min.js"
    ></script>
    <style>
      body {
        font-family: sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
      }

      * {
        box-sizing: border-box;
      }

      .container {
        background: #fff;
        padding: 30px;
        border-radius: 15px;
        width: 100%;
        max-width: 900px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      .header {
        text-align: center;
        margin-bottom: 25px;
      }

      .header h1 {
        margin: 0;
        color: #333;
        font-size: 28px;
      }

      .subtitle {
        color: #666;
        margin-top: 8px;
        font-size: 14px;
      }

      .group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      textarea,
      input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 13px;
        transition: border-color 0.3s ease;
      }

      textarea:focus,
      input:focus {
        outline: none;
        border-color: #667eea;
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      .decrypt-btn {
        width: 100%;
        padding: 15px;
        margin-top: 20px;
        border: none;
        border-radius: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .decrypt-btn:hover {
        transform: translateY(-2px);
      }

      .decrypt-btn:active {
        transform: translateY(0);
      }

      .results {
        margin-top: 25px;
      }

      .result-box {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        word-wrap: break-word;
        max-height: 300px;
        overflow: auto;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 13px;
        white-space: pre-wrap;
      }

      .success {
        border-color: #28a745;
        background: #d4edda;
        color: #155724;
      }

      .error {
        border-color: #dc3545;
        background: #f8d7da;
        color: #721c24;
      }

      .status {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-weight: 600;
        text-align: center;
      }

      .loading {
        animation: pulse 1.5s infinite;
      }

      .kdf-indicator {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
      }

      .kdf-argon2 {
        background: #e3f2fd;
        color: #1565c0;
      }

      .kdf-pbkdf2 {
        background: #f3e5f5;
        color: #7b1fa2;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .info-box {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        font-size: 14px;
        color: #0066cc;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ”“ AES-GCM è§£å¯†å·¥å…· v2</h1>
        <div class="subtitle">è‡ªå‹•åµæ¸¬ Argon2id æˆ– PBKDF2 é‡‘é‘°æ´¾ç”Ÿå‡½æ•¸</div>
      </div>

      <div class="info-box">
        ğŸ’¡ æœ¬å·¥å…·æœƒè‡ªå‹•åµæ¸¬æ‚¨çš„åŠ å¯†è³‡æ–™ä½¿ç”¨çš„é‡‘é‘°æ´¾ç”Ÿå‡½æ•¸ï¼Œæ”¯æ´ Argon2id å’Œ PBKDF2 å…©ç¨®æ¼”ç®—æ³•ã€‚
      </div>

      <div class="group">
        <label for="ciphertext">åŠ å¯†è³‡æ–™ï¼š</label>
        <textarea id="ciphertext" placeholder="è«‹è²¼ä¸Šæ‚¨çš„ Base64 ç·¨ç¢¼åŠ å¯†è³‡æ–™..." rows="8"></textarea>
      </div>

      <div class="group">
        <label for="password">å¯†ç¢¼çŸ­èªï¼š</label>
        <input id="password" type="password" placeholder="è«‹è¼¸å…¥è§£å¯†å¯†ç¢¼..." />
      </div>

      <button class="decrypt-btn" onclick="decrypt()">ğŸ”“ é–‹å§‹è§£å¯†</button>

      <div class="results">
        <div id="status"></div>
        <div id="result"></div>
      </div>
    </div>

    <script>
      function setStatus(message, type, kdfType = null) {
        const statusEl = document.getElementById('status');
        statusEl.className = 'status ' + type;
        let displayMessage = message;

        if (kdfType) {
          displayMessage += `<span class="kdf-indicator kdf-${kdfType.toLowerCase()}">${kdfType}</span>`;
        }

        statusEl.innerHTML = displayMessage;
      }

      function setResult(content, type) {
        const resultEl = document.getElementById('result');
        resultEl.className = 'result-box ' + type;
        resultEl.textContent = content;
        resultEl.style.display = content ? 'block' : 'none';
      }

      function base64UrlDecode(str) {
        // è™•ç† base64url å’Œæ¨™æº– base64 æ ¼å¼
        str = str.replace(/-/g, '+').replace(/_/g, '/');

        // è£œé½Š padding
        while (str.length % 4) {
          str += '=';
        }

        const binaryString = atob(str);
        const bytes = new Uint8Array(binaryString.length);

        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }

        return bytes;
      }

      function buildAAD(params) {
        const aadObj = {
          version: params.version,
        };

        // å»ºæ§‹ keyDerivation ç‰©ä»¶
        const keyDerivation = {
          name: params.keyDerivation.name,
        };

        // æ ¹æ“šä¸åŒçš„ KDF åŠ å…¥ç›¸æ‡‰åƒæ•¸
        if (params.keyDerivation.name === 'Argon2id') {
          keyDerivation.iterations = params.keyDerivation.iterations;
          keyDerivation.memory = params.keyDerivation.memory;
          keyDerivation.parallelism = params.keyDerivation.parallelism;
        } else if (params.keyDerivation.name === 'PBKDF2') {
          keyDerivation.iterations = params.keyDerivation.iterations;
          if (params.keyDerivation.hash) {
            keyDerivation.hash = params.keyDerivation.hash;
          }
        }

        aadObj.keyDerivation = keyDerivation;
        aadObj.encryptionName = params.encryption.name;

        return new TextEncoder().encode(JSON.stringify(aadObj));
      }

      async function deriveKeyArgon2(passphrase, salt, iterations, memory, parallelism) {
        if (typeof argon2 === 'undefined') {
          throw new Error('Argon2 åº«è¼‰å…¥å¤±æ•—ï¼Œç„¡æ³•ä½¿ç”¨ Argon2id è§£å¯†');
        }

        const result = await argon2.hash({
          pass: passphrase,
          salt: salt,
          time: iterations,
          mem: memory,
          parallelism: parallelism,
          hashLen: 32,
          type: argon2.ArgonType.Argon2id,
        });

        return result.hash;
      }

      async function deriveKeyPBKDF2(passphrase, salt, iterations) {
        const encoder = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey(
          'raw',
          encoder.encode(passphrase),
          { name: 'PBKDF2' },
          false,
          ['deriveBits']
        );

        const derivedBits = await crypto.subtle.deriveBits(
          {
            name: 'PBKDF2',
            salt: salt,
            iterations: iterations,
            hash: 'SHA-256',
          },
          keyMaterial,
          256
        );

        return new Uint8Array(derivedBits);
      }

      async function decryptAESGCM(key, iv, ciphertext, tag, aad) {
        const cryptoKey = await crypto.subtle.importKey('raw', key, { name: 'AES-GCM' }, false, ['decrypt']);

        // çµ„åˆ ciphertext å’Œ tag
        const combinedData = new Uint8Array(ciphertext.length + tag.length);
        combinedData.set(ciphertext);
        combinedData.set(tag, ciphertext.length);

        const decryptedBuffer = await crypto.subtle.decrypt(
          {
            name: 'AES-GCM',
            iv: iv,
            additionalData: aad,
            tagLength: 128,
          },
          cryptoKey,
          combinedData
        );

        return new Uint8Array(decryptedBuffer);
      }

      async function decrypt() {
        const ciphertextInput = document.getElementById('ciphertext').value.trim();
        const password = document.getElementById('password').value;

        // æ¸…ç©ºä¹‹å‰çš„çµæœ
        setResult('', '');

        if (!ciphertextInput) {
          setStatus('âŒ è«‹è¼¸å…¥åŠ å¯†è³‡æ–™', 'error');
          return;
        }

        if (!password) {
          setStatus('âŒ è«‹è¼¸å…¥å¯†ç¢¼çŸ­èª', 'error');
          return;
        }

        setStatus('ğŸ”„ è§£æåŠ å¯†è³‡æ–™ä¸­...', 'loading');

        try {
          // è§£ç¢¼ Base64 è³‡æ–™
          const decodedData = base64UrlDecode(ciphertextInput);
          const jsonString = new TextDecoder().decode(decodedData);
          const params = JSON.parse(jsonString);

          // æª¢æŸ¥æ”¯æ´çš„æ¼”ç®—æ³•
          if (params.encryption.name !== 'AES-GCM') {
            throw new Error('ä¸æ”¯æ´çš„åŠ å¯†æ¼”ç®—æ³•ï¼š' + params.encryption.name);
          }

          const kdfName = params.keyDerivation.name;
          if (!['Argon2id', 'PBKDF2'].includes(kdfName)) {
            throw new Error(`ä¸æ”¯æ´çš„é‡‘é‘°æ´¾ç”Ÿå‡½æ•¸ï¼š${kdfName}ï¼ˆåƒ…æ”¯æ´ Argon2id å’Œ PBKDF2ï¼‰`);
          }

          setStatus(`ğŸ”„ ä½¿ç”¨ ${kdfName} æ´¾ç”Ÿé‡‘é‘°ä¸­...`, 'loading', kdfName);

          // è§£ç¢¼å¿…è¦çš„è³‡æ–™
          const salt = base64UrlDecode(params.keyDerivation.salt);
          const iv = base64UrlDecode(params.encryption.iv);
          const ciphertext = base64UrlDecode(params.encryption.ciphertext);
          const tag = base64UrlDecode(params.encryption.tag);

          // æ ¹æ“š KDF é¡å‹æ´¾ç”Ÿé‡‘é‘°
          let key;
          if (kdfName === 'Argon2id') {
            key = await deriveKeyArgon2(
              password,
              salt,
              params.keyDerivation.iterations,
              params.keyDerivation.memory,
              params.keyDerivation.parallelism
            );
          } else if (kdfName === 'PBKDF2') {
            key = await deriveKeyPBKDF2(password, salt, params.keyDerivation.iterations);
          }

          setStatus(`ğŸ”„ åŸ·è¡Œ AES-GCM è§£å¯†ä¸­...`, 'loading', kdfName);

          // å»ºæ§‹ AADï¼ˆå¦‚æœæ˜¯ç‰ˆæœ¬ 2ï¼‰
          let aad = null;
          if (params.version === 2) {
            aad = buildAAD(params);
          }

          // å˜—è©¦è§£å¯†
          let decryptedData;
          try {
            decryptedData = await decryptAESGCM(key, iv, ciphertext, tag, aad);
          } catch (decryptError) {
            // å¦‚æœä¸æ˜¯ç‰ˆæœ¬ 2ï¼Œå˜—è©¦ä¸ä½¿ç”¨ AAD
            if (params.version !== 2) {
              try {
                decryptedData = await decryptAESGCM(key, iv, ciphertext, tag, null);
              } catch (retryError) {
                throw new Error('å¯†ç¢¼éŒ¯èª¤æˆ–åŠ å¯†è³‡æ–™å·²ææ¯€');
              }
            } else {
              throw new Error('å¯†ç¢¼éŒ¯èª¤æˆ–åŠ å¯†è³‡æ–™å·²ææ¯€');
            }
          }

          // è½‰æ›ç‚ºæ–‡å­—
          const plaintext = new TextDecoder().decode(decryptedData);

          setStatus('âœ… è§£å¯†æˆåŠŸï¼', 'success', kdfName);
          setResult(plaintext, 'success');
        } catch (error) {
          console.error('è§£å¯†éŒ¯èª¤ï¼š', error);
          setStatus('âŒ è§£å¯†å¤±æ•—ï¼š' + error.message, 'error');
          setResult('', '');
        }
      }

      // å…è¨±æŒ‰ Enter éµåŸ·è¡Œè§£å¯†
      document.getElementById('password').addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
          decrypt();
        }
      });
    </script>
  </body>
</html>
