<!doctype html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>AES-GCM 解密工具 v2</title>
        <script
            src="https://cdn.jsdelivr.net/npm/argon2-browser@1.18.0/dist/argon2-bundled.min.js"
            onerror="this.remove(); document.getElementById('backup-argon2-script').style.display='block';"
        ></script>
        <script
            id="backup-argon2-script"
            style="display: none"
            src="https://unpkg.com/argon2-browser@1.18.0/dist/argon2-bundled.min.js"
        ></script>
        <style>
            body {
                font-family: sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                margin: 0;
                padding: 20px;
            }

            * {
                box-sizing: border-box;
            }

            .container {
                background: #fff;
                padding: 30px;
                border-radius: 15px;
                width: 100%;
                max-width: 900px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            }

            .header {
                text-align: center;
                margin-bottom: 25px;
            }

            .header h1 {
                margin: 0;
                color: #333;
                font-size: 28px;
            }

            .subtitle {
                color: #666;
                margin-top: 8px;
                font-size: 14px;
            }

            .group {
                margin-bottom: 15px;
            }

            label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #333;
            }

            textarea,
            input {
                width: 100%;
                padding: 12px;
                border: 2px solid #e1e5e9;
                border-radius: 8px;
                font-family: "Consolas", "Monaco", monospace;
                font-size: 13px;
                transition: border-color 0.3s ease;
            }

            textarea:focus,
            input:focus {
                outline: none;
                border-color: #667eea;
            }

            textarea {
                min-height: 120px;
                resize: vertical;
            }

            .decrypt-btn {
                width: 100%;
                padding: 15px;
                margin-top: 20px;
                border: none;
                border-radius: 8px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: #fff;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: transform 0.2s ease;
            }

            .decrypt-btn:hover {
                transform: translateY(-2px);
            }

            .decrypt-btn:active {
                transform: translateY(0);
            }

            .results {
                margin-top: 25px;
            }

            .result-box {
                background: #f8f9fa;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                padding: 15px;
                word-wrap: break-word;
                max-height: 300px;
                overflow: auto;
                font-family: "Consolas", "Monaco", monospace;
                font-size: 13px;
                white-space: pre-wrap;
            }

            .success {
                border-color: #28a745;
                background: #d4edda;
                color: #155724;
            }

            .error {
                border-color: #dc3545;
                background: #f8d7da;
                color: #721c24;
            }

            .status {
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 15px;
                font-weight: 600;
                text-align: center;
            }

            .loading {
                animation: pulse 1.5s infinite;
            }

            .kdf-indicator {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
                margin-left: 10px;
            }

            .kdf-argon2 {
                background: #e3f2fd;
                color: #1565c0;
            }

            .kdf-pbkdf2 {
                background: #f3e5f5;
                color: #7b1fa2;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            .info-box {
                background: #e7f3ff;
                border: 1px solid #b3d9ff;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 20px;
                font-size: 14px;
                color: #0066cc;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>🔓 AES-GCM 解密工具 v2</h1>
                <div class="subtitle">自動偵測 Argon2id 或 PBKDF2 金鑰派生函數</div>
            </div>

            <div class="info-box">
                💡 本工具會自動偵測您的加密資料使用的金鑰派生函數，支援 Argon2id 和 PBKDF2 兩種演算法。
            </div>

            <div class="group">
                <label for="ciphertext">加密資料：</label>
                <textarea id="ciphertext" placeholder="請貼上您的 Base64 編碼加密資料..." rows="8"></textarea>
            </div>

            <div class="group">
                <label for="password">密碼短語：</label>
                <input id="password" type="password" placeholder="請輸入解密密碼..." />
            </div>

            <button class="decrypt-btn" onclick="decrypt()">🔓 開始解密</button>

            <div class="results">
                <div id="status"></div>
                <div id="result"></div>
            </div>
        </div>

        <script>
            function setStatus(message, type, kdfType = null) {
                const statusEl = document.getElementById("status");
                statusEl.className = "status " + type;
                let displayMessage = message;

                if (kdfType) {
                    displayMessage += `<span class="kdf-indicator kdf-${kdfType.toLowerCase()}">${kdfType}</span>`;
                }

                statusEl.innerHTML = displayMessage;
            }

            function setResult(content, type) {
                const resultEl = document.getElementById("result");
                resultEl.className = "result-box " + type;
                resultEl.textContent = content;
                resultEl.style.display = content ? "block" : "none";
            }

            function base64UrlDecode(str) {
                // 處理 base64url 和標準 base64 格式
                str = str.replace(/-/g, "+").replace(/_/g, "/");

                // 補齊 padding
                while (str.length % 4) {
                    str += "=";
                }

                const binaryString = atob(str);
                const bytes = new Uint8Array(binaryString.length);

                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                return bytes;
            }

            function buildAAD(params) {
                const aadObj = {
                    version: params.version,
                };

                // 建構 keyDerivation 物件
                const keyDerivation = {
                    name: params.keyDerivation.name,
                };

                // 根據不同的 KDF 加入相應參數
                if (params.keyDerivation.name === "Argon2id") {
                    keyDerivation.iterations = params.keyDerivation.iterations;
                    keyDerivation.memory = params.keyDerivation.memory;
                    keyDerivation.parallelism = params.keyDerivation.parallelism;
                } else if (params.keyDerivation.name === "PBKDF2") {
                    keyDerivation.iterations = params.keyDerivation.iterations;
                    if (params.keyDerivation.hash) {
                        keyDerivation.hash = params.keyDerivation.hash;
                    }
                }

                aadObj.keyDerivation = keyDerivation;
                aadObj.encryptionName = params.encryption.name;

                return new TextEncoder().encode(JSON.stringify(aadObj));
            }

            async function deriveKeyArgon2(passphrase, salt, iterations, memory, parallelism) {
                if (typeof argon2 === "undefined") {
                    throw new Error("Argon2 庫載入失敗，無法使用 Argon2id 解密");
                }

                const result = await argon2.hash({
                    pass: passphrase,
                    salt: salt,
                    time: iterations,
                    mem: memory,
                    parallelism: parallelism,
                    hashLen: 32,
                    type: argon2.ArgonType.Argon2id,
                });

                return result.hash;
            }

            async function deriveKeyPBKDF2(passphrase, salt, iterations) {
                const encoder = new TextEncoder();
                const keyMaterial = await crypto.subtle.importKey(
                    "raw",
                    encoder.encode(passphrase),
                    { name: "PBKDF2" },
                    false,
                    ["deriveBits"]
                );

                const derivedBits = await crypto.subtle.deriveBits(
                    {
                        name: "PBKDF2",
                        salt: salt,
                        iterations: iterations,
                        hash: "SHA-256",
                    },
                    keyMaterial,
                    256
                );

                return new Uint8Array(derivedBits);
            }

            async function decryptAESGCM(key, iv, ciphertext, tag, aad) {
                const cryptoKey = await crypto.subtle.importKey("raw", key, { name: "AES-GCM" }, false, ["decrypt"]);

                // 組合 ciphertext 和 tag
                const combinedData = new Uint8Array(ciphertext.length + tag.length);
                combinedData.set(ciphertext);
                combinedData.set(tag, ciphertext.length);

                const decryptedBuffer = await crypto.subtle.decrypt(
                    {
                        name: "AES-GCM",
                        iv: iv,
                        additionalData: aad,
                        tagLength: 128,
                    },
                    cryptoKey,
                    combinedData
                );

                return new Uint8Array(decryptedBuffer);
            }

            async function decrypt() {
                const ciphertextInput = document.getElementById("ciphertext").value.trim();
                const password = document.getElementById("password").value;

                // 清空之前的結果
                setResult("", "");

                if (!ciphertextInput) {
                    setStatus("❌ 請輸入加密資料", "error");
                    return;
                }

                if (!password) {
                    setStatus("❌ 請輸入密碼短語", "error");
                    return;
                }

                setStatus("🔄 解析加密資料中...", "loading");

                try {
                    // 解碼 Base64 資料
                    const decodedData = base64UrlDecode(ciphertextInput);
                    const jsonString = new TextDecoder().decode(decodedData);
                    const params = JSON.parse(jsonString);

                    // 檢查支援的演算法
                    if (params.encryption.name !== "AES-GCM") {
                        throw new Error("不支援的加密演算法：" + params.encryption.name);
                    }

                    const kdfName = params.keyDerivation.name;
                    if (!["Argon2id", "PBKDF2"].includes(kdfName)) {
                        throw new Error(`不支援的金鑰派生函數：${kdfName}（僅支援 Argon2id 和 PBKDF2）`);
                    }

                    setStatus(`🔄 使用 ${kdfName} 派生金鑰中...`, "loading", kdfName);

                    // 解碼必要的資料
                    const salt = base64UrlDecode(params.keyDerivation.salt);
                    const iv = base64UrlDecode(params.encryption.iv);
                    const ciphertext = base64UrlDecode(params.encryption.ciphertext);
                    const tag = base64UrlDecode(params.encryption.tag);

                    // 根據 KDF 類型派生金鑰
                    let key;
                    if (kdfName === "Argon2id") {
                        key = await deriveKeyArgon2(
                            password,
                            salt,
                            params.keyDerivation.iterations,
                            params.keyDerivation.memory,
                            params.keyDerivation.parallelism
                        );
                    } else if (kdfName === "PBKDF2") {
                        key = await deriveKeyPBKDF2(password, salt, params.keyDerivation.iterations);
                    }

                    setStatus(`🔄 執行 AES-GCM 解密中...`, "loading", kdfName);

                    // 建構 AAD（如果是版本 2）
                    let aad = null;
                    if (params.version === 2) {
                        aad = buildAAD(params);
                    }

                    // 嘗試解密
                    let decryptedData;
                    try {
                        decryptedData = await decryptAESGCM(key, iv, ciphertext, tag, aad);
                    } catch (decryptError) {
                        // 如果不是版本 2，嘗試不使用 AAD
                        if (params.version !== 2) {
                            try {
                                decryptedData = await decryptAESGCM(key, iv, ciphertext, tag, null);
                            } catch (retryError) {
                                throw new Error("密碼錯誤或加密資料已損毀");
                            }
                        } else {
                            throw new Error("密碼錯誤或加密資料已損毀");
                        }
                    }

                    // 轉換為文字
                    const plaintext = new TextDecoder().decode(decryptedData);

                    setStatus("✅ 解密成功！", "success", kdfName);
                    setResult(plaintext, "success");
                } catch (error) {
                    console.error("解密錯誤：", error);
                    setStatus("❌ 解密失敗：" + error.message, "error");
                    setResult("", "");
                }
            }

            // 允許按 Enter 鍵執行解密
            document.getElementById("password").addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                    decrypt();
                }
            });
        </script>
    </body>
</html>
