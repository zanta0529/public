(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const d={appModeSelector:document.getElementById("appModeSelector"),textModeSection:document.getElementById("text-mode-section"),fileModeSection:document.getElementById("file-mode-section"),modeSelector:document.getElementById("modeSelector"),encryptSection:document.getElementById("encrypt-section"),decryptSection:document.getElementById("decrypt-section"),mnemonic:document.getElementById("mnemonic"),ciphertextInput:document.getElementById("ciphertext-input"),passphraseEncrypt:document.getElementById("passphrase-encrypt"),passphraseDecrypt:document.getElementById("passphrase-decrypt"),algoSelectionGroup:document.getElementById("algoSelectionGroup"),kdfSelectionGroup:document.getElementById("kdfSelectionGroup"),argon2ParamsSection:document.querySelector('.kdf-params-section[data-kdf="Argon2id"]'),pbkdf2ParamsSection:document.querySelector('.kdf-params-section[data-kdf="PBKDF2"]'),argon2Memory:document.getElementById("argon2-memory"),argon2Iterations:document.getElementById("argon2-iterations"),argon2Parallelism:document.getElementById("argon2-parallelism"),pbkdf2ParamsSection:document.getElementById("pbkdf2-params-section"),pbkdf2Iterations:document.getElementById("pbkdf2-iterations"),encryptBtn:document.getElementById("encryptBtn"),encryptBtn:document.getElementById("encryptBtn"),decryptBtn:document.getElementById("decryptBtn"),parseBtn:document.getElementById("parseBtn"),benchmarkBtn:document.getElementById("benchmarkBtn"),benchmarkStatus:document.getElementById("benchmarkStatus"),selfVerifyCheckbox:document.getElementById("self-verify-checkbox"),selfVerifyFileCheckbox:document.getElementById("self-verify-file-checkbox"),passwordStrengthBarEncrypt:document.getElementById("password-strength-bar-encrypt"),passwordStrengthTextEncrypt:document.getElementById("password-strength-text-encrypt"),passwordStrengthBarFile:document.getElementById("password-strength-bar-file"),passwordStrengthTextFile:document.getElementById("password-strength-text-file"),fileEncryptInput:document.getElementById("file-encrypt-input"),fileEncryptInfo:document.getElementById("file-encrypt-info"),passphraseFileEncrypt:document.getElementById("passphrase-file-encrypt"),encryptFileBtn:document.getElementById("encryptFileBtn"),fileDecryptInput:document.getElementById("file-decrypt-input"),fileDecryptInfo:document.getElementById("file-decrypt-info"),passphraseFileDecrypt:document.getElementById("passphrase-file-decrypt"),decryptFileBtn:document.getElementById("decryptFileBtn"),pasteBtn:document.getElementById("pasteBtn"),resetBtn:document.getElementById("resetBtn"),resultsArea:document.getElementById("results-area"),textModeResults:document.getElementById("text-mode-results"),output:document.getElementById("output"),copyBtn:document.getElementById("copyBtn"),downloadBtn:document.getElementById("downloadBtn"),qrCanvas:document.getElementById("qrCanvas"),jsonView:document.getElementById("jsonView"),base64ResultView:document.getElementById("base64ResultView"),paramsDisplayArea:document.getElementById("params-display-area"),passwordToggles:document.querySelectorAll(".toggle-password-icon"),decryptionActions:document.getElementById("decryption-actions"),copyDecryptedBtn:document.getElementById("copyDecryptedBtn"),themeToggleBtn:document.getElementById("themeToggleBtn"),currentYear:document.getElementById("currentYear"),toast:document.getElementById("toast"),scrollTopBtn:document.getElementById("scroll-to-top"),accordionContainer:document.querySelector(".accordion")},K={currentAppMode:null,currentMode:null,selectedAlgorithm:null,selectedKDF:null,toastTimer:null,lastEncryptedOutput:null,lastDecryptedText:null,fileToEncrypt:null,fileToDecrypt:null},T={VERSION:4,SALT_BYTES:16,NONCE_BYTES:12,KEY_LENGTH_BITS:256,PBKDF2_ITERATIONS:2e6,QR_CODE_MAX_BYTES:2953,FILE_SIZE_LIMIT_BYTES:10*1024*1024,ARGON2_MIN_MEM_MB:128,ARGON2_MIN_ITER:4,ARGON2_MIN_PARALLELISM:1,ARGON2_MIN_TIME:1,ARGON2_MIN_PARA:4,SVG_EYE_OPEN:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>',SVG_EYE_SLASH:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7.029 7.029 0 0 0 2.79-.588zM5.21 3.088A7.028 7.028 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474L5.21 3.089z"/><path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829l-2.83-2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12-.708.708z"/></svg>',MODE_TEXT:"text",MODE_FILE:"file",OP_ENCRYPT:"encrypt",OP_DECRYPT:"decrypt",ALGO_AES_GCM:"A256GCM",ALGO_CHACHA:"ChaCha20-Poly1305",KDF_ARGON2:"Argon2id",KDF_PBKDF2:"PBKDF2",HASH_SHA256:"SHA-256",DOWNLOAD_FILENAME_SUFFIX:".jwe"},N={copyFromResult(){K.lastEncryptedOutput&&navigator.clipboard.writeText(K.lastEncryptedOutput).then(()=>this.showToast("✅ 已複製 JWE 密文！"),()=>this.showToast("❌ 複製失敗"))},copyDecryptedResult(){K.lastDecryptedText&&navigator.clipboard.writeText(K.lastDecryptedText).then(()=>this.showToast("✅ 已複製解密結果！"),()=>this.showToast("❌ 複製失敗"))},pasteTo(e){navigator.clipboard.readText().then(t=>{d[e].value=t,this.showToast("✅ 已貼上內容！")},()=>this.showToast("❌ 貼上失敗"))},downloadAsFile(e,t){const n=e instanceof Blob?e:new Blob([e],{type:"application/json"}),r=URL.createObjectURL(n),o=document.createElement("a");o.href=r,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r)},showToast(e){K.toastTimer&&clearTimeout(K.toastTimer),d.toast.textContent=e,d.toast.className="show",K.toastTimer=setTimeout(()=>{d.toast.className="",K.toastTimer=null},3e3)},async checkArgon2Ready(){return typeof argon2<"u"?!0:new Promise(e=>{setTimeout(()=>{typeof argon2<"u"?e(!0):(this.showToast("❌ Argon2 函式庫載入失敗！","error"),e(!1))},1e3)})},runSecurityChecks(e,t){if(this.checkPasswordStrength(e).level==="weak"&&this.showToast("⚠️ 警告：密碼強度較弱，建議使用更複雜的密碼。"),t===T.KDF_ARGON2){const r=parseInt(d.argon2Memory.value,10),o=parseInt(d.argon2Iterations.value,10),i=parseInt(d.argon2Parallelism.value,10);if(r<T.ARGON2_MIN_MEM_MB||o<T.ARGON2_MIN_ITER||i<T.ARGON2_MIN_PARA)return this.showToast("❌ 安全性警告：Argon2 參數過低！"),!1}return!0},checkPasswordStrength(e){let t=0,n="",r="empty";return e.length===0?{score:0,message:"",level:"empty"}:(e.length>=8&&(t+=25),e.length>=12&&(t+=25),/[a-z]/.test(e)&&/[A-Z]/.test(e)&&(t+=20),/\d/.test(e)&&(t+=15),/[^a-zA-Z0-9]/.test(e)&&(t+=15),t=Math.min(t,100),t<50?(n="強度：弱",r="weak"):t<85?(n="強度：中等",r="medium"):(n="強度：強",r="strong"),{score:t,message:n,level:r})}},L={setAppMode(e){K.currentAppMode=e;const t=e===T.MODE_TEXT;this.handleOptionSelection({target:d.appModeSelector.querySelector(`[data-app-mode="${e}"]`)}),d.textModeSection.hidden=!t,d.fileModeSection.hidden=t,this.setMode(T.OP_ENCRYPT)},setMode(e){this.resetAll(),K.currentMode=e;const t=e===T.OP_ENCRYPT;this.handleOptionSelection({target:d.modeSelector.querySelector(`[data-mode="${e}"]`)}),d.encryptSection.hidden=!t,d.decryptSection.hidden=t,d.pasteBtn.hidden=t},handleOptionSelection(e,t){const n=e.target.closest(".option");return n&&!n.classList.contains("selected")&&!n.style.cursor.includes("not-allowed")?(n.parentElement.querySelector(".selected")?.classList.remove("selected"),n.classList.add("selected"),t&&(K[t]=n.dataset.value),!0):!1},toggleKdfParams(e){document.querySelectorAll(".kdf-params-section").forEach(t=>{t.hidden=t.dataset.kdf!==e})},setOutput(e,t){d.resultsArea.hidden=!1,d.output.className=`output-box ${e}`;let n=t;if(e==="success"&&K.currentMode===T.OP_DECRYPT){if(t.startsWith("✅ 檔案解密成功！")){const r=t.split("(");n=`${r[0]}<br>✅ <strong>檔案完整性驗證通過</strong><br>(${r[1]}`}else if(t.startsWith("✅ 解密成功")){const r=t.split("<br><br>");n=`${r[0]}<br>✅ <strong>檔案完整性驗證通過</strong><br><br>${r[1]}`}}d.output.innerHTML=n,d.textModeResults.hidden=!0,d.decryptionActions.hidden=!0,e==="success"&&K.currentAppMode===T.MODE_TEXT&&(K.currentMode===T.OP_ENCRYPT?d.textModeResults.hidden=!1:d.decryptionActions.hidden=!1)},resetAll(){if(["mnemonic","ciphertextInput","passphraseEncrypt","passphraseDecrypt","passphraseFileEncrypt","passphraseFileDecrypt"].forEach(t=>d[t]?d[t].value="":null),this.updatePasswordStrength("","encrypt"),this.updatePasswordStrength("","file"),d.fileEncryptInput.value="",d.fileDecryptInput.value="",K.fileToEncrypt=null,K.fileToDecrypt=null,d.fileEncryptInfo.hidden=!0,d.fileDecryptInfo.hidden=!0,d.resultsArea.hidden=!0,d.textModeResults.hidden=!0,d.decryptionActions.hidden=!0,d.paramsDisplayArea.hidden=!0,K.lastEncryptedOutput=null,K.lastDecryptedText=null,K.selectedAlgorithm=T.ALGO_AES_GCM,K.selectedKDF=T.KDF_ARGON2,this.handleOptionSelection({target:d.algoSelectionGroup.querySelector(`[data-value="${T.ALGO_AES_GCM}"]`)},"selectedAlgorithm"),this.handleOptionSelection({target:d.kdfSelectionGroup.querySelector(`[data-value="${T.KDF_ARGON2}"]`)},"selectedKDF"),this.toggleKdfParams(K.selectedKDF),d.qrCanvas){const t=d.qrCanvas.getContext("2d");t&&t.clearRect(0,0,d.qrCanvas.width,d.qrCanvas.height)}},togglePasswordVisibility(e){const t=document.getElementById(e.dataset.for);t.type==="password"?(t.type="text",e.innerHTML=T.SVG_EYE_SLASH):(t.type="password",e.innerHTML=T.SVG_EYE_OPEN)},updatePasswordStrength(e,t){const n=N.checkPasswordStrength(e),r=t==="encrypt"?d.passwordStrengthBarEncrypt:d.passwordStrengthBarFile,o=t==="encrypt"?d.passwordStrengthTextEncrypt:d.passwordStrengthTextFile;r.className="password-strength-meter-bar",n.level!=="empty"&&r.classList.add(`strength-${n.level}`),r.style.width=n.score+"%",o.textContent=n.message}},Ae={handleFileSelect(e,t){const n=e.target.files[0];if(!n)return;const r=d[`file${t.charAt(0).toUpperCase()+t.slice(1)}Info`];if(n.size>T.FILE_SIZE_LIMIT_BYTES){r.innerHTML=`<p style="color: var(--error-color);">❌ 檔案過大：${(n.size/1024/1024).toFixed(2)} MB</p>`,r.hidden=!1,K[t===T.OP_ENCRYPT?"fileToEncrypt":"fileToDecrypt"]=null;return}r.innerHTML=`檔案名稱: <span>${n.name}</span><br>檔案大小: <span>${(n.size/1024).toFixed(2)} KB</span>`,r.hidden=!1,K[t===T.OP_ENCRYPT?"fileToEncrypt":"fileToDecrypt"]=n},readFileAsArrayBuffer:e=>e.arrayBuffer(),readFileAsText:e=>e.text()},D=crypto,G=e=>e instanceof CryptoKey,Sn=async(e,t)=>{const n=`SHA-${e.slice(-3)}`;return new Uint8Array(await D.subtle.digest(n,t))},k=new TextEncoder,fe=new TextDecoder,Se=2**32;function j(...e){const t=e.reduce((o,{length:i})=>o+i,0),n=new Uint8Array(t);let r=0;for(const o of e)n.set(o,r),r+=o.length;return n}function Cn(e,t){return j(k.encode(e),new Uint8Array([0]),t)}function tt(e,t,n){if(t<0||t>=Se)throw new RangeError(`value must be >= 0 and <= ${Se-1}. Received ${t}`);e.set([t>>>24,t>>>16,t>>>8,t&255],n)}function Gt(e){const t=Math.floor(e/Se),n=e%Se,r=new Uint8Array(8);return tt(r,t,0),tt(r,n,4),r}function it(e){const t=new Uint8Array(4);return tt(t,e),t}function Ke(e){return j(it(e.length),e)}async function bn(e,t,n){const r=Math.ceil((t>>3)/32),o=new Uint8Array(r*32);for(let i=0;i<r;i++){const s=new Uint8Array(4+e.length+n.length);s.set(it(i+1)),s.set(e,4),s.set(n,4+e.length),o.set(await Sn("sha256",s),i*32)}return o.slice(0,t>>3)}const Tn=e=>{let t=e;typeof t=="string"&&(t=k.encode(t));const n=32768,r=[];for(let o=0;o<t.length;o+=n)r.push(String.fromCharCode.apply(null,t.subarray(o,o+n)));return btoa(r.join(""))},$=e=>Tn(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),In=e=>{const t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return n},W=e=>{let t=e;t instanceof Uint8Array&&(t=fe.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return In(t)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}};class U extends Error{constructor(t,n){super(t,n),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}}U.code="ERR_JOSE_GENERIC";class Bn extends U{constructor(t,n,r="unspecified",o="unspecified"){super(t,{cause:{claim:r,reason:o,payload:n}}),this.code="ERR_JWT_CLAIM_VALIDATION_FAILED",this.claim=r,this.reason=o,this.payload=n}}Bn.code="ERR_JWT_CLAIM_VALIDATION_FAILED";class _n extends U{constructor(t,n,r="unspecified",o="unspecified"){super(t,{cause:{claim:r,reason:o,payload:n}}),this.code="ERR_JWT_EXPIRED",this.claim=r,this.reason=o,this.payload=n}}_n.code="ERR_JWT_EXPIRED";class qt extends U{constructor(){super(...arguments),this.code="ERR_JOSE_ALG_NOT_ALLOWED"}}qt.code="ERR_JOSE_ALG_NOT_ALLOWED";class H extends U{constructor(){super(...arguments),this.code="ERR_JOSE_NOT_SUPPORTED"}}H.code="ERR_JOSE_NOT_SUPPORTED";class Ce extends U{constructor(t="decryption operation failed",n){super(t,n),this.code="ERR_JWE_DECRYPTION_FAILED"}}Ce.code="ERR_JWE_DECRYPTION_FAILED";class w extends U{constructor(){super(...arguments),this.code="ERR_JWE_INVALID"}}w.code="ERR_JWE_INVALID";class Pn extends U{constructor(){super(...arguments),this.code="ERR_JWS_INVALID"}}Pn.code="ERR_JWS_INVALID";class Rn extends U{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}}Rn.code="ERR_JWT_INVALID";class vn extends U{constructor(){super(...arguments),this.code="ERR_JWK_INVALID"}}vn.code="ERR_JWK_INVALID";class Kn extends U{constructor(){super(...arguments),this.code="ERR_JWKS_INVALID"}}Kn.code="ERR_JWKS_INVALID";class Mn extends U{constructor(t="no applicable key found in the JSON Web Key Set",n){super(t,n),this.code="ERR_JWKS_NO_MATCHING_KEY"}}Mn.code="ERR_JWKS_NO_MATCHING_KEY";class Dn extends U{constructor(t="multiple matching keys found in the JSON Web Key Set",n){super(t,n),this.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS"}}Dn.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";class On extends U{constructor(t="request timed out",n){super(t,n),this.code="ERR_JWKS_TIMEOUT"}}On.code="ERR_JWKS_TIMEOUT";class Ln extends U{constructor(t="signature verification failed",n){super(t,n),this.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED"}}Ln.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";const st=D.getRandomValues.bind(D);function kt(e){switch(e){case"A128GCM":case"A128GCMKW":case"A192GCM":case"A192GCMKW":case"A256GCM":case"A256GCMKW":return 96;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return 128;default:throw new H(`Unsupported JWE Algorithm: ${e}`)}}const Nn=e=>st(new Uint8Array(kt(e)>>3)),Vt=(e,t)=>{if(t.length<<3!==kt(e))throw new w("Invalid Initialization Vector length")},be=(e,t)=>{const n=e.byteLength<<3;if(n!==t)throw new w(`Invalid Content Encryption Key length. Expected ${t} bits, got ${n} bits`)},Hn=(e,t)=>{if(!(e instanceof Uint8Array))throw new TypeError("First argument must be a buffer");if(!(t instanceof Uint8Array))throw new TypeError("Second argument must be a buffer");if(e.length!==t.length)throw new TypeError("Input buffers must have the same length");const n=e.length;let r=0,o=-1;for(;++o<n;)r|=e[o]^t[o];return r===0};function X(e,t="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function ge(e,t){return e.name===t}function Fn(e){return parseInt(e.name.slice(4),10)}function Wn(e,t){if(t.length&&!t.some(n=>e.usages.includes(n))){let n="CryptoKey does not support this operation, its usages must include ";if(t.length>2){const r=t.pop();n+=`one of ${t.join(", ")}, or ${r}.`}else t.length===2?n+=`one of ${t[0]} or ${t[1]}.`:n+=`${t[0]}.`;throw new TypeError(n)}}function Z(e,t,...n){switch(t){case"A128GCM":case"A192GCM":case"A256GCM":{if(!ge(e.algorithm,"AES-GCM"))throw X("AES-GCM");const r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw X(r,"algorithm.length");break}case"A128KW":case"A192KW":case"A256KW":{if(!ge(e.algorithm,"AES-KW"))throw X("AES-KW");const r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw X(r,"algorithm.length");break}case"ECDH":{switch(e.algorithm.name){case"ECDH":case"X25519":case"X448":break;default:throw X("ECDH, X25519, or X448")}break}case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":if(!ge(e.algorithm,"PBKDF2"))throw X("PBKDF2");break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":{if(!ge(e.algorithm,"RSA-OAEP"))throw X("RSA-OAEP");const r=parseInt(t.slice(9),10)||1;if(Fn(e.algorithm.hash)!==r)throw X(`SHA-${r}`,"algorithm.hash");break}default:throw new TypeError("CryptoKey does not support this operation")}Wn(e,n)}function zt(e,t,...n){if(n=n.filter(Boolean),n.length>2){const r=n.pop();e+=`one of type ${n.join(", ")}, or ${r}.`}else n.length===2?e+=`one of type ${n[0]} or ${n[1]}.`:e+=`of type ${n[0]}.`;return t==null?e+=` Received ${t}`:typeof t=="function"&&t.name?e+=` Received function ${t.name}`:typeof t=="object"&&t!=null&&t.constructor?.name&&(e+=` Received an instance of ${t.constructor.name}`),e}const J=(e,...t)=>zt("Key must be ",e,...t);function Yt(e,t,...n){return zt(`Key for the ${e} algorithm must be `,t,...n)}const Xt=e=>G(e)?!0:e?.[Symbol.toStringTag]==="KeyObject",x=["CryptoKey"];async function Un(e,t,n,r,o,i){if(!(t instanceof Uint8Array))throw new TypeError(J(t,"Uint8Array"));const s=parseInt(e.slice(1,4),10),c=await D.subtle.importKey("raw",t.subarray(s>>3),"AES-CBC",!1,["decrypt"]),a=await D.subtle.importKey("raw",t.subarray(0,s>>3),{hash:`SHA-${s<<1}`,name:"HMAC"},!1,["sign"]),u=j(i,r,n,Gt(i.length<<3)),l=new Uint8Array((await D.subtle.sign("HMAC",a,u)).slice(0,s>>3));let g;try{g=Hn(o,l)}catch{}if(!g)throw new Ce;let h;try{h=new Uint8Array(await D.subtle.decrypt({iv:r,name:"AES-CBC"},c,n))}catch{}if(!h)throw new Ce;return h}async function Jn(e,t,n,r,o,i){let s;t instanceof Uint8Array?s=await D.subtle.importKey("raw",t,"AES-GCM",!1,["decrypt"]):(Z(t,e,"decrypt"),s=t);try{return new Uint8Array(await D.subtle.decrypt({additionalData:i,iv:r,name:"AES-GCM",tagLength:128},s,j(n,o)))}catch{throw new Ce}}const Qt=async(e,t,n,r,o,i)=>{if(!G(t)&&!(t instanceof Uint8Array))throw new TypeError(J(t,...x,"Uint8Array"));if(!r)throw new w("JWE Initialization Vector missing");if(!o)throw new w("JWE Authentication Tag missing");switch(Vt(e,r),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return t instanceof Uint8Array&&be(t,parseInt(e.slice(-3),10)),Un(e,t,n,r,o,i);case"A128GCM":case"A192GCM":case"A256GCM":return t instanceof Uint8Array&&be(t,parseInt(e.slice(1,4),10)),Jn(e,t,n,r,o,i);default:throw new H("Unsupported JWE Content Encryption Algorithm")}},Zt=(...e)=>{const t=e.filter(Boolean);if(t.length===0||t.length===1)return!0;let n;for(const r of t){const o=Object.keys(r);if(!n||n.size===0){n=new Set(o);continue}for(const i of o){if(n.has(i))return!1;n.add(i)}}return!0};function xn(e){return typeof e=="object"&&e!==null}function ee(e){if(!xn(e)||Object.prototype.toString.call(e)!=="[object Object]")return!1;if(Object.getPrototypeOf(e)===null)return!0;let t=e;for(;Object.getPrototypeOf(t)!==null;)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}const Be=[{hash:"SHA-256",name:"HMAC"},!0,["sign"]];function jt(e,t){if(e.algorithm.length!==parseInt(t.slice(1,4),10))throw new TypeError(`Invalid key size for alg: ${t}`)}function en(e,t,n){if(G(e))return Z(e,t,n),e;if(e instanceof Uint8Array)return D.subtle.importKey("raw",e,"AES-KW",!0,[n]);throw new TypeError(J(e,...x,"Uint8Array"))}const nt=async(e,t,n)=>{const r=await en(t,e,"wrapKey");jt(r,e);const o=await D.subtle.importKey("raw",n,...Be);return new Uint8Array(await D.subtle.wrapKey("raw",o,r,"AES-KW"))},rt=async(e,t,n)=>{const r=await en(t,e,"unwrapKey");jt(r,e);const o=await D.subtle.unwrapKey("raw",n,r,"AES-KW",...Be);return new Uint8Array(await D.subtle.exportKey("raw",o))};async function tn(e,t,n,r,o=new Uint8Array(0),i=new Uint8Array(0)){if(!G(e))throw new TypeError(J(e,...x));if(Z(e,"ECDH"),!G(t))throw new TypeError(J(t,...x));Z(t,"ECDH","deriveBits");const s=j(Ke(k.encode(n)),Ke(o),Ke(i),it(r));let c;e.algorithm.name==="X25519"?c=256:e.algorithm.name==="X448"?c=448:c=Math.ceil(parseInt(e.algorithm.namedCurve.substr(-3),10)/8)<<3;const a=new Uint8Array(await D.subtle.deriveBits({name:e.algorithm.name,public:e},t,c));return bn(a,r,s)}async function $n(e){if(!G(e))throw new TypeError(J(e,...x));return D.subtle.generateKey(e.algorithm,!0,["deriveBits"])}function nn(e){if(!G(e))throw new TypeError(J(e,...x));return["P-256","P-384","P-521"].includes(e.algorithm.namedCurve)||e.algorithm.name==="X25519"||e.algorithm.name==="X448"}function Gn(e){if(!(e instanceof Uint8Array)||e.length<8)throw new w("PBES2 Salt Input must be 8 or more octets")}function qn(e,t){if(e instanceof Uint8Array)return D.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits"]);if(G(e))return Z(e,t,"deriveBits","deriveKey"),e;throw new TypeError(J(e,...x,"Uint8Array"))}async function rn(e,t,n,r){Gn(e);const o=Cn(t,e),i=parseInt(t.slice(13,16),10),s={hash:`SHA-${t.slice(8,11)}`,iterations:n,name:"PBKDF2",salt:o},c={length:i,name:"AES-KW"},a=await qn(r,t);if(a.usages.includes("deriveBits"))return new Uint8Array(await D.subtle.deriveBits(s,a,i));if(a.usages.includes("deriveKey"))return D.subtle.deriveKey(s,a,c,!1,["wrapKey","unwrapKey"]);throw new TypeError('PBKDF2 key "usages" must include "deriveBits" or "deriveKey"')}const kn=async(e,t,n,r=2048,o=st(new Uint8Array(16)))=>{const i=await rn(o,e,r,t);return{encryptedKey:await nt(e.slice(-6),i,n),p2c:r,p2s:$(o)}},Vn=async(e,t,n,r,o)=>{const i=await rn(o,e,r,t);return rt(e.slice(-6),i,n)};function Te(e){switch(e){case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":return"RSA-OAEP";default:throw new H(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}const on=(e,t)=>{if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:n}=t.algorithm;if(typeof n!="number"||n<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}},zn=async(e,t,n)=>{if(!G(t))throw new TypeError(J(t,...x));if(Z(t,e,"encrypt","wrapKey"),on(e,t),t.usages.includes("encrypt"))return new Uint8Array(await D.subtle.encrypt(Te(e),t,n));if(t.usages.includes("wrapKey")){const r=await D.subtle.importKey("raw",n,...Be);return new Uint8Array(await D.subtle.wrapKey("raw",r,t,Te(e)))}throw new TypeError('RSA-OAEP key "usages" must include "encrypt" or "wrapKey" for this operation')},Yn=async(e,t,n)=>{if(!G(t))throw new TypeError(J(t,...x));if(Z(t,e,"decrypt","unwrapKey"),on(e,t),t.usages.includes("decrypt"))return new Uint8Array(await D.subtle.decrypt(Te(e),t,n));if(t.usages.includes("unwrapKey")){const r=await D.subtle.unwrapKey("raw",n,t,Te(e),...Be);return new Uint8Array(await D.subtle.exportKey("raw",r))}throw new TypeError('RSA-OAEP key "usages" must include "decrypt" or "unwrapKey" for this operation')};function he(e){return ee(e)&&typeof e.kty=="string"}function Xn(e){return e.kty!=="oct"&&typeof e.d=="string"}function Qn(e){return e.kty!=="oct"&&typeof e.d>"u"}function Zn(e){return he(e)&&e.kty==="oct"&&typeof e.k=="string"}function jn(e){let t,n;switch(e.kty){case"RSA":{switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},n=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},n=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},n=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new H('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"EC":{switch(e.alg){case"ES256":t={name:"ECDSA",namedCurve:"P-256"},n=e.d?["sign"]:["verify"];break;case"ES384":t={name:"ECDSA",namedCurve:"P-384"},n=e.d?["sign"]:["verify"];break;case"ES512":t={name:"ECDSA",namedCurve:"P-521"},n=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},n=e.d?["deriveBits"]:[];break;default:throw new H('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"OKP":{switch(e.alg){case"Ed25519":t={name:"Ed25519"},n=e.d?["sign"]:["verify"];break;case"EdDSA":t={name:e.crv},n=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:e.crv},n=e.d?["deriveBits"]:[];break;default:throw new H('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}default:throw new H('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:n}}const sn=async e=>{if(!e.alg)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');const{algorithm:t,keyUsages:n}=jn(e),r=[t,e.ext??!1,e.key_ops??n],o={...e};return delete o.alg,delete o.use,D.subtle.importKey("jwk",o,...r)},an=e=>W(e);let oe,ie;const cn=e=>e?.[Symbol.toStringTag]==="KeyObject",Ie=async(e,t,n,r,o=!1)=>{let i=e.get(t);if(i?.[r])return i[r];const s=await sn({...n,alg:r});return o&&Object.freeze(t),i?i[r]=s:e.set(t,{[r]:s}),s},er=(e,t)=>{if(cn(e)){let n=e.export({format:"jwk"});return delete n.d,delete n.dp,delete n.dq,delete n.p,delete n.q,delete n.qi,n.k?an(n.k):(ie||(ie=new WeakMap),Ie(ie,e,n,t))}return he(e)?e.k?W(e.k):(ie||(ie=new WeakMap),Ie(ie,e,e,t,!0)):e},tr=(e,t)=>{if(cn(e)){let n=e.export({format:"jwk"});return n.k?an(n.k):(oe||(oe=new WeakMap),Ie(oe,e,n,t))}return he(e)?e.k?W(e.k):(oe||(oe=new WeakMap),Ie(oe,e,e,t,!0)):e},dn={normalizePublicKey:er,normalizePrivateKey:tr};function at(e){switch(e){case"A128GCM":return 128;case"A192GCM":return 192;case"A256GCM":case"A128CBC-HS256":return 256;case"A192CBC-HS384":return 384;case"A256CBC-HS512":return 512;default:throw new H(`Unsupported JWE Algorithm: ${e}`)}}const ae=e=>st(new Uint8Array(at(e)>>3));async function nr(e,t){if(!ee(e))throw new TypeError("JWK must be an object");switch(t||(t=e.alg),e.kty){case"oct":if(typeof e.k!="string"||!e.k)throw new TypeError('missing "k" (Key Value) Parameter value');return W(e.k);case"RSA":if("oth"in e&&e.oth!==void 0)throw new H('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return sn({...e,alg:t});default:throw new H('Unsupported "kty" (Key Type) Parameter value')}}const ce=e=>e?.[Symbol.toStringTag],ot=(e,t,n)=>{if(t.use!==void 0&&t.use!=="sig")throw new TypeError("Invalid key for this operation, when present its use must be sig");if(t.key_ops!==void 0&&t.key_ops.includes?.(n)!==!0)throw new TypeError(`Invalid key for this operation, when present its key_ops must include ${n}`);if(t.alg!==void 0&&t.alg!==e)throw new TypeError(`Invalid key for this operation, when present its alg must be ${e}`);return!0},rr=(e,t,n,r)=>{if(!(t instanceof Uint8Array)){if(r&&he(t)){if(Zn(t)&&ot(e,t,n))return;throw new TypeError('JSON Web Key for symmetric algorithms must have JWK "kty" (Key Type) equal to "oct" and the JWK "k" (Key Value) present')}if(!Xt(t))throw new TypeError(Yt(e,t,...x,"Uint8Array",r?"JSON Web Key":null));if(t.type!=="secret")throw new TypeError(`${ce(t)} instances for symmetric algorithms must be of type "secret"`)}},or=(e,t,n,r)=>{if(r&&he(t))switch(n){case"sign":if(Xn(t)&&ot(e,t,n))return;throw new TypeError("JSON Web Key for this operation be a private JWK");case"verify":if(Qn(t)&&ot(e,t,n))return;throw new TypeError("JSON Web Key for this operation be a public JWK")}if(!Xt(t))throw new TypeError(Yt(e,t,...x,r?"JSON Web Key":null));if(t.type==="secret")throw new TypeError(`${ce(t)} instances for asymmetric algorithms must not be of type "secret"`);if(n==="sign"&&t.type==="public")throw new TypeError(`${ce(t)} instances for asymmetric algorithm signing must be of type "private"`);if(n==="decrypt"&&t.type==="public")throw new TypeError(`${ce(t)} instances for asymmetric algorithm decryption must be of type "private"`);if(t.algorithm&&n==="verify"&&t.type==="private")throw new TypeError(`${ce(t)} instances for asymmetric algorithm verifying must be of type "public"`);if(t.algorithm&&n==="encrypt"&&t.type==="private")throw new TypeError(`${ce(t)} instances for asymmetric algorithm encryption must be of type "public"`)};function un(e,t,n,r){t.startsWith("HS")||t==="dir"||t.startsWith("PBES2")||/^A\d{3}(?:GCM)?KW$/.test(t)?rr(t,n,r,e):or(t,n,r,e)}const ln=un.bind(void 0,!1);un.bind(void 0,!0);async function ir(e,t,n,r,o){if(!(n instanceof Uint8Array))throw new TypeError(J(n,"Uint8Array"));const i=parseInt(e.slice(1,4),10),s=await D.subtle.importKey("raw",n.subarray(i>>3),"AES-CBC",!1,["encrypt"]),c=await D.subtle.importKey("raw",n.subarray(0,i>>3),{hash:`SHA-${i<<1}`,name:"HMAC"},!1,["sign"]),a=new Uint8Array(await D.subtle.encrypt({iv:r,name:"AES-CBC"},s,t)),u=j(o,r,a,Gt(o.length<<3)),l=new Uint8Array((await D.subtle.sign("HMAC",c,u)).slice(0,i>>3));return{ciphertext:a,tag:l,iv:r}}async function sr(e,t,n,r,o){let i;n instanceof Uint8Array?i=await D.subtle.importKey("raw",n,"AES-GCM",!1,["encrypt"]):(Z(n,e,"encrypt"),i=n);const s=new Uint8Array(await D.subtle.encrypt({additionalData:o,iv:r,name:"AES-GCM",tagLength:128},i,t)),c=s.slice(-16);return{ciphertext:s.slice(0,-16),tag:c,iv:r}}const fn=async(e,t,n,r,o)=>{if(!G(n)&&!(n instanceof Uint8Array))throw new TypeError(J(n,...x,"Uint8Array"));switch(r?Vt(e,r):r=Nn(e),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return n instanceof Uint8Array&&be(n,parseInt(e.slice(-3),10)),ir(e,t,n,r,o);case"A128GCM":case"A192GCM":case"A256GCM":return n instanceof Uint8Array&&be(n,parseInt(e.slice(1,4),10)),sr(e,t,n,r,o);default:throw new H("Unsupported JWE Content Encryption Algorithm")}};async function ar(e,t,n,r){const o=e.slice(0,7),i=await fn(o,n,t,r,new Uint8Array(0));return{encryptedKey:i.ciphertext,iv:$(i.iv),tag:$(i.tag)}}async function cr(e,t,n,r,o){const i=e.slice(0,7);return Qt(i,t,n,r,o,new Uint8Array(0))}async function dr(e,t,n,r,o){switch(ln(e,t,"decrypt"),t=await dn.normalizePrivateKey?.(t,e)||t,e){case"dir":{if(n!==void 0)throw new w("Encountered unexpected JWE Encrypted Key");return t}case"ECDH-ES":if(n!==void 0)throw new w("Encountered unexpected JWE Encrypted Key");case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{if(!ee(r.epk))throw new w('JOSE Header "epk" (Ephemeral Public Key) missing or invalid');if(!nn(t))throw new H("ECDH with the provided key is not allowed or not supported by your javascript runtime");const i=await nr(r.epk,e);let s,c;if(r.apu!==void 0){if(typeof r.apu!="string")throw new w('JOSE Header "apu" (Agreement PartyUInfo) invalid');try{s=W(r.apu)}catch{throw new w("Failed to base64url decode the apu")}}if(r.apv!==void 0){if(typeof r.apv!="string")throw new w('JOSE Header "apv" (Agreement PartyVInfo) invalid');try{c=W(r.apv)}catch{throw new w("Failed to base64url decode the apv")}}const a=await tn(i,t,e==="ECDH-ES"?r.enc:e,e==="ECDH-ES"?at(r.enc):parseInt(e.slice(-5,-2),10),s,c);if(e==="ECDH-ES")return a;if(n===void 0)throw new w("JWE Encrypted Key missing");return rt(e.slice(-6),a,n)}case"RSA1_5":case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":{if(n===void 0)throw new w("JWE Encrypted Key missing");return Yn(e,t,n)}case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{if(n===void 0)throw new w("JWE Encrypted Key missing");if(typeof r.p2c!="number")throw new w('JOSE Header "p2c" (PBES2 Count) missing or invalid');if(r.p2c>1e4)throw new w('JOSE Header "p2c" (PBES2 Count) out is of acceptable bounds');if(typeof r.p2s!="string")throw new w('JOSE Header "p2s" (PBES2 Salt) missing or invalid');let s;try{s=W(r.p2s)}catch{throw new w("Failed to base64url decode the p2s")}return Vn(e,t,n,r.p2c,s)}case"A128KW":case"A192KW":case"A256KW":{if(n===void 0)throw new w("JWE Encrypted Key missing");return rt(e,t,n)}case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{if(n===void 0)throw new w("JWE Encrypted Key missing");if(typeof r.iv!="string")throw new w('JOSE Header "iv" (Initialization Vector) missing or invalid');if(typeof r.tag!="string")throw new w('JOSE Header "tag" (Authentication Tag) missing or invalid');let i;try{i=W(r.iv)}catch{throw new w("Failed to base64url decode the iv")}let s;try{s=W(r.tag)}catch{throw new w("Failed to base64url decode the tag")}return cr(e,t,n,i,s)}default:throw new H('Invalid or unsupported "alg" (JWE Algorithm) header value')}}function hn(e,t,n,r,o){if(o.crit!==void 0&&r?.crit===void 0)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!r||r.crit===void 0)return new Set;if(!Array.isArray(r.crit)||r.crit.length===0||r.crit.some(s=>typeof s!="string"||s.length===0))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let i;n!==void 0?i=new Map([...Object.entries(n),...t.entries()]):i=t;for(const s of r.crit){if(!i.has(s))throw new H(`Extension Header Parameter "${s}" is not recognized`);if(o[s]===void 0)throw new e(`Extension Header Parameter "${s}" is missing`);if(i.get(s)&&r[s]===void 0)throw new e(`Extension Header Parameter "${s}" MUST be integrity protected`)}return new Set(r.crit)}async function ur(e,t,n){if(!ee(e))throw new w("Flattened JWE must be an object");if(e.protected===void 0&&e.header===void 0&&e.unprotected===void 0)throw new w("JOSE Header missing");if(e.iv!==void 0&&typeof e.iv!="string")throw new w("JWE Initialization Vector incorrect type");if(typeof e.ciphertext!="string")throw new w("JWE Ciphertext missing or incorrect type");if(e.tag!==void 0&&typeof e.tag!="string")throw new w("JWE Authentication Tag incorrect type");if(e.protected!==void 0&&typeof e.protected!="string")throw new w("JWE Protected Header incorrect type");if(e.encrypted_key!==void 0&&typeof e.encrypted_key!="string")throw new w("JWE Encrypted Key incorrect type");if(e.aad!==void 0&&typeof e.aad!="string")throw new w("JWE AAD incorrect type");if(e.header!==void 0&&!ee(e.header))throw new w("JWE Shared Unprotected Header incorrect type");if(e.unprotected!==void 0&&!ee(e.unprotected))throw new w("JWE Per-Recipient Unprotected Header incorrect type");let r;if(e.protected)try{const E=W(e.protected);r=JSON.parse(fe.decode(E))}catch{throw new w("JWE Protected Header is invalid")}if(!Zt(r,e.header,e.unprotected))throw new w("JWE Protected, JWE Unprotected Header, and JWE Per-Recipient Unprotected Header Parameter names must be disjoint");const o={...r,...e.header,...e.unprotected};if(hn(w,new Map,n?.crit,r,o),o.zip!==void 0)throw new H('JWE "zip" (Compression Algorithm) Header Parameter is not supported.');const{alg:i,enc:s}=o;if(typeof i!="string"||!i)throw new w("missing JWE Algorithm (alg) in JWE Header");if(typeof s!="string"||!s)throw new w("missing JWE Encryption Algorithm (enc) in JWE Header");if(i.startsWith("PBES2"))throw new qt('"alg" (Algorithm) Header Parameter value not allowed');let c;if(e.encrypted_key!==void 0)try{c=W(e.encrypted_key)}catch{throw new w("Failed to base64url decode the encrypted_key")}let a=!1;typeof t=="function"&&(t=await t(r,e),a=!0);let u;try{u=await dr(i,t,c,o,n)}catch(E){if(E instanceof TypeError||E instanceof w||E instanceof H)throw E;u=ae(s)}let l,g;if(e.iv!==void 0)try{l=W(e.iv)}catch{throw new w("Failed to base64url decode the iv")}if(e.tag!==void 0)try{g=W(e.tag)}catch{throw new w("Failed to base64url decode the tag")}const h=k.encode(e.protected??"");let f;e.aad!==void 0?f=j(h,k.encode("."),k.encode(e.aad)):f=h;let y;try{y=W(e.ciphertext)}catch{throw new w("Failed to base64url decode the ciphertext")}const O={plaintext:await Qt(s,u,y,l,g,f)};if(e.protected!==void 0&&(O.protectedHeader=r),e.aad!==void 0)try{O.additionalAuthenticatedData=W(e.aad)}catch{throw new w("Failed to base64url decode the aad")}return e.unprotected!==void 0&&(O.sharedUnprotectedHeader=e.unprotected),e.header!==void 0&&(O.unprotectedHeader=e.header),a?{...O,key:t}:O}async function lr(e,t,n){if(e instanceof Uint8Array&&(e=fe.decode(e)),typeof e!="string")throw new w("Compact JWE must be a string or Uint8Array");const{0:r,1:o,2:i,3:s,4:c,length:a}=e.split(".");if(a!==5)throw new w("Invalid Compact JWE");const u=await ur({ciphertext:s,iv:i||void 0,protected:r,tag:c||void 0,encrypted_key:o||void 0},t,n),l={plaintext:u.plaintext,protectedHeader:u.protectedHeader};return typeof t=="function"?{...l,key:u.key}:l}const fr=Symbol(),hr=async e=>{if(e instanceof Uint8Array)return{kty:"oct",k:$(e)};if(!G(e))throw new TypeError(J(e,...x,"Uint8Array"));if(!e.extractable)throw new TypeError("non-extractable CryptoKey cannot be exported as a JWK");const{ext:t,key_ops:n,alg:r,use:o,...i}=await D.subtle.exportKey("jwk",e);return i};async function pr(e){return hr(e)}async function gr(e,t,n,r,o={}){let i,s,c;switch(ln(e,n,"encrypt"),n=await dn.normalizePublicKey?.(n,e)||n,e){case"dir":{c=n;break}case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{if(!nn(n))throw new H("ECDH with the provided key is not allowed or not supported by your javascript runtime");const{apu:a,apv:u}=o;let{epk:l}=o;l||(l=(await $n(n)).privateKey);const{x:g,y:h,crv:f,kty:y}=await pr(l),C=await tn(n,l,e==="ECDH-ES"?t:e,e==="ECDH-ES"?at(t):parseInt(e.slice(-5,-2),10),a,u);if(s={epk:{x:g,crv:f,kty:y}},y==="EC"&&(s.epk.y=h),a&&(s.apu=$(a)),u&&(s.apv=$(u)),e==="ECDH-ES"){c=C;break}c=r||ae(t);const O=e.slice(-6);i=await nt(O,C,c);break}case"RSA1_5":case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":{c=r||ae(t),i=await zn(e,n,c);break}case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{c=r||ae(t);const{p2c:a,p2s:u}=o;({encryptedKey:i,...s}=await kn(e,n,c,a,u));break}case"A128KW":case"A192KW":case"A256KW":{c=r||ae(t),i=await nt(e,n,c);break}case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{c=r||ae(t);const{iv:a}=o;({encryptedKey:i,...s}=await ar(e,n,c,a));break}default:throw new H('Invalid or unsupported "alg" (JWE Algorithm) header value')}return{cek:c,encryptedKey:i,parameters:s}}class yr{constructor(t){if(!(t instanceof Uint8Array))throw new TypeError("plaintext must be an instance of Uint8Array");this._plaintext=t}setKeyManagementParameters(t){if(this._keyManagementParameters)throw new TypeError("setKeyManagementParameters can only be called once");return this._keyManagementParameters=t,this}setProtectedHeader(t){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=t,this}setSharedUnprotectedHeader(t){if(this._sharedUnprotectedHeader)throw new TypeError("setSharedUnprotectedHeader can only be called once");return this._sharedUnprotectedHeader=t,this}setUnprotectedHeader(t){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=t,this}setAdditionalAuthenticatedData(t){return this._aad=t,this}setContentEncryptionKey(t){if(this._cek)throw new TypeError("setContentEncryptionKey can only be called once");return this._cek=t,this}setInitializationVector(t){if(this._iv)throw new TypeError("setInitializationVector can only be called once");return this._iv=t,this}async encrypt(t,n){if(!this._protectedHeader&&!this._unprotectedHeader&&!this._sharedUnprotectedHeader)throw new w("either setProtectedHeader, setUnprotectedHeader, or sharedUnprotectedHeader must be called before #encrypt()");if(!Zt(this._protectedHeader,this._unprotectedHeader,this._sharedUnprotectedHeader))throw new w("JWE Protected, JWE Shared Unprotected and JWE Per-Recipient Header Parameter names must be disjoint");const r={...this._protectedHeader,...this._unprotectedHeader,...this._sharedUnprotectedHeader};if(hn(w,new Map,n?.crit,this._protectedHeader,r),r.zip!==void 0)throw new H('JWE "zip" (Compression Algorithm) Header Parameter is not supported.');const{alg:o,enc:i}=r;if(typeof o!="string"||!o)throw new w('JWE "alg" (Algorithm) Header Parameter missing or invalid');if(typeof i!="string"||!i)throw new w('JWE "enc" (Encryption Algorithm) Header Parameter missing or invalid');let s;if(this._cek&&(o==="dir"||o==="ECDH-ES"))throw new TypeError(`setContentEncryptionKey cannot be called with JWE "alg" (Algorithm) Header ${o}`);let c;{let C;({cek:c,encryptedKey:s,parameters:C}=await gr(o,i,t,this._cek,this._keyManagementParameters)),C&&(n&&fr in n?this._unprotectedHeader?this._unprotectedHeader={...this._unprotectedHeader,...C}:this.setUnprotectedHeader(C):this._protectedHeader?this._protectedHeader={...this._protectedHeader,...C}:this.setProtectedHeader(C))}let a,u,l;this._protectedHeader?u=k.encode($(JSON.stringify(this._protectedHeader))):u=k.encode(""),this._aad?(l=$(this._aad),a=j(u,k.encode("."),k.encode(l))):a=u;const{ciphertext:g,tag:h,iv:f}=await fn(i,this._plaintext,c,this._iv,a),y={ciphertext:$(g)};return f&&(y.iv=$(f)),h&&(y.tag=$(h)),s&&(y.encrypted_key=$(s)),l&&(y.aad=l),this._protectedHeader&&(y.protected=fe.decode(u)),this._sharedUnprotectedHeader&&(y.unprotected=this._sharedUnprotectedHeader),this._unprotectedHeader&&(y.header=this._unprotectedHeader),y}}class mr{constructor(t){this._flattened=new yr(t)}setContentEncryptionKey(t){return this._flattened.setContentEncryptionKey(t),this}setInitializationVector(t){return this._flattened.setInitializationVector(t),this}setProtectedHeader(t){return this._flattened.setProtectedHeader(t),this}setKeyManagementParameters(t){return this._flattened.setKeyManagementParameters(t),this}async encrypt(t,n){const r=await this._flattened.encrypt(t,n);return[r.protected,r.encrypted_key,r.iv,r.ciphertext,r.tag].join(".")}}const wr=W;function ye(e){let t;if(typeof e=="string"){const n=e.split(".");(n.length===3||n.length===5)&&([t]=n)}else if(typeof e=="object"&&e)if("protected"in e)t=e.protected;else throw new TypeError("Token does not contain a Protected Header");try{if(typeof t!="string"||!t)throw new Error;const n=JSON.parse(fe.decode(wr(t)));if(!ee(n))throw new Error;return n}catch{throw new TypeError("Invalid Token or Protected Header formatting")}}function Er(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var se={},Me,ft;function Ar(){return ft||(ft=1,Me=function(){return typeof Promise=="function"&&Promise.prototype&&Promise.prototype.then}),Me}var De={},Q={},ht;function te(){if(ht)return Q;ht=1;let e;const t=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];return Q.getSymbolSize=function(r){if(!r)throw new Error('"version" cannot be null or undefined');if(r<1||r>40)throw new Error('"version" should be in range from 1 to 40');return r*4+17},Q.getSymbolTotalCodewords=function(r){return t[r]},Q.getBCHDigit=function(n){let r=0;for(;n!==0;)r++,n>>>=1;return r},Q.setToSJISFunction=function(r){if(typeof r!="function")throw new Error('"toSJISFunc" is not a valid function.');e=r},Q.isKanjiModeEnabled=function(){return typeof e<"u"},Q.toSJIS=function(r){return e(r)},Q}var Oe={},pt;function ct(){return pt||(pt=1,(function(e){e.L={bit:1},e.M={bit:0},e.Q={bit:3},e.H={bit:2};function t(n){if(typeof n!="string")throw new Error("Param is not a string");switch(n.toLowerCase()){case"l":case"low":return e.L;case"m":case"medium":return e.M;case"q":case"quartile":return e.Q;case"h":case"high":return e.H;default:throw new Error("Unknown EC Level: "+n)}}e.isValid=function(r){return r&&typeof r.bit<"u"&&r.bit>=0&&r.bit<4},e.from=function(r,o){if(e.isValid(r))return r;try{return t(r)}catch{return o}}})(Oe)),Oe}var Le,gt;function Sr(){if(gt)return Le;gt=1;function e(){this.buffer=[],this.length=0}return e.prototype={get:function(t){const n=Math.floor(t/8);return(this.buffer[n]>>>7-t%8&1)===1},put:function(t,n){for(let r=0;r<n;r++)this.putBit((t>>>n-r-1&1)===1)},getLengthInBits:function(){return this.length},putBit:function(t){const n=Math.floor(this.length/8);this.buffer.length<=n&&this.buffer.push(0),t&&(this.buffer[n]|=128>>>this.length%8),this.length++}},Le=e,Le}var Ne,yt;function Cr(){if(yt)return Ne;yt=1;function e(t){if(!t||t<1)throw new Error("BitMatrix size must be defined and greater than 0");this.size=t,this.data=new Uint8Array(t*t),this.reservedBit=new Uint8Array(t*t)}return e.prototype.set=function(t,n,r,o){const i=t*this.size+n;this.data[i]=r,o&&(this.reservedBit[i]=!0)},e.prototype.get=function(t,n){return this.data[t*this.size+n]},e.prototype.xor=function(t,n,r){this.data[t*this.size+n]^=r},e.prototype.isReserved=function(t,n){return this.reservedBit[t*this.size+n]},Ne=e,Ne}var He={},mt;function br(){return mt||(mt=1,(function(e){const t=te().getSymbolSize;e.getRowColCoords=function(r){if(r===1)return[];const o=Math.floor(r/7)+2,i=t(r),s=i===145?26:Math.ceil((i-13)/(2*o-2))*2,c=[i-7];for(let a=1;a<o-1;a++)c[a]=c[a-1]-s;return c.push(6),c.reverse()},e.getPositions=function(r){const o=[],i=e.getRowColCoords(r),s=i.length;for(let c=0;c<s;c++)for(let a=0;a<s;a++)c===0&&a===0||c===0&&a===s-1||c===s-1&&a===0||o.push([i[c],i[a]]);return o}})(He)),He}var Fe={},wt;function Tr(){if(wt)return Fe;wt=1;const e=te().getSymbolSize,t=7;return Fe.getPositions=function(r){const o=e(r);return[[0,0],[o-t,0],[0,o-t]]},Fe}var We={},Et;function Ir(){return Et||(Et=1,(function(e){e.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};const t={N1:3,N2:3,N3:40,N4:10};e.isValid=function(o){return o!=null&&o!==""&&!isNaN(o)&&o>=0&&o<=7},e.from=function(o){return e.isValid(o)?parseInt(o,10):void 0},e.getPenaltyN1=function(o){const i=o.size;let s=0,c=0,a=0,u=null,l=null;for(let g=0;g<i;g++){c=a=0,u=l=null;for(let h=0;h<i;h++){let f=o.get(g,h);f===u?c++:(c>=5&&(s+=t.N1+(c-5)),u=f,c=1),f=o.get(h,g),f===l?a++:(a>=5&&(s+=t.N1+(a-5)),l=f,a=1)}c>=5&&(s+=t.N1+(c-5)),a>=5&&(s+=t.N1+(a-5))}return s},e.getPenaltyN2=function(o){const i=o.size;let s=0;for(let c=0;c<i-1;c++)for(let a=0;a<i-1;a++){const u=o.get(c,a)+o.get(c,a+1)+o.get(c+1,a)+o.get(c+1,a+1);(u===4||u===0)&&s++}return s*t.N2},e.getPenaltyN3=function(o){const i=o.size;let s=0,c=0,a=0;for(let u=0;u<i;u++){c=a=0;for(let l=0;l<i;l++)c=c<<1&2047|o.get(u,l),l>=10&&(c===1488||c===93)&&s++,a=a<<1&2047|o.get(l,u),l>=10&&(a===1488||a===93)&&s++}return s*t.N3},e.getPenaltyN4=function(o){let i=0;const s=o.data.length;for(let a=0;a<s;a++)i+=o.data[a];return Math.abs(Math.ceil(i*100/s/5)-10)*t.N4};function n(r,o,i){switch(r){case e.Patterns.PATTERN000:return(o+i)%2===0;case e.Patterns.PATTERN001:return o%2===0;case e.Patterns.PATTERN010:return i%3===0;case e.Patterns.PATTERN011:return(o+i)%3===0;case e.Patterns.PATTERN100:return(Math.floor(o/2)+Math.floor(i/3))%2===0;case e.Patterns.PATTERN101:return o*i%2+o*i%3===0;case e.Patterns.PATTERN110:return(o*i%2+o*i%3)%2===0;case e.Patterns.PATTERN111:return(o*i%3+(o+i)%2)%2===0;default:throw new Error("bad maskPattern:"+r)}}e.applyMask=function(o,i){const s=i.size;for(let c=0;c<s;c++)for(let a=0;a<s;a++)i.isReserved(a,c)||i.xor(a,c,n(o,a,c))},e.getBestMask=function(o,i){const s=Object.keys(e.Patterns).length;let c=0,a=1/0;for(let u=0;u<s;u++){i(u),e.applyMask(u,o);const l=e.getPenaltyN1(o)+e.getPenaltyN2(o)+e.getPenaltyN3(o)+e.getPenaltyN4(o);e.applyMask(u,o),l<a&&(a=l,c=u)}return c}})(We)),We}var me={},At;function pn(){if(At)return me;At=1;const e=ct(),t=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],n=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];return me.getBlocksCount=function(o,i){switch(i){case e.L:return t[(o-1)*4+0];case e.M:return t[(o-1)*4+1];case e.Q:return t[(o-1)*4+2];case e.H:return t[(o-1)*4+3];default:return}},me.getTotalCodewordsCount=function(o,i){switch(i){case e.L:return n[(o-1)*4+0];case e.M:return n[(o-1)*4+1];case e.Q:return n[(o-1)*4+2];case e.H:return n[(o-1)*4+3];default:return}},me}var Ue={},ue={},St;function Br(){if(St)return ue;St=1;const e=new Uint8Array(512),t=new Uint8Array(256);return(function(){let r=1;for(let o=0;o<255;o++)e[o]=r,t[r]=o,r<<=1,r&256&&(r^=285);for(let o=255;o<512;o++)e[o]=e[o-255]})(),ue.log=function(r){if(r<1)throw new Error("log("+r+")");return t[r]},ue.exp=function(r){return e[r]},ue.mul=function(r,o){return r===0||o===0?0:e[t[r]+t[o]]},ue}var Ct;function _r(){return Ct||(Ct=1,(function(e){const t=Br();e.mul=function(r,o){const i=new Uint8Array(r.length+o.length-1);for(let s=0;s<r.length;s++)for(let c=0;c<o.length;c++)i[s+c]^=t.mul(r[s],o[c]);return i},e.mod=function(r,o){let i=new Uint8Array(r);for(;i.length-o.length>=0;){const s=i[0];for(let a=0;a<o.length;a++)i[a]^=t.mul(o[a],s);let c=0;for(;c<i.length&&i[c]===0;)c++;i=i.slice(c)}return i},e.generateECPolynomial=function(r){let o=new Uint8Array([1]);for(let i=0;i<r;i++)o=e.mul(o,new Uint8Array([1,t.exp(i)]));return o}})(Ue)),Ue}var Je,bt;function Pr(){if(bt)return Je;bt=1;const e=_r();function t(n){this.genPoly=void 0,this.degree=n,this.degree&&this.initialize(this.degree)}return t.prototype.initialize=function(r){this.degree=r,this.genPoly=e.generateECPolynomial(this.degree)},t.prototype.encode=function(r){if(!this.genPoly)throw new Error("Encoder not initialized");const o=new Uint8Array(r.length+this.degree);o.set(r);const i=e.mod(o,this.genPoly),s=this.degree-i.length;if(s>0){const c=new Uint8Array(this.degree);return c.set(i,s),c}return i},Je=t,Je}var xe={},$e={},Ge={},Tt;function gn(){return Tt||(Tt=1,Ge.isValid=function(t){return!isNaN(t)&&t>=1&&t<=40}),Ge}var q={},It;function yn(){if(It)return q;It=1;const e="[0-9]+",t="[A-Z $%*+\\-./:]+";let n="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";n=n.replace(/u/g,"\\u");const r="(?:(?![A-Z0-9 $%*+\\-./:]|"+n+`)(?:.|[\r
]))+`;q.KANJI=new RegExp(n,"g"),q.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g"),q.BYTE=new RegExp(r,"g"),q.NUMERIC=new RegExp(e,"g"),q.ALPHANUMERIC=new RegExp(t,"g");const o=new RegExp("^"+n+"$"),i=new RegExp("^"+e+"$"),s=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");return q.testKanji=function(a){return o.test(a)},q.testNumeric=function(a){return i.test(a)},q.testAlphanumeric=function(a){return s.test(a)},q}var Bt;function ne(){return Bt||(Bt=1,(function(e){const t=gn(),n=yn();e.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]},e.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]},e.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]},e.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]},e.MIXED={bit:-1},e.getCharCountIndicator=function(i,s){if(!i.ccBits)throw new Error("Invalid mode: "+i);if(!t.isValid(s))throw new Error("Invalid version: "+s);return s>=1&&s<10?i.ccBits[0]:s<27?i.ccBits[1]:i.ccBits[2]},e.getBestModeForData=function(i){return n.testNumeric(i)?e.NUMERIC:n.testAlphanumeric(i)?e.ALPHANUMERIC:n.testKanji(i)?e.KANJI:e.BYTE},e.toString=function(i){if(i&&i.id)return i.id;throw new Error("Invalid mode")},e.isValid=function(i){return i&&i.bit&&i.ccBits};function r(o){if(typeof o!="string")throw new Error("Param is not a string");switch(o.toLowerCase()){case"numeric":return e.NUMERIC;case"alphanumeric":return e.ALPHANUMERIC;case"kanji":return e.KANJI;case"byte":return e.BYTE;default:throw new Error("Unknown mode: "+o)}}e.from=function(i,s){if(e.isValid(i))return i;try{return r(i)}catch{return s}}})($e)),$e}var _t;function Rr(){return _t||(_t=1,(function(e){const t=te(),n=pn(),r=ct(),o=ne(),i=gn(),s=7973,c=t.getBCHDigit(s);function a(h,f,y){for(let C=1;C<=40;C++)if(f<=e.getCapacity(C,y,h))return C}function u(h,f){return o.getCharCountIndicator(h,f)+4}function l(h,f){let y=0;return h.forEach(function(C){const O=u(C.mode,f);y+=O+C.getBitsLength()}),y}function g(h,f){for(let y=1;y<=40;y++)if(l(h,y)<=e.getCapacity(y,f,o.MIXED))return y}e.from=function(f,y){return i.isValid(f)?parseInt(f,10):y},e.getCapacity=function(f,y,C){if(!i.isValid(f))throw new Error("Invalid QR Code version");typeof C>"u"&&(C=o.BYTE);const O=t.getSymbolTotalCodewords(f),E=n.getTotalCodewordsCount(f,y),M=(O-E)*8;if(C===o.MIXED)return M;const R=M-u(C,f);switch(C){case o.NUMERIC:return Math.floor(R/10*3);case o.ALPHANUMERIC:return Math.floor(R/11*2);case o.KANJI:return Math.floor(R/13);case o.BYTE:default:return Math.floor(R/8)}},e.getBestVersionForData=function(f,y){let C;const O=r.from(y,r.M);if(Array.isArray(f)){if(f.length>1)return g(f,O);if(f.length===0)return 1;C=f[0]}else C=f;return a(C.mode,C.getLength(),O)},e.getEncodedBits=function(f){if(!i.isValid(f)||f<7)throw new Error("Invalid QR Code version");let y=f<<12;for(;t.getBCHDigit(y)-c>=0;)y^=s<<t.getBCHDigit(y)-c;return f<<12|y}})(xe)),xe}var qe={},Pt;function vr(){if(Pt)return qe;Pt=1;const e=te(),t=1335,n=21522,r=e.getBCHDigit(t);return qe.getEncodedBits=function(i,s){const c=i.bit<<3|s;let a=c<<10;for(;e.getBCHDigit(a)-r>=0;)a^=t<<e.getBCHDigit(a)-r;return(c<<10|a)^n},qe}var ke={},Ve,Rt;function Kr(){if(Rt)return Ve;Rt=1;const e=ne();function t(n){this.mode=e.NUMERIC,this.data=n.toString()}return t.getBitsLength=function(r){return 10*Math.floor(r/3)+(r%3?r%3*3+1:0)},t.prototype.getLength=function(){return this.data.length},t.prototype.getBitsLength=function(){return t.getBitsLength(this.data.length)},t.prototype.write=function(r){let o,i,s;for(o=0;o+3<=this.data.length;o+=3)i=this.data.substr(o,3),s=parseInt(i,10),r.put(s,10);const c=this.data.length-o;c>0&&(i=this.data.substr(o),s=parseInt(i,10),r.put(s,c*3+1))},Ve=t,Ve}var ze,vt;function Mr(){if(vt)return ze;vt=1;const e=ne(),t=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"];function n(r){this.mode=e.ALPHANUMERIC,this.data=r}return n.getBitsLength=function(o){return 11*Math.floor(o/2)+6*(o%2)},n.prototype.getLength=function(){return this.data.length},n.prototype.getBitsLength=function(){return n.getBitsLength(this.data.length)},n.prototype.write=function(o){let i;for(i=0;i+2<=this.data.length;i+=2){let s=t.indexOf(this.data[i])*45;s+=t.indexOf(this.data[i+1]),o.put(s,11)}this.data.length%2&&o.put(t.indexOf(this.data[i]),6)},ze=n,ze}var Ye,Kt;function Dr(){if(Kt)return Ye;Kt=1;const e=ne();function t(n){this.mode=e.BYTE,typeof n=="string"?this.data=new TextEncoder().encode(n):this.data=new Uint8Array(n)}return t.getBitsLength=function(r){return r*8},t.prototype.getLength=function(){return this.data.length},t.prototype.getBitsLength=function(){return t.getBitsLength(this.data.length)},t.prototype.write=function(n){for(let r=0,o=this.data.length;r<o;r++)n.put(this.data[r],8)},Ye=t,Ye}var Xe,Mt;function Or(){if(Mt)return Xe;Mt=1;const e=ne(),t=te();function n(r){this.mode=e.KANJI,this.data=r}return n.getBitsLength=function(o){return o*13},n.prototype.getLength=function(){return this.data.length},n.prototype.getBitsLength=function(){return n.getBitsLength(this.data.length)},n.prototype.write=function(r){let o;for(o=0;o<this.data.length;o++){let i=t.toSJIS(this.data[o]);if(i>=33088&&i<=40956)i-=33088;else if(i>=57408&&i<=60351)i-=49472;else throw new Error("Invalid SJIS character: "+this.data[o]+`
Make sure your charset is UTF-8`);i=(i>>>8&255)*192+(i&255),r.put(i,13)}},Xe=n,Xe}var Qe={exports:{}},Dt;function Lr(){return Dt||(Dt=1,(function(e){var t={single_source_shortest_paths:function(n,r,o){var i={},s={};s[r]=0;var c=t.PriorityQueue.make();c.push(r,0);for(var a,u,l,g,h,f,y,C,O;!c.empty();){a=c.pop(),u=a.value,g=a.cost,h=n[u]||{};for(l in h)h.hasOwnProperty(l)&&(f=h[l],y=g+f,C=s[l],O=typeof s[l]>"u",(O||C>y)&&(s[l]=y,c.push(l,y),i[l]=u))}if(typeof o<"u"&&typeof s[o]>"u"){var E=["Could not find a path from ",r," to ",o,"."].join("");throw new Error(E)}return i},extract_shortest_path_from_predecessor_list:function(n,r){for(var o=[],i=r;i;)o.push(i),n[i],i=n[i];return o.reverse(),o},find_path:function(n,r,o){var i=t.single_source_shortest_paths(n,r,o);return t.extract_shortest_path_from_predecessor_list(i,o)},PriorityQueue:{make:function(n){var r=t.PriorityQueue,o={},i;n=n||{};for(i in r)r.hasOwnProperty(i)&&(o[i]=r[i]);return o.queue=[],o.sorter=n.sorter||r.default_sorter,o},default_sorter:function(n,r){return n.cost-r.cost},push:function(n,r){var o={value:n,cost:r};this.queue.push(o),this.queue.sort(this.sorter)},pop:function(){return this.queue.shift()},empty:function(){return this.queue.length===0}}};e.exports=t})(Qe)),Qe.exports}var Ot;function Nr(){return Ot||(Ot=1,(function(e){const t=ne(),n=Kr(),r=Mr(),o=Dr(),i=Or(),s=yn(),c=te(),a=Lr();function u(E){return unescape(encodeURIComponent(E)).length}function l(E,M,R){const _=[];let F;for(;(F=E.exec(R))!==null;)_.push({data:F[0],index:F.index,mode:M,length:F[0].length});return _}function g(E){const M=l(s.NUMERIC,t.NUMERIC,E),R=l(s.ALPHANUMERIC,t.ALPHANUMERIC,E);let _,F;return c.isKanjiModeEnabled()?(_=l(s.BYTE,t.BYTE,E),F=l(s.KANJI,t.KANJI,E)):(_=l(s.BYTE_KANJI,t.BYTE,E),F=[]),M.concat(R,_,F).sort(function(I,b){return I.index-b.index}).map(function(I){return{data:I.data,mode:I.mode,length:I.length}})}function h(E,M){switch(M){case t.NUMERIC:return n.getBitsLength(E);case t.ALPHANUMERIC:return r.getBitsLength(E);case t.KANJI:return i.getBitsLength(E);case t.BYTE:return o.getBitsLength(E)}}function f(E){return E.reduce(function(M,R){const _=M.length-1>=0?M[M.length-1]:null;return _&&_.mode===R.mode?(M[M.length-1].data+=R.data,M):(M.push(R),M)},[])}function y(E){const M=[];for(let R=0;R<E.length;R++){const _=E[R];switch(_.mode){case t.NUMERIC:M.push([_,{data:_.data,mode:t.ALPHANUMERIC,length:_.length},{data:_.data,mode:t.BYTE,length:_.length}]);break;case t.ALPHANUMERIC:M.push([_,{data:_.data,mode:t.BYTE,length:_.length}]);break;case t.KANJI:M.push([_,{data:_.data,mode:t.BYTE,length:u(_.data)}]);break;case t.BYTE:M.push([{data:_.data,mode:t.BYTE,length:u(_.data)}])}}return M}function C(E,M){const R={},_={start:{}};let F=["start"];for(let m=0;m<E.length;m++){const I=E[m],b=[];for(let p=0;p<I.length;p++){const P=I[p],A=""+m+p;b.push(A),R[A]={node:P,lastCount:0},_[A]={};for(let B=0;B<F.length;B++){const S=F[B];R[S]&&R[S].node.mode===P.mode?(_[S][A]=h(R[S].lastCount+P.length,P.mode)-h(R[S].lastCount,P.mode),R[S].lastCount+=P.length):(R[S]&&(R[S].lastCount=P.length),_[S][A]=h(P.length,P.mode)+4+t.getCharCountIndicator(P.mode,M))}}F=b}for(let m=0;m<F.length;m++)_[F[m]].end=0;return{map:_,table:R}}function O(E,M){let R;const _=t.getBestModeForData(E);if(R=t.from(M,_),R!==t.BYTE&&R.bit<_.bit)throw new Error('"'+E+'" cannot be encoded with mode '+t.toString(R)+`.
 Suggested mode is: `+t.toString(_));switch(R===t.KANJI&&!c.isKanjiModeEnabled()&&(R=t.BYTE),R){case t.NUMERIC:return new n(E);case t.ALPHANUMERIC:return new r(E);case t.KANJI:return new i(E);case t.BYTE:return new o(E)}}e.fromArray=function(M){return M.reduce(function(R,_){return typeof _=="string"?R.push(O(_,null)):_.data&&R.push(O(_.data,_.mode)),R},[])},e.fromString=function(M,R){const _=g(M,c.isKanjiModeEnabled()),F=y(_),m=C(F,R),I=a.find_path(m.map,"start","end"),b=[];for(let p=1;p<I.length-1;p++)b.push(m.table[I[p]].node);return e.fromArray(f(b))},e.rawSplit=function(M){return e.fromArray(g(M,c.isKanjiModeEnabled()))}})(ke)),ke}var Lt;function Hr(){if(Lt)return De;Lt=1;const e=te(),t=ct(),n=Sr(),r=Cr(),o=br(),i=Tr(),s=Ir(),c=pn(),a=Pr(),u=Rr(),l=vr(),g=ne(),h=Nr();function f(m,I){const b=m.size,p=i.getPositions(I);for(let P=0;P<p.length;P++){const A=p[P][0],B=p[P][1];for(let S=-1;S<=7;S++)if(!(A+S<=-1||b<=A+S))for(let v=-1;v<=7;v++)B+v<=-1||b<=B+v||(S>=0&&S<=6&&(v===0||v===6)||v>=0&&v<=6&&(S===0||S===6)||S>=2&&S<=4&&v>=2&&v<=4?m.set(A+S,B+v,!0,!0):m.set(A+S,B+v,!1,!0))}}function y(m){const I=m.size;for(let b=8;b<I-8;b++){const p=b%2===0;m.set(b,6,p,!0),m.set(6,b,p,!0)}}function C(m,I){const b=o.getPositions(I);for(let p=0;p<b.length;p++){const P=b[p][0],A=b[p][1];for(let B=-2;B<=2;B++)for(let S=-2;S<=2;S++)B===-2||B===2||S===-2||S===2||B===0&&S===0?m.set(P+B,A+S,!0,!0):m.set(P+B,A+S,!1,!0)}}function O(m,I){const b=m.size,p=u.getEncodedBits(I);let P,A,B;for(let S=0;S<18;S++)P=Math.floor(S/3),A=S%3+b-8-3,B=(p>>S&1)===1,m.set(P,A,B,!0),m.set(A,P,B,!0)}function E(m,I,b){const p=m.size,P=l.getEncodedBits(I,b);let A,B;for(A=0;A<15;A++)B=(P>>A&1)===1,A<6?m.set(A,8,B,!0):A<8?m.set(A+1,8,B,!0):m.set(p-15+A,8,B,!0),A<8?m.set(8,p-A-1,B,!0):A<9?m.set(8,15-A-1+1,B,!0):m.set(8,15-A-1,B,!0);m.set(p-8,8,1,!0)}function M(m,I){const b=m.size;let p=-1,P=b-1,A=7,B=0;for(let S=b-1;S>0;S-=2)for(S===6&&S--;;){for(let v=0;v<2;v++)if(!m.isReserved(P,S-v)){let Y=!1;B<I.length&&(Y=(I[B]>>>A&1)===1),m.set(P,S-v,Y),A--,A===-1&&(B++,A=7)}if(P+=p,P<0||b<=P){P-=p,p=-p;break}}}function R(m,I,b){const p=new n;b.forEach(function(v){p.put(v.mode.bit,4),p.put(v.getLength(),g.getCharCountIndicator(v.mode,m)),v.write(p)});const P=e.getSymbolTotalCodewords(m),A=c.getTotalCodewordsCount(m,I),B=(P-A)*8;for(p.getLengthInBits()+4<=B&&p.put(0,4);p.getLengthInBits()%8!==0;)p.putBit(0);const S=(B-p.getLengthInBits())/8;for(let v=0;v<S;v++)p.put(v%2?17:236,8);return _(p,m,I)}function _(m,I,b){const p=e.getSymbolTotalCodewords(I),P=c.getTotalCodewordsCount(I,b),A=p-P,B=c.getBlocksCount(I,b),S=p%B,v=B-S,Y=Math.floor(p/B),de=Math.floor(A/B),wn=de+1,dt=Y-de,En=new a(dt);let _e=0;const pe=new Array(B),ut=new Array(B);let Pe=0;const An=new Uint8Array(m.buffer);for(let re=0;re<B;re++){const ve=re<v?de:wn;pe[re]=An.slice(_e,_e+ve),ut[re]=En.encode(pe[re]),_e+=ve,Pe=Math.max(Pe,ve)}const Re=new Uint8Array(p);let lt=0,V,z;for(V=0;V<Pe;V++)for(z=0;z<B;z++)V<pe[z].length&&(Re[lt++]=pe[z][V]);for(V=0;V<dt;V++)for(z=0;z<B;z++)Re[lt++]=ut[z][V];return Re}function F(m,I,b,p){let P;if(Array.isArray(m))P=h.fromArray(m);else if(typeof m=="string"){let Y=I;if(!Y){const de=h.rawSplit(m);Y=u.getBestVersionForData(de,b)}P=h.fromString(m,Y||40)}else throw new Error("Invalid data");const A=u.getBestVersionForData(P,b);if(!A)throw new Error("The amount of data is too big to be stored in a QR Code");if(!I)I=A;else if(I<A)throw new Error(`
The chosen QR Code version cannot contain this amount of data.
Minimum version required to store current data is: `+A+`.
`);const B=R(I,b,P),S=e.getSymbolSize(I),v=new r(S);return f(v,I),y(v),C(v,I),E(v,b,0),I>=7&&O(v,I),M(v,B),isNaN(p)&&(p=s.getBestMask(v,E.bind(null,v,b))),s.applyMask(p,v),E(v,b,p),{modules:v,version:I,errorCorrectionLevel:b,maskPattern:p,segments:P}}return De.create=function(I,b){if(typeof I>"u"||I==="")throw new Error("No input text");let p=t.M,P,A;return typeof b<"u"&&(p=t.from(b.errorCorrectionLevel,t.M),P=u.from(b.version),A=s.from(b.maskPattern),b.toSJISFunc&&e.setToSJISFunction(b.toSJISFunc)),F(I,P,p,A)},De}var Ze={},je={},Nt;function mn(){return Nt||(Nt=1,(function(e){function t(n){if(typeof n=="number"&&(n=n.toString()),typeof n!="string")throw new Error("Color should be defined as hex string");let r=n.slice().replace("#","").split("");if(r.length<3||r.length===5||r.length>8)throw new Error("Invalid hex color: "+n);(r.length===3||r.length===4)&&(r=Array.prototype.concat.apply([],r.map(function(i){return[i,i]}))),r.length===6&&r.push("F","F");const o=parseInt(r.join(""),16);return{r:o>>24&255,g:o>>16&255,b:o>>8&255,a:o&255,hex:"#"+r.slice(0,6).join("")}}e.getOptions=function(r){r||(r={}),r.color||(r.color={});const o=typeof r.margin>"u"||r.margin===null||r.margin<0?4:r.margin,i=r.width&&r.width>=21?r.width:void 0,s=r.scale||4;return{width:i,scale:i?4:s,margin:o,color:{dark:t(r.color.dark||"#000000ff"),light:t(r.color.light||"#ffffffff")},type:r.type,rendererOpts:r.rendererOpts||{}}},e.getScale=function(r,o){return o.width&&o.width>=r+o.margin*2?o.width/(r+o.margin*2):o.scale},e.getImageWidth=function(r,o){const i=e.getScale(r,o);return Math.floor((r+o.margin*2)*i)},e.qrToImageData=function(r,o,i){const s=o.modules.size,c=o.modules.data,a=e.getScale(s,i),u=Math.floor((s+i.margin*2)*a),l=i.margin*a,g=[i.color.light,i.color.dark];for(let h=0;h<u;h++)for(let f=0;f<u;f++){let y=(h*u+f)*4,C=i.color.light;if(h>=l&&f>=l&&h<u-l&&f<u-l){const O=Math.floor((h-l)/a),E=Math.floor((f-l)/a);C=g[c[O*s+E]?1:0]}r[y++]=C.r,r[y++]=C.g,r[y++]=C.b,r[y]=C.a}}})(je)),je}var Ht;function Fr(){return Ht||(Ht=1,(function(e){const t=mn();function n(o,i,s){o.clearRect(0,0,i.width,i.height),i.style||(i.style={}),i.height=s,i.width=s,i.style.height=s+"px",i.style.width=s+"px"}function r(){try{return document.createElement("canvas")}catch{throw new Error("You need to specify a canvas element")}}e.render=function(i,s,c){let a=c,u=s;typeof a>"u"&&(!s||!s.getContext)&&(a=s,s=void 0),s||(u=r()),a=t.getOptions(a);const l=t.getImageWidth(i.modules.size,a),g=u.getContext("2d"),h=g.createImageData(l,l);return t.qrToImageData(h.data,i,a),n(g,u,l),g.putImageData(h,0,0),u},e.renderToDataURL=function(i,s,c){let a=c;typeof a>"u"&&(!s||!s.getContext)&&(a=s,s=void 0),a||(a={});const u=e.render(i,s,a),l=a.type||"image/png",g=a.rendererOpts||{};return u.toDataURL(l,g.quality)}})(Ze)),Ze}var et={},Ft;function Wr(){if(Ft)return et;Ft=1;const e=mn();function t(o,i){const s=o.a/255,c=i+'="'+o.hex+'"';return s<1?c+" "+i+'-opacity="'+s.toFixed(2).slice(1)+'"':c}function n(o,i,s){let c=o+i;return typeof s<"u"&&(c+=" "+s),c}function r(o,i,s){let c="",a=0,u=!1,l=0;for(let g=0;g<o.length;g++){const h=Math.floor(g%i),f=Math.floor(g/i);!h&&!u&&(u=!0),o[g]?(l++,g>0&&h>0&&o[g-1]||(c+=u?n("M",h+s,.5+f+s):n("m",a,0),a=0,u=!1),h+1<i&&o[g+1]||(c+=n("h",l),l=0)):a++}return c}return et.render=function(i,s,c){const a=e.getOptions(s),u=i.modules.size,l=i.modules.data,g=u+a.margin*2,h=a.color.light.a?"<path "+t(a.color.light,"fill")+' d="M0 0h'+g+"v"+g+'H0z"/>':"",f="<path "+t(a.color.dark,"stroke")+' d="'+r(l,u,a.margin)+'"/>',y='viewBox="0 0 '+g+" "+g+'"',O='<svg xmlns="http://www.w3.org/2000/svg" '+(a.width?'width="'+a.width+'" height="'+a.width+'" ':"")+y+' shape-rendering="crispEdges">'+h+f+`</svg>
`;return typeof c=="function"&&c(null,O),O},et}var Wt;function Ur(){if(Wt)return se;Wt=1;const e=Ar(),t=Hr(),n=Fr(),r=Wr();function o(i,s,c,a,u){const l=[].slice.call(arguments,1),g=l.length,h=typeof l[g-1]=="function";if(!h&&!e())throw new Error("Callback required as last argument");if(h){if(g<2)throw new Error("Too few arguments provided");g===2?(u=c,c=s,s=a=void 0):g===3&&(s.getContext&&typeof u>"u"?(u=a,a=void 0):(u=a,a=c,c=s,s=void 0))}else{if(g<1)throw new Error("Too few arguments provided");return g===1?(c=s,s=a=void 0):g===2&&!s.getContext&&(a=c,c=s,s=void 0),new Promise(function(f,y){try{const C=t.create(c,a);f(i(C,s,a))}catch(C){y(C)}})}try{const f=t.create(c,a);u(null,i(f,s,a))}catch(f){u(f)}}return se.create=t.create,se.toCanvas=o.bind(null,n.render),se.toDataURL=o.bind(null,n.renderToDataURL),se.toString=o.bind(null,function(i,s,c){return r.render(i,c)}),se}var Jr=Ur();const xr=Er(Jr);function Ut(e){return btoa(String.fromCharCode.apply(null,e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Jt(e){e=(e||"").replace(/-/g,"+").replace(/_/g,"/");const t=e.length%4===0?"":"=".repeat(4-e.length%4),n=atob(e+t),r=new Uint8Array(n.length);for(let o=0;o<n.length;o++)r[o]=n.charCodeAt(o);return r}async function we(e,t,n){if(n.name===T.KDF_ARGON2){if(!await N.checkArgon2Ready())throw new Error("Argon2 函式庫未成功載入，無法執行。");const{hash:r}=await window.argon2.hash({pass:e,salt:t,time:n.iterations,mem:n.memory,parallelism:n.parallelism,hashLen:32,type:window.argon2.ArgonType.Argon2id});return r}if(n.name===T.KDF_PBKDF2){const r=await crypto.subtle.importKey("raw",new TextEncoder().encode(e),{name:T.KDF_PBKDF2},!1,["deriveBits"]),o=await crypto.subtle.deriveBits({name:T.KDF_PBKDF2,salt:t,iterations:n.iterations,hash:T.HASH_SHA256},r,T.KEY_LENGTH_BITS);return new Uint8Array(o)}throw new Error("不支援的金鑰衍生演算法。")}async function xt(e,t,n){return await new mr(e).setProtectedHeader(n).encrypt(t)}async function Ee(e,t){try{const{plaintext:n}=await lr(e,t);return n}catch{throw new Error("密碼短語不正確，或密文在傳輸過程中已被竄改 (完整性驗證失敗)。")}}const le={async encryptText(){const e=d.mnemonic.value.trim(),t=d.passphraseEncrypt.value;if(!e||!t)return N.showToast("❌ 明文和密碼短語不能為空。");if(!N.runSecurityChecks(t,K.selectedKDF))return;L.setOutput("info","⏳ 正在加密，請稍候..."),await new Promise(r=>setTimeout(r,50));const n=performance.now();try{const r=crypto.getRandomValues(new Uint8Array(T.SALT_BYTES)),o={name:K.selectedKDF},i={alg:"dir",enc:T.ALGO_AES_GCM,kdf:o.name,salt:Ut(r)};K.selectedKDF===T.KDF_ARGON2?(o.iterations=i.t=parseInt(d.argon2Iterations.value,10),o.memory=i.m=parseInt(d.argon2Memory.value,10)*1024,o.parallelism=i.p=parseInt(d.argon2Parallelism.value,10)):o.iterations=i.i=parseInt(d.pbkdf2Iterations.value,10);const s=await we(t,r,o),c=new TextEncoder().encode(e),a=await xt(c,s,i),u=((performance.now()-n)/1e3).toFixed(3);if(K.lastEncryptedOutput=a,L.setOutput("success",`✅ 加密成功！ (處理時間：${u} 秒)`),d.selfVerifyCheckbox.checked){L.setOutput("info","✅ 加密成功！<br>...正在進行自我驗證..."),await new Promise(l=>setTimeout(l,20));try{await Ee(a,s),L.setOutput("success",`✅ 加密與驗證均成功！ (總時間：${((performance.now()-n)/1e3).toFixed(3)} 秒)`)}catch(l){L.setOutput("error",`❌ 嚴重錯誤：加密後驗證失敗！請勿使用此密文，並回報此問題。<br>錯誤訊息：${l.message}`);return}}d.base64ResultView.value=a,d.jsonView.value=JSON.stringify(ye(a),null,2),d.qrCanvas.hidden=a.length>=T.QR_CODE_MAX_BYTES,d.qrCanvas.hidden||xr.toCanvas(d.qrCanvas,a,{errorCorrectionLevel:"L",width:320})}catch(r){L.setOutput("error",`❌ 加密失敗：${r.message}`)}},async decryptText(){const e=d.ciphertextInput.value.trim(),t=d.passphraseDecrypt.value;if(!e||!t)return N.showToast("❌ 密文和密碼短語不能為空。");L.setOutput("info","⏳ 正在解密，請稍候..."),await new Promise(r=>setTimeout(r,50));const n=performance.now();try{const r=ye(e),o=Jt(r.salt),i={name:r.kdf};if(r.kdf===T.KDF_ARGON2)i.iterations=r.t,i.memory=r.m,i.parallelism=r.p;else if(r.kdf===T.KDF_PBKDF2)i.iterations=r.i;else throw new Error(`不支援的 KDF: ${r.kdf}`);const s=await we(t,o,i),c=await Ee(e,s),a=((performance.now()-n)/1e3).toFixed(3),u=new TextDecoder().decode(c);K.lastDecryptedText=u,L.setOutput("success",`✅ 解密成功 (處理時間：${a} 秒)<br><br><strong style="font-size: 1.1em; white-space: pre-wrap; word-break: break-word;">${u}</strong>`)}catch(r){L.setOutput("error",`❌ 解密失敗：${r.message}`)}},async encryptFile(){const e=K.fileToEncrypt,t=d.passphraseFileEncrypt.value;if(!e||!t)return N.showToast("❌ 請選擇檔案並輸入密碼短語。");if(!N.runSecurityChecks(t,K.selectedKDF))return;L.setOutput("info",`⏳ 正在加密檔案 ${e.name}，請稍候...`),await new Promise(r=>setTimeout(r,50));const n=performance.now();try{const r=await Ae.readFileAsArrayBuffer(e),o=crypto.getRandomValues(new Uint8Array(T.SALT_BYTES)),i={name:K.selectedKDF},s={alg:"dir",enc:T.ALGO_AES_GCM,kdf:i.name,salt:Ut(o)};K.selectedKDF===T.KDF_ARGON2?(i.iterations=s.t=parseInt(d.argon2Iterations.value,10),i.memory=s.m=parseInt(d.argon2Memory.value,10)*1024,i.parallelism=s.p=parseInt(d.argon2Parallelism.value,10)):i.iterations=s.i=parseInt(d.pbkdf2Iterations.value,10);const c=await we(t,o,i),a=await xt(new Uint8Array(r),c,s);let u=((performance.now()-n)/1e3).toFixed(3);if(d.selfVerifyFileCheckbox.checked){L.setOutput("info","✅ 檔案加密成功！<br>...正在進行自我驗證..."),await new Promise(l=>setTimeout(l,20));try{await Ee(a,c),u=((performance.now()-n)/1e3).toFixed(3),L.setOutput("success",`✅ 檔案加密與驗證均成功！已開始下載。 (總時間: ${u} 秒)`)}catch(l){L.setOutput("error",`❌ 嚴重錯誤：檔案加密後驗證失敗！請勿使用此檔案。<br>錯誤訊息：${l.message}`);return}}else L.setOutput("success",`✅ 檔案加密成功！ (處理時間：${u} 秒)`);N.downloadAsFile(a,e.name+T.DOWNLOAD_FILENAME_SUFFIX)}catch(r){L.setOutput("error",`❌ 檔案加密失敗：${r.message}`)}},async decryptFile(){const e=K.fileToDecrypt,t=d.passphraseFileDecrypt.value;if(!e||!t)return N.showToast("❌ 請選擇檔案並輸入密碼短語。");L.setOutput("info",`⏳ 正在解密檔案 ${e.name}，請稍候...`),await new Promise(r=>setTimeout(r,50));const n=performance.now();try{const r=await Ae.readFileAsText(e),o=ye(r),i=Jt(o.salt),s={name:o.kdf};if(o.kdf===T.KDF_ARGON2)s.iterations=o.t,s.memory=o.m,s.parallelism=o.p;else if(o.kdf===T.KDF_PBKDF2)s.iterations=o.i;else throw new Error(`不支援的 KDF: ${o.kdf}`);const c=await we(t,i,s),a=await Ee(r,c),u=((performance.now()-n)/1e3).toFixed(3),l=e.name.endsWith(T.DOWNLOAD_FILENAME_SUFFIX)?e.name.slice(0,-4):`decrypted-${e.name}`;N.downloadAsFile(new Blob([a]),l),L.setOutput("success",`✅ 檔案解密成功！已開始下載 ${l} (處理時間：${u} 秒)`)}catch(r){L.setOutput("error",`❌ 解密失敗：${r.message}`)}},async parseParameters(){const e=d.ciphertextInput.value.trim();if(!e)return N.showToast("請先貼上 JWE 密文");try{const n=ye(e);let r=`${n.kdf}`;n.kdf===T.KDF_PBKDF2?r+=` (SHA-256, ${n.i.toLocaleString("en-US")} 迭代)`:n.kdf===T.KDF_ARGON2&&(r+=` (mem: ${n.m/1024}MB, iter: ${n.t}, parallel: ${n.p})`);const o=`v${T.VERSION} (JWE)`;d.paramsDisplayArea.innerHTML=`<p>格式版本：<span>${o}</span></p><p>金鑰衍生：<span>${r}</span></p><p>加密演算法：<span>${n.enc}</span></p><p style="color: var(--success-color);">狀態：<span>JWE Header 已載入 ✅</span></p>`,d.paramsDisplayArea.hidden=!1}catch{d.paramsDisplayArea.innerHTML='<p style="color: var(--error-color);">❌ 解析失敗：無效的 JWE 格式。</p>',d.paramsDisplayArea.hidden=!1}}},$t={init(){const e=localStorage.getItem("my-app-theme")||"dark";this.apply(e)},apply(e){document.documentElement.setAttribute("data-theme",e),d.themeToggleBtn.textContent=e==="dark"?"☀️":"🌙",localStorage.setItem("my-app-theme",e)},toggle(){const e=document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark";this.apply(e)}},$r={toggle(e){const t=e.classList.contains("active");e.classList.toggle("active"),e.setAttribute("aria-expanded",!t),e.nextElementSibling.setAttribute("aria-hidden",t)}},Gr={async run(){if(!await N.checkArgon2Ready())return N.showToast("❌ Argon2 函式庫未就緒，無法測試。");d.benchmarkBtn.disabled=!0,d.encryptBtn.disabled=!0,d.benchmarkStatus.textContent="⏱️ 正在執行基準測試，請稍候...";try{const n=navigator.hardwareConcurrency||4,r=[1024,512,256,128,64,32];let o=256;for(const i of r){const s=i*1024,c=performance.now();if(await window.argon2.hash({pass:"benchmark",salt:"benchmark-salt",time:4,mem:s,parallelism:n,hashLen:32,type:window.argon2.ArgonType.Argon2id}),performance.now()-c<1e3){o=i;break}await new Promise(u=>setTimeout(u,50))}d.argon2Memory.value=o,d.argon2Iterations.value=4,d.argon2Parallelism.value=n,d.benchmarkStatus.textContent="✅ 測試完成！",N.showToast("✅ 建議參數已產生並填入！")}catch(e){d.benchmarkStatus.textContent="❌ 測試失敗",N.showToast(`❌ 基準測試失敗: ${e.message}`)}finally{d.benchmarkBtn.disabled=!1,d.encryptBtn.disabled=!1,setTimeout(()=>{d.benchmarkStatus.textContent=""},4e3)}}};function qr(){d.currentYear.textContent=new Date().getFullYear(),$t.init(),K.currentAppMode=T.MODE_TEXT,K.selectedAlgorithm=T.ALGO_AES_GCM,K.selectedKDF=T.KDF_ARGON2,L.setAppMode(K.currentAppMode),N.checkArgon2Ready(),d.themeToggleBtn.addEventListener("click",()=>$t.toggle()),d.scrollTopBtn.addEventListener("click",()=>window.scrollTo({top:0,behavior:"smooth"})),window.addEventListener("scroll",()=>d.scrollTopBtn.classList.toggle("active",window.scrollY>300)),d.appModeSelector.addEventListener("click",t=>{const n=t.target.closest(".option");n?.dataset.appMode&&L.setAppMode(n.dataset.appMode)}),d.modeSelector.addEventListener("click",t=>{const n=t.target.closest(".option");n?.dataset.mode&&L.setMode(n.dataset.mode)}),d.algoSelectionGroup.addEventListener("click",t=>{const n=t.target.closest(".option");n&&n.style.cursor==="not-allowed"||L.handleOptionSelection(t,"selectedAlgorithm")}),d.kdfSelectionGroup.addEventListener("click",t=>{L.handleOptionSelection(t,"selectedKDF")&&L.toggleKdfParams(K.selectedKDF)}),d.passphraseEncrypt.addEventListener("input",t=>L.updatePasswordStrength(t.target.value,"encrypt")),d.passphraseFileEncrypt.addEventListener("input",t=>L.updatePasswordStrength(t.target.value,"file")),d.encryptBtn.addEventListener("click",()=>le.encryptText()),d.decryptBtn.addEventListener("click",()=>le.decryptText()),d.parseBtn.addEventListener("click",()=>le.parseParameters()),d.benchmarkBtn.addEventListener("click",()=>Gr.run()),d.fileEncryptInput.addEventListener("change",t=>Ae.handleFileSelect(t,T.OP_ENCRYPT)),d.fileDecryptInput.addEventListener("change",t=>Ae.handleFileSelect(t,T.OP_DECRYPT)),d.encryptFileBtn.addEventListener("click",()=>le.encryptFile()),d.decryptFileBtn.addEventListener("click",()=>le.decryptFile()),d.resetBtn.addEventListener("click",()=>L.resetAll()),d.pasteBtn.addEventListener("click",()=>N.pasteTo("ciphertextInput")),d.copyBtn.addEventListener("click",()=>N.copyFromResult()),d.copyDecryptedBtn.addEventListener("click",()=>N.copyDecryptedResult()),d.downloadBtn.addEventListener("click",()=>{K.lastEncryptedOutput&&N.downloadAsFile(K.lastEncryptedOutput,`encrypted-v4-${Date.now()}${T.DOWNLOAD_FILENAME_SUFFIX}`)}),d.passwordToggles.forEach(t=>{t.innerHTML=T.SVG_EYE_OPEN,t.addEventListener("click",n=>L.togglePasswordVisibility(n.currentTarget))});const e=(t,n)=>{t&&(["dragenter","dragover","dragleave","drop"].forEach(r=>{t.addEventListener(r,o=>{o.preventDefault(),o.stopPropagation()})}),["dragenter","dragover"].forEach(r=>t.addEventListener(r,()=>t.classList.add("drag-over"))),["dragleave","drop"].forEach(r=>t.addEventListener(r,()=>t.classList.remove("drag-over"))),t.addEventListener("drop",r=>{r.dataTransfer.files.length>0&&(n.files=r.dataTransfer.files,n.dispatchEvent(new Event("change",{bubbles:!0})))}))};e(d.fileEncryptInput.closest(".file-input-wrapper"),d.fileEncryptInput),e(d.fileDecryptInput.closest(".file-input-wrapper"),d.fileDecryptInput),d.accordionContainer&&d.accordionContainer.addEventListener("click",t=>{const n=t.target.closest(".accordion-header");n&&$r.toggle(n)})}document.addEventListener("DOMContentLoaded",qr);
