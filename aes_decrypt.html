<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>åŠ©è¨˜è©è§£å¯†å·¥å…· (AES-GCM / PBKDF2)</title>
        <style>
            :root {
                --header-color: #007bff;
                --primary-color: #007bff;
                --secondary-color: #6c757d;
                --bg-color: #f8f9fa;
                --container-bg: #fff;
                --text-color: #212529;
                --note-color: #04500e;
                --note-bgcolor: #d6f5a3;
                --border-color: #ced4da;
                --error-color: #dc3545;
                --error-bg: #fbebeb;
                --success-color: #28a745;
                --success-bg: #e6ffed;
                --input-bg: #c3ddbf; /* Light theme input background */
                --input-focus-shadow: rgba(0, 123, 255, 0.25);
            }
            :root[data-theme="dark"] {
                --header-color: #fff;
                --primary-color: #1e90ff;
                --secondary-color: #778899;
                --bg-color: #1e1e2f;
                --container-bg: #2f2f4f;
                --text-color: #e8e8f0;
                --note-color: #c0c0e0;
                --note-bgcolor: #273f2a;
                --border-color: #4a4a5f;
                --error-color: #ff7f7f;
                --error-bg: #4f2e2e;
                --success-color: #60d978;
                --success-bg: #2a4a30;
                --input-bg: #444; /* Dark theme input background */
                --input-focus-shadow: rgba(30, 144, 255, 0.4);
            }
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                line-height: 1.6;
                margin: 0;
                padding: 20px;
                background-color: var(--bg-color);
                color: var(--text-color);
                display: flex;
                flex-direction: column;
                align-items: center;
                min-height: 100vh;
                transition: background-color 0.3s, color 0.3s;
            }
            .container {
                width: 100%;
                max-width: 80%;
                background-color: var(--container-bg);
                padding: 25px;
                border-radius: 8px;
                box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
                transition: background-color 0.3s;
            }
            header h1 {
                color: var(--header-color);
                text-align: center;
                margin-bottom: 25px;
                font-size: 1.8em;
            }
            .form-group {
                margin-bottom: 20px;
            }
            label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: var(--text-color);
            }
            textarea,
            input[type="password"],
            input[type="text"] {
                width: 100%;
                padding: 12px;
                border: 1px solid var(--border-color);
                border-radius: 5px;
                box-sizing: border-box;
                font-size: 1em;
                background-color: var(--input-bg);
                color: var(--text-color);
                transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            }
            textarea:focus,
            input[type="password"]:focus,
            input[type="text"]:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0.2rem var(--input-focus-shadow);
            }
            .field-note {
                font-size: 1em;
                color: var(--note-color);
                background-color: var(--note-bgcolor);
                margin-top: 5px;
                padding: 5px;
                border-radius: 3px;
                transition: background-color 0.3s, color 0.3s;
            }
            button#decryptBtn {
                background-color: var(--primary-color);
                color: #ffffff;
                padding: 12px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 1.1em;
                width: 100%;
                transition: background-color 0.2s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            button#decryptBtn:hover {
                filter: brightness(90%);
            }
            button#decryptBtn:disabled {
                background-color: var(--secondary-color);
                cursor: not-allowed;
                opacity: 0.7;
            }
            .spinner {
                width: 18px;
                height: 18px;
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: #fff;
                animation: spin 1s linear infinite;
                margin-left: 10px;
            }
            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
            .output-section {
                margin-top: 30px;
            }
            .output-section h2 {
                font-size: 1.4em;
                color: var(--primary-color);
                border-bottom: 2px solid var(--border-color);
                padding-bottom: 10px;
                margin-bottom: 15px;
            }
            pre#output {
                background-color: var(--input-bg);
                padding: 15px;
                border: 1px solid var(--border-color);
                border-radius: 5px;
                white-space: pre-wrap;
                word-break: break-all;
                min-height: 50px;
                font-size: 1.2em;
                line-height: 1.5;
                color: var(--text-color);
                transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            }
            pre#output.error {
                color: var(--error-color);
                border-left: 5px solid var(--error-color);
                background-color: var(--error-bg);
            }
            pre#output.success {
                color: var(--success-color);
                border-left: 5px solid var(--success-color);
                background-color: var(--success-bg);
            }
            button#copyBtn {
                background-color: var(--success-color);
                color: #ffffff;
                padding: 8px 15px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.9em;
                margin-top: 10px;
                transition: background-color 0.2s ease, opacity 0.2s ease;
            }
            button#copyBtn:hover {
                filter: brightness(90%);
            }
            button#copyBtn:disabled {
                background-color: var(--secondary-color);
                cursor: not-allowed;
                opacity: 0.7;
            }
            footer {
                text-align: center;
                margin-top: 30px;
                font-size: 0.9em;
                color: var(--secondary-color);
            }
            #themeToggleBtn {
                background: none;
                border: 1px solid var(--border-color);
                color: var(--text-color);
                padding: 5px 8px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 1.2em;
                margin-left: 10px;
                vertical-align: middle;
            }
            #themeToggleBtn:hover {
                background-color: var(--border-color);
            }

            /* --- æ–°å¢ï¼šå¯†ç¢¼æ¬„ä½æ¨£å¼ (èˆ‡ä¸»å·¥å…·ä¸€è‡´) --- */
            .password-wrapper {
                position: relative;
                display: flex;
                align-items: center;
            }
            .toggle-password-icon {
                position: absolute;
                right: 12px; /* èª¿æ•´ä½ç½®ä»¥é©æ‡‰æ­¤å·¥å…·çš„ padding */
                cursor: pointer;
                color: var(--secondary-color); /* ä½¿ç”¨æ¬¡è¦é¡è‰² */
                transition: color 0.2s;
            }
            .toggle-password-icon:hover {
                color: var(--text-color); /* æ»‘é¼ æ‡¸åœæ™‚ä½¿ç”¨ä¸»è¦æ–‡å­—é¡è‰² */
            }
            .toggle-password-icon svg {
                width: 20px;
                height: 20px;
                vertical-align: middle;
                fill: currentColor; /* è®“ SVG é¡è‰²ç¹¼æ‰¿è‡ªçˆ¶å…ƒç´  span */
            }
            /* ç¢ºä¿ input[type="text"] æ™‚ä¹Ÿæœ‰è¶³å¤ å³é‚Šè· */
            .password-wrapper input[type="password"],
            .password-wrapper input[type="text"] {
                padding-right: 40px; /* ç•™å‡ºç©ºé–“çµ¦åœ–ç¤º */
            }

            @media (max-width: 600px) {
                body {
                    padding: 10px;
                }
                .container {
                    padding: 15px;
                    max-width: 95%;
                }
                header h1 {
                    color: var(--header-color);
                    font-size: 1.5em;
                    margin-bottom: 20px;
                }
                button#decryptBtn {
                    padding: 10px 15px;
                    font-size: 1em;
                }
                textarea,
                input[type="password"],
                input[type="text"] {
                    padding: 10px;
                }
                button#copyBtn {
                    width: 100%;
                    padding: 10px 15px;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>åŠ©è¨˜è©è§£å¯†å·¥å…· (AES-GCM / PBKDF2)</h1>
            </header>
            <main>
                <section class="input-section">
                    <div class="form-group">
                        <label for="jsonInput">åŠ å¯†è³‡æ–™ (JSON æˆ– Base64 ç·¨ç¢¼çš„ JSON)</label>
                        <textarea
                            id="jsonInput"
                            rows="8"
                            placeholder="è²¼ä¸Šç´” JSON è³‡æ–™ï¼Œæˆ–ç¶“ Base64 ç·¨ç¢¼çš„ JSON è³‡æ–™"
                        ></textarea>
                        <div class="field-note"><strong>ğŸ’¡ æ³¨æ„ï¼š</strong>æ”¯æ´æ–°èˆŠå…©ç¨®åŠ å¯†æ ¼å¼ã€‚</div>
                    </div>
                    <div class="form-group">
                        <label for="passphrase">å¯†ç¢¼çŸ­èª</label>
                        <div class="password-wrapper">
                            <input type="password" id="passphrase" placeholder="è¼¸å…¥æ‚¨çš„å¯†ç¢¼çŸ­èª" />
                            <span id="togglePassword" class="toggle-password-icon" title="é¡¯ç¤º/éš±è—å¯†ç¢¼"> </span>
                        </div>
                    </div>
                    <button id="decryptBtn">
                        <span class="btn-text">ğŸ”“ è§£å¯†</span>
                        <span class="spinner" style="display: none"></span>
                    </button>
                </section>
                <section class="output-section">
                    <h2>è§£å¯†çµæœ</h2>
                    <pre id="output" aria-live="polite"></pre>
                    <button id="copyBtn" style="display: none">è¤‡è£½å…§å®¹</button>
                </section>
            </main>
        </div>
        <footer>
            <p>
                &copy; <span id="currentYear"></span> Zanta's Customized AES Tool for Cryptocurrency Wallets
                <button id="themeToggleBtn" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ™</button>
            </p>
        </footer>

        <script>
            document.getElementById("currentYear").textContent = new Date().getFullYear();

            const KEY_LENGTH_BITS = 256;
            const TAG_LENGTH_BITS = 128;
            const LEGACY_DEFAULT_ITERATIONS = 300000;

            // --- æ–°å¢ï¼šSVG åœ–ç¤ºå¸¸æ•¸ (èˆ‡ä¸»å·¥å…·ä¸€è‡´) ---
            const SVG_EYE_OPEN = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>`;
            const SVG_EYE_SLASH = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7.029 7.029 0 0 0 2.79-.588zM5.21 3.088A7.028 7.028 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474L5.21 3.089z"/><path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829l-2.83-2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12-.708.708z"/></svg>`;

            async function base64ToArrayBuffer(base64) {
                try {
                    return Uint8Array.from(atob(base64), (c) => c.charCodeAt(0));
                } catch (e) {
                    throw new Error("Base64 è§£ç¢¼å¤±æ•—ï¼šè¼¸å…¥çš„å­—ä¸²å¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„ Base64ã€‚");
                }
            }

            async function deriveKey(passphrase, salt, iterations, keySize) {
                const encoder = new TextEncoder();
                const passphraseKey = await window.crypto.subtle.importKey(
                    "raw",
                    encoder.encode(passphrase),
                    "PBKDF2",
                    false,
                    ["deriveKey"]
                );
                return await window.crypto.subtle.deriveKey(
                    { name: "PBKDF2", salt, iterations, hash: "SHA-256" },
                    passphraseKey,
                    { name: "AES-GCM", length: keySize },
                    false,
                    ["decrypt"]
                );
            }

            async function decryptData(jsonData, passphrase) {
                let saltB64, iterations, keySize, ivB64, ciphertextB64, tagB64, tagLength;
                if (jsonData.keyDerivation && jsonData.encryption) {
                    console.log("åµæ¸¬åˆ°æ–°ç‰ˆåŠ å¯†æ ¼å¼ã€‚");
                    const kd = jsonData.keyDerivation;
                    const enc = jsonData.encryption;
                    if (kd.name !== "PBKDF2" || enc.name !== "AES-GCM") throw new Error("ä¸æ”¯æ´çš„æ¼”ç®—æ³•ã€‚");
                    saltB64 = kd.salt;
                    iterations = kd.iterations;
                    ivB64 = enc.iv;
                    ciphertextB64 = enc.ciphertext;
                    tagB64 = enc.tag;
                    tagLength = enc.tagLength || TAG_LENGTH_BITS;
                    keySize = KEY_LENGTH_BITS;
                } else {
                    console.log("åµæ¸¬åˆ°èˆŠç‰ˆåŠ å¯†æ ¼å¼ã€‚");
                    saltB64 = jsonData.salt;
                    iterations = jsonData.iterations || LEGACY_DEFAULT_ITERATIONS;
                    keySize = jsonData.keySize || KEY_LENGTH_BITS;
                    ivB64 = jsonData.iv;
                    ciphertextB64 = jsonData.ciphertext;
                    tagB64 = jsonData.tag;
                    tagLength = jsonData.algorithm?.tagLength || TAG_LENGTH_BITS;
                }
                const params = { saltB64, iterations, keySize, ivB64, ciphertextB64, tagB64, tagLength };
                const requiredFields = {
                    saltB64: "string",
                    iterations: "number",
                    keySize: "number",
                    ivB64: "string",
                    ciphertextB64: "string",
                    tagB64: "string",
                    tagLength: "number",
                };
                for (const fieldName in requiredFields) {
                    if (typeof params[fieldName] === "undefined" || params[fieldName] === null) {
                        throw new Error(`å¿…è¦çš„åŠ å¯†åƒæ•¸ "${fieldName}" éºå¤±ã€‚`);
                    }
                    if (typeof params[fieldName] !== requiredFields[fieldName]) {
                        throw new Error(`åŠ å¯†åƒæ•¸ "${fieldName}" çš„æ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰ç‚º ${requiredFields[fieldName]}ã€‚`);
                    }
                }
                if (params.iterations <= 0) throw new Error("iterations å¿…é ˆæ˜¯æ­£æ•´æ•¸ã€‚");
                const saltBuf = await base64ToArrayBuffer(saltB64);
                const ivBuf = await base64ToArrayBuffer(ivB64);
                const tagBuf = await base64ToArrayBuffer(tagB64);
                const ciphertextBuf = await base64ToArrayBuffer(ciphertextB64);
                const combined = new Uint8Array(ciphertextBuf.length + tagBuf.length);
                combined.set(ciphertextBuf);
                combined.set(tagBuf, ciphertextBuf.length);
                const key = await deriveKey(passphrase, saltBuf, iterations, keySize);
                try {
                    const decrypted = await window.crypto.subtle.decrypt(
                        { name: "AES-GCM", iv: ivBuf, tagLength: tagLength },
                        key,
                        combined
                    );
                    const decoder = new TextDecoder();
                    return decoder.decode(decrypted);
                } catch (e) {
                    let specificError = "æœªçŸ¥éŒ¯èª¤";
                    if (e.name === "OperationError") {
                        specificError = "å¯†ç¢¼çŸ­èªéŒ¯èª¤ã€è³‡æ–™ææ¯€æˆ–é©—è­‰æ¨™ç±¤ (tag) ä¸ç¬¦ã€‚";
                    } else {
                        specificError = e.message;
                    }
                    throw new Error("è§£å¯†æ“ä½œå¤±æ•—ï¼š" + specificError);
                }
            }

            const decryptBtn = document.getElementById("decryptBtn");
            const btnText = decryptBtn.querySelector(".btn-text");
            const spinner = decryptBtn.querySelector(".spinner");
            const output = document.getElementById("output");
            const jsonInput = document.getElementById("jsonInput");
            const passphraseInput = document.getElementById("passphrase");
            const copyBtn = document.getElementById("copyBtn");
            const themeToggleBtn = document.getElementById("themeToggleBtn");
            const togglePasswordIcon = document.getElementById("togglePassword"); // æ–°å¢

            decryptBtn.addEventListener("click", async () => {
                const rawInputText = jsonInput.value.trim();
                const passphrase = passphraseInput.value;
                output.textContent = "";
                output.className = "";
                copyBtn.style.display = "none";
                copyBtn.textContent = "è¤‡è£½å…§å®¹";
                copyBtn.disabled = false;
                if (!rawInputText) {
                    output.textContent = "éŒ¯èª¤ï¼šè¼¸å…¥è³‡æ–™ä¸èƒ½ç‚ºç©ºã€‚";
                    output.className = "error";
                    return;
                }
                if (!passphrase) {
                    output.textContent = "éŒ¯èª¤ï¼šå¯†ç¢¼çŸ­èªä¸èƒ½ç‚ºç©ºã€‚";
                    output.className = "error";
                    return;
                }
                setDecryptButtonState(true);
                let jsonData;
                try {
                    try {
                        jsonData = JSON.parse(rawInputText);
                    } catch (e) {
                        try {
                            const decodedJsonText = atob(rawInputText);
                            jsonData = JSON.parse(decodedJsonText);
                            console.log("è¼¸å…¥å…§å®¹å·²æˆåŠŸå¾ Base64 è§£ç¢¼ä¸¦è§£æç‚º JSONã€‚");
                        } catch (e2) {
                            throw new Error("è¼¸å…¥çš„è³‡æ–™æ ¼å¼ç„¡æ•ˆã€‚è«‹æä¾›ç´” JSON æˆ–æœ‰æ•ˆçš„ Base64 ç·¨ç¢¼ JSONã€‚");
                        }
                    }
                    const result = await decryptData(jsonData, passphrase);
                    output.textContent = result;
                    output.className = "success";
                    if (result) copyBtn.style.display = "inline-block";
                } catch (e) {
                    output.textContent = "è™•ç†å¤±æ•—ï¼š" + e.message;
                    output.className = "error";
                    copyBtn.style.display = "none";
                } finally {
                    setDecryptButtonState(false);
                }
            });

            function setDecryptButtonState(isDecrypting) {
                decryptBtn.disabled = isDecrypting;
                btnText.textContent = isDecrypting ? "è§£å¯†ä¸­..." : "ğŸ”“ è§£å¯†";
                spinner.style.display = isDecrypting ? "inline-block" : "none";
            }

            copyBtn.addEventListener("click", async () => {
                const textToCopy = output.textContent;
                if (!textToCopy || output.className !== "success") return;
                try {
                    await navigator.clipboard.writeText(textToCopy);
                    copyBtn.textContent = "âœ… å·²è¤‡è£½æˆåŠŸï¼";
                    copyBtn.disabled = true;
                    setTimeout(() => {
                        copyBtn.textContent = "è¤‡è£½å…§å®¹";
                        copyBtn.disabled = false;
                    }, 2000);
                } catch (err) {
                    console.error("è¤‡è£½åˆ°å‰ªè²¼ç°¿å¤±æ•—: ", err);
                    copyBtn.textContent = "âŒ è¤‡è£½å¤±æ•—ï¼";
                    setTimeout(() => {
                        copyBtn.textContent = "è¤‡è£½å…§å®¹";
                    }, 2000);
                }
            });

            function applyTheme(theme) {
                document.documentElement.setAttribute("data-theme", theme);
                themeToggleBtn.textContent = theme === "dark" ? "â˜€ï¸" : "ğŸŒ™";
                localStorage.setItem("theme", theme);
            }
            function toggleTheme() {
                const currentTheme = document.documentElement.getAttribute("data-theme") || "dark";
                const newTheme = currentTheme === "dark" ? "light" : "dark";
                applyTheme(newTheme);
            }

            // --- æ–°å¢ï¼šåˆ‡æ›å¯†ç¢¼å¯è¦‹æ€§çš„å‡½å¼ ---
            function togglePasswordVisibility() {
                if (passphraseInput.type === "password") {
                    passphraseInput.type = "text";
                    togglePasswordIcon.innerHTML = SVG_EYE_SLASH;
                } else {
                    passphraseInput.type = "password";
                    togglePasswordIcon.innerHTML = SVG_EYE_OPEN;
                }
            }

            // åˆå§‹åŒ–
            themeToggleBtn.addEventListener("click", toggleTheme);
            let initialTheme = localStorage.getItem("theme") || "dark"; // é è¨­ç‚ºæ·±è‰²ä¸»é¡Œ
            applyTheme(initialTheme);

            // --- æ–°å¢ï¼šç‚ºçœ¼ç›åœ–ç¤ºç¶å®šäº‹ä»¶ä¸¦è¨­å®šåˆå§‹åœ–ç¤º ---
            if (togglePasswordIcon) {
                // ç¢ºä¿å…ƒç´ å­˜åœ¨
                togglePasswordIcon.innerHTML = SVG_EYE_OPEN; // åˆå§‹è¨­å®šç‚ºçœé–‹çš„çœ¼ç›
                togglePasswordIcon.addEventListener("click", togglePasswordVisibility);
            } else {
                console.error("Toggle password icon not found!");
            }
        </script>
    </body>
</html>
